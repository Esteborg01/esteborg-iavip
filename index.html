<script>
// ========== CONFIG ==========
const API_BASE = "https://esteborg88full-backend-modular.onrender.com";
const MODULE_PATH = "/api/modules/iavipcom";
const TTS_URL = API_BASE + "/api/voice";

// ========== I18N ==========
const I18N = {
  es: {
    bannerMain: "ESTEBORG EXECUTIVE Â· MEMBERS VIP",
    bannerSub: "Programa ejecutivo Â· Coach profesional de Inteligencia Artificial",
    bannerDesc:
      "Esteborg IA â€“ Despliega todo tu poder es tu programa ejecutivo para dominar la Inteligencia Artificial aplicada. En 3 meses (versiÃ³n acelerada) pasarÃ¡s de principiante a avanzado con prÃ¡ctica guiada y certificaciÃ³n AI Executive & Prompt Engineer by Esteborg Institute. Acceso exclusivo mediante Tokken Esteborg Members.",
    panelTitle: "Mini entrenamiento Â· Esteborg IA â€“ Despliega todo tu poder",
    chipsLabel: "Comenzar entrenamiento:",
    btnLesson: "Aprender IA desde cero",
    btnLessonText:
      "Quiero aprender Inteligencia Artificial desde cero y empezar por el MÃ³dulo 1: Fundamentos de la IA.",
    btnEmotion: "Aplicar IA en mi trabajo",
    btnEmotionText:
      "Quiero aplicar la IA en mi trabajo o negocio y diseÃ±ar contigo un plan prÃ¡ctico con tareas concretas.",
    btnChallenge: "Dominar ChatGPT y otras IA",
    btnChallengeText:
      "Quiero dominar ChatGPT y otros modelos generativos para crear contenido, ideas y automatizaciones.",
    contentLabel: "Herramientas del programa:",
    btnSlides: "Ver estructura del programa",
    btnSlidesText:
      "MuÃ©strame la estructura completa del programa Esteborg IA â€“ Despliega todo tu poder: mÃ³dulos, duraciÃ³n, objetivos y resultados.",
    btnSummary: "Automatizar tareas con IA",
    btnSummaryText:
      "Quiero que me ayudes a automatizar tareas con IA usando herramientas no-code, agentes y flujos inteligentes para mi trabajo diario.",
    inputPlaceholder:
      "CuÃ©ntame quÃ© quieres lograr con la Inteligencia Artificial en tu trabajo, negocio o proyectos...",
    footerTokenTitle: "Tokken Esteborg Members",
    footerTokenText:
      "Si aÃºn no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip",
    chatName: "Esteborg",
    chatRole: "Coach profesional de Inteligencia Artificial",
    voiceToggleLabel: "Voz Esteborg activada",
    voicePillLabel: "ðŸŽ§ Voz Esteborg",
    sendButtonLabel: "ENVIAR",
    statusInitialWithToken:
      "DetectÃ© un Tokken en la URL o guardado Â· lo usarÃ© automÃ¡ticamente en tu entrenamiento premium.",
    statusInitialNoToken:
      "Acceso pendiente Â· necesitas tu Tokken Esteborg Members para activar el entrenamiento completo.",
    statusTokenManual:
      "Tokken pegado manualmente Â· usarÃ© ese Tokken en tu entrenamiento.",
    statusTokenValid: "Modo Members activo Â· Tokken VIP vÃ¡lido.",
    statusTokenInvalid:
      "Tokken invÃ¡lido o expirado Â· genera uno nuevo en Members para continuar con tu entrenamiento.",
    statusDemoEnded:
      "Tu acceso actual terminÃ³ Â· renueva tu Tokken Esteborg Members para seguir con Esteborg IA.",
    statusDemoActive:
      "Esperando Tokken Esteborg Members Â· cuando lo generes, lo usarÃ© automÃ¡ticamente.",
    statusListening: "Escuchando... habla ahora.",
    statusProcessingSpeech: "Procesando lo que dijiste...",
    statusMicError:
      "Hubo un problema con el micrÃ³fono, intenta de nuevo.",
    statusTextCaptured:
      "Texto capturado, puedes enviarlo o editarlo.",
    statusTTSOn: "Voz Esteborg activada.",
    statusTTSOff: "Voz Esteborg desactivada.",
    statusLangCurrent: "Idioma cambiado a espaÃ±ol.",
    tokenPasteReply:
      "Perfecto, ya tengo tu Tokken Esteborg Members âœ…\nAhora dime: Â¿quieres que construyamos tu entrenamiento en IA en \"espaÃ±ol\", \"inglÃ©s\", \"portuguÃ©s\", \"francÃ©s\", \"italiano\" o \"alemÃ¡n\"?",
    tokenWelcomeMessage:
      "âœ… Tu Tokken Esteborg Members estÃ¡ validado.\nEstÃ¡s en modo Members VIP, asÃ­ que trabajaremos tu programa Esteborg IA â€“ Despliega todo tu poder con acceso completo a mÃ³dulos, prÃ¡cticas y certificaciÃ³n.",
    welcomeMessage:
      "Â¡QuÃ© gusto saludarte! ðŸ˜Š Antes de entrar a tu entrenamiento necesito tu Tokken Esteborg Members para validar tu acceso.\n\nSi aÃºn no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip\n\nUna vez que tengas tu Tokken, pÃ©galo aquÃ­ o accede desde tu panel Members VIP. DespuÃ©s elige el idioma en la parte superior (ES, EN, PT, FR, IT, DE) y comenzamos."
  },
  en: {
    bannerMain: "ESTEBORG EXECUTIVE Â· MEMBERS VIP",
    bannerSub: "Executive Program Â· Professional Artificial Intelligence Coach",
    bannerDesc:
      "Esteborg IA â€“ Unleash all your power is your executive program to master applied Artificial Intelligence. In 3 months (accelerated version) you go from beginner to advanced with guided practice and the AI Executive & Prompt Engineer certification by Esteborg Institute. Access is exclusive via Esteborg Members Token.",
    panelTitle: "Mini Training Â· Esteborg IA â€“ Unleash all your power",
    chipsLabel: "Start training:",
    btnLesson: "Learn AI from scratch",
    btnLessonText:
      "I want to learn Artificial Intelligence from scratch and start with Module 1: AI Fundamentals.",
    btnEmotion: "Apply AI to my work",
    btnEmotionText:
      "I want to apply AI to my job or business and design a practical, step-by-step plan with you.",
    btnChallenge: "Master ChatGPT and other AIs",
    btnChallengeText:
      "I want to master ChatGPT and other generative models to create content, ideas and automations.",
    contentLabel: "Program tools:",
    btnSlides: "View program structure",
    btnSlidesText:
      "Show me the full structure of the Esteborg IA â€“ Unleash all your power program: modules, duration, objectives and outcomes.",
    btnSummary: "Automate tasks with AI",
    btnSummaryText:
      "Help me automate tasks with AI using no-code tools, agents and smart workflows in my daily work.",
    inputPlaceholder:
      "Tell me what you want to achieve with Artificial Intelligence in your work, business or projects...",
    footerTokenTitle: "Esteborg Members Token",
    footerTokenText:
      "If you donâ€™t have a token yet, you can get or recover it at: https://membersvip.esteborg.live/#miembrosvip",
    chatName: "Esteborg",
    chatRole: "Professional AI coach",
    voiceToggleLabel: "Esteborg voice enabled",
    voicePillLabel: "ðŸŽ§ Esteborg Voice",
    sendButtonLabel: "SEND",
    statusInitialWithToken:
      "I detected a token in the URL or stored locally Â· Iâ€™ll use it automatically in your premium training.",
    statusInitialNoToken:
      "Access pending Â· you need your Esteborg Members Token to activate the full training.",
    statusTokenManual:
      "Token pasted manually Â· Iâ€™ll use that token in your training.",
    statusTokenValid: "Members mode active Â· VIP token valid.",
    statusTokenInvalid:
      "Invalid or expired token Â· generate a new one in Members to continue your training.",
    statusDemoEnded:
      "Your current access has ended Â· renew your Esteborg Members Token to continue with Esteborg IA.",
    statusDemoActive:
      "Waiting for your Esteborg Members Token Â· once you generate it, Iâ€™ll use it automatically.",
    statusListening: "Listening... speak now.",
    statusProcessingSpeech: "Processing what you said...",
    statusMicError:
      "There was a problem with the microphone, please try again.",
    statusTextCaptured:
      "Text captured, you can send or edit it.",
    statusTTSOn: "Esteborg voice enabled.",
    statusTTSOff: "Esteborg voice disabled.",
    statusLangCurrent: "Language set to English.",
    tokenPasteReply:
      "Perfect, Iâ€™ve got your Esteborg Members Token âœ…\nNow tell me: do you want us to build your AI training in Spanish, English, Portuguese, French, Italian or German?",
    tokenWelcomeMessage:
      "âœ… Your Esteborg Members Token is validated.\nYouâ€™re in Members VIP mode, so weâ€™ll work through your Esteborg IA â€“ Unleash all your power program with full access to modules, practice and certification.",
    welcomeMessage:
      "Great to have you here! ðŸ˜Š Before we start your training I need your Esteborg Members Token to validate your access.\n\nIf you donâ€™t have a token yet, you can get or recover it at: https://membersvip.esteborg.live/#miembrosvip\n\nOnce you have your token, paste it here or log in through your Members VIP panel. Then choose your language at the top (ES, EN, PT, FR, IT, DE) and weâ€™ll get started."
  },
  pt: {
    bannerMain: "ESTEBORG EXECUTIVE Â· MEMBERS VIP",
    bannerSub: "Programa executivo Â· Coach profissional de InteligÃªncia Artificial",
    bannerDesc:
      "Esteborg IA â€“ Liberte todo o seu poder Ã© o seu programa executivo para dominar InteligÃªncia Artificial aplicada. Em 3 meses (versÃ£o acelerada) vocÃª vai de iniciante a avanÃ§ado com prÃ¡tica guiada e certificaÃ§Ã£o AI Executive & Prompt Engineer pelo Esteborg Institute. Acesso exclusivo com Tokken Esteborg Members.",
    panelTitle: "Mini treinamento Â· Esteborg IA â€“ Liberte todo o seu poder",
    chipsLabel: "Iniciar treinamento:",
    btnLesson: "Aprender IA do zero",
    btnLessonText:
      "Quero aprender InteligÃªncia Artificial do zero e comeÃ§ar pelo MÃ³dulo 1: Fundamentos de IA.",
    btnEmotion: "Aplicar IA no meu trabalho",
    btnEmotionText:
      "Quero aplicar IA no meu trabalho ou negÃ³cio e desenhar com vocÃª um plano prÃ¡tico com tarefas concretas.",
    btnChallenge: "Dominar ChatGPT e outras IAs",
    btnChallengeText:
      "Quero dominar o ChatGPT e outros modelos generativos para criar conteÃºdo, ideias e automaÃ§Ãµes.",
    contentLabel: "Ferramentas do programa:",
    btnSlides: "Ver estrutura do programa",
    btnSlidesText:
      "Mostre-me a estrutura completa do programa Esteborg IA â€“ Liberte todo o seu poder: mÃ³dulos, duraÃ§Ã£o, objetivos e resultados.",
    btnSummary: "Automatizar tarefas com IA",
    btnSummaryText:
      "Quero que vocÃª me ajude a automatizar tarefas com IA usando ferramentas no-code, agentes e fluxos inteligentes no meu dia a dia.",
    inputPlaceholder:
      "Conte-me o que vocÃª quer alcanÃ§ar com InteligÃªncia Artificial no seu trabalho, negÃ³cio ou projetos...",
    footerTokenTitle: "Tokken Esteborg Members",
    footerTokenText:
      "Se vocÃª ainda nÃ£o tem token, pode obtÃª-lo ou recuperÃ¡-lo em: https://membersvip.esteborg.live/#miembrosvip",
    chatName: "Esteborg",
    chatRole: "Coach profissional de IA",
    voiceToggleLabel: "Voz Esteborg ativada",
    voicePillLabel: "ðŸŽ§ Voz Esteborg",
    sendButtonLabel: "ENVIAR",
    statusInitialWithToken:
      "Detectei um Tokken na URL ou salvo Â· vou usÃ¡-lo automaticamente no seu treinamento premium.",
    statusInitialNoToken:
      "Acesso pendente Â· vocÃª precisa do seu Tokken Esteborg Members para ativar o treinamento completo.",
    statusTokenManual:
      "Tokken colado manualmente Â· vou usar esse Tokken no seu treinamento.",
    statusTokenValid: "Modo Members ativo Â· Tokken VIP vÃ¡lido.",
    statusTokenInvalid:
      "Tokken invÃ¡lido ou expirado Â· gere um novo no Members para continuar o seu treinamento.",
    statusDemoEnded:
      "Seu acesso atual terminou Â· renove seu Tokken Esteborg Members para continuar com Esteborg IA.",
    statusDemoActive:
      "Aguardando o seu Tokken Esteborg Members Â· quando vocÃª gerar, vou usÃ¡-lo automaticamente.",
    statusListening: "Ouvindo... fale agora.",
    statusProcessingSpeech: "Processando o que vocÃª disse...",
    statusMicError:
      "Houve um problema com o microfone, tente novamente.",
    statusTextCaptured:
      "Texto capturado, vocÃª pode enviar ou editar.",
    statusTTSOn: "Voz Esteborg ativada.",
    statusTTSOff: "Voz Esteborg desativada.",
    statusLangCurrent: "Idioma alterado para portuguÃªs.",
    tokenPasteReply:
      "Perfeito, jÃ¡ tenho seu Tokken Esteborg Members âœ…\nAgora me diga: quer construir seu treinamento em IA em espanhol, inglÃªs, portuguÃªs, francÃªs, italiano ou alemÃ£o?",
    tokenWelcomeMessage:
      "âœ… Seu Tokken Esteborg Members foi validado.\nVocÃª estÃ¡ no modo Members VIP, entÃ£o vamos trabalhar seu programa Esteborg IA â€“ Liberte todo o seu poder com acesso completo a mÃ³dulos, prÃ¡ticas e certificaÃ§Ã£o.",
    welcomeMessage:
      "Que bom ter vocÃª aqui! ðŸ˜Š Antes de comeÃ§armos o seu treinamento, preciso do seu Tokken Esteborg Members para validar o acesso.\n\nSe vocÃª ainda nÃ£o tem token, pode obtÃª-lo ou recuperÃ¡-lo em: https://membersvip.esteborg.live/#miembrosvip\n\nQuando tiver o seu Tokken, cole aqui ou acesse pelo painel Members VIP. Depois escolha o idioma na parte superior (ES, EN, PT, FR, IT, DE) e comeÃ§amos."
  },
  fr: {
    bannerMain: "ESTEBORG EXECUTIVE Â· MEMBERS VIP",
    bannerSub: "Programme exÃ©cutif Â· Coach professionnel en Intelligence Artificielle",
    bannerDesc:
      "Esteborg IA â€“ LibÃ¨re tout ton potentiel est ton programme exÃ©cutif pour maÃ®triser lâ€™Intelligence Artificielle appliquÃ©e. En 3 mois (version accÃ©lÃ©rÃ©e), tu passes de dÃ©butant Ã  avancÃ© avec pratique guidÃ©e et certification AI Executive & Prompt Engineer par lâ€™Esteborg Institute. AccÃ¨s exclusif via Tokken Esteborg Members.",
    panelTitle: "Mini formation Â· Esteborg IA â€“ LibÃ¨re tout ton potentiel",
    chipsLabel: "Commencer la formation :",
    btnLesson: "Apprendre lâ€™IA depuis zÃ©ro",
    btnLessonText:
      "Je veux apprendre lâ€™Intelligence Artificielle depuis zÃ©ro et commencer par le Module 1 : Fondements de lâ€™IA.",
    btnEmotion: "Appliquer lâ€™IA Ã  mon travail",
    btnEmotionText:
      "Je veux appliquer lâ€™IA Ã  mon travail ou Ã  mon entreprise et concevoir avec toi un plan pratique avec des actions concrÃ¨tes.",
    btnChallenge: "MaÃ®triser ChatGPT et dâ€™autres IA",
    btnChallengeText:
      "Je veux maÃ®triser ChatGPT et dâ€™autres modÃ¨les gÃ©nÃ©ratifs pour crÃ©er du contenu, des idÃ©es et des automatisations.",
    contentLabel: "Outils du programme :",
    btnSlides: "Voir la structure du programme",
    btnSlidesText:
      "Montre-moi la structure complÃ¨te du programme Esteborg IA â€“ LibÃ¨re tout ton potentiel : modules, durÃ©e, objectifs et rÃ©sultats.",
    btnSummary: "Automatiser des tÃ¢ches avec lâ€™IA",
    btnSummaryText:
      "Aide-moi Ã  automatiser des tÃ¢ches avec lâ€™IA en utilisant des outils no-code, des agents et des workflows intelligents dans mon travail quotidien.",
    inputPlaceholder:
      "Raconte-moi ce que tu veux accomplir avec lâ€™Intelligence Artificielle dans ton travail, ton entreprise ou tes projets...",
    footerTokenTitle: "Tokken Esteborg Members",
    footerTokenText:
      "Si tu nâ€™as pas encore de token, tu peux lâ€™obtenir ou le rÃ©cupÃ©rer ici : https://membersvip.esteborg.live/#miembrosvip",
    chatName: "Esteborg",
    chatRole: "Coach professionnel en IA",
    voiceToggleLabel: "Voix Esteborg activÃ©e",
    voicePillLabel: "ðŸŽ§ Voix Esteborg",
    sendButtonLabel: "ENVOYER",
    statusInitialWithToken:
      "Jâ€™ai dÃ©tectÃ© un Tokken dans lâ€™URL ou en local Â· je lâ€™utiliserai automatiquement dans ta formation premium.",
    statusInitialNoToken:
      "AccÃ¨s en attente Â· tu as besoin de ton Tokken Esteborg Members pour activer la formation complÃ¨te.",
    statusTokenManual:
      "Tokken collÃ© manuellement Â· jâ€™utiliserai ce Tokken dans ta formation.",
    statusTokenValid: "Mode Members actif Â· Tokken VIP valide.",
    statusTokenInvalid:
      "Tokken invalide ou expirÃ© Â· gÃ©nÃ¨re-en un nouveau dans Members pour continuer ta formation.",
    statusDemoEnded:
      "Ton accÃ¨s actuel est terminÃ© Â· renouvelle ton Tokken Esteborg Members pour continuer avec Esteborg IA.",
    statusDemoActive:
      "En attente de ton Tokken Esteborg Members Â· dÃ¨s que tu le gÃ©nÃ¨res, je lâ€™utiliserai automatiquement.",
    statusListening: "Jâ€™Ã©coute... tu peux parler.",
    statusProcessingSpeech: "Je traite ce que tu as dit...",
    statusMicError:
      "Il y a eu un problÃ¨me avec le micro, rÃ©essaie.",
    statusTextCaptured:
      "Texte capturÃ©, tu peux lâ€™envoyer ou le modifier.",
    statusTTSOn: "Voix Esteborg activÃ©e.",
    statusTTSOff: "Voix Esteborg dÃ©sactivÃ©e.",
    statusLangCurrent: "Langue rÃ©glÃ©e sur le franÃ§ais.",
    tokenPasteReply:
      "Parfait, jâ€™ai ton Tokken Esteborg Members âœ…\nDis-moi maintenant : veux-tu que lâ€™on construise ta formation en IA en espagnol, anglais, portugais, franÃ§ais, italien ou allemand ?",
    tokenWelcomeMessage:
      "âœ… Ton Tokken Esteborg Members est validÃ©.\nTu es en mode Members VIP, nous allons donc travailler ton programme Esteborg IA â€“ LibÃ¨re tout ton potentiel avec un accÃ¨s complet aux modules, aux pratiques et Ã  la certification.",
    welcomeMessage:
      "Ravi de te voir ici ! ðŸ˜Š Avant de commencer ta formation, jâ€™ai besoin de ton Tokken Esteborg Members pour valider ton accÃ¨s.\n\nSi tu nâ€™as pas encore de token, tu peux lâ€™obtenir ou le rÃ©cupÃ©rer ici : https://membersvip.esteborg.live/#miembrosvip\n\nUne fois que tu as ton Tokken, colle-le ici ou passe par ton panneau Members VIP. Ensuite, choisis la langue en haut (ES, EN, PT, FR, IT, DE) et on commence."
  },
  it: {
    bannerMain: "ESTEBORG EXECUTIVE Â· MEMBERS VIP",
    bannerSub: "Programma esecutivo Â· Coach professionale di Intelligenza Artificiale",
    bannerDesc:
      "Esteborg IA â€“ Sprigiona tutto il tuo potenziale Ã¨ il tuo programma esecutivo per dominare lâ€™Intelligenza Artificiale applicata. In 3 mesi (versione accelerata) passi da principiante ad avanzato con pratica guidata e certificazione AI Executive & Prompt Engineer by Esteborg Institute. Accesso esclusivo tramite Tokken Esteborg Members.",
    panelTitle: "Mini training Â· Esteborg IA â€“ Sprigiona tutto il tuo potenziale",
    chipsLabel: "Inizia il training:",
    btnLesson: "Imparare lâ€™IA da zero",
    btnLessonText:
      "Voglio imparare lâ€™Intelligenza Artificiale da zero e iniziare dal Modulo 1: Fondamenti di IA.",
    btnEmotion: "Applicare lâ€™IA al mio lavoro",
    btnEmotionText:
      "Voglio applicare lâ€™IA al mio lavoro o business e costruire con te un piano pratico con attivitÃ  concrete.",
    btnChallenge: "Dominare ChatGPT e altre IA",
    btnChallengeText:
      "Voglio dominare ChatGPT e altri modelli generativi per creare contenuti, idee e automazioni.",
    contentLabel: "Strumenti del programma:",
    btnSlides: "Vedi la struttura del programma",
    btnSlidesText:
      "Fammi vedere la struttura completa del programma Esteborg IA â€“ Sprigiona tutto il tuo potenziale: moduli, durata, obiettivi e risultati.",
    btnSummary: "Automatizzare attivitÃ  con lâ€™IA",
    btnSummaryText:
      "Voglio che mi aiuti ad automatizzare attivitÃ  con lâ€™IA usando strumenti no-code, agenti e flussi intelligenti nel mio lavoro quotidiano.",
    inputPlaceholder:
      "Raccontami cosa vuoi ottenere con lâ€™Intelligenza Artificiale nel tuo lavoro, business o nei tuoi progetti...",
    footerTokenTitle: "Tokken Esteborg Members",
    footerTokenText:
      "Se non hai ancora un token, puoi ottenerlo o recuperarlo qui: https://membersvip.esteborg.live/#miembrosvip",
    chatName: "Esteborg",
    chatRole: "Coach professionale di IA",
    voiceToggleLabel: "Voce Esteborg attivata",
    voicePillLabel: "ðŸŽ§ Voce Esteborg",
    sendButtonLabel: "INVIA",
    statusInitialWithToken:
      "Ho rilevato un Tokken nellâ€™URL o salvato in locale Â· lo userÃ² automaticamente nel tuo training premium.",
    statusInitialNoToken:
      "Accesso in sospeso Â· hai bisogno del tuo Tokken Esteborg Members per attivare il training completo.",
    statusTokenManual:
      "Tokken incollato manualmente Â· userÃ² quel Tokken nel tuo training.",
    statusTokenValid: "ModalitÃ  Members attiva Â· Tokken VIP valido.",
    statusTokenInvalid:
      "Tokken non valido o scaduto Â· generane uno nuovo su Members per continuare il training.",
    statusDemoEnded:
      "Il tuo accesso attuale Ã¨ terminato Â· rinnova il tuo Tokken Esteborg Members per continuare con Esteborg IA.",
    statusDemoActive:
      "In attesa del tuo Tokken Esteborg Members Â· non appena lo generi, lo userÃ² automaticamente.",
    statusListening: "Sto ascoltando... puoi parlare.",
    statusProcessingSpeech: "Sto elaborando quello che hai detto...",
    statusMicError:
      "Si Ã¨ verificato un problema con il microfono, riprova.",
    statusTextCaptured:
      "Testo catturato, puoi inviarlo o modificarlo.",
    statusTTSOn: "Voce Esteborg attivata.",
    statusTTSOff: "Voce Esteborg disattivata.",
    statusLangCurrent: "Lingua impostata su italiano.",
    tokenPasteReply:
      "Perfetto, ho il tuo Tokken Esteborg Members âœ…\nDimmi ora: vuoi costruire il tuo training in IA in spagnolo, inglese, portoghese, francese, italiano o tedesco?",
    tokenWelcomeMessage:
      "âœ… Il tuo Tokken Esteborg Members Ã¨ stato validato.\nSei in modalitÃ  Members VIP, quindi lavoreremo al tuo programma Esteborg IA â€“ Sprigiona tutto il tuo potenziale con accesso completo a moduli, pratica e certificazione.",
    welcomeMessage:
      "Felice di vederti qui! ðŸ˜Š Prima di iniziare il tuo training ho bisogno del tuo Tokken Esteborg Members per validare lâ€™accesso.\n\nSe non hai ancora un token, puoi ottenerlo o recuperarlo qui: https://membersvip.esteborg.live/#miembrosvip\n\nQuando avrai il tuo Tokken, incollalo aqui o accedi dal pannello Members VIP. Poi scegli la lingua in alto (ES, EN, PT, FR, IT, DE) e iniziamo."
  },
  de: {
    bannerMain: "ESTEBORG EXECUTIVE Â· MEMBERS VIP",
    bannerSub: "Executive-Programm Â· Professioneller Coach fÃ¼r KÃ¼nstliche Intelligenz",
    bannerDesc:
      "Esteborg IA â€“ Entfalte deine ganze Power ist dein Executive-Programm, um angewandte KÃ¼nstliche Intelligenz zu meistern. In 3 Monaten (beschleunigte Version) gehst du von AnfÃ¤nger zu Fortgeschrittenem â€“ mit angeleiteter Praxis und dem Zertifikat AI Executive & Prompt Engineer vom Esteborg Institute. Zugang ausschlieÃŸlich mit Esteborg Members Tokken.",
    panelTitle: "Mini-Training Â· Esteborg IA â€“ Entfalte deine ganze Power",
    chipsLabel: "Training starten:",
    btnLesson: "KI von Grund auf lernen",
    btnLessonText:
      "Ich mÃ¶chte KÃ¼nstliche Intelligenz von Grund auf lernen und mit Modul 1: KI-Grundlagen beginnen.",
    btnEmotion: "KI in meiner Arbeit einsetzen",
    btnEmotionText:
      "Ich mÃ¶chte KI in meinem Job oder Unternehmen einsetzen und mit dir einen praktischen Plan mit konkreten Aufgaben entwerfen.",
    btnChallenge: "ChatGPT und andere KIs meistern",
    btnChallengeText:
      "Ich mÃ¶chte ChatGPT und andere generative Modelle meistern, um Inhalte, Ideen und Automatisierungen zu erstellen.",
    contentLabel: "Programm-Werkzeuge:",
    btnSlides: "Programmstruktur ansehen",
    btnSlidesText:
      "Zeig mir die komplette Struktur des Programms Esteborg IA â€“ Entfalte deine ganze Power: Module, Dauer, Ziele und Ergebnisse.",
    btnSummary: "Aufgaben mit KI automatisieren",
    btnSummaryText:
      "Hilf mir, Aufgaben mit KI zu automatisieren â€“ mit No-Code-Tools, Agents und intelligenten Workflows fÃ¼r meinen Arbeitsalltag.",
    inputPlaceholder:
      "ErzÃ¤hl mir, was du mit KÃ¼nstlicher Intelligenz in deiner Arbeit, deinem Business oder deinen Projekten erreichen mÃ¶chtest...",
    footerTokenTitle: "Esteborg Members Tokken",
    footerTokenText:
      "Wenn du noch keinen Tokken hast, kannst du ihn hier erhalten oder wiederherstellen: https://membersvip.esteborg.live/#miembrosvip",
    chatName: "Esteborg",
    chatRole: "Professioneller KI-Coach",
    voiceToggleLabel: "Esteborg-Stimme aktiviert",
    voicePillLabel: "ðŸŽ§ Esteborg-Stimme",
    sendButtonLabel: "SENDEN",
    statusInitialWithToken:
      "Ich habe einen Tokken in der URL oder lokal erkannt Â· ich verwende ihn automatisch fÃ¼r dein Premium-Training.",
    statusInitialNoToken:
      "Zugang ausstehend Â· du brauchst deinen Esteborg Members Tokken, um das vollstÃ¤ndige Training zu aktivieren.",
    statusTokenManual:
      "Tokken manuell eingefÃ¼gt Â· ich verwende diesen Tokken in deinem Training.",
    statusTokenValid: "Members-Modus aktiv Â· VIP-Tokken gÃ¼ltig.",
    statusTokenInvalid:
      "Tokken ungÃ¼ltig oder abgelaufen Â· erstelle einen neuen in Members, um dein Training fortzusetzen.",
    statusDemoEnded:
      "Dein aktueller Zugang ist beendet Â· erneuere deinen Esteborg Members Tokken, um mit Esteborg IA fortzufahren.",
    statusDemoActive:
      "Warte auf deinen Esteborg Members Tokken Â· sobald du ihn erzeugst, werde ich ihn automatisch verwenden.",
    statusListening: "Ich hÃ¶re zu... du kannst jetzt sprechen.",
    statusProcessingSpeech: "Ich verarbeite, was du gesagt hast...",
    statusMicError:
      "Es gab ein Problem mit dem Mikrofon, versuche es noch einmal.",
    statusTextCaptured:
      "Text erfasst â€“ du kannst ihn senden oder bearbeiten.",
    statusTTSOn: "Esteborg-Stimme aktiviert.",
    statusTTSOff: "Esteborg-Stimme deaktiviert.",
    statusLangCurrent: "Sprache auf Deutsch gesetzt.",
    tokenPasteReply:
      "Perfekt, ich habe deinen Esteborg Members Tokken âœ…\nSag mir jetzt: Sollen wir dein KI-Training auf Spanisch, Englisch, Portugiesisch, FranzÃ¶sisch, Italienisch oder Deutsch aufbauen?",
    tokenWelcomeMessage:
      "âœ… Dein Esteborg Members Tokken ist validiert.\nDu bist im Members-VIP-Modus, daher arbeiten wir dein Programm Esteborg IA â€“ Entfalte deine ganze Power mit vollem Zugriff auf Module, Praxis und Zertifizierung durch.",
    welcomeMessage:
      "SchÃ¶n, dass du hier bist! ðŸ˜Š Bevor wir mit deinem Training starten, benÃ¶tige ich deinen Esteborg Members Tokken, um deinen Zugang zu bestÃ¤tigen.\n\nWenn du noch keinen Tokken hast, kannst du ihn hier erhalten oder wiederherstellen: https://membersvip.esteborg.live/#miembrosvip\n\nSobald du deinen Tokken hast, fÃ¼ge ihn hier ein oder nutze dein Members-VIP-Panel. WÃ¤hle dann oben die Sprache (ES, EN, PT, FR, IT, DE) und wir legen los."
  }
};

// ===== Helpers =====
function $(id) {
  return document.getElementById(id);
}

function t(key) {
  const pack = I18N[window.currentLang || "es"] || I18N.es;
  return pack[key] || "";
}

function setStatus(message) {
  const el = $("status-line");
  if (!el) return;
  const span = el.querySelector("span:nth-child(2)");
  if (span) span.textContent = message;
}

function applyUILanguage(lang) {
  const pack = I18N[lang] || I18N.es;
  if ($("i-banner-main")) $("i-banner-main").textContent = pack.bannerMain;
  if ($("i-banner-sub")) $("i-banner-sub").textContent = pack.bannerSub;
  if ($("i-banner-desc")) $("i-banner-desc").textContent = pack.bannerDesc;

  if ($("i-panel-title")) $("i-panel-title").textContent = pack.panelTitle;
  if ($("i-chips-label")) $("i-chips-label").textContent = pack.chipsLabel;

  const btnLesson = $("i-btn-lesson");
  if (btnLesson) {
    btnLesson.textContent = pack.btnLesson;
    btnLesson.setAttribute("data-text", pack.btnLessonText);
  }
  const btnEmotion = $("i-btn-emotion");
  if (btnEmotion) {
    btnEmotion.textContent = pack.btnEmotion;
    btnEmotion.setAttribute("data-text", pack.btnEmotionText);
  }
  const btnChallenge = $("i-btn-challenge");
  if (btnChallenge) {
    btnChallenge.textContent = pack.btnChallenge;
    btnChallenge.setAttribute("data-text", pack.btnChallengeText);
  }

  const btnSlides = $("i-btn-slides");
  if (btnSlides) {
    btnSlides.textContent = pack.btnSlides;
    btnSlides.setAttribute("data-text", pack.btnSlidesText);
  }
  const btnSummary = $("i-btn-summary");
  if (btnSummary) {
    btnSummary.textContent = pack.btnSummary;
    btnSummary.setAttribute("data-text", pack.btnSummaryText);
  }

  const input = $("user-input");
  if (input) input.placeholder = pack.inputPlaceholder;

  if ($("i-footer-token-title"))
    $("i-footer-token-title").textContent = pack.footerTokenTitle;
  if ($("i-footer-token-text"))
    $("i-footer-token-text").textContent = pack.footerTokenText;

  if ($("i-chat-name")) $("i-chat-name").textContent = pack.chatName;
  if ($("i-chat-role")) $("i-chat-role").textContent = pack.chatRole;

  if ($("i-voice-toggle-label"))
    $("i-voice-toggle-label").textContent = pack.voiceToggleLabel;
  if ($("i-voice-pill")) $("i-voice-pill").textContent = pack.voicePillLabel;

  const sendBtn = $("send-btn");
  if (sendBtn) sendBtn.textContent = pack.sendButtonLabel;
}

function getSpeechLangCode(lang) {
  switch (lang) {
    case "en": return "en-US";
    case "pt": return "pt-BR";
    case "fr": return "fr-FR";
    case "it": return "it-IT";
    case "de": return "de-DE";
    default: return "es-MX";
  }
}

// ===== Global state =====
let currentAudio = null;
let isSending = false;
let history = [];
let recognition = null;

// ===== Token helpers =====
function getVIPTokenFromURL() {
  try {
    const params = new URLSearchParams(window.location.search || "");
    const raw =
      params.get("tokken") ||
      params.get("access_token") ||
      params.get("token") ||
      "";
    if (!raw) return null;
    return raw.trim();
  } catch (e) {
    console.warn("[Tokken] Error leyendo token de URL:", e);
    return null;
  }
}

function getVIPTokenFromStorage() {
  try {
    const stored =
      window.localStorage.getItem("esteborg_members_token") || "";
    return stored.trim() || null;
  } catch (e) {
    console.warn("[Tokken] Error leyendo token de storage:", e);
    return null;
  }
}

function saveVIPToken(token) {
  try {
    if (!token) return;
    window.localStorage.setItem("esteborg_members_token", token);
  } catch (e) {
    console.warn("[Tokken] Error guardando token:", e);
  }
}

// ===== Chat helpers =====
function appendMessage(role, content) {
  const log = $("chat-log");
  if (!log) return;
  const wrapper = document.createElement("div");
  wrapper.className = "message " + (role === "assistant" ? "assistant" : "user");
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = content;
  wrapper.appendChild(bubble);
  log.appendChild(wrapper);
  log.scrollTop = log.scrollHeight;
}

function stopTTS() {
  if (currentAudio) {
    try {
      currentAudio.pause();
      currentAudio.currentTime = 0;
    } catch (_) {}
    currentAudio = null;
  }
}

async function speakText(text) {
  const toggle = $("tts-toggle");
  if (!toggle || !toggle.checked) return;
  if (!text) return;

  try {
    const trimmed = text.length > 450 ? text.slice(0, 450) : text;
    const res = await fetch(TTS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        text: trimmed,
        voiceId: "IdhxxSTaAg80CTeSgScm"
      })
    });
    if (!res.ok) {
      console.error("[TTS] API error", await res.text());
      return;
    }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    stopTTS();
    currentAudio = new Audio(url);
    currentAudio.play().catch((err) => {
      console.warn("[TTS] No se pudo reproducir:", err);
    });
  } catch (e) {
    console.error("[TTS] Error general TTS:", e);
  }
}

function detectTokenInContent(text) {
  const maybe = text.trim();
  if (
    maybe.length > 20 &&
    !maybe.includes(" ") &&
    !maybe.includes("\n") &&
    maybe.includes(".")
  ) {
    return maybe;
  }
  return null;
}

function showWelcomeMessage() {
  const log = $("chat-log");
  if (!log) return;
  log.innerHTML = "";
  history = [];
  const welcome = t("welcomeMessage");
  appendMessage("assistant", welcome);
  history.push({ role: "assistant", content: welcome });
  speakText(welcome);
}

function bootstrapTokenStatus() {
  const urlToken = getVIPTokenFromURL();
  const storedToken = getVIPTokenFromStorage();

  if (urlToken) {
    saveVIPToken(urlToken);
    setStatus(t("statusInitialWithToken"));
    const msg = t("tokenWelcomeMessage");
    appendMessage("assistant", msg);
    history.push({ role: "assistant", content: msg });
  } else if (storedToken) {
    setStatus(t("statusInitialWithToken"));
    const msg = t("tokenWelcomeMessage");
    appendMessage("assistant", msg);
    history.push({ role: "assistant", content: msg });
  } else {
    setStatus(t("statusInitialNoToken"));
  }
}

async function sendMessage(text) {
  if (!text || isSending) return;
  const trimmed = text.trim();
  if (!trimmed) return;

  const inputEl = $("user-input");
  appendMessage("user", trimmed);
  history.push({ role: "user", content: trimmed });
  if (inputEl) inputEl.value = "";

  const tokenFromContent = detectTokenInContent(trimmed);
  if (tokenFromContent) {
    saveVIPToken(tokenFromContent);
    setStatus(t("statusTokenManual"));
    const reply = t("tokenPasteReply");
    appendMessage("assistant", reply);
    history.push({ role: "assistant", content: reply });
    speakText(reply);
  }

  isSending = true;

  try {
    const storedToken = getVIPTokenFromStorage();
    const urlToken = getVIPTokenFromURL();
    const effectiveToken = urlToken || storedToken || null;

    const payload = {
      messages: history,
      lang: window.currentLang || "es",
      tokken: effectiveToken || undefined,
      source: "iframe-iavipcom"
    };

    const res = await fetch(API_BASE + MODULE_PATH, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      console.error("[API] Error HTTP", res.status, await res.text());
      const msg =
        "Hubo un problema al procesar tu entrenamiento. Intenta otra vez en unos momentos o revisa tu Tokken Members.";
      appendMessage("assistant", msg);
      history.push({ role: "assistant", content: msg });
      return;
    }

    const data = await res.json();
    const answer = data && (data.reply || data.message || data.content || "");
    const tokStatus = data && (data.tokenStatus || data.tokkenStatus || "unknown");

    if (answer) {
      appendMessage("assistant", answer);
      history.push({ role: "assistant", content: answer });
      speakText(answer);
    }

    if (tokStatus === "valid") {
      setStatus(t("statusTokenValid"));
    } else if (tokStatus === "invalid" || tokStatus === "expired") {
      setStatus(t("statusTokenInvalid"));
    }
  } catch (e) {
    console.error("[API] Error general:", e);
    const msg =
      "OcurriÃ³ un error inesperado al llamar al mÃ³dulo de IA. Intenta nuevamente.";
    appendMessage("assistant", msg);
    history.push({ role: "assistant", content: msg });
  } finally {
    isSending = false;
    const inputEl = $("user-input");
    if (inputEl) inputEl.focus();
  }
}

function initLanguagePills() {
  const container = document.querySelector(".chat-language-pill");
  if (!container) return;

  const options = container.querySelectorAll(".lang-option");
  options.forEach((opt) => {
    opt.addEventListener("click", () => {
      options.forEach((o) => o.classList.remove("active"));
      opt.classList.add("active");

      const lang = opt.getAttribute("data-lang") || "es";
      window.currentLang = lang;

      applyUILanguage(lang);
      showWelcomeMessage();
      bootstrapTokenStatus();
      setStatus(t("statusLangCurrent"));

      if (recognition) {
        recognition.lang = getSpeechLangCode(lang);
      }
    });
  });
}

function initChips() {
  const ids = [
    "i-btn-lesson",
    "i-btn-emotion",
    "i-btn-challenge",
    "i-btn-slides",
    "i-btn-summary"
  ];
  ids.forEach((id) => {
    const btn = $(id);
    if (!btn) return;
    btn.addEventListener("click", () => {
      const text = btn.getAttribute("data-text") || btn.textContent || "";
      if (!text) return;
      const inputEl = $("user-input");
      if (inputEl) {
        inputEl.value = text;
        inputEl.focus();
      }
    });
  });
}

function initInputHandlers() {
  const inputEl = $("user-input");
  const sendBtn = $("send-btn");

  if (sendBtn) {
    sendBtn.addEventListener("click", () => {
      if (!inputEl) return;
      const value = inputEl.value || "";
      sendMessage(value);
    });
  }

  if (inputEl) {
    inputEl.addEventListener("keydown", (ev) => {
      if (ev.key === "Enter" && !ev.shiftKey) {
        ev.preventDefault();
        const value = inputEl.value || "";
        sendMessage(value);
      }
    });
  }
}

function initMic() {
  const micBtn = $("mic-btn");
  if (!micBtn) return;

  micBtn.addEventListener("click", () => {
    if (!("webkitSpeechRecognition" in window || "SpeechRecognition" in window)) {
      alert("Tu navegador no soporta reconocimiento de voz nativo.");
      return;
    }

    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!recognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = getSpeechLangCode(window.currentLang || "es");

      recognition.onstart = () => {
        setStatus(t("statusListening"));
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const inputEl = $("user-input");
        if (inputEl) {
          inputEl.value = transcript;
        }
        setStatus(t("statusTextCaptured"));
      };

      recognition.onerror = () => {
        setStatus(t("statusMicError"));
      };

      recognition.onend = () => {
        setStatus(t("statusProcessingSpeech"));
      };
    }

    try {
      recognition.lang = getSpeechLangCode(window.currentLang || "es");
      recognition.start();
    } catch (e) {
      console.error("[Mic] Error al activar reconocimiento:", e);
      setStatus(t("statusMicError"));
    }
  });
}

function initTTSToggle() {
  const toggle = $("tts-toggle");
  if (!toggle) return;

  toggle.addEventListener("change", () => {
    if (toggle.checked) {
      setStatus(t("statusTTSOn"));
    } else {
      setStatus(t("statusTTSOff"));
      stopTTS();
    }
  });
}

function sendResize() {
  try {
    const height = document.body.scrollHeight;
    window.parent.postMessage(
      {
        type: "esteborg-iframe-resize",
        height: height
      },
      "*"
    );
  } catch (_) {}
}

function initResizeObserver() {
  sendResize();
  window.addEventListener("resize", () => {
    clearTimeout(window.__esteborgResizeTimer);
    window.__esteborgResizeTimer = setTimeout(sendResize, 80);
  });

  const observer = new MutationObserver(() => {
    clearTimeout(window.__esteborgResizeTimer);
    window.__esteborgResizeTimer = setTimeout(sendResize, 80);
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true,
    attributes: true
  });
}

// ===== Init =====
document.addEventListener("DOMContentLoaded", () => {
  window.currentLang = "es";
  applyUILanguage("es");
  showWelcomeMessage();
  bootstrapTokenStatus();
  initLanguagePills();
  initChips();
  initInputHandlers();
  initMic();
  initTTSToggle();
  initResizeObserver();
});
</script>
