<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Esteborg IA - Despliega todo tu poder</title>

  <style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; }

  body {
    margin: 0;
    height: 100%;
    min-height: 100vh;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
      "Inter", sans-serif;
    background: radial-gradient(circle at top, #28224b 0, #050509 55%, #020208 100%);
    color: #f5f5ff;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 16px 8px 32px; /* compacto, igual que Com7 */
    overflow: hidden;
  }

  .app {
    width: 100%;
    max-width: 960px;  /* ancho gemelo a Com7 */
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .shell {
    position: relative;
    border-radius: 32px;
    padding: 26px 26px 22px;
    background:
      radial-gradient(circle at top left, rgba(94, 234, 212, 0.06), transparent 55%),
      radial-gradient(circle at bottom right, rgba(251, 191, 36, 0.09), transparent 55%),
      rgba(3, 7, 18, 0.96);
    box-shadow:
      0 30px 90px rgba(0, 0, 0, 0.95),
      0 0 0 1px rgba(148, 163, 184, 0.28),
      0 0 32px rgba(56, 189, 248, 0.25);
    border: 1px solid rgba(75, 85, 99, 0.75);
  }

  .banner-header {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 10px;
  }
  .banner-avatar {
    width: 40px;
    height: 40px;
    border-radius: 999px;
    background: radial-gradient(circle at top, #38bdf8, #4f46e5);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 20px;
    color: #ecfeff;
    box-shadow:
      0 0 0 2px rgba(15, 23, 42, 1),
      0 0 0 1px rgba(226, 232, 240, 0.9),
      0 0 32px rgba(96, 165, 250, 0.95);
  }

  .banner-title {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .banner-title-main {
    font-size: 13px;
    letter-spacing: 0.19em;
    text-transform: uppercase;
    color: rgba(209, 213, 219, 0.96);
  }
  .banner-title-sub {
    font-size: 22px;
    font-weight: 650;
    letter-spacing: 0.02em;
    color: #e5e7eb;
  }

  .banner-description {
    margin-top: 4px;
    font-size: 13px;
    color: rgba(209, 213, 219, 0.92);
  }

  .panel {
    margin-top: 18px;
    border-radius: 22px;
    padding: 14px 16px 14px;
    background:
      linear-gradient(
        145deg,
        rgba(15, 23, 42, 0.96),
        rgba(15, 23, 42, 0.85)
      );
    border: 1px solid rgba(148, 163, 184, 0.8);
    box-shadow:
      inset 0 0 0 1px rgba(15, 23, 42, 0.96),
      0 18px 40px rgba(15, 23, 42, 0.95);
  }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 10px;
  }
  .panel-title {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: rgba(148, 163, 184, 0.95);
  }
  .panel-badge {
    border-radius: 999px;
    padding: 4px 10px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    border: 1px solid rgba(52, 211, 153, 0.6);
    color: #a7f3d0;
    background: radial-gradient(circle at top left, rgba(16, 185, 129, 0.35), rgba(15, 23, 42, 0.98));
  }
  .panel-badge .dot {
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: radial-gradient(circle at center, #22c55e, #15803d);
    box-shadow: 0 0 12px rgba(34, 197, 94, 0.95);
  }

  .chips-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
    font-size: 11px;
    color: rgba(156, 163, 175, 0.95);
  }
  .chips-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: rgba(148, 163, 184, 0.98);
  }
  .chip-btn {
    border-radius: 999px;
    border: 1px solid rgba(129, 140, 248, 0.9);
    background: radial-gradient(circle at top, rgba(79, 70, 229, 0.95), rgba(30, 64, 175, 0.98));
    color: #e5e7eb;
    padding: 4px 11px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow:
      0 10px 22px rgba(15, 23, 42, 0.95),
      0 0 0 1px rgba(191, 219, 254, 0.35);
  }

  .content-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-bottom: 12px;
  }
  .content-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: rgba(148, 163, 184, 0.98);
  }
  .content-btn {
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.9);
    background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.86));
    color: rgba(209, 213, 219, 0.98);
    padding: 4px 10px;
    font-size: 11px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  /* CHAT */
  .chat-container {
    margin-top: 10px;
    border-radius: 20px;
    padding: 10px 10px 12px;
    background:
      radial-gradient(circle at top left, rgba(96, 165, 250, 0.07), transparent 55%),
      radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.09), transparent 55%),
      rgba(15, 23, 42, 0.98);
    border: 1px solid rgba(55, 65, 81, 0.95);
    box-shadow:
      inset 0 0 0 1px rgba(15, 23, 42, 1),
      0 20px 42px rgba(15, 23, 42, 0.98);

    display: flex;
    flex-direction: column;
    max-height: 540px;
    overflow: hidden;
  }

  .chat-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2px 2px 6px;
  }
  .chat-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .chat-node {
    width: 22px;
    height: 22px;
    border-radius: 999px;
    border: 1px solid rgba(191, 219, 254, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 700;
    color: #e5e7eb;
    background: radial-gradient(circle at top, #4f46e5, #0ea5e9);
    box-shadow:
      0 0 0 1px rgba(15, 23, 42, 1),
      0 0 18px rgba(129, 140, 248, 0.95);
  }
  .chat-title {
    display: flex;
    flex-direction: column;
    gap: 0;
    font-size: 12px;
    color: #e5e7eb;
  }
  .chat-title small {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    color: rgba(148, 163, 184, 0.95);
  }

  .chat-language-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    border-radius: 999px;
    padding: 3px 7px;
    border: 1px solid rgba(248, 250, 252, 0.3);
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.9));
    font-size: 11px;
    color: rgba(229, 231, 235, 0.98);
  }
  .lang-option {
    padding: 1px 6px;
    border-radius: 999px;
    border: 1px solid rgba(55, 65, 81, 0.9);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    cursor: pointer;
  }
  .lang-option.active {
    border-color: rgba(96, 165, 250, 0.95);
    background: radial-gradient(circle at top, rgba(59, 130, 246, 0.9), rgba(15, 23, 42, 0.9));
  }

  /* CHAT BOX */
  #chat-log {
    margin-top: 8px;
    border-radius: 18px;
    background: rgba(5, 7, 18, 0.96);
    border: 1px solid rgba(51, 65, 85, 0.9);
    padding: 12px;

    flex: 1;
    min-height: 200px;
    max-height: none;
    overflow-y: auto;

    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .msg-row {
    display: flex;
    align-items: flex-start;
    gap: 6px;
  }
  .msg-row.user { justify-content: flex-end; }
  .msg-tag {
    font-size: 11px;
    border-radius: 999px;
    padding: 2px 7px;
    border: 1px solid rgba(148, 163, 184, 0.7);
    opacity: 0.9;
    white-space: nowrap;
  }
  .msg-tag.user {
    color: rgba(248, 250, 252, 0.96);
    border-color: rgba(248, 250, 252, 0.6);
  }
  .msg-tag.assistant {
    color: rgba(52, 211, 153, 0.96);
    border-color: rgba(52, 211, 153, 0.7);
  }
  .msg-bubble {
    max-width: 88%;
    padding: 8px 12px;
    border-radius: 14px;
    font-size: 17px;
    line-height: 1.5;
    border: 1px solid transparent;
  }
  .msg-row.user .msg-bubble {
    border-radius: 14px 14px 3px 14px;
    background: linear-gradient(135deg, #1d4ed8, #4c1d95);
    border-color: rgba(191, 219, 254, 0.4);
    color: #e5e7eb;
  }
  .msg-row.assistant .msg-bubble {
    border-radius: 14px 14px 14px 3px;
    background: linear-gradient(135deg, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.92));
    border-color: rgba(55, 65, 81, 0.9);
    color: #e5e7eb;
  }
  .msg-text {
    white-space: pre-wrap;
  }

  .input-row {
    margin-top: 10px;
    display: grid;
    grid-template-columns: minmax(0, 1fr) auto auto;
    gap: 8px;
    align-items: stretch;
  }
  .input-row textarea {
    resize: none;
    border-radius: 999px;
    border: 1px solid rgba(75, 85, 99, 0.95);
    background: radial-gradient(circle at top, rgba(3, 7, 18, 0.98), rgba(3, 7, 18, 0.95));
    color: #e5e7eb;
    padding: 10px 14px;
    font-size: 14px;
    min-height: 44px;
    max-height: 84px;
    line-height: 1.4;
    outline: none;
    box-shadow:
      0 0 0 1px rgba(15, 23, 42, 0.9),
      0 14px 24px rgba(15, 23, 42, 0.98);
  }
  .input-row textarea::placeholder {
    color: rgba(148, 163, 184, 0.95);
  }

  .send-button,
  .mic-button {
    border-radius: 999px;
    border: none;
    padding: 0 18px;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    white-space: nowrap;
  }
  .send-button {
    background: radial-gradient(circle at top left, #facc15, #f97316);
    color: #111827;
    box-shadow:
      0 12px 24px rgba(248, 184, 75, 0.85),
      0 0 0 1px rgba(251, 191, 36, 0.9);
  }
  .mic-button {
    background: radial-gradient(circle at top left, #0ea5e9, #4f46e5);
    color: #e0f2fe;
    box-shadow:
      0 12px 24px rgba(56, 189, 248, 0.7),
      0 0 0 1px rgba(191, 219, 254, 0.7);
    font-size: 18px;
    padding: 0 14px;
  }
  .mic-button.active {
    box-shadow:
      0 0 0 1px rgba(96, 165, 250, 0.95),
      0 0 22px rgba(56, 189, 248, 1);
  }

  .status-line {
    margin-top: 6px;
    font-size: 11px;
    color: rgba(148, 163, 184, 0.96);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .status-dot {
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: radial-gradient(circle at center, #22c55e, #15803d);
    box-shadow: 0 0 10px rgba(34, 197, 94, 0.95);
    transform: translateY(-0.5px);
  }

  .voice-row {
    margin-top: 6px;
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: rgba(226, 232, 240, 0.96);
  }
  .voice-toggle {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .voice-toggle input {
    accent-color: #facc15;
  }
  .voice-pill {
    border-radius: 999px;
    padding: 3px 8px;
    border: 1px solid rgba(251, 191, 36, 0.75);
    background: radial-gradient(circle at top, rgba(250, 204, 21, 0.85), rgba(15, 23, 42, 0.95));
    color: #111827;
    font-weight: 600;
    font-size: 11px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  /* FOOTER */
  .footer-row {
    margin-top: 10px;
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: center;
    font-size: 11px;
    color: rgba(148, 163, 184, 0.95);
  }
  .footer-left {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .footer-left strong {
    font-weight: 600;
    color: rgba(229, 231, 235, 0.96);
  }
  .footer-right {
    font-size: 10px;
    color: rgba(148, 163, 184, 0.9);
    text-align: right;
  }
  .footer-right a {
    color: #a5b4fc;
    text-decoration: none;
  }

  @media (max-width: 720px) {
    .shell {
      padding: 20px 16px;
      border-radius: 24px;
    }
    #app {
      padding: 18px 10px 26px;
    }
    .banner-title-sub {
      font-size: 18px;
    }
    .panel {
      padding: 12px 12px 14px;
    }
    .chat-container {
      margin-top: 8px;
    }
  }
</style>
</head>
<body>
  <div id="app">
    <div class="shell">
      
      <!-- HEADER -->
      <div class="banner-header">
        <div class="banner-avatar">E</div>
        <div class="banner-title">
          <div class="banner-title-main" id="i-banner-main">
            ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP
          </div>
          <div class="banner-title-sub" id="i-banner-sub">
            Entrenamiento ejecutivo en IA aplicada
          </div>
        </div>
      </div>

      <div class="banner-description" id="i-banner-desc">
        Esteborg IA es tu copiloto ejecutivo de inteligencia artificial. Aqu√≠ dise√±amos tu plan estrat√©gico, optimizamos tu negocio y entrenamos tus habilidades ejecutivas con IA.
      </div>

      <!-- PANEL PRINCIPAL -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title" id="i-panel-title">
            Inicio del entrenamiento ¬∑ Copiloto Ejecutivo IA
          </div>
          <div class="panel-badge">
            <span class="dot"></span>
            <span>Members VIP</span>
          </div>
        </div>

        <!-- CHIPS: INTENCIONES -->
        <div class="chips-row">
          <span class="chips-label" id="i-chips-label">Quiero empezar:</span>

          <button
            class="chip-btn starter"
            id="i-btn-automation"
            data-text="Quiero usar IA para automatizar tareas repetitivas del d√≠a a d√≠a."
          >
            Automatizar tareas
          </button>

          <button
            class="chip-btn starter"
            id="i-btn-decisions"
            data-text="Quiero que la IA me ayude a tomar mejores decisiones ejecutivas."
          >
            Decisiones ejecutivas
          </button>

          <button
            class="chip-btn starter"
            id="i-btn-business"
            data-text="Quiero lanzar una nueva l√≠nea de negocio apalancando IA generativa."
          >
            Nueva l√≠nea de negocio
          </button>

          <button
            class="chip-btn starter"
            id="i-btn-master"
            data-text="Quiero dominar ChatGPT y otras IA en mi trabajo diario."
          >
            Dominar IA diaria
          </button>
        </div>

        <!-- CHIPS: CONTENIDO VISUAL -->
        <div class="content-row">
          <span class="content-label" id="i-content-label">Material:</span>
          <button
            class="content content-btn"
            id="i-btn-slides"
            data-text="Mu√©strame las diapositivas ejecutivas para este m√≥dulo de IA."
          >
            Diapositivas
          </button>
          <button
            class="content content-btn"
            id="i-btn-summary"
            data-text="Dame un resumen descargable del entrenamiento IA de hoy."
          >
            Resumen IA
          </button>
        </div>

        <!-- CHAT -->
        <div class="chat-container">
          <div class="chat-header-row">
            <div class="chat-header-left">
              <div class="chat-node">E</div>
              <div class="chat-title">
                <div id="i-chat-name">Esteborg IA</div>
                <small id="i-chat-role">Copiloto Ejecutivo IA</small>
              </div>
            </div>

            <div class="chat-language-pill">
              <span class="lang-option active" data-lang="es">ES</span>
              <span class="lang-option" data-lang="en">EN</span>
              <span class="lang-option" data-lang="pt">PT</span>
              <span class="lang-option" data-lang="fr">FR</span>
              <span class="lang-option" data-lang="it">IT</span>
              <span class="lang-option" data-lang="de">DE</span>
            </div>
          </div>

          <div id="chat-log"></div>

          <!-- INPUT -->
          <div class="input-row">
            <textarea
              id="user-input"
              placeholder="Cu√©ntame qu√© quieres lograr con IA en los pr√≥ximos 90 d√≠as..."
            ></textarea>

            <button id="mic-btn" class="mic-button" title="Hablar con voz">
              üéôÔ∏è
            </button>

            <button id="send-btn" class="send-button">ENVIAR</button>
          </div>

          <!-- STATUS -->
          <div class="status-line" id="status-line">
            <span class="status-dot"></span>
            <span>Preparando tu entrenamiento con Esteborg IA...</span>
          </div>

          <!-- VOZ -->
          <div class="voice-row">
            <label class="voice-toggle">
              <input type="checkbox" id="tts-toggle" />
              <span id="i-voice-toggle-label">Voz Esteborg IA activada</span>
            </label>
            <div class="voice-pill" id="i-voice-pill">üéß Voz Esteborg IA</div>
          </div>
        </div>

        <!-- FOOTER -->
        <div class="footer-row">
          <div class="footer-left">
            <strong id="i-footer-token-title">Tokken Esteborg Members</strong>
            <span id="i-footer-token-text">
              Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en:
              https://membersvip.esteborg.live/#miembrosvip
            </span>
          </div>
          <div class="footer-right">
            Propiedad de Esteban Manuel Gonz√°lez C√°rdenas ¬∑ Esteborg<br />
            <a href="https://esteborg.com" target="_blank" rel="noopener">esteborg.com</a>
          </div>
        </div>

      </div>
    </div>
  </div>

 <script>
(() => {
  // ================== CONFIG ==================
  const API_BASE = "https://esteborg88full-backend-modular.onrender.com";
  const API_URL = `${API_BASE}/api/modules/iavipcom`;
  const TTS_URL = `${API_BASE}/api/voice`;

  const TOKEN_STORAGE_KEY = "esteborg_token_members";

  // ================== I18N ==================
  const I18N = {
    es: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub: "Entrenamiento ejecutivo en IA aplicada para desplegar todo tu poder.",
      bannerDesc:
        "Esteborg IA es tu copiloto ejecutivo de inteligencia artificial. Aqu√≠ dise√±amos tu plan estrat√©gico, optimizamos tu negocio y entrenamos tus habilidades ejecutivas con IA.",
      panelTitle: "INICIO DEL ENTRENAMIENTO ¬∑ COPILOTO EJECUTIVO IA",

      chipsLabel: "Quiero empezar:",
      btnLesson: "Automatizar tareas",
      btnLessonText:
        "Quiero usar IA para automatizar tareas repetitivas de mi equipo.",
      btnEmotion: "Decisiones ejecutivas",
      btnEmotionText:
        "Quiero que la IA me ayude a tomar mejores decisiones ejecutivas.",
      btnChallenge: "Dominar IA diaria",
      btnChallengeText:
        "Quiero dominar IA en mi d√≠a a d√≠a y en mi trabajo ejecutivo.",

      contentLabel: "Material:",
      btnSlides: "Diapositivas",
      btnSlidesText:
        "Mu√©strame las diapositivas del entrenamiento ejecutivo en IA aplicada.",
      btnSummary: "Resumen IA",
      btnSummaryText:
        "Dame un resumen descargable con los puntos clave del entrenamiento en IA.",

      chatName: "Esteborg IA",
      chatRole: "Copiloto ejecutivo IA",
      inputPlaceholder:
        "Cu√©ntame qu√© quieres lograr con IA en los pr√≥ximos 90 d√≠as...",

      footerTokenTitle: "Tokken Esteborg Members",
      footerTokenText:
        "Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip",

      voiceToggleLabel: "Voz Esteborg IA activada",
      voicePillLabel: "üéß Voz Esteborg IA",

      sendButtonLabel: "ENVIAR",

      statusPreparing: "Preparando tu entrenamiento con Esteborg IA...",
      statusThinking: "Esteborg IA est√° pensando...",
      statusReady: "Listo para continuar con tu entrenamiento.",

      welcomeMessage:
        "¬°Qu√© gusto saludarte! üòä Antes de entrar a tu entrenamiento necesito tu Tokken Esteborg Members para validar tu acceso.\n\nPega aqu√≠ tu Tokken o haz tu primera pregunta y yo te gu√≠o.",
      tokenDetectedUrl:
        "Detect√© un Tokken en la URL. Lo usar√© autom√°ticamente en tu sesi√≥n.",
      tokenDetectedStored:
        "Detect√© un Tokken guardado. Lo usar√© autom√°ticamente en tu sesi√≥n.",
      tokenMissingHint:
        "A√∫n no detecto tu Tokken Esteborg Members. P√©galo en el chat cuando est√©s listo.",
      invalidToken:
        "Tu Tokken Esteborg Members parece inv√°lido o expirado.\n\nVe a https://membersvip.esteborg.live/#miembrosvip para generar uno nuevo y p√©galo aqu√≠.",

      errorGeneric:
        "Hubo un problema de conexi√≥n. Intenta de nuevo en unos segundos."
    },

    en: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub: "Executive training in Applied AI to unlock all your power.",
      bannerDesc:
        "Esteborg IA is your executive AI copilot. Here we design your strategic plan, optimize your business and train your executive skills with AI.",
      panelTitle: "TRAINING START ¬∑ EXECUTIVE AI COPILOT",

      chipsLabel: "I want to start with:",
      btnLesson: "Automate tasks",
      btnLessonText:
        "I want to use AI to automate repetitive tasks in my team.",
      btnEmotion: "Executive decisions",
      btnEmotionText:
        "I want AI to help me make better executive decisions.",
      btnChallenge: "Daily AI mastery",
      btnChallengeText:
        "I want to master AI in my daily work and executive role.",

      contentLabel: "Material:",
      btnSlides: "Slides",
      btnSlidesText:
        "Show me the slides for the executive training in Applied AI.",
      btnSummary: "AI Summary",
      btnSummaryText:
        "Give me a downloadable summary with the key points of this AI training.",

      chatName: "Esteborg IA",
      chatRole: "Executive AI copilot",
      inputPlaceholder:
        "Tell me what you want to achieve with AI in the next 90 days...",

      footerTokenTitle: "Tokken Esteborg Members",
      footerTokenText:
        "If you don't have a token yet, you can get or recover it at: https://membersvip.esteborg.live/#miembrosvip",

      voiceToggleLabel: "Esteborg IA voice enabled",
      voicePillLabel: "üéß Esteborg IA Voice",

      sendButtonLabel: "SEND",

      statusPreparing: "Preparing your training with Esteborg IA...",
      statusThinking: "Esteborg IA is thinking...",
      statusReady: "Ready to continue your training.",

      welcomeMessage:
        "Great to see you here! üòä Before we start your training I need your Esteborg Members Tokken to validate your access.\n\nPaste your Tokken here or ask your first question and I'll guide you.",
      tokenDetectedUrl:
        "I detected a Tokken in the URL. I'll use it automatically in your session.",
      tokenDetectedStored:
        "I detected a stored Tokken. I'll use it automatically in your session.",
      tokenMissingHint:
        "I haven't detected your Esteborg Members Tokken yet. Paste it in the chat when you're ready.",
      invalidToken:
        "Your Esteborg Members Tokken seems invalid or expired.\n\nGo to https://membersvip.esteborg.live/#miembrosvip to generate a new one and paste it here.",

      errorGeneric:
        "There was a connection problem. Please try again in a few seconds."
    }
  };

  function t(lang, key) {
    const pack = I18N[lang] || I18N.es;
    return pack[key] || (I18N.es[key] || "");
  }

  // ================== STATE ==================
  let currentLang = "es";
  let history = [];
  let isSending = false;
  let storedToken = null;
  let currentAudio = null;

  // ================== DOM HELPERS ==================
  const $ = (id) => document.getElementById(id);

  function getEls() {
    return {
      bannerMainEl: $("i-banner-main"),
      bannerSubEl: $("i-banner-sub"),
      bannerDescEl: $("i-banner-desc"),
      panelTitleEl: $("i-panel-title"),
      chipsLabelEl: $("i-chips-label"),
      contentLabelEl: $("i-content-label"),
      chatNameEl: $("i-chat-name"),
      chatRoleEl: $("i-chat-role"),
      inputEl: $("user-input"),
      sendBtn: $("send-btn"),
      micBtn: $("mic-btn"),
      statusLine: $("status-line"),
      chatLog: $("chat-log"),
      ttsToggle: $("tts-toggle"),
      voiceToggleLabel: $("i-voice-toggle-label"),
      voicePill: $("i-voice-pill"),
      footerTokenTitleEl: $("i-footer-token-title"),
      footerTokenTextEl: $("i-footer-token-text"),
      langOptions: document.querySelectorAll(".lang-option"),
      starterBtns: document.querySelectorAll(".chip-btn.starter"),
      contentBtns: document.querySelectorAll(".content-btn.content")
    };
  }

  const els = {};

  // ================== UI APPLY LANG ==================
  function applyUILanguage() {
    const s = (key) => t(currentLang, key);

    if (els.bannerMainEl) els.bannerMainEl.textContent = s("bannerMain");
    if (els.bannerSubEl) els.bannerSubEl.textContent = s("bannerSub");
    if (els.bannerDescEl) els.bannerDescEl.textContent = s("bannerDesc");
    if (els.panelTitleEl) els.panelTitleEl.textContent = s("panelTitle");

    if (els.chipsLabelEl) els.chipsLabelEl.textContent = s("chipsLabel");
    if (els.contentLabelEl) els.contentLabelEl.textContent = s("contentLabel");

    if (els.chatNameEl) els.chatNameEl.textContent = s("chatName");
    if (els.chatRoleEl) els.chatRoleEl.textContent = s("chatRole");

    if (els.inputEl)
      els.inputEl.placeholder = s("inputPlaceholder");

    if (els.footerTokenTitleEl)
      els.footerTokenTitleEl.textContent = s("footerTokenTitle");
    if (els.footerTokenTextEl)
      els.footerTokenTextEl.textContent = s("footerTokenText");

    if (els.voiceToggleLabel)
      els.voiceToggleLabel.textContent = s("voiceToggleLabel");
    if (els.voicePill)
      els.voicePill.textContent = s("voicePillLabel");

    if (els.sendBtn)
      els.sendBtn.textContent = s("sendButtonLabel");

    if (els.statusLine) {
      const spans = els.statusLine.querySelectorAll("span");
      if (spans.length > 1) {
        spans[1].textContent = s("statusPreparing");
      }
    }

    // Chips textos/data-text
    const lessonBtn = $("i-btn-lesson");
    const emotionBtn = $("i-btn-emotion");
    const challengeBtn = $("i-btn-challenge");
    const slidesBtn = $("i-btn-slides");
    const summaryBtn = $("i-btn-summary");

    if (lessonBtn) {
      lessonBtn.textContent = s("btnLesson");
      lessonBtn.dataset.text = s("btnLessonText");
    }
    if (emotionBtn) {
      emotionBtn.textContent = s("btnEmotion");
      emotionBtn.dataset.text = s("btnEmotionText");
    }
    if (challengeBtn) {
      challengeBtn.textContent = s("btnChallenge");
      challengeBtn.dataset.text = s("btnChallengeText");
    }
    if (slidesBtn) {
      slidesBtn.textContent = s("btnSlides");
      slidesBtn.dataset.text = s("btnSlidesText");
    }
    if (summaryBtn) {
      summaryBtn.textContent = s("btnSummary");
      summaryBtn.dataset.text = s("btnSummaryText");
    }
  }

  // ================== STATUS & MESSAGES ==================
  function setStatus(textKey) {
    if (!els.statusLine) return;
    const spans = els.statusLine.querySelectorAll("span");
    const txt = typeof textKey === "string" ? t(currentLang, textKey) : textKey;
    if (spans.length > 1) spans[1].textContent = txt;
    else els.statusLine.textContent = txt;
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function appendMessage(role, content) {
    if (!els.chatLog) return;

    const safe = escapeHtml(content || "");
    const row = document.createElement("div");
    row.className = "msg-row " + (role === "user" ? "user" : "assistant");

    const tag = document.createElement("div");
    tag.className = "msg-tag " + (role === "user" ? "user" : "assistant");
    tag.textContent = role === "user" ? "T√∫" : "Esteborg IA";

    const bubble = document.createElement("div");
    bubble.className = "msg-bubble";
    bubble.innerHTML = '<div class="msg-text">' + safe + "</div>";

    if (role === "user") {
      row.appendChild(bubble);
      row.appendChild(tag);
    } else {
      row.appendChild(tag);
      row.appendChild(bubble);
    }

    els.chatLog.appendChild(row);
    els.chatLog.scrollTop = els.chatLog.scrollHeight;
  }

  // ================== TOKKEN ==================
  function initToken() {
    let message = "";
    const s = (key) => t(currentLang, key);

    try {
      const params = new URLSearchParams(window.location.search);
      const urlToken =
        params.get("tokken") || params.get("token") || params.get("t");
      const localToken = localStorage.getItem(TOKEN_STORAGE_KEY);

      if (urlToken) {
        storedToken = urlToken.trim();
        localStorage.setItem(TOKEN_STORAGE_KEY, storedToken);
        message = s("tokenDetectedUrl");
      } else if (localToken) {
        storedToken = localToken.trim();
        message = s("tokenDetectedStored");
      } else {
        message = s("tokenMissingHint");
      }
    } catch (e) {
      console.warn("[Tokken] Error init:", e);
      message = s("tokenMissingHint");
    }

    // Abajo del chat, como mensaje del asistente
    appendMessage("assistant", message);
  }

  // ================== TTS ==================
  function stopTTS() {
    if (currentAudio) {
      try {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      } catch (_) {}
    }
  }

  async function playTTS(text) {
    if (!els.ttsToggle || !els.ttsToggle.checked) return;
    if (!text) return;

    try {
      const trimmed = text.length > 450 ? text.slice(0, 450) : text;

      const res = await fetch(TTS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: trimmed,
          voiceId: "IdhxxSTaAg80CTeSgScm"
        })
      });

      if (!res.ok) {
        console.error("[TTS] error", await res.text());
        return;
      }

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      stopTTS();
      currentAudio = new Audio(url);
      currentAudio.play().catch((err) => {
        console.warn("[TTS] no se pudo reproducir:", err);
      });
    } catch (e) {
      console.error("[TTS] error general:", e);
    }
  }

  // ================== BACKEND ==================
  async function sendToBackend(messageText) {
    const langForBackend = currentLang; // el backend ya sabe qu√© hacer con "es", "en", etc.
    const s = (key) => t(currentLang, key);

    const payload = {
      message: messageText,
      history,
      lang: langForBackend,
      token: storedToken || null
    };

    try {
      isSending = true;
      setStatus("statusThinking");

      const res = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...(storedToken ? { "x-esteborg-token": storedToken } : {})
        },
        body: JSON.stringify(payload)
      });

      if (res.status === 401) {
        appendMessage("assistant", s("invalidToken"));
        storedToken = null;
        localStorage.removeItem(TOKEN_STORAGE_KEY);
        isSending = false;
        setStatus("statusReady");
        return;
      }

      if (!res.ok) {
        console.error("[API] no OK", await res.text());
        appendMessage("assistant", s("errorGeneric"));
        isSending = false;
        setStatus("statusReady");
        return;
      }

      const data = await res.json();
      const reply =
        (data && (data.reply || data.message || data.response)) ||
        s("errorGeneric");

      history.push({ role: "user", content: messageText });
      history.push({ role: "assistant", content: reply });

      appendMessage("assistant", reply);
      playTTS(reply);
    } catch (e) {
      console.error("[API] error:", e);
      appendMessage("assistant", s("errorGeneric"));
    } finally {
      isSending = false;
      setStatus("statusReady");
    }
  }

  // ================== ENV√çO MENSAJE ==================
  async function handleSend(fromText) {
    if (isSending) return;
    const text =
      (fromText != null ? fromText : (els.inputEl && els.inputEl.value)) || "";
    const trimmed = text.trim();
    if (!trimmed) return;

    appendMessage("user", trimmed);
    if (els.inputEl) els.inputEl.value = "";

    await sendToBackend(trimmed);
  }

  // ================== EVENTOS ==================
  function wireEvents() {
    // Bot√≥n enviar
    if (els.sendBtn) {
      els.sendBtn.addEventListener("click", () => handleSend());
    }

    // Enter en textarea
    if (els.inputEl) {
      els.inputEl.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" && !ev.shiftKey) {
          ev.preventDefault();
          handleSend();
        }
      });
    }

    // Chips de inicio
    if (els.starterBtns) {
      els.starterBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const txt = btn.dataset.text || btn.textContent || "";
          handleSend(txt);
        });
      });
    }

    // Chips de contenido
    if (els.contentBtns) {
      els.contentBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const txt = btn.dataset.text || btn.textContent || "";
          handleSend(txt);
        });
      });
    }

    // Idiomas
    if (els.langOptions && els.langOptions.length) {
      els.langOptions.forEach((opt) => {
        opt.addEventListener("click", () => {
          const lang = opt.dataset.lang;
          if (!lang || lang === currentLang) return;

          currentLang = lang;

          els.langOptions.forEach((o) =>
            o.classList.toggle("active", o === opt)
          );

          applyUILanguage();
          // reiniciamos sesi√≥n con idioma nuevo
          startSession();
        });
      });
    }

    // Mic: por ahora s√≥lo placeholder visual (no rompemos nada)
    if (els.micBtn) {
      els.micBtn.addEventListener("click", () => {
        // Aqu√≠ luego podemos enganchar STT. Por ahora solo un peque√±o feedback visual.
        els.micBtn.classList.add("active");
        setTimeout(() => els.micBtn.classList.remove("active"), 200);
      });
    }
  }

  // ================== SESI√ìN ==================
  function startSession() {
    if (els.chatLog) els.chatLog.innerHTML = "";
    history = [];
    stopTTS();

    const welcome = t(currentLang, "welcomeMessage");
    appendMessage("assistant", welcome);
    playTTS(welcome);

    initToken();
    setStatus("statusPreparing");
  }

  // ================== INIT ==================
  window.addEventListener("DOMContentLoaded", () => {
    Object.assign(els, getEls());
    applyUILanguage();
    wireEvents();
    startSession();
  });
})();
</script>

</body>
</html>
