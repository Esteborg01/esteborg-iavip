<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Esteborg IA - Despliega todo tu poder</title>

  <style>
    :root {
      --bg-main: #050509;
      --accent: #f1ca63;
      --accent-strong: #f6e29e;
      --accent-alt: #8fd8ff;
      --text-main: #f5f5ff;
      --text-soft: #c3c3d8;
      --text-dim: #7e7e9c;
      --border-subtle: #25253a;
      --card-bg: #0b0b16;
      --card-inner: #10101d;
      --radius-lg: 20px;
      --radius-pill: 999px;
      --danger: #ff6b6b;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      height: 100%;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Inter", sans-serif;
      background: radial-gradient(circle at top, #28224b 0, #050509 55%, #020208 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px 12px 40px;
      overflow: hidden; /* <- solo la conversaci√≥n scrollea */
    }

    .app {
      width: 100%;
      max-width: 960px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .hero {
      text-align: center;
      margin-bottom: 12px;
      flex-shrink: 0;
    }

    .hero-logo {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .hero-logo-mark {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #f8e089 0, #f1c967 18%, #8c46ff 52%, #32127b 90%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.8),
        0 10px 30px rgba(0, 0, 0, 0.75);
    }

    .hero-logo-mark svg {
      width: 22px;
      height: 22px;
    }

    .hero-logo-text {
      font-size: 0.95rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-weight: 650;
    }

    .hero-logo-text span {
      color: var(--accent-strong);
    }

    .hero-title {
      font-size: clamp(1.4rem, 2.2vw, 1.7rem);
      line-height: 1.35;
      margin: 0 0 6px;
      font-weight: 640;
    }

    .hero-title span {
      color: var(--accent-strong);
    }

    .hero-sub {
      font-size: 0.9rem;
      color: var(--text-soft);
      max-width: 540px;
      margin: 0 auto;
    }

    .hero-sub strong {
      color: var(--accent-strong);
    }

    .chat-card {
      margin-top: 8px;
      border-radius: 24px;
      background: radial-gradient(circle at top left, #262042 0, #050509 60%);
      border: 1px solid rgba(140, 139, 196, 0.55);
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.8);
      padding: 16px;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    @media (min-width: 900px) {
      .chat-card {
        padding: 18px 18px 16px;
      }
    }

    .chat-inner {
      border-radius: 18px;
      background: linear-gradient(145deg, #0c0c19, #090915);
      border: 1px solid rgba(111, 111, 180, 0.6);
      padding: 14px 14px 12px;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
      flex-shrink: 0;
    }

    .chat-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chat-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .chat-subtitle {
      font-size: 0.78rem;
      color: var(--text-dim);
    }

    .chat-header-right {
      font-size: 0.7rem;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dot-live {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent-strong);
      box-shadow: 0 0 0 4px rgba(241, 202, 99, 0.28);
    }

    /* Selector de idioma */

    .lang-pill-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(140, 139, 196, 0.7);
      background: rgba(8, 8, 20, 0.9);
    }

    .lang-pill-wrapper .lang-icon {
      font-size: 0.9rem;
    }

    .lang-pill-group {
      display: inline-flex;
      gap: 4px;
    }

    .lang-pill {
      border-radius: 999px;
      border: 1px solid rgba(140, 139, 196, 0.4);
      background: transparent;
      color: var(--text-soft);
      padding: 4px 10px;
      font-size: 0.68rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .lang-pill:hover {
      border-color: rgba(241, 202, 99, 0.9);
      color: var(--accent-strong);
    }

    .lang-pill.active {
      background: radial-gradient(circle at 30% 0, #3c73ff, #182b5c);
      border-color: rgba(135, 170, 255, 0.95);
      color: #fff;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.7),
        0 0 12px rgba(60, 115, 255, 0.7);
    }

    /* Starters */

    .starter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      margin-top: 2px;
      font-size: 0.7rem;
    }

    .starter-label {
      color: var(--text-dim);
      margin-right: 4px;
      flex-basis: 100%;
    }

    .starter-pill {
      border-radius: 999px;
      border: 1px solid rgba(140, 139, 196, 0.5);
      background: rgba(9, 10, 22, 0.96);
      color: var(--text-soft);
      padding: 4px 10px;
      font-size: 0.72rem;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .starter-pill:hover {
      border-color: var(--accent-strong);
      color: var(--accent-strong);
      background: rgba(19, 22, 60, 0.96);
    }

    /* Chat box */

    .chat-box {
      border-radius: 12px;
      padding: 10px 9px;
      background: radial-gradient(circle at top, rgba(32, 32, 64, 0.9) 0, rgba(8, 9, 20, 0.98) 42%);
      border: 1px solid rgba(84, 84, 133, 0.8);
      box-shadow:
        inset 0 0 0 1px rgba(5, 5, 12, 0.8),
        0 14px 40px rgba(0, 0, 0, 0.75);
      scroll-behavior: smooth;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
    }

    .chat-box::-webkit-scrollbar {
      width: 6px;
    }

    .chat-box::-webkit-scrollbar-thumb {
      background: rgba(110, 110, 160, 0.7);
      border-radius: 999px;
    }

    .msg-row {
      display: flex;
      margin-bottom: 8px;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .bubble {
      max-width: 80%;
      padding: 7px 9px 7px;
      border-radius: 13px;
      font-size: 0.8rem;
      line-height: 1.45;
      border: 1px solid transparent;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.65);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .bubble-user {
      background: linear-gradient(135deg, #f1ca63, #f6e29e);
      color: #1c1407;
      border-color: rgba(115, 85, 34, 0.52);
    }

    .bubble-ai {
      background: radial-gradient(circle at top left, rgba(17, 18, 32, 0.98), rgba(11, 12, 24, 0.98));
      color: var(--text-main);
      border-color: rgba(135, 134, 202, 0.62);
    }

    .bubble-ai a {
      color: var(--accent-alt);
      text-decoration: none;
      border-bottom: 1px dotted rgba(143, 216, 210, 0.7);
    }

    .bubble-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      margin-bottom: 3px;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .bubble-label-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .bubble-meta {
      font-size: 0.66rem;
      color: var(--text-dim);
      margin-top: 2px;
      text-align: right;
    }

    /* Input + botones */

    .input-row {
      display: flex;
      align-items: stretch;
      gap: 8px;
      margin-top: 9px;
      flex-shrink: 0;
    }

    .input-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      align-items: center;
    }

    #userMsg {
      width: 100%;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(124, 124, 180, 0.65);
      background: radial-gradient(circle at top left, rgba(26, 26, 52, 0.9), rgba(8, 9, 20, 0.98));
      color: var(--text-main);
      padding: 8px 38px 8px 12px; /* espacio para mic */
      font-size: 0.8rem;
      outline: none;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.7),
        0 10px 25px rgba(0, 0, 0, 0.75);
    }

    #userMsg::placeholder {
      color: rgba(159, 159, 210, 0.72);
    }

    .mic-btn {
      position: absolute;
      right: 8px;
      width: 24px;
      height: 24px;
      border-radius: 999px;
      border: 1px solid rgba(140, 139, 196, 0.7);
      background: rgba(12, 12, 32, 0.96);
      color: var(--text-soft);
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }

    .mic-btn.listening {
      border-color: var(--accent-strong);
      color: var(--accent-strong);
      box-shadow: 0 0 0 4px rgba(241, 202, 99, 0.25);
      background: radial-gradient(circle at 30% 0, #30224f, #12091f);
    }

    #sendBtn {
      border-radius: var(--radius-pill);
      border: none;
      padding: 0 14px;
      font-size: 0.8rem;
      font-weight: 560;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #f1ca63, #f6e29e);
      color: #21140a;
      cursor: pointer;
      min-width: 130px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow:
        0 8px 22px rgba(0, 0, 0, 0.75),
        0 0 0 1px rgba(0, 0, 0, 0.7);
    }

    #sendBtn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 0.72rem;
      color: var(--text-dim);
      gap: 8px;
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    #demoStatus {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-strong);
      box-shadow: 0 0 0 4px rgba(241, 202, 99, 0.28);
    }

    .status-dot.ended {
      background: var(--danger);
      box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.3);
    }

    .token-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      color: var(--text-dim);
    }

    .token-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #39d98a;
      box-shadow: 0 0 0 4px rgba(57, 217, 138, 0.25);
    }

    .demo-note {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--text-dim);
      flex-shrink: 0;
    }

    .demo-note a {
      color: var(--accent-strong);
      text-decoration: none;
    }

    /* Voz Esteborg */

    .voice-toggle {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      font-size: 0.72rem;
    }

    .voice-pill {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(140, 139, 196, 0.7);
      background: rgba(9, 9, 24, 0.96);
      color: var(--text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .voice-pill.active {
      border-color: var(--accent-strong);
      color: var(--accent-strong);
      box-shadow: 0 0 0 3px rgba(241, 202, 99, 0.25);
      background: radial-gradient(circle at 30% 0, #352654, #120a1f);
    }

    .voice-pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-strong);
    }

    @media (max-width: 720px) {
      body {
        padding: 16px 8px 28px;
      }

      .chat-card {
        margin-top: 10px;
      }

      .status-row {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="hero">
      <div class="hero-logo">
        <div class="hero-logo-mark">
          <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="gradHero" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#f9e6a9"/>
                <stop offset="35%" stop-color="#f1c45d"/>
                <stop offset="70%" stop-color="#b37cff"/>
                <stop offset="100%" stop-color="#2c0f63"/>
              </linearGradient>
            </defs>
            <circle cx="20" cy="20" r="18" fill="url(#gradHero)" />
            <path d="M14 10c3.5 0 6 3.2 6 7.5S17.5 25 14 25 8 21.8 8 17.5 10.5 10 14 10Z" fill="rgba(12,8,24,0.96)"/>
            <path d="M26 13c2.4 0 4.2 1.9 4.2 4.5S28.4 22 26 22s-4.2-1.9-4.2-4.5S23.6 13 26 13Z" fill="rgba(12,8,24,0.96)"/>
            <path d="M18 13h3.5M18 16h3.5M18 19h3.5M18 22h3.5" stroke="#f9e6a9" stroke-width="1.2" stroke-linecap="round" />
          </svg>
        </div>
        <div class="hero-logo-text">ESTEBORG <span>EXECUTIVE</span></div>
      </div>

      <h1 class="hero-title" id="heroTitle"></h1>
      <p class="hero-sub" id="heroSub"></p>
    </header>

    <main class="chat-card">
      <div class="chat-inner">
        <div class="chat-header">
          <div class="chat-header-left">
            <div class="chat-title" id="chatTitle"></div>
            <div class="chat-subtitle" id="chatSubtitle"></div>
          </div>
          <div class="chat-header-right">
            <span class="dot-live"></span>
            <span id="chatModeLabel">Demo guiada</span>

            <div class="lang-pill-wrapper">
              <span class="lang-icon">üåê</span>
              <div class="lang-pill-group" id="langPills">
                <button class="lang-pill active" type="button" data-lang="es">ES</button>
                <button class="lang-pill" type="button" data-lang="en">EN</button>
                <button class="lang-pill" type="button" data-lang="pt">PT</button>
                <button class="lang-pill" type="button" data-lang="fr">FR</button>
                <button class="lang-pill" type="button" data-lang="it">IT</button>
                <button class="lang-pill" type="button" data-lang="de">DE</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Starters -->
        <div class="starter-row" id="starterRow">
          <span class="starter-label" id="starterLabel"></span>
          <!-- pills din√°micos -->
        </div>

        <div id="chatBox" class="chat-box"></div>

        <div class="input-row">
          <div class="input-wrapper">
            <input
              id="userMsg"
              type="text"
              placeholder="Escribe aqu√≠ lo que quieres lograr con IA..."
              autocomplete="off"
            />
            <button id="micBtn" type="button" class="mic-btn" aria-label="Hablar con Esteborg IA">
              üéôÔ∏è
            </button>
          </div>

          <button id="sendBtn" type="button">
            <span>Enviar a Esteborg IA</span>
          </button>
        </div>

        <div class="status-row">
          <div id="demoStatus">
            <span class="status-dot"></span>
            <span>Demo activa ¬∑ primeras interacciones</span>
          </div>

          <div class="voice-toggle">
            <button id="voiceToggle" type="button" class="voice-pill">
              <span class="voice-pill-dot"></span>
              <span id="voiceLabel">Voz Esteborg</span>
            </button>
          </div>

          <div class="token-status" id="tokenStatus"></div>
        </div>

        <p class="demo-note" id="demoNote">
          Tokken Esteborg Members ¬∑ Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en:
          <a href="https://membersvip.esteborg.live/#miembrosvip" target="_blank" rel="noopener noreferrer">
            https://membersvip.esteborg.live/#miembrosvip
          </a>
        </p>
      </div>
    </main>
  </div>

  <script>
    const doc = document;

    const chatBox = doc.getElementById("chatBox");
    const userMsgInput = doc.getElementById("userMsg");
    const sendBtn = doc.getElementById("sendBtn");
    const demoStatusEl = doc.getElementById("demoStatus");
    const heroTitleEl = doc.getElementById("heroTitle");
    const heroSubEl = doc.getElementById("heroSub");
    const chatTitleEl = doc.getElementById("chatTitle");
    const chatSubtitleEl = doc.getElementById("chatSubtitle");
    const chatModeLabelEl = doc.getElementById("chatModeLabel");
    const demoNoteEl = doc.getElementById("demoNote");
    const langPillContainer = doc.getElementById("langPills");
    const starterRowEl = doc.getElementById("starterRow");
    const starterLabelEl = doc.getElementById("starterLabel");
    const tokenStatusEl = doc.getElementById("tokenStatus");
    const micBtn = doc.getElementById("micBtn");
    const voiceToggleBtn = doc.getElementById("voiceToggle");
    const voiceLabelEl = doc.getElementById("voiceLabel");

    // ==== BACKEND MODULAR ====
    const API_BASE = "https://esteborg88full-backend-modular.onrender.com";
    const API_URL = `${API_BASE}/api/modules/iavipcom`;

    let history = [];
    let isSending = false;
    let demoEnded = false;
    let userName = null;
    // 1 = pido Tokken, 2 = pido nombre + objetivo IA, 3+ = backend
    let introStep = 1;
    let currentLang = "es";

    const MAX_DEMO_INTERACTIONS = 14;
    let demoInteractionCount = 0;

    let storedToken = null;
    let voiceEnabled = false;

    // ==== Diccionario multiidioma UI ====
    const UI_STRINGS = {
      es: {
        heroTitleHTML:
          "¬øListo para desplegar <strong>todo tu poder</strong> con IA?<br />" +
          '<span>Entrena con Esteborg IA Executive y domina la nueva era digital.</span>',
        heroSubHTML:
          "Programa acelerado de <strong>3 meses</strong>, 100% online, con certificaci√≥n " +
          "<strong>AI Executive &amp; Prompt Engineer</strong> by Esteborg Institute. " +
          "Acceso exclusivo mediante Tokken Esteborg Members.",
        chatTitle: "Esteborg IA ¬∑ Copiloto Ejecutivo",
        chatSubtitle:
          "Cu√©ntale a Esteborg IA qu√© quieres lograr con la Inteligencia Artificial en tu empresa o carrera. " +
          "Entre m√°s contexto le des, m√°s precisas ser√°n sus recomendaciones.",
        chatModeLabel: "Demo guiada",
        inputPlaceholder: "Pega tu Tokken o escribe aqu√≠...",
        sendLabel: "Enviar a Esteborg IA",
        demoStatusInitial: "Demo activa ¬∑ primeras interacciones",
        demoStatusFinal: "Demo finalizada ¬∑ entra a Members VIP para seguir",
        demoStatusLast: "Demo activa ¬∑ √∫ltimas {n} interacciones",
        demoStatusRemaining: "Demo activa ¬∑ {n} interacciones restantes",
        demoNoteHTML:
          "Tokken Esteborg Members ¬∑ Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en: " +
          '<a href="https://membersvip.esteborg.live/#miembrosvip" target="_blank" rel="noopener noreferrer">' +
          "https://membersvip.esteborg.live/#miembrosvip</a>.",
        initialAssistant:
          "¬°Qu√© gusto saludarte! üòä Antes de entrar a tu entrenamiento necesito tu Tokken Esteborg Members para validar tu acceso.\n\n" +
          "Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en:\n" +
          "https://membersvip.esteborg.live/#miembrosvip\n\n" +
          "Una vez que tengas tu Tokken, p√©galo aqu√≠ o accede desde tu panel Members VIP. " +
          "Despu√©s elige el idioma en la parte superior (ES, EN, PT, FR, IT, DE) y comenzamos.",
        initialAssistantMeta: "Acceso con Tokken",
        afterToken:
          "Perfecto, ya tengo tu Tokken registrado. Ahora dime primero tu nombre y, en una frase, " +
          "¬øqu√© quieres lograr con IA en estos pr√≥ximos 90 d√≠as?",
        afterTokenMeta: "Tokken validado",
        startersLabel: "Ideas para comenzar:",
        starters: [
          "Quiero usar IA para automatizar tareas repetitivas de mi equipo.",
          "Quiero que la IA me ayude a tomar mejores decisiones ejecutivas.",
          "Quiero lanzar una nueva l√≠nea de negocio apalancando IA generativa.",
          "Quiero dominar ChatGPT y otras IA para aplicarlas a mi trabajo diario."
        ],
        tokenDetectedUrl:
          "Detect√© un Tokken en la URL, lo usar√© autom√°ticamente en tu sesi√≥n.",
        tokenDetectedStored:
          "Tengo un Tokken Esteborg Members guardado, lo usar√© autom√°ticamente en tu sesi√≥n.",
        tokenMissingHint:
          "Pega tu Tokken Esteborg Members en el chat para comenzar.",
        voiceOnLabel: "Voz Esteborg activada",
        voiceOffLabel: "Voz Esteborg",
        micHint:
          "Toca el micr√≥fono, habla y despu√©s revisa el texto antes de enviarlo."
      },
      en: {
        heroTitleHTML:
          "Ready to unlock <strong>all your power</strong> with AI?<br />" +
          '<span>Train with Esteborg AI Executive and lead the new digital era.</span>',
        heroSubHTML:
          "Accelerated <strong>3-month</strong> online program with " +
          "<strong>AI Executive &amp; Prompt Engineer</strong> certification by Esteborg Institute. " +
          "Exclusive access via Esteborg Members Token.",
        chatTitle: "Esteborg AI ¬∑ Executive Copilot",
        chatSubtitle:
          "Tell Esteborg AI what you want to achieve with artificial intelligence in your company or career. " +
          "The more context you share, the sharper the recommendations.",
        chatModeLabel: "Guided demo",
        inputPlaceholder: "Paste your Token or type here...",
        sendLabel: "Send to Esteborg AI",
        demoStatusInitial: "Demo active ¬∑ first interactions",
        demoStatusFinal: "Demo finished ¬∑ go to Members VIP to continue",
        demoStatusLast: "Demo active ¬∑ last {n} interactions",
        demoStatusRemaining: "Demo active ¬∑ {n} interactions remaining",
        demoNoteHTML:
          "Esteborg Members Token ¬∑ If you don‚Äôt have it yet, you can get or recover it at: " +
          '<a href="https://membersvip.esteborg.live/#miembrosvip" target="_blank" rel="noopener noreferrer">' +
          "https://membersvip.esteborg.live/#miembrosvip</a>.",
        initialAssistant:
          "So glad to see you here! üòä Before we start your training I need your Esteborg Members Token to validate access.\n\n" +
          "If you don‚Äôt have a token yet, you can get or recover it at:\n" +
          "https://membersvip.esteborg.live/#miembrosvip\n\n" +
          "Once you have your Token, paste it here or access from your Members VIP panel. " +
          "Then choose your language at the top (ES, EN, PT, FR, IT, DE) and we‚Äôll begin.",
        initialAssistantMeta: "Token access",
        afterToken:
          "Great, I‚Äôve registered your Token. Now tell me your first name and, in one sentence, " +
          "what you want to achieve with AI in the next 90 days.",
        afterTokenMeta: "Token validated",
        startersLabel: "Ideas to start:",
        starters: [
          "Use AI to automate repetitive tasks in my team.",
          "Use AI to support my executive decision-making.",
          "Launch a new business line powered by generative AI.",
          "Master ChatGPT and other AIs to apply them in my daily work."
        ],
        tokenDetectedUrl:
          "I detected a Token in the URL. I‚Äôll use it automatically in your session.",
        tokenDetectedStored:
          "I found a stored Esteborg Members Token. I‚Äôll use it automatically in your session.",
        tokenMissingHint:
          "Paste your Esteborg Members Token in the chat to begin.",
        voiceOnLabel: "Esteborg voice on",
        voiceOffLabel: "Esteborg voice",
        micHint:
          "Tap the mic, speak, then review the text before sending."
      },
      pt: {
        heroTitleHTML:
          "Pronto para liberar <strong>todo o seu poder</strong> com IA?<br />" +
          '<span>Treine com Esteborg IA Executive e lidere a nova era digital.</span>',
        heroSubHTML:
          "Programa acelerado de <strong>3 meses</strong>, 100% online, com certifica√ß√£o " +
          "<strong>AI Executive &amp; Prompt Engineer</strong> pelo Esteborg Institute. " +
          "Acesso exclusivo via Token Esteborg Members.",
        chatTitle: "Esteborg IA ¬∑ Copiloto Executivo",
        chatSubtitle:
          "Conte ao Esteborg IA o que voc√™ quer alcan√ßar com intelig√™ncia artificial na sua empresa ou carreira. " +
          "Quanto mais contexto voc√™ der, mais precisas ser√£o as recomenda√ß√µes.",
        chatModeLabel: "Demo guiada",
        inputPlaceholder: "Cole seu Token ou escreva aqui...",
        sendLabel: "Enviar para Esteborg IA",
        demoStatusInitial: "Demo ativa ¬∑ primeiras intera√ß√µes",
        demoStatusFinal: "Demo finalizada ¬∑ entre em Members VIP para continuar",
        demoStatusLast: "Demo ativa ¬∑ √∫ltimas {n} intera√ß√µes",
        demoStatusRemaining: "Demo ativa ¬∑ {n} intera√ß√µes restantes",
        demoNoteHTML:
          "Token Esteborg Members ¬∑ Se voc√™ ainda n√£o tem, pode obt√™-lo ou recuper√°-lo em: " +
          '<a href="https://membersvip.esteborg.live/#miembrosvip" target="_blank" rel="noopener noreferrer">' +
          "https://membersvip.esteborg.live/#miembrosvip</a>.",
        initialAssistant:
          "Que bom falar com voc√™! üòä Antes de come√ßarmos o treinamento, preciso do seu Token Esteborg Members para validar o acesso.\n\n" +
          "Se ainda n√£o tem um token, voc√™ pode obt√™-lo ou recuper√°-lo em:\n" +
          "https://membersvip.esteborg.live/#miembrosvip\n\n" +
          "Quando tiver o Token, cole aqui ou acesse a partir do seu painel Members VIP. " +
          "Depois escolha o idioma na parte superior (ES, EN, PT, FR, IT, DE) e come√ßamos.",
        initialAssistantMeta: "Acesso com Token",
        afterToken:
          "Perfeito, j√° registrei o seu Token. Agora diga seu nome e, em uma frase, " +
          "o que voc√™ quer alcan√ßar com IA nos pr√≥ximos 90 dias.",
        afterTokenMeta: "Token validado",
        startersLabel: "Ideias para come√ßar:",
        starters: [
          "Quero usar IA para automatizar tarefas repetitivas da minha equipe.",
          "Quero que a IA me ajude a tomar melhores decis√µes executivas.",
          "Quero lan√ßar uma nova linha de neg√≥cios apoiada em IA generativa.",
          "Quero dominar o ChatGPT e outras IAs no meu trabalho di√°rio."
        ],
        tokenDetectedUrl:
          "Detectei um Token na URL, vou us√°-lo automaticamente na sua sess√£o.",
        tokenDetectedStored:
          "Encontrei um Token Esteborg Members salvo, vou us√°-lo automaticamente.",
        tokenMissingHint:
          "Cole seu Token Esteborg Members no chat para come√ßar.",
        voiceOnLabel: "Voz Esteborg ativada",
        voiceOffLabel: "Voz Esteborg",
        micHint:
          "Toque no microfone, fale e depois revise o texto antes de enviar."
      },
      fr: {
        heroTitleHTML:
          "Pr√™t √† d√©ployer <strong>tout ton pouvoir</strong> avec l‚ÄôIA ?<br />" +
          '<span>Forme-toi avec Esteborg IA Executive et m√®ne la nouvelle √®re digitale.</span>',
        heroSubHTML:
          "Programme acc√©l√©r√© de <strong>3 mois</strong>, 100 % en ligne, avec certification " +
          "<strong>AI Executive &amp; Prompt Engineer</strong> par l‚ÄôEsteborg Institute. " +
          "Acc√®s exclusif via Token Esteborg Members.",
        chatTitle: "Esteborg IA ¬∑ Copilote Ex√©cutif",
        chatSubtitle:
          "Explique √† Esteborg IA ce que tu veux accomplir avec l‚Äôintelligence artificielle dans ton entreprise ou ta carri√®re. " +
          "Plus tu donnes de contexte, plus les recommandations seront pr√©cises.",
        chatModeLabel: "D√©mo guid√©e",
        inputPlaceholder: "Colle ton Token ou √©cris ici...",
        sendLabel: "Envoyer √† Esteborg IA",
        demoStatusInitial: "D√©mo active ¬∑ premi√®res interactions",
        demoStatusFinal: "D√©mo termin√©e ¬∑ va sur Members VIP pour continuer",
        demoStatusLast: "D√©mo active ¬∑ derni√®res {n} interactions",
        demoStatusRemaining: "D√©mo active ¬∑ {n} interactions restantes",
        demoNoteHTML:
          "Token Esteborg Members ¬∑ Si tu ne l‚Äôas pas encore, tu peux l‚Äôobtenir ou le r√©cup√©rer sur : " +
          '<a href="https://membersvip.esteborg.live/#miembrosvip" target="_blank" rel="noopener noreferrer">' +
          "https://membersvip.esteborg.live/#miembrosvip</a>.",
        initialAssistant:
          "Ravi de te retrouver ! üòä Avant de commencer ton entra√Ænement, j‚Äôai besoin de ton Token Esteborg Members pour valider ton acc√®s.\n\n" +
          "Si tu n‚Äôas pas encore de token, tu peux l‚Äôobtenir ou le r√©cup√©rer ici :\n" +
          "https://membersvip.esteborg.live/#miembrosvip\n\n" +
          "Une fois que tu as ton Token, colle-le ici ou passe par ton espace Members VIP. " +
          "Ensuite, choisis la langue en haut (ES, EN, PT, FR, IT, DE) et on d√©marre.",
        initialAssistantMeta: "Acc√®s avec Token",
        afterToken:
          "Parfait, ton Token est enregistr√©. Maintenant dis-moi ton pr√©nom et, en une phrase, " +
          "ce que tu veux accomplir avec l‚ÄôIA dans les 90 prochains jours.",
        afterTokenMeta: "Token valid√©",
        startersLabel: "Id√©es pour d√©marrer :",
        starters: [
          "Utiliser l‚ÄôIA pour automatiser les t√¢ches r√©p√©titives de mon √©quipe.",
          "M‚Äôappuyer sur l‚ÄôIA pour prendre de meilleures d√©cisions ex√©cutives.",
          "Lancer une nouvelle activit√© port√©e par l‚ÄôIA g√©n√©rative.",
          "Ma√Ætriser ChatGPT et d‚Äôautres IA pour mon travail quotidien."
        ],
        tokenDetectedUrl:
          "J‚Äôai d√©tect√© un Token dans l‚ÄôURL, je vais l‚Äôutiliser automatiquement pour ta session.",
        tokenDetectedStored:
          "J‚Äôai trouv√© un Token Esteborg Members enregistr√©, je vais l‚Äôutiliser automatiquement.",
        tokenMissingHint:
          "Colle ton Token Esteborg Members dans le chat pour commencer.",
        voiceOnLabel: "Voix Esteborg activ√©e",
        voiceOffLabel: "Voix Esteborg",
        micHint:
          "Appuie sur le micro, parle, puis v√©rifie le texte avant d‚Äôenvoyer."
      },
      de: {
        heroTitleHTML:
          "Bereit, <strong>deine volle St√§rke</strong> mit KI zu entfalten?<br />" +
          '<span>Trainiere mit Esteborg AI Executive und f√ºhre die neue digitale √Ñra an.</span>',
        heroSubHTML:
          "Beschleunigtes <strong>3-Monats-Programm</strong>, komplett online, mit Zertifikat " +
          "<strong>AI Executive &amp; Prompt Engineer</strong> vom Esteborg Institute. " +
          "Exklusiver Zugang √ºber Esteborg Members Token.",
        chatTitle: "Esteborg AI ¬∑ Executive Copilot",
        chatSubtitle:
          "Erkl√§re Esteborg AI, was du mit k√ºnstlicher Intelligenz in deinem Unternehmen oder deiner Karriere erreichen m√∂chtest. " +
          "Je mehr Kontext du gibst, desto pr√§ziser werden die Empfehlungen.",
        chatModeLabel: "Gef√ºhrte Demo",
        inputPlaceholder: "F√ºge dein Token ein oder schreibe hier...",
        sendLabel: "An Esteborg AI senden",
        demoStatusInitial: "Demo aktiv ¬∑ erste Interaktionen",
        demoStatusFinal: "Demo beendet ¬∑ gehe zu Members VIP, um fortzufahren",
        demoStatusLast: "Demo aktiv ¬∑ letzte {n} Interaktionen",
        demoStatusRemaining: "Demo aktiv ¬∑ {n} Interaktionen verbleibend",
        demoNoteHTML:
          "Esteborg Members Token ¬∑ Wenn du noch keins hast, kannst du es hier erhalten oder wiederherstellen: " +
          '<a href="https://membersvip.esteborg.live/#miembrosvip" target="_blank" rel="noopener noreferrer">' +
          "https://membersvip.esteborg.live/#miembrosvip</a>.",
        initialAssistant:
          "Sch√∂n, dich hier zu sehen! üòä Bevor wir mit deinem Training beginnen, brauche ich dein Esteborg Members Token, um den Zugang zu best√§tigen.\n\n" +
          "Wenn du noch kein Token hast, kannst du es hier bekommen oder wiederherstellen:\n" +
          "https://membersvip.esteborg.live/#miembrosvip\n\n" +
          "Sobald du dein Token hast, f√ºge es hier ein oder gehe √ºber dein Members-VIP-Panel. " +
          "Danach w√§hle oben deine Sprache (ES, EN, PT, FR, IT, DE) und wir legen los.",
        initialAssistantMeta: "Token-Zugang",
        afterToken:
          "Super, ich habe dein Token gespeichert. Sag mir nun deinen Vornamen und in einem Satz, " +
          "was du in den n√§chsten 90 Tagen mit KI erreichen m√∂chtest.",
        afterTokenMeta: "Token best√§tigt",
        startersLabel: "Ideen f√ºr den Start:",
        starters: [
          "KI nutzen, um wiederkehrende Aufgaben in meinem Team zu automatisieren.",
          "KI einsetzen, um bessere Management-Entscheidungen zu treffen.",
          "Eine neue Gesch√§ftslinie mit generativer KI aufbauen.",
          "ChatGPT und andere KIs f√ºr meine t√§gliche Arbeit meistern."
        ],
        tokenDetectedUrl:
          "Ich habe ein Token in der URL erkannt und werde es automatisch in deiner Session verwenden.",
        tokenDetectedStored:
          "Ich habe ein gespeichertes Esteborg-Members-Token gefunden und werde es automatisch verwenden.",
        tokenMissingHint:
          "F√ºge dein Esteborg-Members-Token im Chat ein, um zu starten.",
        voiceOnLabel: "Esteborg-Stimme aktiv",
        voiceOffLabel: "Esteborg-Stimme",
        micHint:
          "Tippe auf das Mikrofon, sprich und pr√ºfe dann den Text vor dem Senden."
      },
      it: {
        heroTitleHTML:
          "Pronto a liberare <strong>tutto il tuo potere</strong> con l‚ÄôIA?<br />" +
          '<span>Allenati con Esteborg IA Executive e guida la nuova era digitale.</span>',
        heroSubHTML:
          "Programma accelerato di <strong>3 mesi</strong>, 100% online, con certificazione " +
          "<strong>AI Executive &amp; Prompt Engineer</strong> dell‚ÄôEsteborg Institute. " +
          "Accesso esclusivo tramite Token Esteborg Members.",
        chatTitle: "Esteborg IA ¬∑ Copilota Esecutivo",
        chatSubtitle:
          "Racconta a Esteborg IA cosa vuoi ottenere con l‚Äôintelligenza artificiale nel tuo lavoro o nella tua carriera. " +
          "Pi√π contesto dai, pi√π precise saranno le raccomandazioni.",
        chatModeLabel: "Demo guidata",
        inputPlaceholder: "Incolla il tuo Token o scrivi qui...",
        sendLabel: "Invia a Esteborg IA",
        demoStatusInitial: "Demo attiva ¬∑ prime interazioni",
        demoStatusFinal: "Demo terminata ¬∑ entra in Members VIP per continuare",
        demoStatusLast: "Demo attiva ¬∑ ultime {n} interazioni",
        demoStatusRemaining: "Demo attiva ¬∑ {n} interazioni rimanenti",
        demoNoteHTML:
          "Token Esteborg Members ¬∑ Se non lo hai ancora, puoi ottenerlo o recuperarlo su: " +
          '<a href="https://membersvip.esteborg.live/#miembrosvip" target="_blank" rel="noopener noreferrer">' +
          "https://membersvip.esteborg.live/#miembrosvip</a>.",
        initialAssistant:
          "Che piacere incontrarti! üòä Prima di iniziare il tuo allenamento ho bisogno del tuo Token Esteborg Members per convalidare l‚Äôaccesso.\n\n" +
          "Se non hai ancora un token, puoi ottenerlo o recuperarlo qui:\n" +
          "https://membersvip.esteborg.live/#miembrosvip\n\n" +
          "Quando hai il tuo Token, incollalo qui o accedi dal tuo pannello Members VIP. " +
          "Poi scegli la lingua in alto (ES, EN, PT, FR, IT, DE) e iniziamo.",
        initialAssistantMeta: "Accesso con Token",
        afterToken:
          "Perfetto, ho registrato il tuo Token. Ora dimmi il tuo nome e, in una frase, " +
          "cosa vuoi ottenere con l‚ÄôIA nei prossimi 90 giorni.",
        afterTokenMeta: "Token convalidato",
        startersLabel: "Idee per iniziare:",
        starters: [
          "Voglio usare l‚ÄôIA per automatizzare i compiti ripetitivi del mio team.",
          "Voglio che l‚ÄôIA mi aiuti a prendere decisioni esecutive migliori.",
          "Voglio lanciare una nuova linea di business basata sull‚ÄôIA generativa.",
          "Voglio padroneggiare ChatGPT e altre IA per il mio lavoro quotidiano."
        ],
        tokenDetectedUrl:
          "Ho rilevato un Token nell‚ÄôURL, lo user√≤ automaticamente nella tua sessione.",
        tokenDetectedStored:
          "Ho trovato un Token Esteborg Members salvato, lo user√≤ automaticamente.",
        tokenMissingHint:
          "Incolla il tuo Token Esteborg Members nella chat per iniziare.",
        voiceOnLabel: "Voce Esteborg attiva",
        voiceOffLabel: "Voce Esteborg",
        micHint:
          "Tocca il microfono, parla e poi controlla il testo prima di inviarlo."
      }
    };

    // Helpers

    function stripHtml(html) {
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || "";
    }

    function formatTextWithLinks(text) {
      if (!text) return "";
      const urlRegex =
        /(https?:\/\/[^\s]+)|(www\.[^\s]+)|(membersvip\.esteborg\.live[^\s]*)/gi;

      return text.replace(urlRegex, (match) => {
        let url = match;
        if (!/^https?:\/\//i.test(url)) {
          if (url.startsWith("www.")) {
            url = "https://" + url;
          } else if (url.startsWith("membersvip.esteborg.live")) {
            url = "https://" + url;
          }
        }
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${match}</a>`;
      });
    }

    function appendMessage(role, text, meta) {
      const row = doc.createElement("div");
      row.className = "msg-row " + (role === "user" ? "user" : "ai");

      const bubble = doc.createElement("div");
      bubble.className = "bubble " + (role === "user" ? "bubble-user" : "bubble-ai");

      const label = doc.createElement("div");
      label.className = "bubble-label";
      const dot = doc.createElement("span");
      dot.className = "bubble-label-dot";
      const who = doc.createElement("span");
      who.textContent = role === "user" ? (userName || "T√∫") : "Esteborg IA";

      label.appendChild(dot);
      label.appendChild(who);
      bubble.appendChild(label);

      const content = doc.createElement("div");
      if (role === "assistant") {
        content.innerHTML = formatTextWithLinks(text);
      } else {
        content.textContent = text;
      }
      bubble.appendChild(content);

      if (meta) {
        const metaDiv = doc.createElement("div");
        metaDiv.className = "bubble-meta";
        metaDiv.textContent = meta;
        bubble.appendChild(metaDiv);
      }

      row.appendChild(bubble);
      chatBox.appendChild(row);
      chatBox.scrollTop = chatBox.scrollHeight;

      // Voz Esteborg
      if (role === "assistant" && voiceEnabled && "speechSynthesis" in window) {
        const utter = new SpeechSynthesisUtterance(stripHtml(text));
        const lang = formatLangForBackend(currentLang);
        const map = {
          es: "es-MX",
          en: "en-US",
          pt: "pt-BR",
          fr: "fr-FR",
          de: "de-DE",
          it: "it-IT"
        };
        utter.lang = map[lang] || "es-MX";
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utter);
      }
    }

    function updateDemoStatus(text, ended) {
      if (!demoStatusEl) return;
      demoStatusEl.innerHTML = "";

      const dot = doc.createElement("span");
      dot.className = "status-dot";
      if (ended) dot.classList.add("ended");

      const label = doc.createElement("span");
      label.textContent = text;

      demoStatusEl.appendChild(dot);
      demoStatusEl.appendChild(label);
    }

    function setDemoStatus(status, remaining) {
      const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];

      if (status === "ended") {
        updateDemoStatus(strings.demoStatusFinal, true);
        demoEnded = true;
        sendBtn.disabled = true;
        userMsgInput.disabled = true;
        micBtn.disabled = true;
        return;
      }

      demoEnded = false;
      sendBtn.disabled = false;
      userMsgInput.disabled = false;
      micBtn.disabled = false;

      if (status === "initial" || typeof remaining !== "number") {
        updateDemoStatus(strings.demoStatusInitial, false);
        return;
      }

      if (remaining <= 0) {
        updateDemoStatus(strings.demoStatusFinal, true);
        demoEnded = true;
        sendBtn.disabled = true;
        userMsgInput.disabled = true;
        micBtn.disabled = true;
      } else if (remaining <= 3) {
        updateDemoStatus(
          strings.demoStatusLast.replace("{n}", String(remaining)),
          false
        );
      } else {
        updateDemoStatus(
          strings.demoStatusRemaining.replace("{n}", String(remaining)),
          false
        );
      }
    }

    function formatLangForBackend(lang) {
      const code = (lang || "").toLowerCase();
      if (["es", "en", "fr", "pt", "de", "it"].includes(code)) return code;
      return "es";
    }

    function setLoading(isLoading) {
      isSending = isLoading;
      sendBtn.disabled = isLoading || demoEnded;
      userMsgInput.disabled = demoEnded;
      micBtn.disabled = demoEnded;

      const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];
      sendBtn.textContent = isLoading ? "Pensando..." : strings.sendLabel;
    }

    function applyLanguageUI(lang) {
      const strings = UI_STRINGS[lang] || UI_STRINGS["es"];
      heroTitleEl.innerHTML = strings.heroTitleHTML;
      heroSubEl.innerHTML = strings.heroSubHTML;
      chatTitleEl.textContent = strings.chatTitle;
      chatSubtitleEl.textContent = strings.chatSubtitle;
      chatModeLabelEl.textContent = strings.chatModeLabel;
      userMsgInput.placeholder = strings.inputPlaceholder;
      demoNoteEl.innerHTML = strings.demoNoteHTML;
      voiceLabelEl.textContent = voiceEnabled
        ? strings.voiceOnLabel
        : strings.voiceOffLabel;

      // Starters UI
      starterRowEl.innerHTML = "";
      if (strings.starters && strings.starters.length) {
        const labelSpan = document.createElement("span");
        labelSpan.className = "starter-label";
        labelSpan.textContent = strings.startersLabel || "";
        starterRowEl.appendChild(labelSpan);

        strings.starters.forEach((s) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "starter-pill";
          btn.textContent = s;
          btn.addEventListener("click", () => {
            userMsgInput.value = s;
            userMsgInput.focus();
          });
          starterRowEl.appendChild(btn);
        });
      }

      setDemoStatus("initial");
      setLoading(false);
    }

    async function sendToBackend(messageText) {
      const langForBackend = formatLangForBackend(currentLang);
      const payload = {
        message: messageText,
        history,
        lang: langForBackend,
        userName,
        token: storedToken || null
      };

      try {
        setLoading(true);

        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(storedToken ? { "x-esteborg-token": storedToken } : {})
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error("Respuesta no OK del backend");
        }

        const data = await res.json();
        const reply =
          (data && (data.reply || data.message || data.response)) ||
          "No pude generar una respuesta en este momento. Intenta de nuevo.";

        history.push({ role: "user", content: messageText });
        history.push({ role: "assistant", content: reply });

        demoInteractionCount += 1;
        const remaining = MAX_DEMO_INTERACTIONS - demoInteractionCount;

        appendMessage("assistant", reply);
        setDemoStatus(remaining <= 0 ? "ended" : "remaining", remaining);
      } catch (err) {
        console.error("Error al llamar al backend:", err);
        appendMessage(
          "assistant",
          "Hubo un problema al conectar con Esteborg IA. Intenta de nuevo en unos momentos."
        );
      } finally {
        setLoading(false);
      }
    }

    function initTokenFromUrlOrStorage() {
      const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];
      let message = "";

      try {
        const params = new URLSearchParams(window.location.search);
        const urlToken =
          params.get("tokken") || params.get("token") || params.get("t");

        const localToken = localStorage.getItem("esteborg_token_members");

        if (urlToken) {
          storedToken = urlToken.trim();
          localStorage.setItem("esteborg_token_members", storedToken);
          message = strings.tokenDetectedUrl;
        } else if (localToken) {
          storedToken = localToken.trim();
          message = strings.tokenDetectedStored;
        } else {
          message = strings.tokenMissingHint;
        }
      } catch (e) {
        console.warn("Token init error", e);
      }

      if (tokenStatusEl) {
        tokenStatusEl.innerHTML = "";
        const dot = document.createElement("span");
        dot.className = "token-dot";
        const txt = document.createElement("span");
        txt.textContent = message;
        tokenStatusEl.appendChild(dot);
        tokenStatusEl.appendChild(txt);
      }
    }

    function initChat() {
      if (!chatBox) return;
      chatBox.innerHTML = "";
      history = [];
      demoEnded = false;
      introStep = 1;
      demoInteractionCount = 0;

      const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];
      applyLanguageUI(currentLang);
      appendMessage("assistant", strings.initialAssistant, strings.initialAssistantMeta);
      initTokenFromUrlOrStorage();
    }

    function handleUserMessage() {
      if (isSending || demoEnded) return;
      const text = (userMsgInput.value || "").trim();
      if (!text) return;

      const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];

      appendMessage("user", text);
      userMsgInput.value = "";

      // Paso 1: Tokken
      if (introStep === 1) {
        // Guardar Tokken (JWT base64 t√≠picamente empieza con eyJ...)
        storedToken = text.trim();
        try {
          localStorage.setItem("esteborg_token_members", storedToken);
        } catch (_) {}

        // Feedback UI
        if (tokenStatusEl) {
          tokenStatusEl.innerHTML = "";
          const dot = document.createElement("span");
          dot.className = "token-dot";
          const txt = document.createElement("span");
          txt.textContent = strings.tokenDetectedStored;
          tokenStatusEl.appendChild(dot);
          tokenStatusEl.appendChild(txt);
        }

        appendMessage("assistant", strings.afterToken, strings.afterTokenMeta);
        introStep = 2;
        return;
      }

      // Paso 2: nombre + objetivo IA (se manda al backend)
      if (introStep === 2) {
        userName = text.split(" ")[0] || text;
        introStep = 3;
        sendToBackend(text);
        return;
      }

      // Paso 3+: flujo normal
      sendToBackend(text);
    }

    // ==== Voz: mic (entrada) ====

    let recognition = null;
    let listening = false;

    function setupSpeechRecognition() {
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        micBtn.disabled = true;
        micBtn.title = "Tu navegador no soporta dictado por voz.";
        return;
      }

      recognition = new SpeechRecognition();
      recognition.lang = "es-MX";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.addEventListener("result", (event) => {
        const transcript = Array.from(event.results)
          .map((r) => r[0].transcript)
          .join(" ");
        userMsgInput.value = transcript;
        userMsgInput.focus();
      });

      recognition.addEventListener("end", () => {
        listening = false;
        micBtn.classList.remove("listening");
      });

      micBtn.addEventListener("click", () => {
        if (!recognition) return;
        if (listening) {
          recognition.stop();
          listening = false;
          micBtn.classList.remove("listening");
        } else {
          try {
            const lang = formatLangForBackend(currentLang);
            const map = {
              es: "es-MX",
              en: "en-US",
              pt: "pt-BR",
              fr: "fr-FR",
              de: "de-DE",
              it: "it-IT"
            };
            recognition.lang = map[lang] || "es-MX";
          } catch (_) {}
          recognition.start();
          listening = true;
          micBtn.classList.add("listening");
        }
      });

      const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];
      micBtn.title = strings.micHint;
    }

    // ==== Voz: salida (toggle) ====

    function setupVoiceToggle() {
      voiceToggleBtn.addEventListener("click", () => {
        voiceEnabled = !voiceEnabled;
        const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];
        voiceLabelEl.textContent = voiceEnabled
          ? strings.voiceOnLabel
          : strings.voiceOffLabel;
        voiceToggleBtn.classList.toggle("active", voiceEnabled);

        if (!voiceEnabled && "speechSynthesis" in window) {
          window.speechSynthesis.cancel();
        }
      });
    }

    // Idioma (pills)

    if (langPillContainer) {
      langPillContainer.addEventListener("click", (event) => {
        const btn = event.target.closest(".lang-pill");
        if (!btn) return;
        const lang = btn.dataset.lang;
        if (!lang || lang === currentLang) return;

        currentLang = lang;

        Array.from(langPillContainer.querySelectorAll(".lang-pill")).forEach((el) => {
          el.classList.toggle("active", el.dataset.lang === currentLang);
        });

        initChat();
      });
    }

    // Env√≠o

    if (sendBtn) {
      sendBtn.addEventListener("click", handleUserMessage);
    }

    if (userMsgInput) {
      userMsgInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          handleUserMessage();
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      initChat();
      setupSpeechRecognition();
      setupVoiceToggle();

      if (userMsgInput) {
        userMsgInput.focus();
      }
    });
  </script>
</body>
</html>
