<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Esteborg IA ¬∑ Entrenamiento ejecutivo en IA aplicada</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      height: 100%;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Inter", sans-serif;
      background: radial-gradient(circle at top, #28224b 0, #050509 55%, #020208 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px 8px 32px; /* antes 24px 12px 40px */
      overflow-y: auto;   /* deja que la p√°gina pueda scrollear si la tarjeta lo necesita */
      overflow-x: hidden;
    }

    #app {
      width: 100%;
      max-width: 960px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .shell {
      position: relative;
      border-radius: 32px;
      padding: 26px 26px 22px;
      background:
        radial-gradient(circle at top left, rgba(94, 234, 212, 0.06), transparent 55%),
        radial-gradient(circle at bottom right, rgba(251, 191, 36, 0.09), transparent 55%),
        rgba(3, 7, 18, 0.96);
      box-shadow:
        0 30px 90px rgba(0, 0, 0, 0.95),
        0 0 0 1px rgba(148, 163, 184, 0.28),
        0 0 32px rgba(56, 189, 248, 0.25);
      border: 1px solid rgba(75, 85, 99, 0.75);
      max-height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }

    .banner-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 10px;
    }
    .banner-avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #38bdf8, #4f46e5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 20px;
      color: #ecfeff;
      box-shadow:
        0 0 0 2px rgba(15, 23, 42, 1),
        0 0 0 1px rgba(226, 232, 240, 0.9),
        0 0 32px rgba(96, 165, 250, 0.95);
    }

    .banner-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .banner-title-main {
      font-size: 13px;
      letter-spacing: 0.19em;
      text-transform: uppercase;
      color: rgba(209, 213, 219, 0.96);
    }
    .banner-title-sub {
      font-size: 22px;
      font-weight: 650;
      letter-spacing: 0.02em;
      color: #e5e7eb;
    }

    .banner-description {
      margin-top: 4px;
      font-size: 13px;
      color: rgba(209, 213, 219, 0.92);
    }

    .panel {
      margin-top: 18px;
      border-radius: 22px;
      padding: 14px 16px 14px;
      background:
        linear-gradient(
          145deg,
          rgba(15, 23, 42, 0.96),
          rgba(15, 23, 42, 0.85)
        );
      border: 1px solid rgba(148, 163, 184, 0.8);
      box-shadow:
        inset 0 0 0 1px rgba(15, 23, 42, 0.96),
        0 18px 40px rgba(15, 23, 42, 0.95);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .panel-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: rgba(148, 163, 184, 0.95);
    }
    .panel-badge {
      border-radius: 999px;
      padding: 4px 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      border: 1px solid rgba(52, 211, 153, 0.6);
      color: #a7f3d0;
      background: radial-gradient(circle at top left, rgba(16, 185, 129, 0.35), rgba(15, 23, 42, 0.98));
    }
    .panel-badge .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle at center, #22c55e, #15803d);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.95);
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 11px;
      color: rgba(156, 163, 175, 0.95);
    }
    .chips-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(148, 163, 184, 0.98);
    }
    .chip-btn {
      border-radius: 999px;
      border: 1px solid rgba(129, 140, 248, 0.9);
      background: radial-gradient(circle at top, rgba(79, 70, 229, 0.95), rgba(30, 64, 175, 0.98));
      color: #e5e7eb;
      padding: 4px 11px;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow:
        0 10px 22px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(191, 219, 254, 0.35);
    }

    .content-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
    }
    .content-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(148, 163, 184, 0.98);
    }
    .content-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.86));
      color: rgba(209, 213, 219, 0.98);
      padding: 4px 10px;
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* CHAT */
    .chat-container {
      margin-top: 10px;
      border-radius: 20px;
      padding: 10px 10px 12px;
      background:
        radial-gradient(circle at top left, rgba(96, 165, 250, 0.07), transparent 55%),
        radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.09), transparent 55%),
        rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(55, 65, 81, 0.95);
      box-shadow:
        inset 0 0 0 1px rgba(15, 23, 42, 1),
        0 20px 42px rgba(15, 23, 42, 0.98);
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 2px 6px;
    }
    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chat-node {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid rgba(191, 219, 254, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: #e5e7eb;
      background: radial-gradient(circle at top, #4f46e5, #0ea5e9);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 0 18px rgba(129, 140, 248, 0.95);
    }
    .chat-title {
      display: flex;
      flex-direction: column;
      gap: 0;
      font-size: 11px;
      color: #e5e7eb;
    }
    .chat-title small {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: rgba(148, 163, 184, 0.95);
    }

    .chat-language-pill {
      display: inline-flex;
      align-items: center;
      flex-wrap: wrap;           /* üîπ permite que salten de l√≠nea si no caben */
      gap: 4px;
      border-radius: 999px;
      padding: 3px 7px;
      border: 1px solid rgba(248, 250, 252, 0.3);
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.9));
      font-size: 11px;
      color: rgba(229, 231, 235, 0.98);
    }
    .lang-option {
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      cursor: pointer;
    }
    .lang-option.active {
      border-color: rgba(96, 165, 250, 0.95);
      background: radial-gradient(circle at top, rgba(59, 130, 246, 0.9), rgba(15, 23, 42, 0.9));
    }

    /* CHAT BOX */
    #chat-log {
      margin-top: 8px;
      border-radius: 18px;
      background: rgba(5, 7, 18, 0.96);
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 12px;
      flex: 1;
      min-height: 180px;
      overflow-y: auto;

      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .msg-row {
      display: flex;
      align-items: flex-start;
      gap: 6px;
    }
    .msg-row.user { justify-content: flex-end; }
    .msg-tag {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 7px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      opacity: 0.9;
      white-space: nowrap;
    }
    .msg-tag.user {
      color: rgba(248, 250, 252, 0.96);
      border-color: rgba(248, 250, 252, 0.6);
    }
    .msg-tag.assistant {
      color: rgba(52, 211, 153, 0.96);
      border-color: rgba(52, 211, 153, 0.7);
    }
    .msg-bubble {
      max-width: 88%;
      padding: 8px 12px;
      border-radius: 14px;
      font-size: 15px;
      line-height: 1.5;
      border: 1px solid transparent;
    }
    .msg-row.user .msg-bubble {
      border-radius: 14px 14px 3px 14px;
      background: linear-gradient(135deg, #1d4ed8, #4c1d95);
      border-color: rgba(191, 219, 254, 0.4);
      color: #e5e7eb;
    }
    .msg-row.assistant .msg-bubble {
      border-radius: 14px 14px 14px 3px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.92));
      border-color: rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
    }
    .msg-text {
      white-space: pre-wrap;
    }
    .input-row {
      margin-top: 10px;
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto auto;
      gap: 8px;
      align-items: stretch;
    }
    .input-row textarea {
      resize: none;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.95);
      background: radial-gradient(circle at top, rgba(3, 7, 18, 0.98), rgba(3, 7, 18, 0.95));
      color: #e5e7eb;
      padding: 10px 14px;
      font-size: 12px;
      min-height: 44px;
      max-height: 84px;
      line-height: 1.4;
      outline: none;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 14px 24px rgba(15, 23, 42, 0.98);
    }
    .input-row textarea::placeholder {
      color: rgba(148, 163, 184, 0.95);
    }

    .send-button,
    .mic-button {
      border-radius: 999px;
      border: none;
      padding: 0 18px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }
    .send-button {
      background: radial-gradient(circle at top left, #facc15, #f97316);
      color: #111827;
      box-shadow:
        0 12px 24px rgba(248, 184, 75, 0.85),
        0 0 0 1px rgba(251, 191, 36, 0.9);
    }
    .mic-button {
      background: radial-gradient(circle at top left, #0ea5e9, #4f46e5);
      color: #e0f2fe;
      box-shadow:
        0 12px 24px rgba(56, 189, 248, 0.7),
        0 0 0 1px rgba(191, 219, 254, 0.7);
      font-size: 18px;
      padding: 0 14px;
    }
    .mic-button.active {
      box-shadow:
        0 0 0 1px rgba(96, 165, 250, 0.95),
        0 0 22px rgba(56, 189, 248, 1);
    }

    .status-line {
      margin-top: 6px;
      font-size: 11px;
      color: rgba(148, 163, 184, 0.96);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle at center, #22c55e, #15803d);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.95);
      transform: translateY(-0.5px);
    }

    .voice-row {
      margin-top: 6px;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: rgba(226, 232, 240, 0.96);
    }
    .voice-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .voice-toggle input {
      accent-color: #facc15;
    }
    .voice-pill {
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(251, 191, 36, 0.75);
      background: radial-gradient(circle at top, rgba(250, 204, 21, 0.85), rgba(15, 23, 42, 0.95));
      color: #111827;
      font-weight: 600;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* FOOTER */
    .footer-row {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      font-size: 11px;
      color: rgba(148, 163, 184, 0.95);
    }
    .footer-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .footer-left strong {
      font-weight: 600;
      color: rgba(229, 231, 235, 0.96);
    }
    .footer-right {
      font-size: 10px;
      color: rgba(148, 163, 184, 0.9);
      text-align: right;
    }
    .footer-right a {
      color: #a5b4fc;
      text-decoration: none;
    }

    /* üëâ Tablet / m√≥vil grande */
    @media (max-width: 720px) {
      /* layout general: que se vea a pantalla completa en embed Carrd */
      body {
        padding: 0;
        height: auto;
        min-height: 100vh;
        overflow-y: auto;
        align-items: stretch;
        justify-content: flex-start;
      }

      #app {
        padding: 18px 0 22px;
        width: 100%;
      }

      .shell {
        max-width: 100%;
        margin: 0;
        padding: 14px 12px 16px;
        border-radius: 0;
      }

      .banner-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .panel {
        margin-top: 14px;
        padding: 12px 12px 14px;
      }

      .chat-container {
        margin-top: 8px;
        -webkit-overflow-scrolling: touch;
      }

      #chat-log {
        min-height: 260px;
        max-height: none;
      }

      .footer-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .footer-right {
        text-align: left;
      }
    }

    /* üëâ M√≥vil chico (iPhone SE / Android peque√±o) */
    @media (max-width: 480px) {
      .banner-title-main {
        font-size: 11px;
      }

      .banner-title-sub {
        font-size: 18px;
      }

      .panel-title {
        font-size: 11px;
      }

      .panel-badge {
        font-size: 10px;
      }

      .chips-row,
      .content-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .input-row {
        flex-direction: column;
        align-items: stretch;
        display: flex;
      }

      .input-actions {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }

      .send-btn {
        flex: 1;
        justify-content: center;
      }

      .mic-btn {
        width: 32px;
        height: 32px;
      }

      #app {
        padding: 14px 0 18px;
      }

      .shell {
        padding: 12px 10px 14px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="shell">
      <div class="banner-header">
        <div class="banner-avatar">E</div>
        <div class="banner-title">
          <div class="banner-title-main" id="i-banner-main">
            ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP
          </div>
          <div class="banner-title-sub" id="i-banner-sub">
            Entrenamiento de Comunicaci√≥n con Inteligencia Emocional
          </div>
        </div>
      </div>
      <div class="banner-description" id="i-banner-desc">
        EsteborgCom7 es tu entrenador ejecutivo de comunicaci√≥n. Aqu√≠ trabajas
        situaciones reales, lecciones y retos dise√±ados para que tu mente sea tu ventaja.
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title" id="i-panel-title">
            Mini entrenamiento ¬∑ Comunicaci√≥n con EsteborgCom7
          </div>
          <div class="panel-badge">
            <span class="dot"></span>
            <span>Members VIP</span>
          </div>
        </div>

        <!-- CHIPS: SESI√ìN -->
        <div class="chips-row">
          <span class="chips-label" id="i-chips-label">Comenzar sesi√≥n:</span>
          <button
            class="chip-btn starter"
            id="i-btn-lesson"
            data-text="Quiero iniciar la Lecci√≥n 1 de comunicaci√≥n con inteligencia emocional."
          >
            Iniciar Lecci√≥n 1
          </button>
          <button
            class="chip-btn starter"
            id="i-btn-emotion"
            data-text="Quiero trabajar mi inteligencia emocional en una conversaci√≥n importante."
          >
            Inteligencia Emocional
          </button>
          <button
            class="chip-btn starter"
            id="i-btn-challenge"
            data-text="Dame un reto pr√°ctico de comunicaci√≥n para hoy."
          >
            Iniciar retos
          </button>
        </div>

        <!-- CHIPS: CONTENIDO VISUAL -->
        <div class="content-row">
          <span class="content-label" id="i-content-label">Contenido visual:</span>
          <button
            class="content content-btn"
            id="i-btn-slides"
            data-text="Mu√©strame las diapositivas de la sesi√≥n que acompa√±an este entrenamiento."
          >
            Diapositivas de la sesi√≥n
          </button>
          <button
            class="content content-btn"
            id="i-btn-summary"
            data-text="Dame un resumen descargable con los puntos clave de lo que trabajemos hoy."
          >
            Resumen descargable
          </button>
        </div>

        <!-- CHAT -->
        <div class="chat-container">
          <div class="chat-header-row">
            <div class="chat-header-left">
              <div class="chat-node">E</div>
              <div class="chat-title">
                <div id="i-chat-name">Esteborg</div>
                <small id="i-chat-role">Entrenador de comunicaci√≥n</small>
              </div>
            </div>
            <div class="chat-language-pill">
              <span class="lang-option active" data-lang="es">ES</span>
              <span class="lang-option" data-lang="en">EN</span>
              <span class="lang-option" data-lang="pt">PT</span>
              <span class="lang-option" data-lang="fr">FR</span>
              <span class="lang-option" data-lang="it">IT</span>
              <span class="lang-option" data-lang="de">DE</span>
            </div>
          </div>

          <div id="chat-log"></div>

          <div class="input-row">
            <textarea
              id="user-input"
              placeholder="Cu√©ntame una situaci√≥n real de comunicaci√≥n que quieras mejorar..."
            ></textarea>
            <button id="mic-btn" class="mic-button" title="Hablar con voz">
              üéôÔ∏è
            </button>
            <button id="send-btn" class="send-button">ENVIAR</button>
          </div>

          <div class="status-line" id="status-line">
            <span class="status-dot"></span>
            <span>Preparando tu sesi√≥n con EsteborgCom7...</span>
          </div>

          <div class="voice-row">
            <label class="voice-toggle">
              <input type="checkbox" id="tts-toggle" />
              <span id="i-voice-toggle-label">Voz Esteborg activada</span>
            </label>
            <div class="voice-pill" id="i-voice-pill">üéß Voz Esteborg</div>
          </div>
        </div>

        <div class="footer-row">
          <div class="footer-left">
            <strong id="i-footer-token-title">Tokken Esteborg Members</strong>
            <span id="i-footer-token-text">
              Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en:
              https://membersvip.esteborg.live/#miembrosvip
            </span>
          </div>
          <div class="footer-right">
            Propiedad de Esteban Manuel Gonz√°lez C√°rdenas ¬∑ Esteborg<br />
            <a href="https://esteborg.com" target="_blank" rel="noopener">esteborg.com</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIG ==========
    const API_BASE = "https://esteborg-iavipcom.onrender.com";
    const MODULE_PATH = "/api/modules/iavipcom";
    const TTS_URL = API_BASE + "/api/voice";

    // ========== I18N ==========
    const I18N = {
      es: {
        bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
        bannerSub: "Entrenamiento de Comunicaci√≥n con Inteligencia Emocional",
        bannerDesc:
          "EsteborgCom7 es tu entrenador ejecutivo de comunicaci√≥n... lecciones y retos dise√±ados para que tu mente sea tu ventaja.",
        panelTitle: "Mini entrenamiento ¬∑ Comunicaci√≥n con EsteborgCom7",
        chipsLabel: "Comenzar sesi√≥n:",
        btnLesson: "Iniciar Lecci√≥n 1",
        btnLessonText:
          "Quiero iniciar la Lecci√≥n 1 de comunicaci√≥n con inteligencia emocional.",
        btnEmotion: "Inteligencia Emocional",
        btnEmotionText:
          "Quiero trabajar mi inteligencia emocional en una conversaci√≥n importante.",
        btnChallenge: "Iniciar retos",
        btnChallengeText: "Dame un reto pr√°ctico de comunicaci√≥n para hoy.",
        contentLabel: "Contenido visual:",
        btnSlides: "Diapositivas de la sesi√≥n",
        btnSlidesText:
          "Mu√©strame las diapositivas de la sesi√≥n que acompa√±an este entrenamiento.",
        btnSummary: "Resumen descargable",
        btnSummaryText:
          "Dame un resumen descargable con los puntos clave de lo que trabajemos hoy.",
        inputPlaceholder:
          "Cu√©ntame una situaci√≥n real de comunicaci√≥n que quieras mejorar...",
        footerTokenTitle: "Tokken Esteborg Members",
        footerTokenText:
          "Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip",
        chatName: "Esteborg",
        chatRole: "Entrenador de comunicaci√≥n",
        voiceToggleLabel: "Voz Esteborg activada",
        voicePillLabel: "üéß Voz Esteborg",
        sendButtonLabel: "ENVIAR",
        statusInitialWithToken:
          "Detect√© un Tokken en la URL o guardado ¬∑ lo usar√© autom√°ticamente en tu sesi√≥n.",
        statusInitialNoToken:
          "Demo activa ¬∑ si generas tu Tokken VIP en Members, lo usar√© autom√°ticamente.",
        statusTokenManual:
          "Tokken pegado manualmente ¬∑ usar√© ese Tokken en tu sesi√≥n.",
        statusTokenValid: "Modo Members activo ¬∑ Tokken VIP v√°lido.",
        statusTokenInvalid:
          "Tokken inv√°lido o expirado ¬∑ usando modo demo. Genera uno nuevo en Members.",
        statusDemoEnded:
          "Demo finalizada ¬∑ renueva tu acceso para seguir con EsteborgCom7.",
        statusDemoActive:
          "Demo activa ¬∑ si generas tu Tokken VIP en Members, lo usar√© autom√°ticamente.",
        statusListening: "Escuchando... habla ahora.",
        statusProcessingSpeech: "Procesando lo que dijiste...",
        statusMicError:
          "Hubo un problema con el micr√≥fono, intenta de nuevo.",
        statusTextCaptured:
          "Texto capturado, puedes enviarlo o editarlo.",
        statusTTSOn: "Voz Esteborg activada.",
        statusTTSOff: "Voz Esteborg desactivada.",
        statusLangCurrent: "Idioma cambiado a espa√±ol.",
        tokenPasteReply:
          "Perfecto, ya tengo tu Tokken Esteborg Members ‚úÖ\nAhora dime: ¬øquieres que conversemos en \"espa√±ol\", \"ingl√©s\", \"portugu√©s\", \"franc√©s\", \"italiano\" o \"alem√°n\"?",
        tokenWelcomeMessage:
          "‚úÖ Tu Tokken Esteborg Members est√° validado.\nEst√°s en modo Members VIP, as√≠ que podemos trabajar tus situaciones reales de comunicaci√≥n con acceso completo.",
        welcomeMessage:
          "¬°Qu√© gusto saludarte! üòä Antes de entrar a tu entrenamiento necesito tu Tokken Esteborg Members para validar tu acceso.\n\n" +
          "Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip\n\n" +
          "Una vez que tengas tu Tokken, p√©galo aqu√≠ o accede desde tu panel Members VIP. Despu√©s elige el idioma en la parte superior (ES, EN, PT, FR, IT, DE) y comenzamos."
      },
      en: {
        bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
        bannerSub: "Communication Training with Emotional Intelligence",
        bannerDesc:
          "EsteborgCom7 is your executive communication coach. Here you work on real situations, lessons and challenges designed to make your mind your advantage.",
        panelTitle: "Mini Training ¬∑ Communication with EsteborgCom7",
        chipsLabel: "Start session:",
        btnLesson: "Start Lesson 1",
        btnLessonText:
          "I want to start Lesson 1 on communication with emotional intelligence.",
        btnEmotion: "Emotional intelligence",
        btnEmotionText:
          "I want to work on my emotional intelligence in an important conversation.",
        btnChallenge: "Start challenges",
        btnChallengeText:
          "Give me a practical communication challenge for today.",
        contentLabel: "Visual content:",
        btnSlides: "Session slides",
        btnSlidesText:
          "Show me the slides that support this training session.",
        btnSummary: "Downloadable summary",
        btnSummaryText:
          "Give me a downloadable summary with the key points from what we work on today.",
        inputPlaceholder:
          "Tell me a real communication situation you'd like to improve...",
        footerTokenTitle: "Esteborg Members Token",
        footerTokenText:
          "If you don‚Äôt have a token yet, you can get or recover it at: https://membersvip.esteborg.live/#miembrosvip",
        chatName: "Esteborg",
        chatRole: "Communication coach",
        voiceToggleLabel: "Esteborg voice enabled",
        voicePillLabel: "üéß Esteborg Voice",
        sendButtonLabel: "SEND",
        statusInitialWithToken:
          "I detected a token in the URL or stored locally ¬∑ I‚Äôll use it automatically in your session.",
        statusInitialNoToken:
          "Demo mode is active ¬∑ if you generate your VIP token in Members, I‚Äôll use it automatically.",
        statusTokenManual:
          "Token pasted manually ¬∑ I‚Äôll use that token in your session.",
        statusTokenValid: "Members mode active ¬∑ VIP token valid.",
        statusTokenInvalid:
          "Invalid or expired token ¬∑ using demo mode. Generate a new one in Members.",
        statusDemoEnded:
          "Demo finished ¬∑ renew your access to continue with EsteborgCom7.",
        statusDemoActive:
          "Demo mode active ¬∑ if you generate your VIP token in Members, I‚Äôll use it automatically.",
        statusListening: "Listening... you can speak now.",
        statusProcessingSpeech: "Processing what you said...",
        statusMicError:
          "There was a problem with the microphone, please try again.",
        statusTextCaptured:
          "Text captured, you can send or edit it.",
        statusTTSOn: "Esteborg voice enabled.",
        statusTTSOff: "Esteborg voice disabled.",
        statusLangCurrent: "Language set to English.",
        tokenPasteReply:
          "Perfect, I‚Äôve got your Esteborg Members Token ‚úÖ\nNow tell me: would you rather work in Spanish, English, Portuguese, French, Italian or German?",
        tokenWelcomeMessage:
          "‚úÖ Your Esteborg Members Token is validated.\nYou‚Äôre in Members VIP mode, so we can work on your real communication situations with full access.",
        welcomeMessage:
          "Great to have you here! üòä Before we start your training I need your Esteborg Members Token to validate your access.\n\n" +
          "If you don‚Äôt have a token yet, you can get or recover it at: https://membersvip.esteborg.live/#miembrosvip\n\n" +
          "Once you have your token, paste it here or access through your Members VIP panel. Then choose the language at the top (ES, EN, PT, FR, IT, DE) and we begin."
      },
      pt: {
        bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
        bannerSub: "Treinamento de Comunica√ß√£o com Intelig√™ncia Emocional",
        bannerDesc:
          "EsteborgCom7 √© o seu treinador executivo de comunica√ß√£o. Aqui voc√™ trabalha situa√ß√µes reais, li√ß√µes e desafios pensados para que sua mente seja a sua vantagem.",
        panelTitle: "Mini treinamento ¬∑ Comunica√ß√£o com EsteborgCom7",
        chipsLabel: "Iniciar sess√£o:",
        btnLesson: "Iniciar Li√ß√£o 1",
        btnLessonText:
          "Quero iniciar a Li√ß√£o 1 de comunica√ß√£o com intelig√™ncia emocional.",
        btnEmotion: "Intelig√™ncia emocional",
        btnEmotionText:
          "Quero trabalhar minha intelig√™ncia emocional em uma conversa importante.",
        btnChallenge: "Iniciar desafios",
        btnChallengeText:
          "Me d√™ um desafio pr√°tico de comunica√ß√£o para hoje.",
        contentLabel: "Conte√∫do visual:",
        btnSlides: "Slides da sess√£o",
        btnSlidesText:
          "Mostre-me os slides que acompanham este treinamento.",
        btnSummary: "Resumo para download",
        btnSummaryText:
          "Me d√™ um resumo para download com os pontos-chave do que trabalharmos hoje.",
        inputPlaceholder:
          "Me conte uma situa√ß√£o real de comunica√ß√£o que voc√™ deseja melhorar...",
        footerTokenTitle: "Token Esteborg Members",
        footerTokenText:
          "Se voc√™ ainda n√£o tem token, pode obt√™-lo ou recuper√°-lo em: https://membersvip.esteborg.live/#miembrosvip",
        chatName: "Esteborg",
        chatRole: "Treinador de comunica√ß√£o",
        voiceToggleLabel: "Voz Esteborg ativada",
        voicePillLabel: "üéß Voz Esteborg",
        sendButtonLabel: "ENVIAR",
        statusInitialWithToken:
          "Detectei um token na URL ou salvo localmente ¬∑ vou us√°-lo automaticamente na sua sess√£o.",
        statusInitialNoToken:
          "Modo demonstra√ß√£o ativo ¬∑ se voc√™ gerar seu token VIP em Members, vou us√°-lo automaticamente.",
        statusTokenManual:
          "Token colado manualmente ¬∑ vou usar esse token na sua sess√£o.",
        statusTokenValid:
          "Modo Members ativo ¬∑ token VIP v√°lido.",
        statusTokenInvalid:
          "Token inv√°lido ou expirado ¬∑ usando modo demonstra√ß√£o. Gere um novo em Members.",
        statusDemoEnded:
          "Demonstra√ß√£o finalizada ¬∑ renove seu acesso para continuar com EsteborgCom7.",
        statusDemoActive:
          "Modo demonstra√ß√£o ativo ¬∑ se voc√™ gerar seu token VIP em Members, vou us√°-lo automaticamente.",
        statusListening: "Ouvindo... pode falar agora.",
        statusProcessingSpeech: "Processando o que voc√™ disse...",
        statusMicError:
          "Houve um problema com o microfone, tente novamente.",
        statusTextCaptured:
          "Texto capturado, voc√™ pode enviar ou editar.",
        statusTTSOn: "Voz Esteborg ativada.",
        statusTTSOff: "Voz Esteborg desativada.",
        statusLangCurrent: "Idioma alterado para portugu√™s.",
        tokenPasteReply:
          "Perfeito, j√° tenho seu Token Esteborg Members ‚úÖ\nAgora me diga: prefere que conversemos em espanhol, ingl√™s, portugu√™s, franc√™s, italiano ou alem√£o?",
        tokenWelcomeMessage:
          "‚úÖ Seu Token Esteborg Members foi validado.\nVoc√™ est√° em modo Members VIP, ent√£o podemos trabalhar situa√ß√µes reais de comunica√ß√£o com acesso completo.",
        welcomeMessage:
          "Que bom ter voc√™ aqui! üòä Antes de come√ßar o treinamento, preciso do seu Token Esteborg Members para validar o acesso.\n\n" +
          "Se voc√™ ainda n√£o tem token, pode obt√™-lo ou recuper√°-lo em: https://membersvip.esteborg.live/#miembrosvip\n\n" +
          "Quando tiver o token em m√£os, cole aqui ou acesse pelo seu painel Members VIP. Depois, escolha o idioma no topo (ES, EN, PT, FR, IT, DE) e come√ßamos."
      },
      fr: {
        bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
        bannerSub: "Entra√Ænement √† la communication avec intelligence √©motionnelle",
        bannerDesc:
          "EsteborgCom7 est ton coach ex√©cutif en communication. Ici tu travailles sur des situations r√©elles, des le√ßons et des d√©fis con√ßus pour faire de ton esprit ton avantage.",
        panelTitle: "Mini entra√Ænement ¬∑ Communication avec EsteborgCom7",
        chipsLabel: "D√©marrer la session :",
        btnLesson: "Commencer la Le√ßon 1",
        btnLessonText:
          "Je veux commencer la Le√ßon 1 sur la communication avec intelligence √©motionnelle.",
        btnEmotion: "Intelligence √©motionnelle",
        btnEmotionText:
          "Je veux travailler mon intelligence √©motionnelle dans une conversation importante.",
        btnChallenge: "Commencer les d√©fis",
        btnChallengeText:
          "Donne-moi un d√©fi pratique de communication pour aujourd‚Äôhui.",
        contentLabel: "Contenu visuel :",
        btnSlides: "Diapositives de la session",
        btnSlidesText:
          "Montre-moi les diapositives qui accompagnent cette session.",
        btnSummary: "R√©sum√© t√©l√©chargeable",
        btnSummaryText:
          "Donne-moi un r√©sum√© t√©l√©chargeable avec les points cl√©s de ce que nous allons travailler aujourd‚Äôhui.",
        inputPlaceholder:
          "Raconte-moi une situation r√©elle de communication que tu souhaites am√©liorer...",
        footerTokenTitle: "Token Esteborg Members",
        footerTokenText:
          "Si tu n‚Äôas pas encore de token, tu peux l‚Äôobtenir ou le r√©cup√©rer sur : https://membersvip.esteborg.live/#miembrosvip",
        chatName: "Esteborg",
        chatRole: "Coach en communication",
        voiceToggleLabel: "Voix Esteborg activ√©e",
        voicePillLabel: "üéß Voix Esteborg",
        sendButtonLabel: "ENVOYER",
        statusInitialWithToken:
          "J‚Äôai d√©tect√© un token dans l‚ÄôURL ou stock√© localement ¬∑ je l‚Äôutiliserai automatiquement dans ta session.",
        statusInitialNoToken:
          "Mode d√©mo actif ¬∑ si tu g√©n√®res ton token VIP dans Members, je l‚Äôutiliserai automatiquement.",
        statusTokenManual:
          "Token coll√© manuellement ¬∑ je vais utiliser ce token dans ta session.",
        statusTokenValid:
          "Mode Members actif ¬∑ token VIP valide.",
        statusTokenInvalid:
          "Token invalide ou expir√© ¬∑ utilisation du mode d√©mo. G√©n√®re-en un nouveau dans Members.",
        statusDemoEnded:
          "D√©monstration termin√©e ¬∑ renouvelle ton acc√®s pour continuer avec EsteborgCom7.",
        statusDemoActive:
          "Mode d√©mo actif ¬∑ si tu g√©n√®res ton token VIP dans Members, je l‚Äôutiliserai automatiquement.",
        statusListening:
          "J‚Äô√©coute... tu peux parler maintenant.",
        statusProcessingSpeech:
          "Je traite ce que tu as dit...",
        statusMicError:
          "Un probl√®me est survenu avec le micro, r√©essaie.",
        statusTextCaptured:
          "Texte captur√©, tu peux l‚Äôenvoyer ou le modifier.",
        statusTTSOn: "Voix Esteborg activ√©e.",
        statusTTSOff: "Voix Esteborg d√©sactiv√©e.",
        statusLangCurrent: "Langue r√©gl√©e sur le fran√ßais.",
        tokenPasteReply:
          "Parfait, j‚Äôai ton Token Esteborg Members ‚úÖ\nDis-moi maintenant : pr√©f√®res-tu que l‚Äôon travaille en espagnol, anglais, portugais, fran√ßais, italien ou allemand ?",
        tokenWelcomeMessage:
          "‚úÖ Ton Token Esteborg Members est valid√©.\nTu es en mode Members VIP, nous pouvons donc travailler tes situations de communication r√©elles avec un acc√®s complet.",
        welcomeMessage:
          "Ravi de te voir ici ! üòä Avant de commencer ta formation, j‚Äôai besoin de ton Token Esteborg Members pour valider ton acc√®s.\n\n" +
          "Si tu n‚Äôas pas encore de token, tu peux l‚Äôobtenir ou le r√©cup√©rer sur : https://membersvip.esteborg.live/#miembrosvip\n\n" +
          "Une fois ton token pr√™t, colle-le ici ou passe par ton espace Members VIP. Ensuite, choisis la langue en haut (ES, EN, PT, FR, IT, DE) et on commence."
      },
      it: {
        bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
        bannerSub: "Training di Comunicazione con Intelligenza Emotiva",
        bannerDesc:
          "EsteborgCom7 √® il tuo coach esecutivo di comunicazione. Qui lavori su situazioni reali, lezioni e sfide pensate per rendere la tua mente il tuo vantaggio competitivo.",
        panelTitle: "Mini training ¬∑ Comunicazione con EsteborgCom7",
        chipsLabel: "Inizia la sessione:",
        btnLesson: "Inizia Lezione 1",
        btnLessonText:
          "Voglio iniziare la Lezione 1 sulla comunicazione con intelligenza emotiva.",
        btnEmotion: "Intelligenza emotiva",
        btnEmotionText:
          "Voglio lavorare sulla mia intelligenza emotiva in una conversazione importante.",
        btnChallenge: "Inizia le sfide",
        btnChallengeText:
          "Dammi una sfida pratica di comunicazione per oggi.",
        contentLabel: "Contenuto visivo:",
        btnSlides: "Slide della sessione",
        btnSlidesText:
          "Mostrami le slide che accompagnano questo training.",
        btnSummary: "Riassunto scaricabile",
        btnSummaryText:
          "Dammi un riassunto scaricabile con i punti chiave di quello che lavoriamo oggi.",
        inputPlaceholder:
          "Raccontami una situazione reale di comunicazione che vuoi migliorare...",
        footerTokenTitle: "Token Esteborg Members",
        footerTokenText:
          "Se non hai ancora un token, puoi ottenerlo o recuperarlo su: https://membersvip.esteborg.live/#miembrosvip",
        chatName: "Esteborg",
        chatRole: "Coach di comunicazione",
        voiceToggleLabel: "Voce Esteborg attivata",
        voicePillLabel: "üéß Voce Esteborg",
        sendButtonLabel: "INVIA",
        statusInitialWithToken:
          "Ho rilevato un token nell‚ÄôURL o salvato in locale ¬∑ lo user√≤ automaticamente nella tua sessione.",
        statusInitialNoToken:
          "Modalit√† demo attiva ¬∑ se generi il tuo token VIP in Members, lo user√≤ automaticamente.",
        statusTokenManual:
          "Token incollato manualmente ¬∑ user√≤ questo token nella tua sessione.",
        statusTokenValid:
          "Modalit√† Members attiva ¬∑ token VIP valido.",
        statusTokenInvalid:
          "Token non valido o scaduto ¬∑ uso la modalit√† demo. Generane uno nuovo in Members.",
        statusDemoEnded:
          "Demo terminata ¬∑ rinnova il tuo accesso per continuare con EsteborgCom7.",
        statusDemoActive:
          "Modalit√† demo attiva ¬∑ se generi il tuo token VIP in Members, lo user√≤ automaticamente.",
        statusListening:
          "In ascolto... puoi parlare ora.",
        statusProcessingSpeech:
          "Sto elaborando ci√≤ che hai detto...",
        statusMicError:
          "C‚Äô√® stato un problema con il microfono, riprova.",
        statusTextCaptured:
          "Testo catturato, puoi inviarlo o modificarlo.",
        statusTTSOn: "Voce Esteborg attivata.",
        statusTTSOff: "Voce Esteborg disattivata.",
        statusLangCurrent: "Lingua impostata su italiano.",
        tokenPasteReply:
          "Perfetto, ho il tuo Token Esteborg Members ‚úÖ\nOra dimmi: preferisci lavorare in spagnolo, inglese, portoghese, francese, italiano o tedesco?",
        tokenWelcomeMessage:
          "‚úÖ Il tuo Token Esteborg Members √® stato validato.\nSei in modalit√† Members VIP, quindi possiamo lavorare su situazioni reali di comunicazione con accesso completo.",
        welcomeMessage:
          "Felice di vederti qui! üòä Prima di iniziare il training ho bisogno del tuo Token Esteborg Members per validare l‚Äôaccesso.\n\n" +
          "Se non hai ancora un token, puoi ottenerlo o recuperarlo su: https://membersvip.esteborg.live/#miembrosvip\n\n" +
          "Una volta che hai il token, incollalo qui o entra dal tuo pannello Members VIP. Poi scegli la lingua in alto (ES, EN, PT, FR, IT, DE) e partiamo."
      },
      de: {
        bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
        bannerSub: "Kommunikationstraining mit emotionaler Intelligenz",
        bannerDesc:
          "EsteborgCom7 ist dein Executive-Coach f√ºr Kommunikation. Hier arbeitest du an realen Situationen, Lektionen und Challenges, damit dein Mindset zu deinem gr√∂√üten Vorteil wird.",
        panelTitle: "Mini-Training ¬∑ Kommunikation mit EsteborgCom7",
        chipsLabel: "Session starten:",
        btnLesson: "Lektion 1 starten",
        btnLessonText:
          "Ich m√∂chte Lektion 1 √ºber Kommunikation mit emotionaler Intelligenz starten.",
        btnEmotion: "Emotionale Intelligenz",
        btnEmotionText:
          "Ich m√∂chte an meiner emotionalen Intelligenz in einem wichtigen Gespr√§ch arbeiten.",
        btnChallenge: "Challenge starten",
        btnChallengeText:
          "Gib mir eine praktische Kommunikations-Challenge f√ºr heute.",
        contentLabel: "Visueller Content:",
        btnSlides: "Session-Slides",
        btnSlidesText:
          "Zeig mir die Slides, die dieses Training begleiten.",
        btnSummary: "Downloadbares Summary",
        btnSummaryText:
          "Gib mir ein downloadbares Summary mit den wichtigsten Punkten von dem, was wir heute erarbeiten.",
        inputPlaceholder:
          "Erz√§hl mir eine reale Kommunikationssituation, die du verbessern m√∂chtest...",
        footerTokenTitle: "Esteborg Members Token",
        footerTokenText:
          "Wenn du noch keinen Token hast, kannst du ihn hier erhalten oder wiederherstellen: https://membersvip.esteborg.live/#miembrosvip",
        chatName: "Esteborg",
        chatRole: "Kommunikationscoach",
        voiceToggleLabel: "Esteborg-Stimme aktiviert",
        voicePillLabel: "üéß Esteborg-Stimme",
        sendButtonLabel: "SENDEN",
        statusInitialWithToken:
          "Ich habe einen Token in der URL oder lokal gespeichert erkannt ¬∑ ich nutze ihn automatisch in deiner Session.",
        statusInitialNoToken:
          "Demo-Modus aktiv ¬∑ wenn du deinen VIP-Token in Members erzeugst, nutze ich ihn automatisch.",
        statusTokenManual:
          "Token manuell eingef√ºgt ¬∑ ich nutze diesen Token in deiner Session.",
        statusTokenValid:
          "Members-Modus aktiv ¬∑ VIP-Token g√ºltig.",
        statusTokenInvalid:
          "Token ung√ºltig oder abgelaufen ¬∑ Demo-Modus aktiv. Erzeuge einen neuen Token in Members.",
        statusDemoEnded:
          "Demo beendet ¬∑ erneuere deinen Zugriff, um mit EsteborgCom7 weiterzumachen.",
        statusDemoActive:
          "Demo-Modus aktiv ¬∑ wenn du deinen VIP-Token in Members erzeugst, nutze ich ihn automatisch.",
        statusListening:
          "Ich h√∂re zu... du kannst jetzt sprechen.",
        statusProcessingSpeech:
          "Ich verarbeite, was du gesagt hast...",
        statusMicError:
          "Es gab ein Problem mit dem Mikrofon, bitte versuche es erneut.",
        statusTextCaptured:
          "Text erfasst, du kannst ihn senden oder bearbeiten.",
        statusTTSOn: "Esteborg-Stimme aktiviert.",
        statusTTSOff: "Esteborg-Stimme deaktiviert.",
        statusLangCurrent: "Sprache auf Deutsch gestellt.",
        tokenPasteReply:
          "Perfekt, ich habe deinen Esteborg Members Token ‚úÖ\nSag mir jetzt: Sollen wir auf Spanisch, Englisch, Portugiesisch, Franz√∂sisch, Italienisch oder Deutsch arbeiten?",
        tokenWelcomeMessage:
          "‚úÖ Dein Esteborg Members Token ist validiert.\nDu bist im Members-VIP-Modus, wir k√∂nnen also mit vollem Zugang an deinen realen Kommunikationssituationen arbeiten.",
        welcomeMessage:
          "Stark, dass du hier bist! üòä Bevor wir mit deinem Training starten, brauche ich deinen Esteborg Members Token, um deinen Zugriff zu validieren.\n\n" +
          "Wenn du noch keinen Token hast, kannst du ihn hier erhalten oder wiederherstellen: https://membersvip.esteborg.live/#miembrosvip\n\n" +
          "Sobald du deinen Token hast, f√ºge ihn hier ein oder komm √ºber dein Members-VIP-Panel rein. Danach w√§hlst du oben die Sprache (ES, EN, PT, FR, IT, DE) und wir legen los."
      }
    };

    function t(key, langOverride) {
      const lang = langOverride || currentLang || "es";
      const pack = I18N[lang] || I18N.es;
      return pack[key] || I18N.es[key] || "";
    }

    // ========== TOKEN VIP ==========
    let VIP_TOKEN = null;
    const VIP_STORAGE_KEY = "esteborg_vip_token";

    function getVIPTokenFromURL() {
      const params = new URLSearchParams(window.location.search || "");
      const raw =
        params.get("tokken") ||
        params.get("access_token") ||
        params.get("token") ||
        "";
      const trimmed = (raw || "").trim();
      console.log(
        "[IA] Tokken detectado en URL:",
        trimmed ? trimmed.slice(0, 40) + "..." : "(ninguno)"
      );
      return trimmed || null;
    }

    window.addEventListener("message", (event) => {
      if (!event.data || event.data.type !== "esteborg-token") return;
      const tokken = (event.data.tokken || "").trim();
      if (!tokken) return;
      VIP_TOKEN = tokken;
      console.log(
        "[IA] Tokken recibido por postMessage:",
        VIP_TOKEN.slice(0, 40) + "..."
      );
      try {
        localStorage.setItem(VIP_STORAGE_KEY, VIP_TOKEN);
      } catch (e) {
        console.warn("[IA] No pude guardar Tokken desde postMessage:", e);
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      try {
        const stored = localStorage.getItem(VIP_STORAGE_KEY);
        if (stored) {
          VIP_TOKEN = stored;
          console.log("[IA] Tokken recuperado de localStorage");
        } else {
          VIP_TOKEN = getVIPTokenFromURL();
        }
      } catch (e) {
        console.warn("[IA] No pude leer localStorage:", e);
        VIP_TOKEN = getVIPTokenFromURL();
      }
    });

    // ========== ELEMENTOS ==========
    const chatLog = document.getElementById("chat-log");
    const inputEl = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const micBtn = document.getElementById("mic-btn");
    const ttsToggle = document.getElementById("tts-toggle");
    const statusLine = document.getElementById("status-line");
    const starterBtns = document.querySelectorAll(".starter");
    const contentBtns = document.querySelectorAll(".content");
    const langOptions = document.querySelectorAll(".lang-option");
    const voicePill = document.querySelector(".voice-pill");

    let history = [];
    let isSending = false;
    let recognition = null;
    let isRecording = false;
    let hasShownTokenWelcome = false;
    let currentAudio = null;
    let currentLang = "es";

    // ========== HELPERS UI ==========
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function appendMessage(role, content) {
      const raw = content || "";
      const processed = raw.replace(/^###\s*/gm, "");
      const safe = escapeHtml(processed);

      const row = document.createElement("div");
      row.className = "msg-row " + (role === "user" ? "user" : "assistant");

      const tag = document.createElement("div");
      tag.className = "msg-tag " + (role === "user" ? "user" : "assistant");
      tag.textContent = role === "user" ? "T√∫" : "Esteborg";

      const bubble = document.createElement("div");
      bubble.className = "msg-bubble";
      bubble.innerHTML = '<div class="msg-text">' + safe + "</div>";

      if (role === "user") {
        row.appendChild(bubble);
        row.appendChild(tag);
      } else {
        row.appendChild(tag);
        row.appendChild(bubble);
      }

      chatLog.appendChild(row);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function setStatus(msg) {
      if (!statusLine) return;
      const spans = statusLine.querySelectorAll("span");
      if (spans.length > 1) spans[1].textContent = msg;
      else statusLine.textContent = msg;
    }

    function pushHiddenInstruction(text) {
      history.push({ role: "user", content: text });
    }

    function applyUILanguage(lang) {
      const pack = I18N[lang] || I18N.es;
      const $ = (id) => document.getElementById(id);

      if ($("i-banner-main")) $("i-banner-main").textContent = pack.bannerMain;
      if ($("i-banner-sub")) $("i-banner-sub").textContent = pack.bannerSub;
      if ($("i-banner-desc")) $("i-banner-desc").textContent = pack.bannerDesc;
      if ($("i-panel-title")) $("i-panel-title").textContent = pack.panelTitle;

      if ($("i-chips-label")) $("i-chips-label").textContent = pack.chipsLabel;
      if ($("i-btn-lesson")) {
        $("i-btn-lesson").textContent = pack.btnLesson;
        $("i-btn-lesson").setAttribute("data-text", pack.btnLessonText);
      }
      if ($("i-btn-emotion")) {
        $("i-btn-emotion").textContent = pack.btnEmotion;
        $("i-btn-emotion").setAttribute("data-text", pack.btnEmotionText);
      }
      if ($("i-btn-challenge")) {
        $("i-btn-challenge").textContent = pack.btnChallenge;
        $("i-btn-challenge").setAttribute("data-text", pack.btnChallengeText);
      }

      if ($("i-content-label")) $("i-content-label").textContent = pack.contentLabel;
      if ($("i-btn-slides")) {
        $("i-btn-slides").textContent = pack.btnSlides;
        $("i-btn-slides").setAttribute("data-text", pack.btnSlidesText);
      }
      if ($("i-btn-summary")) {
        $("i-btn-summary").textContent = pack.btnSummary;
        $("i-btn-summary").setAttribute("data-text", pack.btnSummaryText);
      }

      if (inputEl) inputEl.placeholder = pack.inputPlaceholder;

      if ($("i-footer-token-title"))
        $("i-footer-token-title").textContent = pack.footerTokenTitle;
      if ($("i-footer-token-text"))
        $("i-footer-token-text").textContent = pack.footerTokenText;

      if ($("i-chat-name")) $("i-chat-name").textContent = pack.chatName;
      if ($("i-chat-role")) $("i-chat-role").textContent = pack.chatRole;

      if ($("i-voice-toggle-label"))
        $("i-voice-toggle-label").textContent = pack.voiceToggleLabel;
      if ($("i-voice-pill"))
        $("i-voice-pill").textContent = pack.voicePillLabel;

      if (sendBtn) sendBtn.textContent = pack.sendButtonLabel;
    }

    function getSpeechLangCode(lang) {
      switch (lang) {
        case "en": return "en-US";
        case "pt": return "pt-BR";
        case "fr": return "fr-FR";
        case "it": return "it-IT";
        case "de": return "de-DE";
        default: return "es-MX";
      }
    }

    // ========== TTS ==========
    function stopTTS() {
      if (currentAudio) {
        try {
          currentAudio.pause();
          currentAudio.currentTime = 0;
        } catch (_) {}
      }
    }

    async function playTTS(text) {
      if (!ttsToggle || !ttsToggle.checked) return;
      if (!text) return;

      try {
        const trimmed = text.length > 450 ? text.slice(0, 450) : text;

        const res = await fetch(TTS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            text: trimmed,
            voiceId: "IdhxxSTaAg80CTeSgScm"
          })
        });

        if (!res.ok) {
          console.error("[TTS] API error", await res.text());
          return;
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        stopTTS();
        currentAudio = new Audio(url);
        currentAudio.play().catch((err) => {
          console.warn("[TTS] No se pudo reproducir:", err);
        });
      } catch (e) {
        console.error("[TTS] Error general TTS:", e);
      }
    }

    function startSessionForCurrentLang(updateStatus) {
      if (typeof updateStatus === "undefined") updateStatus = true;
      if (!chatLog) return;

      chatLog.innerHTML = "";
      history = [];
      stopTTS();

      const welcome = t("welcomeMessage");
      appendMessage("assistant", welcome);
      playTTS(welcome);

      if (updateStatus) {
        if (VIP_TOKEN) {
          setStatus(t("statusInitialWithToken"));
        } else {
          setStatus(t("statusInitialNoToken"));
        }
      }
    }

    // ========== SEND MESSAGE ==========
    async function sendMessage(optionalText) {
      let text = (optionalText || inputEl.value || "").trim();
      if (!text || isSending) return;

      const candidate = text.replace(/\s+/g, "");
      const looksLikeTokken =
        /^[A-Za-z0-9+/=_-]{40,}$/.test(candidate) && !candidate.includes(".");

      if (!optionalText && looksLikeTokken) {
        VIP_TOKEN = candidate;
        console.log(
          "[IA] Tokken pegado (interceptado, no se manda al backend):",
          VIP_TOKEN.slice(0, 40) + "..."
        );

        try {
          localStorage.setItem(VIP_STORAGE_KEY, VIP_TOKEN);
        } catch (e) {
          console.warn("[IA] No pude guardar Tokken en localStorage:", e);
        }

        appendMessage("assistant", t("tokenPasteReply"));
        setStatus(t("statusTokenManual"));

        inputEl.value = "";
        return;
      }

      const tokenToSend = VIP_TOKEN || getVIPTokenFromURL();

      console.log(
        "[IA] Enviando mensaje:",
        text,
        "Tokken:",
        tokenToSend ? tokenToSend.slice(0, 40) + "..." : "(null)"
      );

      stopTTS();

      isSending = true;
      sendBtn.disabled = true;
      inputEl.disabled = true;
      if (micBtn) micBtn.disabled = true;

      appendMessage("user", text);
      history.push({ role: "user", content: text });
      inputEl.value = "";

      try {
        const resp = await fetch(API_BASE + MODULE_PATH, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: text,
            rawToken: tokenToSend,
            userName: null,
            history,
            lang: currentLang,
          }),
        });

        console.log("[IA] Respuesta HTTP:", resp.status);

        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();
        console.log("[IA] Payload backend:", data);

        const reply =
          data.reply ||
          "No tengo una respuesta en este momento, intenta de nuevo.";

        appendMessage("assistant", reply);
        history.push({ role: "assistant", content: reply });

        if (data.tokenStatus === "valid") {
          setStatus(t("statusTokenValid"));

          if (!hasShownTokenWelcome) {
            const tokenMsg = t("tokenWelcomeMessage");
            appendMessage("assistant", tokenMsg);
            history.push({ role: "assistant", content: tokenMsg });
            hasShownTokenWelcome = true;
          }
        } else if (data.tokenStatus === "invalid") {
          setStatus(t("statusTokenInvalid"));
        } else if (data.demoStatus === "ended") {
          setStatus(t("statusDemoEnded"));
        } else {
          setStatus(t("statusDemoActive"));
        }

        await playTTS(reply);
      } catch (err) {
        console.error("[IA] Error:", err);
        appendMessage(
          "assistant",
          "Hubo un problema al conectar con el servidor. Intenta de nuevo en unos segundos."
        );
      }

      isSending = false;
      sendBtn.disabled = false;
      inputEl.disabled = false;
      if (micBtn) micBtn.disabled = false;
      inputEl.focus();
    }

    // ========== SPEECH RECOGNITION ==========
    function initSpeechRecognition() {
      const SR =
        window.SpeechRecognition || window.webkitSpeechRecognition || null;
      if (!SR || !micBtn) return;

      recognition = new SR();
      recognition.lang = getSpeechLangCode(currentLang);
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        isRecording = true;
        micBtn.classList.add("active");
        setStatus(t("statusListening"));
      };
      recognition.onend = () => {
        isRecording = false;
        micBtn.classList.remove("active");
        setStatus(t("statusProcessingSpeech"));
      };
      recognition.onerror = (e) => {
        isRecording = false;
        micBtn.classList.remove("active");
        console.warn("SpeechRecognition error:", e);
        setStatus(t("statusMicError"));
      };
      recognition.onresult = (e) => {
        const transcript = e.results[0][0].transcript.trim();
        if (transcript) {
          inputEl.value = transcript;
          setStatus(t("statusTextCaptured"));
        }
      };
    }

    function toggleMic() {
      if (!recognition) return;
      try {
        if (!isRecording) {
          recognition.start();
        } else {
          recognition.stop();
        }
      } catch (err) {
        console.warn("[IA] No se pudo iniciar reconocimiento:", err);
      }
    }

    // ========== RESIZE PARA CARRD ==========
    function sendHeight() {
      const height = document.body.scrollHeight;
      window.parent.postMessage(
        { type: "esteborg-resize", height: height },
        "*"
      );
    }
    window.addEventListener("load", sendHeight);
    window.addEventListener("resize", sendHeight);
    setInterval(sendHeight, 500);

    // ========== INIT ==========
    document.addEventListener("DOMContentLoaded", () => {
      if (!chatLog || !inputEl || !sendBtn) {
        console.error("[IA] Faltan elementos base del chat");
        return;
      }

      applyUILanguage(currentLang);

      // Arrancar siempre con la voz desactivada
      if (ttsToggle) {
        ttsToggle.checked = false;
      }

      // Eventos de env√≠o
      sendBtn.addEventListener("click", () => sendMessage());
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Mic / STT
      if (micBtn) micBtn.addEventListener("click", toggleMic);
      initSpeechRecognition();

      // Chips inicio
      starterBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const text = btn.getAttribute("data-text") || btn.textContent;
          sendMessage(text);
        });
      });

      // Botones de contenido
      contentBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const text = btn.getAttribute("data-text") || btn.textContent;
          sendMessage(text);
        });
      });

      // Selector de idioma
      langOptions.forEach((opt) => {
        opt.addEventListener("click", () => {
          langOptions.forEach((o) => o.classList.remove("active"));
          opt.classList.add("active");

          const code = opt.getAttribute("data-lang") || "es";
          currentLang = code;

          applyUILanguage(currentLang);
          startSessionForCurrentLang(false);

          if (code === "en") {
            pushHiddenInstruction(
              "From this point on, please answer ALWAYS in ENGLISH, even if my messages are in other languages."
            );
          } else if (code === "pt") {
            pushHiddenInstruction(
              "A partir de agora, responda SEMPRE em PORTUGU√äS brasileiro, mesmo que eu escreva em outro idioma."
            );
          } else if (code === "fr") {
            pushHiddenInstruction(
              "√Ä partir de maintenant, r√©ponds TOUJOURS en FRAN√áAIS, m√™me si j‚Äô√©cris dans une autre langue."
            );
          } else if (code === "it") {
            pushHiddenInstruction(
              "Da questo momento in poi, rispondi SEMPRE in ITALIANO, anche se scrivo in un‚Äôaltra lingua."
            );
          } else if (code === "de") {
            pushHiddenInstruction(
              "Ab jetzt bitte IMMER auf DEUTSCH antworten, auch wenn ich in einer anderen Sprache schreibe."
            );
          } else {
            pushHiddenInstruction(
              "A partir de este punto, responde siempre en ESPA√ëOL latino, incluso si escribo algo en otro idioma."
            );
          }

          setStatus(t("statusLangCurrent"));

          if (recognition) {
            recognition.lang = getSpeechLangCode(currentLang);
          }
        });
      });

      // Toggle TTS
      if (ttsToggle) {
        ttsToggle.addEventListener("change", () => {
          if (!ttsToggle.checked) {
            stopTTS();
            setStatus(t("statusTTSOff"));
          } else {
            setStatus(t("statusTTSOn"));
          }
        });
      }

      if (voicePill) {
        voicePill.addEventListener("click", () => {
          if (!ttsToggle) return;
          if (ttsToggle.checked) {
            ttsToggle.checked = false;
            stopTTS();
            setStatus(t("statusTTSOff"));
          } else {
            ttsToggle.checked = true;
            setStatus(t("statusTTSOn"));
          }
        });
      }

      // Arrancar sesi√≥n
      startSessionForCurrentLang(true);
    });
  </script>

  <script>
    (function () {
      function sendResize() {
        try {
          const doc = document;
          const height = Math.max(
            doc.documentElement.scrollHeight,
            doc.body.scrollHeight
          );

          window.parent &&
            window.parent.postMessage(
              { type: "esteborg-resize", height: height },
              "*"
            );
        } catch (e) {
          console.warn("[Esteborg] Error al enviar resize:", e);
        }
      }

      window.addEventListener("load", sendResize);
      window.addEventListener("resize", sendResize);

      const observer = new MutationObserver(function () {
        clearTimeout(window.__esteborgResizeTimer);
        window.__esteborgResizeTimer = setTimeout(sendResize, 80);
      });

      observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
      });
    })();
  </script>
</body>
</html>
