body: JSON.stringify({
  message: text,
  rawToken: tokenToSend,
  userName: null,
  history,
  lang: currentLang,
});
``` :contentReference[oaicite:1]{index=1}  

En IA:

- Usas `TOKEN_STORAGE_KEY = "esteborg_token_members"`.
- Mandas el token como `token` en el body **y** en el header `x-esteborg-token`:

```js
const payload = { message, history, lang, token: storedToken || null };

fetch(API_URL, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    ...(storedToken ? { "x-esteborg-token": storedToken } : {})
  },
  body: JSON.stringify(payload)
});
``` :contentReference[oaicite:2]{index=2}  

Tu backend modular est√° copiado del ruta `/api/modules/comunica`, que espera `rawToken` en el body (no `token`, ni header), y devuelve `tokenStatus` / `demoStatus`. Como IA no habla ese ‚Äúdialecto‚Äù, **siempre caes en modo demo y nunca ves el flujo bonito de Members VIP**.

---

## 2. Clon del Index Com7 adaptado para IA (manteniendo lo visual de Com7)

La idea:  
- **Dejamos TODO el HTML y CSS tal cual est√°n en `index_IA.html`** (que ya es visualmente clon del Com7).  
- Solo **reemplazamos el `<script>...</script>` por uno que:**
  - Use **la misma l√≥gica de Tokken VIP de Com7** (VIP_TOKEN, `rawToken`, detecci√≥n en URL/chat/localStorage/postMessage).
  - Hable con el backend IA en `"/api/modules/iavipcom"`.
  - Use tus textos IA (banner, chips, etc.) en ES/EN.
  - Mantenga TTS con ElevenLabs (`IdhxxSTaAg80CTeSgScm`).
  - Mantenga el micr√≥fono como en Com7 (speech-to-text).

A continuaci√≥n te dejo el **script completo** listo para pegar en `index_IA.html` (simplemente sustituye TODO lo que hay entre `<script>(...)` y `</script>` por esto):

```html
<script>
  // ========== CONFIG ==========
  const API_BASE = "https://esteborg88full-backend-modular.onrender.com";
  const MODULE_PATH = "/api/modules/iavipcom";
  const TTS_URL = API_BASE + "/api/voice";

  // ========== I18N ==========
  const I18N = {
  es: {
    bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
    bannerSub: "Entrenamiento ejecutivo en IA aplicada para desplegar todo tu poder.",
    bannerDesc:
      "Esteborg IA es tu copiloto ejecutivo de inteligencia artificial. Aqu√≠ dise√±amos tu plan estrat√©gico, optimizamos tu negocio y entrenamos tus habilidades ejecutivas con IA.",
    panelTitle: "INICIO DEL ENTRENAMIENTO ¬∑ COPILOTO EJECUTIVO IA",

    chipsLabel: "Quiero empezar:",
    btnLesson: "Automatizar tareas",
    btnLessonText:
      "Quiero usar IA para automatizar tareas repetitivas de mi equipo.",
    btnEmotion: "Decisiones ejecutivas",
    btnEmotionText:
      "Quiero que la IA me ayude a tomar mejores decisiones ejecutivas.",
    btnChallenge: "Dominar IA diaria",
    btnChallengeText:
      "Quiero dominar IA en mi d√≠a a d√≠a y en mi trabajo ejecutivo.",

    contentLabel: "Material:",
    btnSlides: "Diapositivas",
    btnSlidesText:
      "Mu√©strame las diapositivas del entrenamiento ejecutivo en IA aplicada.",
    btnSummary: "Resumen IA",
    btnSummaryText:
      "Dame un resumen descargable con los puntos clave del entrenamiento en IA.",

    chatName: "Esteborg IA",
    chatRole: "Copiloto ejecutivo IA",
    inputPlaceholder:
      "Cu√©ntame qu√© quieres lograr con IA en los pr√≥ximos 90 d√≠as...",

    footerTokenTitle: "Tokken Esteborg Members",
    footerTokenText:
      "Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip",

    voiceToggleLabel: "Voz Esteborg IA activada",
    voicePillLabel: "üéß Voz Esteborg IA",
    sendButtonLabel: "ENVIAR",

    statusPreparing: "Preparando tu entrenamiento con Esteborg IA...",
    statusThinking: "Esteborg IA est√° pensando...",
    statusReady: "Listo para continuar con tu entrenamiento.",

    welcomeMessage:
      "¬°Qu√© gusto saludarte! üòä Antes de entrar a tu entrenamiento necesito tu Tokken Esteborg Members para validar tu acceso.\n\n" +
      "Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip\n\n" +
      "Una vez que tengas tu Tokken, p√©galo aqu√≠ o haz tu primera pregunta sobre IA aplicada a tu negocio y yo te gu√≠o paso a paso.",

    tokenDetectedUrl:
      "Detect√© un Tokken en la URL. Lo usar√© autom√°ticamente en tu sesi√≥n.",
    tokenDetectedStored:
      "Detect√© un Tokken guardado. Lo usar√© autom√°ticamente en tu sesi√≥n.",
    tokenMissingHint:
      "A√∫n no detecto tu Tokken Esteborg Members. P√©galo en el chat cuando est√©s listo.",
    invalidToken:
      "Tu Tokken Esteborg Members parece inv√°lido o expirado. Entra a https://membersvip.esteborg.live/#miembrosvip para generar uno nuevo y p√©galo aqu√≠.",

    errorGeneric:
      "Hubo un problema de conexi√≥n. Intenta de nuevo en algunos segundos."
  },

  en: {
    bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
    bannerSub: "Executive training in Applied AI to unlock all your power.",
    bannerDesc:
      "Esteborg IA is your executive AI copilot. Here we design your strategic plan, optimize your business and train your executive skills with AI.",
    panelTitle: "TRAINING START ¬∑ EXECUTIVE AI COPILOT",

    chipsLabel: "I want to start with:",
    btnLesson: "Automate tasks",
    btnLessonText:
      "I want to use AI to automate repetitive tasks in my team.",
    btnEmotion: "Executive decisions",
    btnEmotionText:
      "I want AI to help me make better executive decisions.",
    btnChallenge: "Daily AI mastery",
    btnChallengeText:
      "I want to master AI in my daily work and executive role.",

    contentLabel: "Content:",
    btnSlides: "Slides",
    btnSlidesText:
      "Show me the slides for the executive training in Applied AI.",
    btnSummary: "AI Summary",
    btnSummaryText:
      "Give me a downloadable summary with the key points of this AI training.",

    chatName: "Esteborg IA",
    chatRole: "Executive AI copilot",
    inputPlaceholder:
      "Tell me what you want to achieve with AI in the next 90 days...",

    footerTokenTitle: "Esteborg Members Token",
    footerTokenText:
      "If you don't have a token yet, you can get or recover it at: https://membersvip.esteborg.live/#miembrosvip",

    voiceToggleLabel: "Esteborg IA voice enabled",
    voicePillLabel: "üéß Esteborg IA Voice",
    sendButtonLabel: "SEND",

    statusPreparing: "Preparing your training with Esteborg IA...",
    statusThinking: "Esteborg IA is thinking...",
    statusReady: "Ready to continue your training.",

    welcomeMessage:
      "Great to see you here! üòä Before we start your training I need your Esteborg Members token to validate your access.\n\n" +
      "If you don‚Äôt have a token yet, you can get or recover it at: https://membersvip.esteborg.live/#miembrosvip\n\n" +
      "Once you have your token, paste it here or ask your first question about AI applied to your business and I‚Äôll guide you step by step.",

    tokenDetectedUrl:
      "I detected a token in the URL. I‚Äôll use it automatically in your session.",
    tokenDetectedStored:
      "I detected a stored token. I‚Äôll use it automatically in your session.",
    tokenMissingHint:
      "I haven‚Äôt detected your Esteborg Members token yet. Paste it into the chat when you‚Äôre ready.",
    invalidToken:
      "Your Esteborg Members token seems invalid or expired. Go to https://membersvip.esteborg.live/#miembrosvip to generate a new one and paste it here.",

    errorGeneric:
      "There was a connection problem. Please try again in a few seconds."
  },

  pt: {
    bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
    bannerSub:
      "Treinamento executivo em IA aplicada para liberar todo o seu poder.",
    bannerDesc:
      "Esteborg IA √© o seu copiloto executivo de intelig√™ncia artificial. Aqui desenhamos seu plano estrat√©gico, otimizamos o seu neg√≥cio e treinamos suas habilidades executivas com IA.",
    panelTitle: "IN√çCIO DO TREINAMENTO ¬∑ COPILOTO EXECUTIVO DE IA",

    chipsLabel: "Quero come√ßar por:",
    btnLesson: "Automatizar tarefas",
    btnLessonText:
      "Quero usar IA para automatizar tarefas repetitivas da minha equipe.",
    btnEmotion: "Decis√µes executivas",
    btnEmotionText:
      "Quero que a IA me ajude a tomar melhores decis√µes executivas.",
    btnChallenge: "Dominar IA no dia a dia",
    btnChallengeText:
      "Quero dominar IA no meu dia a dia e no meu papel executivo.",

    contentLabel: "Material:",
    btnSlides: "Apresenta√ß√£o",
    btnSlidesText:
      "Mostre os slides do treinamento executivo em IA aplicada.",
    btnSummary: "Resumo IA",
    btnSummaryText:
      "D√™-me um resumo para download com os pontos-chave deste treinamento em IA.",

    chatName: "Esteborg IA",
    chatRole: "Copiloto executivo de IA",
    inputPlaceholder:
      "Conte o que voc√™ quer alcan√ßar com IA nos pr√≥ximos 90 dias...",

    footerTokenTitle: "Tokken Esteborg Members",
    footerTokenText:
      "Se voc√™ ainda n√£o tem token, pode obter ou recuperar em: https://membersvip.esteborg.live/#miembrosvip",

    voiceToggleLabel: "Voz Esteborg IA ativada",
    voicePillLabel: "üéß Voz Esteborg IA",
    sendButtonLabel: "ENVIAR",

    statusPreparing: "Preparando o seu treinamento com Esteborg IA...",
    statusThinking: "Esteborg IA est√° pensando...",
    statusReady: "Pronto para continuar o seu treinamento.",

    welcomeMessage:
      "Que bom ter voc√™ aqui! üòä Antes de come√ßar o seu treinamento eu preciso do seu Tokken Esteborg Members para validar o acesso.\n\n" +
      "Se voc√™ ainda n√£o tem token, pode obter ou recuperar em: https://membersvip.esteborg.live/#miembrosvip\n\n" +
      "Quando tiver o Tokken, cole aqui ou fa√ßa sua primeira pergunta sobre IA aplicada ao seu neg√≥cio e eu vou gui√°-lo passo a passo.",

    tokenDetectedUrl:
      "Detectei um Tokken na URL. Vou us√°-lo automaticamente na sua sess√£o.",
    tokenDetectedStored:
      "Detectei um Tokken salvo. Vou us√°-lo automaticamente na sua sess√£o.",
    tokenMissingHint:
      "Ainda n√£o detectei o seu Tokken Esteborg Members. Cole-o no chat quando estiver pronto.",
    invalidToken:
      "Seu Tokken Esteborg Members parece inv√°lido ou expirado. Acesse https://membersvip.esteborg.live/#miembrosvip para gerar um novo e colar aqui.",

    errorGeneric:
      "Houve um problema de conex√£o. Tente novamente em alguns segundos."
  },

  fr: {
    bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
    bannerSub:
      "Formation ex√©cutive en IA appliqu√©e pour lib√©rer tout votre potentiel.",
    bannerDesc:
      "Esteborg IA est votre copilote ex√©cutif en intelligence artificielle. Ici nous concevons votre plan strat√©gique, optimisons votre entreprise et entra√Ænons vos comp√©tences ex√©cutives avec l‚ÄôIA.",
    panelTitle: "D√âBUT DE LA FORMATION ¬∑ COPILOTE EX√âCUTIF IA",

    chipsLabel: "Je veux commencer par :",
    btnLesson: "Automatiser des t√¢ches",
    btnLessonText:
      "Je veux utiliser l‚ÄôIA pour automatiser les t√¢ches r√©p√©titives de mon √©quipe.",
    btnEmotion: "D√©cisions ex√©cutives",
    btnEmotionText:
      "Je veux que l‚ÄôIA m‚Äôaide √† prendre de meilleures d√©cisions ex√©cutives.",
    btnChallenge: "Ma√Ætriser l‚ÄôIA au quotidien",
    btnChallengeText:
      "Je veux ma√Ætriser l‚ÄôIA dans mon quotidien et dans mon r√¥le ex√©cutif.",

    contentLabel: "Contenu :",
    btnSlides: "Diapositives",
    btnSlidesText:
      "Montre-moi les diapositives de la formation ex√©cutive en IA appliqu√©e.",
    btnSummary: "R√©sum√© IA",
    btnSummaryText:
      "Donne-moi un r√©sum√© t√©l√©chargeable avec les points cl√©s de cette formation en IA.",

    chatName: "Esteborg IA",
    chatRole: "Copilote ex√©cutif IA",
    inputPlaceholder:
      "Dites-moi ce que vous voulez accomplir avec l‚ÄôIA dans les 90 prochains jours...",

    footerTokenTitle: "Tokken Esteborg Members",
    footerTokenText:
      "Si vous n‚Äôavez pas encore de token, vous pouvez l‚Äôobtenir ou le r√©cup√©rer sur : https://membersvip.esteborg.live/#miembrosvip",

    voiceToggleLabel: "Voix Esteborg IA activ√©e",
    voicePillLabel: "üéß Voix Esteborg IA",
    sendButtonLabel: "ENVOYER",

    statusPreparing: "Pr√©paration de votre formation avec Esteborg IA...",
    statusThinking: "Esteborg IA est en train de r√©fl√©chir...",
    statusReady: "Pr√™t √† poursuivre votre formation.",

    welcomeMessage:
      "Ravi de vous voir ici ! üòä Avant de d√©marrer votre formation j‚Äôai besoin de votre Tokken Esteborg Members pour valider votre acc√®s.\n\n" +
      "Si vous n‚Äôavez pas encore de token, vous pouvez l‚Äôobtenir ou le r√©cup√©rer sur : https://membersvip.esteborg.live/#miembrosvip\n\n" +
      "Une fois que vous avez votre Tokken, collez-le ici ou posez votre premi√®re question sur l‚ÄôIA appliqu√©e √† votre business et je vous guiderai √©tape par √©tape.",

    tokenDetectedUrl:
      "J‚Äôai d√©tect√© un Tokken dans l‚ÄôURL. Je l‚Äôutiliserai automatiquement dans votre session.",
    tokenDetectedStored:
      "J‚Äôai d√©tect√© un Tokken enregistr√©. Je l‚Äôutiliserai automatiquement dans votre session.",
    tokenMissingHint:
      "Je n‚Äôai pas encore d√©tect√© votre Tokken Esteborg Members. Collez-le dans le chat quand vous serez pr√™t.",
    invalidToken:
      "Votre Tokken Esteborg Members semble invalide ou expir√©. Rendez-vous sur https://membersvip.esteborg.live/#miembrosvip pour en g√©n√©rer un nouveau et le coller ici.",

    errorGeneric:
      "Un probl√®me de connexion est survenu. R√©essayez dans quelques secondes."
  },

  it: {
    bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
    bannerSub:
      "Formazione executive in IA applicata per liberare tutto il tuo potenziale.",
    bannerDesc:
      "Esteborg IA √® il tuo copilota executive di intelligenza artificiale. Qui progettiamo il tuo piano strategico, ottimizziamo il business e alleniamo le tue competenze executive con l‚ÄôIA.",
    panelTitle: "INIZIO DELL‚ÄôALLENAMENTO ¬∑ COPILOTA EXECUTIVE IA",

    chipsLabel: "Voglio iniziare da:",
    btnLesson: "Automatizzare compiti",
    btnLessonText:
      "Voglio usare l‚ÄôIA per automatizzare le attivit√† ripetitive del mio team.",
    btnEmotion: "Decisioni executive",
    btnEmotionText:
      "Voglio che l‚ÄôIA mi aiuti a prendere decisioni executive migliori.",
    btnChallenge: "Dominare l‚ÄôIA ogni giorno",
    btnChallengeText:
      "Voglio dominare l‚ÄôIA nella mia quotidianit√† e nel mio ruolo executive.",

    contentLabel: "Materiale:",
    btnSlides: "Slide",
    btnSlidesText:
      "Mostrami le slide della formazione executive in IA applicata.",
    btnSummary: "Sintesi IA",
    btnSummaryText:
      "Dammi una sintesi scaricabile con i punti chiave di questa formazione in IA.",

    chatName: "Esteborg IA",
    chatRole: "Copilota executive IA",
    inputPlaceholder:
      "Dimmi cosa vuoi ottenere con l‚ÄôIA nei prossimi 90 giorni...",

    footerTokenTitle: "Tokken Esteborg Members",
    footerTokenText:
      "Se non hai ancora il token, puoi ottenerlo o recuperarlo su: https://membersvip.esteborg.live/#miembrosvip",

    voiceToggleLabel: "Voce Esteborg IA attivata",
    voicePillLabel: "üéß Voce Esteborg IA",
    sendButtonLabel: "INVIA",

    statusPreparing: "Preparando il tuo allenamento con Esteborg IA...",
    statusThinking: "Esteborg IA sta pensando...",
    statusReady: "Pronto a continuare il tuo allenamento.",

    welcomeMessage:
      "Felice di vederti qui! üòä Prima di iniziare il tuo allenamento ho bisogno del tuo Tokken Esteborg Members per convalidare l‚Äôaccesso.\n\n" +
      "Se non hai ancora il token, puoi ottenerlo o recuperarlo su: https://membersvip.esteborg.live/#miembrosvip\n\n" +
      "Una volta che hai il Tokken, incollalo qui o fai la tua prima domanda sull‚ÄôIA applicata al tuo business e ti guider√≤ passo dopo passo.",

    tokenDetectedUrl:
      "Ho rilevato un Tokken nell‚ÄôURL. Lo user√≤ automaticamente nella tua sessione.",
    tokenDetectedStored:
      "Ho rilevato un Tokken salvato. Lo user√≤ automaticamente nella tua sessione.",
    tokenMissingHint:
      "Non ho ancora rilevato il tuo Tokken Esteborg Members. Incollalo nella chat quando sei pronto.",
    invalidToken:
      "Il tuo Tokken Esteborg Members sembra non valido o scaduto. Vai su https://membersvip.esteborg.live/#miembrosvip per generarne uno nuovo e incollarlo qui.",

    errorGeneric:
      "Si √® verificato un problema di connessione. Riprova tra qualche secondo."
  },

  de: {
    bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
    bannerSub:
      "Executive-Training in angewandter KI, um deine volle St√§rke zu entfalten.",
    bannerDesc:
      "Esteborg IA ist dein Executive-Copilot f√ºr K√ºnstliche Intelligenz. Hier entwickeln wir deinen strategischen Plan, optimieren dein Unternehmen und trainieren deine Executive-F√§higkeiten mit KI.",
    panelTitle: "START DES TRAININGS ¬∑ EXECUTIVE KI-COPILOT",

    chipsLabel: "Ich m√∂chte anfangen mit:",
    btnLesson: "Aufgaben automatisieren",
    btnLessonText:
      "Ich m√∂chte KI nutzen, um wiederkehrende Aufgaben in meinem Team zu automatisieren.",
    btnEmotion: "Executive-Entscheidungen",
    btnEmotionText:
      "Ich m√∂chte, dass KI mir hilft, bessere Executive-Entscheidungen zu treffen.",
    btnChallenge: "KI im Alltag meistern",
    btnChallengeText:
      "Ich m√∂chte KI in meinem Arbeitsalltag und in meiner Executive-Rolle meistern.",

    contentLabel: "Material:",
    btnSlides: "Folien",
    btnSlidesText:
      "Zeig mir die Folien des Executive-Trainings in angewandter KI.",
    btnSummary: "KI-Zusammenfassung",
    btnSummaryText:
      "Gib mir eine herunterladbare Zusammenfassung mit den wichtigsten Punkten dieses KI-Trainings.",

    chatName: "Esteborg IA",
    chatRole: "Executive KI-Copilot",
    inputPlaceholder:
      "Erz√§hl mir, was du in den n√§chsten 90 Tagen mit KI erreichen m√∂chtest...",

    footerTokenTitle: "Tokken Esteborg Members",
    footerTokenText:
      "Wenn du noch keinen Token hast, kannst du ihn hier bekommen oder wiederherstellen: https://membersvip.esteborg.live/#miembrosvip",

    voiceToggleLabel: "Esteborg IA-Stimme aktiviert",
    voicePillLabel: "üéß Esteborg IA-Stimme",
    sendButtonLabel: "SENDEN",

    statusPreparing:
      "Dein Training mit Esteborg IA wird vorbereitet...",
    statusThinking: "Esteborg IA denkt gerade nach...",
    statusReady: "Bereit, mit deinem Training fortzufahren.",

    welcomeMessage:
      "Sch√∂n, dass du hier bist! üòä Bevor wir mit deinem Training starten, brauche ich deinen Esteborg Members-Tokken, um deinen Zugang zu validieren.\n\n" +
      "Wenn du noch keinen Token hast, kannst du ihn hier bekommen oder wiederherstellen: https://membersvip.esteborg.live/#miembrosvip\n\n" +
      "Sobald du deinen Tokken hast, f√ºge ihn hier ein oder stell deine erste Frage zu KI in deinem Unternehmen ‚Äì ich f√ºhre dich Schritt f√ºr Schritt.",

    tokenDetectedUrl:
      "Ich habe einen Tokken in der URL erkannt. Ich werde ihn automatisch in deiner Session verwenden.",
    tokenDetectedStored:
      "Ich habe einen gespeicherten Tokken erkannt. Ich werde ihn automatisch in deiner Session verwenden.",
    tokenMissingHint:
      "Ich habe deinen Esteborg Members-Tokken noch nicht erkannt. F√ºge ihn ins Chatfeld ein, wenn du bereit bist.",
    invalidToken:
      "Dein Esteborg Members-Tokken scheint ung√ºltig oder abgelaufen zu sein. Gehe auf https://membersvip.esteborg.live/#miembrosvip, um einen neuen zu erzeugen und hier einzuf√ºgen.",

    errorGeneric:
      "Es gab ein Verbindungsproblem. Bitte versuche es in ein paar Sekunden erneut."
  }
};

  // ========== TOKEN VIP (CLON EC7) ==========
  let VIP_TOKEN = null;
  const VIP_STORAGE_KEY = "esteborg_vip_token";

  function getVIPTokenFromURL() {
    const params = new URLSearchParams(window.location.search || "");
    const raw =
      params.get("tokken") ||
      params.get("access_token") ||
      params.get("token") ||
      "";
    const trimmed = (raw || "").trim();
    console.log(
      "[IA] Tokken detectado en URL:",
      trimmed ? trimmed.slice(0, 40) + "..." : "(ninguno)"
    );
    return trimmed || null;
  }

  // Tokken por postMessage desde Carrd
  window.addEventListener("message", (event) => {
    if (!event.data || event.data.type !== "esteborg-token") return;
    const tokken = (event.data.tokken || "").trim();
    if (!tokken) return;
    VIP_TOKEN = tokken;
    console.log("[IA] Tokken recibido por postMessage:", VIP_TOKEN.slice(0, 40) + "...");
    try {
      localStorage.setItem(VIP_STORAGE_KEY, VIP_TOKEN);
    } catch (e) {
      console.warn("[IA] No pude guardar Tokken desde postMessage:", e);
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
    try {
      const stored = localStorage.getItem(VIP_STORAGE_KEY);
      if (stored) {
        VIP_TOKEN = stored;
        console.log("[IA] Tokken recuperado de localStorage");
      } else {
        VIP_TOKEN = getVIPTokenFromURL();
      }
    } catch (e) {
      console.warn("[IA] No pude leer localStorage:", e);
      VIP_TOKEN = getVIPTokenFromURL();
    }
  });

  // ========== ELEMENTOS ==========
  const chatLog = document.getElementById("chat-log");
  const inputEl = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");
  const micBtn = document.getElementById("mic-btn");
  const ttsToggle = document.getElementById("tts-toggle");
  const statusLine = document.getElementById("status-line");
  const starterBtns = document.querySelectorAll(".starter");
  const contentBtns = document.querySelectorAll(".content");
  const langOptions = document.querySelectorAll(".lang-option");
  const voicePill = document.querySelector(".voice-pill");

  let history = [];
  let isSending = false;
  let recognition = null;
  let isRecording = false;
  let hasShownTokenWelcome = false;
  let currentAudio = null;
  let currentLang = "es";

  // ========== HELPERS UI ==========
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function appendMessage(role, content) {
    if (!chatLog) return;

    const raw = content || "";
    const processed = raw.replace(/^###\s*/gm, "");
    const safe = escapeHtml(processed);

    const row = document.createElement("div");
    row.className = "msg-row " + (role === "user" ? "user" : "assistant");

    const tag = document.createElement("div");
    tag.className = "msg-tag " + (role === "user" ? "user" : "assistant");
    tag.textContent = role === "user" ? "T√∫" : "Esteborg IA";

    const bubble = document.createElement("div");
    bubble.className = "msg-bubble";
    bubble.innerHTML = '<div class="msg-text">' + safe + "</div>";

    if (role === "user") {
      row.appendChild(bubble);
      row.appendChild(tag);
    } else {
      row.appendChild(tag);
      row.appendChild(bubble);
    }

    chatLog.appendChild(row);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function setStatus(textKey) {
    if (!statusLine) return;
    const spans = statusLine.querySelectorAll("span");
    const txt = typeof textKey === "string" ? t(textKey) : textKey;
    if (spans.length > 1) spans[1].textContent = txt;
    else statusLine.textContent = txt;
  }

  // ========== APLICAR IDIOMA ==========
  function applyUILanguage(lang) {
    const useLang = lang || currentLang || "es";

    const $ = (id) => document.getElementById(id);
    const s = (key) => t(key, useLang);

    // Banner
    const bm = $("i-banner-main");
    const bs = $("i-banner-sub");
    const bd = $("i-banner-desc");
    if (bm) bm.textContent = s("bannerMain");
    if (bs) bs.textContent = s("bannerSub");
    if (bd) bd.textContent = s("bannerDesc");

    // Panel
    const pt = $("i-panel-title");
    const cl = $("i-chips-label");
    if (pt) pt.textContent = s("panelTitle");
    if (cl) cl.textContent = s("chipsLabel");

    // Chat header
    const cn = $("i-chat-name");
    const cr = $("i-chat-role");
    if (cn) cn.textContent = s("chatName");
    if (cr) cr.textContent = s("chatRole");

    // Input placeholder
    if (inputEl) inputEl.placeholder = s("inputPlaceholder");

    // Footer
    const ft = $("i-footer-token-title");
    const ftx = $("i-footer-token-text");
    if (ft) ft.textContent = s("footerTokenTitle");
    if (ftx) ftx.textContent = s("footerTokenText");

    // Voz
    const vLabel = $("i-voice-toggle-label");
    const vPill = $("i-voice-pill");
    if (vLabel) vLabel.textContent = s("voiceToggleLabel");
    if (vPill) vPill.textContent = s("voicePillLabel");

    // Bot√≥n enviar
    if (sendBtn) sendBtn.textContent = s("sendButtonLabel");

    // Estado inicial
    if (statusLine) {
      const spans = statusLine.querySelectorAll("span");
      if (spans.length > 1) {
        spans[1].textContent = s("statusInitialNoToken");
      }
    }

    // Chips
    const lessonBtn = $("i-btn-lesson");
    const emotionBtn = $("i-btn-emotion");
    const challengeBtn = $("i-btn-challenge");
    const slidesBtn = $("i-btn-slides");
    const summaryBtn = $("i-btn-summary");

    if (lessonBtn) {
      lessonBtn.textContent = s("btnLesson");
      lessonBtn.dataset.text = s("btnLessonText");
    }
    if (emotionBtn) {
      emotionBtn.textContent = s("btnEmotion");
      emotionBtn.dataset.text = s("btnEmotionText");
    }
    if (challengeBtn) {
      challengeBtn.textContent = s("btnChallenge");
      challengeBtn.dataset.text = s("btnChallengeText");
    }
    if (slidesBtn) {
      slidesBtn.textContent = s("btnSlides");
      slidesBtn.dataset.text = s("btnSlidesText");
    }
    if (summaryBtn) {
      summaryBtn.textContent = s("btnSummary");
      summaryBtn.dataset.text = s("btnSummaryText");
    }
  }

  // ========== SPEECH LANG CODE ==========
  function getSpeechLangCode(lang) {
    switch (lang) {
      case "en":
        return "en-US";
      case "pt":
        return "pt-BR";
      case "fr":
        return "fr-FR";
      case "it":
        return "it-IT";
      case "de":
        return "de-DE";
      default:
        return "es-MX";
    }
  }

  // ========== TTS ==========
  function stopTTS() {
    if (currentAudio) {
      try {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      } catch (_) {}
    }
  }

  async function playTTS(text) {
    if (!ttsToggle || !ttsToggle.checked) return;
    if (!text) return;

    try {
      const trimmed = text.length > 450 ? text.slice(0, 450) : text;

      const res = await fetch(TTS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: trimmed,
          voiceId: "IdhxxSTaAg80CTeSgScm"
        })
      });

      if (!res.ok) {
        console.error("[TTS] API error", await res.text());
        return;
      }

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      stopTTS();
      currentAudio = new Audio(url);
      currentAudio.play().catch((err) => {
        console.warn("[TTS] No se pudo reproducir:", err);
      });
    } catch (e) {
      console.error("[TTS] Error general TTS:", e);
    }
  }

  // ========== START SESSION ==========
  function startSessionForCurrentLang(updateStatus) {
    if (typeof updateStatus === "undefined") updateStatus = true;
    if (!chatLog) return;

    chatLog.innerHTML = "";
    history = [];
    stopTTS();

    const welcome = t("welcomeMessage");
    appendMessage("assistant", welcome);
    playTTS(welcome);

    if (updateStatus) {
      if (VIP_TOKEN) {
        setStatus("statusInitialWithToken");
      } else {
        setStatus("statusInitialNoToken");
      }
    }
  }

  // ========== SEND MESSAGE (CLON EC7, PERO IA) ==========
  async function sendMessage(optionalText) {
    let text = (optionalText || inputEl.value || "").trim();
    if (!text || isSending) return;

    // ¬øParece un Tokken?
    const candidate = text.replace(/\s+/g, "");
    const looksLikeTokken =
      /^[A-Za-z0-9+/=_-]{40,}$/.test(candidate) && !candidate.includes(".");

    // Interceptamos token pegado
    if (!optionalText && looksLikeTokken) {
      VIP_TOKEN = candidate;
      console.log(
        "[IA] Tokken pegado (interceptado, no se manda al backend):",
        VIP_TOKEN.slice(0, 40) + "..."
      );

      try {
        localStorage.setItem(VIP_STORAGE_KEY, VIP_TOKEN);
      } catch (e) {
        console.warn("[IA] No pude guardar Tokken en localStorage:", e);
      }

      appendMessage("assistant", t("tokenPasteReply"));
      setStatus("statusTokenManual");

      inputEl.value = "";
      return;
    }

    const tokenToSend = VIP_TOKEN || getVIPTokenFromURL();

    console.log(
      "[IA] Enviando mensaje:",
      text,
      "Tokken:",
      tokenToSend ? tokenToSend.slice(0, 40) + "..." : "(null)"
    );

    stopTTS();

    isSending = true;
    if (sendBtn) sendBtn.disabled = true;
    if (inputEl) inputEl.disabled = true;
    if (micBtn) micBtn.disabled = true;

    appendMessage("user", text);
    history.push({ role: "user", content: text });
    if (inputEl) inputEl.value = "";

    try {
      const resp = await fetch(API_BASE + MODULE_PATH, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: text,
          rawToken: tokenToSend,
          userName: null,
          history,
          lang: currentLang
        })
      });

      console.log("[IA] Respuesta HTTP:", resp.status);

      if (!resp.ok) throw new Error("HTTP " + resp.status);

      const data = await resp.json();
      console.log("[IA] Payload backend:", data);

      const reply =
        data.reply ||
        "No tengo una respuesta en este momento, intenta de nuevo.";

      appendMessage("assistant", reply);
      history.push({ role: "assistant", content: reply });

      if (data.tokenStatus === "valid") {
        setStatus("statusTokenValid");

        if (!hasShownTokenWelcome) {
          const tokenMsg = t("tokenWelcomeMessage");
          appendMessage("assistant", tokenMsg);
          history.push({ role: "assistant", content: tokenMsg });
          hasShownTokenWelcome = true;
        }
      } else if (data.tokenStatus === "invalid") {
        setStatus("statusTokenInvalid");
      } else if (data.demoStatus === "ended") {
        setStatus("statusDemoEnded");
      } else {
        setStatus("statusDemoActive");
      }

      await playTTS(reply);
    } catch (err) {
      console.error("[IA] Error:", err);
      appendMessage(
        "assistant",
        "Hubo un problema al conectar con el servidor. Intenta de nuevo en unos segundos."
      );
    }

    isSending = false;
    if (sendBtn) sendBtn.disabled = false;
    if (inputEl) inputEl.disabled = false;
    if (micBtn) micBtn.disabled = false;
    if (inputEl) inputEl.focus();
  }

  // ========== SPEECH RECOGNITION ==========
  function initSpeechRecognition() {
    const SR =
      window.SpeechRecognition || window.webkitSpeechRecognition || null;
    if (!SR || !micBtn) return;

    recognition = new SR();
    recognition.lang = getSpeechLangCode(currentLang);
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      isRecording = true;
      micBtn.classList.add("active");
      setStatus("statusListening");
    };
    recognition.onend = () => {
      isRecording = false;
      micBtn.classList.remove("active");
      setStatus("statusProcessingSpeech");
    };
    recognition.onerror = (e) => {
      isRecording = false;
      micBtn.classList.remove("active");
      console.warn("SpeechRecognition error:", e);
      setStatus("statusMicError");
    };
    recognition.onresult = (e) => {
      const transcript = e.results[0][0].transcript.trim();
      if (transcript && inputEl) {
        inputEl.value = transcript;
        setStatus("statusTextCaptured");
      }
    };
  }

  function toggleMic() {
    if (!recognition) return;
    try {
      if (!isRecording) {
        recognition.start();
      } else {
        recognition.stop();
      }
    } catch (err) {
      console.warn("[IA] No se pudo iniciar reconocimiento:", err);
    }
  }

  // ========== RESIZE PARA CARRD ==========
  function sendHeight() {
    const height = document.body.scrollHeight;
    window.parent.postMessage(
      { type: "esteborg-resize", height: height },
      "*"
    );
  }
  window.addEventListener("load", sendHeight);
  window.addEventListener("resize", sendHeight);
  setInterval(sendHeight, 500);

  // ========== INIT ==========
  document.addEventListener("DOMContentLoaded", () => {
    if (!chatLog || !inputEl || !sendBtn) {
      console.error("[IA] Faltan elementos base del chat");
      return;
    }

    applyUILanguage(currentLang);

    // eventos chips
    if (starterBtns) {
      starterBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const txt = btn.dataset.text || btn.textContent || "";
          sendMessage(txt);
        });
      });
    }

    if (contentBtns) {
      contentBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const txt = btn.dataset.text || btn.textContent || "";
          sendMessage(txt);
        });
      });
    }

    // bot√≥n enviar
    sendBtn.addEventListener("click", () => sendMessage());

    // enter en textarea
    inputEl.addEventListener("keydown", (ev) => {
      if (ev.key === "Enter" && !ev.shiftKey) {
        ev.preventDefault();
        sendMessage();
      }
    });

    // idiomas
    if (langOptions && langOptions.length) {
      langOptions.forEach((opt) => {
        opt.addEventListener("click", () => {
          const lang = opt.dataset.lang;
          if (!lang || lang === currentLang) return;

          currentLang = lang;

          langOptions.forEach((o) =>
            o.classList.toggle("active", o === opt)
          );

          applyUILanguage(currentLang);
          setStatus("statusLangCurrent");
          startSessionForCurrentLang(false);
        });
      });
    }

    // mic
    initSpeechRecognition();
    if (micBtn) {
      micBtn.addEventListener("click", toggleMic);
    }

    // TTS toggle
    if (ttsToggle && voicePill) {
      ttsToggle.addEventListener("change", () => {
        setStatus(ttsToggle.checked ? "statusTTSOn" : "statusTTSOff");
      });
      voicePill.addEventListener("click", () => {
        ttsToggle.checked = !ttsToggle.checked;
        setStatus(ttsToggle.checked ? "statusTTSOn" : "statusTTSOff");
      });
    }

    // primera sesi√≥n
    startSessionForCurrentLang(true);
  });
</script>
