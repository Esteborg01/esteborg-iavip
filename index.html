<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Esteborg IA ¬∑ Inteligencia Artificial Aplicada</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      height: 100%;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Inter", sans-serif;
      background: radial-gradient(circle at top, #28224b 0, #050509 55%, #020208 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px 8px 32px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    #app {
      width: 100%;
      max-width: 960px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .shell {
      position: relative;
      border-radius: 32px;
      padding: 26px 26px 22px;
      background:
        radial-gradient(circle at top left, rgba(94, 234, 212, 0.06), transparent 55%),
        radial-gradient(circle at bottom right, rgba(251, 191, 36, 0.09), transparent 55%),
        rgba(3, 7, 18, 0.96);
      box-shadow:
        0 30px 90px rgba(0, 0, 0, 0.95),
        0 0 0 1px rgba(148, 163, 184, 0.28),
        0 0 32px rgba(56, 189, 248, 0.25);
      border: 1px solid rgba(75, 85, 99, 0.75);
      max-height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }

    .banner-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 10px;
    }

    .banner-avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #38bdf8, #4f46e5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 20px;
      color: #ecfeff;
      box-shadow:
        0 0 0 2px rgba(15, 23, 42, 1),
        0 0 0 1px rgba(226, 232, 240, 0.9),
        0 0 32px rgba(96, 165, 250, 0.95);
    }

    .banner-title { display: flex; flex-direction: column; gap: 2px; }

    .banner-title-main {
      font-size: 13px;
      letter-spacing: 0.19em;
      text-transform: uppercase;
      color: rgba(209, 213, 219, 0.96);
    }

    .banner-title-sub {
      font-size: 22px;
      font-weight: 650;
      letter-spacing: 0.02em;
      color: #e5e7eb;
    }

    .banner-description {
      margin-top: 4px;
      font-size: 13px;
      color: rgba(209, 213, 219, 0.92);
    }
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title" id="i-panel-title">
            Mini entrenamiento ¬∑ Esteborg IA ‚Äì Despliega todo tu poder
          </div>
          <div class="panel-badge">
            <span class="dot"></span>
            <span>Members VIP</span>
          </div>
        </div>

        <!-- CHIPS: SESI√ìN -->
        <div class="chips-row">
          <span class="chips-label" id="i-chips-label">Comenzar entrenamiento:</span>

          <button
            class="chip-btn starter"
            id="i-btn-lesson"
            data-text="Quiero aprender Inteligencia Artificial desde cero y empezar por el M√≥dulo 1: Fundamentos de IA."
          >
            Aprender IA desde cero
          </button>

          <button
            class="chip-btn starter"
            id="i-btn-apply"
            data-text="Quiero aplicar la IA en mi trabajo o negocio y dise√±ar contigo un plan pr√°ctico personalizado."
          >
            Aplicar IA en mi trabajo
          </button>

          <button
            class="chip-btn starter"
            id="i-btn-challenge"
            data-text="Ay√∫dame a dominar ChatGPT y modelos generativos para crear contenido, ideas y automatizaciones."
          >
            Dominar ChatGPT y modelos IA
          </button>
        </div>

        <!-- CHIPS: CONTENIDO VISUAL -->
        <div class="content-row">
          <span class="content-label" id="i-content-label">Herramientas del programa:</span>

          <button
            class="content content-btn"
            id="i-btn-slides"
            data-text="Mu√©strame la estructura completa del programa Esteborg IA: m√≥dulos, duraci√≥n, objetivos y resultados."
          >
            Estructura del programa
          </button>

          <button
            class="content content-btn"
            id="i-btn-summary"
            data-text="Quiero que me ayudes a automatizar tareas con IA usando herramientas no-code y flujos inteligentes."
          >
            Automatizar con IA
          </button>
        </div>
        <!-- CHAT -->
        <div class="chat-container">
          <div class="chat-header-row">
            <div class="chat-header-left">
              <div class="chat-node">E</div>
              <div class="chat-title">
                <div id="i-chat-name">Esteborg</div>
                <small id="i-chat-role">Coach profesional de Inteligencia Artificial</small>
              </div>
            </div>

            <div class="chat-language-pill">
              <span class="lang-option active" data-lang="es">ES</span>
              <span class="lang-option" data-lang="en">EN</span>
              <span class="lang-option" data-lang="pt">PT</span>
              <span class="lang-option" data-lang="fr">FR</span>
              <span class="lang-option" data-lang="it">IT</span>
              <span class="lang-option" data-lang="de">DE</span>
            </div>
          </div>

          <div id="chat-log"></div>

          <div class="input-row">
            <textarea
              id="user-input"
              placeholder="Cu√©ntame qu√© quieres lograr con la Inteligencia Artificial en tu trabajo, negocio o proyectos..."
            ></textarea>
            <button id="mic-btn" class="mic-button" title="Hablar con voz">üéôÔ∏è</button>
            <button id="send-btn" class="send-button">ENVIAR</button>
          </div>

          <div class="status-line" id="status-line">
            <span class="status-dot"></span>
            <span>Preparando tu entrenamiento con Esteborg IA...</span>
          </div>

          <div class="voice-row">
            <label class="voice-toggle">
              <input type="checkbox" id="tts-toggle" />
              <span id="i-voice-toggle-label">Voz Esteborg activada</span>
            </label>
            <div class="voice-pill" id="i-voice-pill">üéß Voz Esteborg</div>
          </div>
        </div>

        <!-- FOOTER -->
        <div class="footer-row">
          <div class="footer-left">
            <strong id="i-footer-token-title">Tokken Esteborg Members</strong>
            <span id="i-footer-token-text">
              Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en:
              https://membersvip.esteborg.live/#miembrosvip
            </span>
          </div>
          <div class="footer-right">
            Propiedad de Esteban Manuel Gonz√°lez C√°rdenas ¬∑ Esteborg<br />
            <a href="https://esteborg.com" target="_blank" rel="noopener noreferrer">
              esteborg.com
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // ========== CONFIG ==========
    const API_BASE = "https://esteborg88full-backend-modular.onrender.com";
    const MODULE_PATH = "/api/modules/iavipcom";
    const TTS_URL = API_BASE + "/api/voice";

    /// ========== TOKEN VIP ==========
    let VIP_TOKEN = null;
    const VIP_STORAGE_KEY = "esteborg_vip_token";

    function getVIPTokenFromURL() {
      const params = new URLSearchParams(window.location.search || "");
      const raw =
        params.get("tokken") ||
        params.get("access_token") ||
        params.get("token") ||
        "";
      const trimmed = (raw || "").trim();
      console.log(
        "[IA] Tokken detectado en URL:",
        trimmed ? trimmed.slice(0, 40) + "..." : "(ninguno)"
      );
      return trimmed || null;
    }

    // Tokken que llega del iframe padre (Members / Outseta)
    window.addEventListener("message", (event) => {
      if (!event.data || event.data.type !== "esteborg-token") return;
      const tokken = (event.data.tokken || "").trim();
      if (!tokken) return;
      VIP_TOKEN = tokken;
      console.log(
        "[IA] Tokken recibido por postMessage:",
        VIP_TOKEN.slice(0, 40) + "..."
      );
      try {
        localStorage.setItem(VIP_STORAGE_KEY, VIP_TOKEN);
      } catch (e) {
        console.warn("[IA] No pude guardar Tokken desde postMessage:", e);
      }
    });

    // Tokken inicial: localStorage ‚Üí URL
    document.addEventListener("DOMContentLoaded", () => {
      try {
        const stored = localStorage.getItem(VIP_STORAGE_KEY);
        if (stored && stored.trim()) {
          VIP_TOKEN = stored.trim();
          console.log("[IA] Tokken recuperado de localStorage");
        } else {
          VIP_TOKEN = getVIPTokenFromURL();
        }
      } catch (e) {
        console.warn("[IA] No pude leer localStorage:", e);
        VIP_TOKEN = getVIPTokenFromURL();
      }
    });

    // ========== I18N ==========
    const I18N = {
      es: {
        bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
        bannerSub: "Programa ejecutivo ¬∑ Coach profesional de Inteligencia Artificial",
        bannerDesc:
          "Esteborg IA ‚Äì Despliega todo tu poder es tu programa ejecutivo para dominar la Inteligencia Artificial aplicada. En 3 meses (versi√≥n acelerada) pasar√°s de principiante a avanzado con pr√°ctica guiada y certificaci√≥n AI Executive & Prompt Engineer by Esteborg Institute. Acceso exclusivo mediante Tokken Esteborg Members.",
        panelTitle: "Mini entrenamiento ¬∑ Esteborg IA ‚Äì Despliega todo tu poder",
        chipsLabel: "Comenzar entrenamiento:",
        btnLesson: "Aprender IA desde cero",
        btnLessonText:
          "Quiero aprender Inteligencia Artificial desde cero y empezar por el M√≥dulo 1: Fundamentos de la IA.",
        btnEmotion: "Aplicar IA en mi trabajo",
        btnEmotionText:
          "Quiero aplicar la IA en mi trabajo o negocio y dise√±ar contigo un plan pr√°ctico con tareas concretas.",
        btnChallenge: "Dominar ChatGPT y otras IA",
        btnChallengeText:
          "Quiero dominar ChatGPT y otros modelos generativos para crear contenido, ideas y automatizaciones.",
        contentLabel: "Herramientas del programa:",
        btnSlides: "Ver estructura del programa",
        btnSlidesText:
          "Mu√©strame la estructura completa del programa Esteborg IA ‚Äì Despliega todo tu poder: m√≥dulos, duraci√≥n, objetivos y resultados.",
        btnSummary: "Automatizar tareas con IA",
        btnSummaryText:
          "Quiero que me ayudes a automatizar tareas con IA usando herramientas no-code, agentes y flujos inteligentes para mi trabajo diario.",
        inputPlaceholder:
          "Cu√©ntame qu√© quieres lograr con la Inteligencia Artificial en tu trabajo, negocio o proyectos...",
        footerTokenTitle: "Tokken Esteborg Members",
        footerTokenText:
          "Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip",
        chatName: "Esteborg",
        chatRole: "Coach profesional de Inteligencia Artificial",
        voiceToggleLabel: "Voz Esteborg activada",
        voicePillLabel: "üéß Voz Esteborg",
        sendButtonLabel: "ENVIAR",
        statusInitialWithToken:
          "Detect√© un Tokken en la URL o guardado ¬∑ lo usar√© autom√°ticamente en tu entrenamiento premium.",
        statusInitialNoToken:
          "Acceso pendiente ¬∑ necesitas tu Tokken Esteborg Members para activar el entrenamiento completo.",
        statusTokenManual:
          "Tokken pegado manualmente ¬∑ usar√© ese Tokken en tu entrenamiento.",
        statusTokenValid: "Modo Members activo ¬∑ Tokken VIP v√°lido.",
        statusTokenInvalid:
          "Tokken inv√°lido o expirado ¬∑ genera uno nuevo en Members para continuar tu entrenamiento.",
        statusDemoEnded:
          "Tu acceso actual ha terminado ¬∑ renueva tu Tokken Esteborg Members para continuar con Esteborg IA.",
        statusDemoActive:
          "Esperando Tokken Esteborg Members ¬∑ cuando lo generes, lo usar√© autom√°ticamente.",
        statusListening: "Escuchando... habla ahora.",
        statusProcessingSpeech: "Procesando lo que dijiste...",
        statusMicError:
          "Hubo un problema con el micr√≥fono, intenta de nuevo.",
        statusTextCaptured:
          "Texto capturado, puedes enviarlo o editarlo.",
        statusTTSOn: "Voz Esteborg activada.",
        statusTTSOff: "Voz Esteborg desactivada.",
        statusLangCurrent: "Idioma cambiado a espa√±ol.",
        tokenPasteReply:
          "Perfecto, ya tengo tu Tokken Esteborg Members ‚úÖ\nAhora dime: ¬øquieres que construyamos tu entrenamiento en IA en \"espa√±ol\", \"ingl√©s\", \"portugu√©s\", \"franc√©s\", \"italiano\" o \"alem√°n\"?",
        tokenWelcomeMessage:
          "‚úÖ Tu Tokken Esteborg Members est√° validado.\nEst√°s en modo Members VIP, as√≠ que trabajaremos tu programa Esteborg IA ‚Äì Despliega todo tu poder con acceso completo a m√≥dulos, pr√°cticas y certificaci√≥n.",
        welcomeMessage:
          "¬°Qu√© gusto saludarte! üòä Antes de entrar a tu entrenamiento necesito tu Tokken Esteborg Members para validar tu acceso.\n\nSi a√∫n no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip\n\nUna vez que tengas tu Tokken, p√©galo aqu√≠ o accede desde tu panel Members VIP. Despu√©s elige el idioma en la parte superior (ES, EN, PT, FR, IT, DE) y comenzamos."
      },

      en: {
        bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
        bannerSub: "Executive Program ¬∑ Professional Artificial Intelligence Coach",
        bannerDesc:
          "Esteborg IA ‚Äì Unleash all your power is your executive program to master applied Artificial Intelligence. In 3 months (accelerated version) you go from beginner to advanced with guided practice and the AI Executive & Prompt Engineer certification by Esteborg Institute. Access is exclusive via Esteborg Members Token.",
        panelTitle: "Mini Training ¬∑ Esteborg IA ‚Äì Unleash all your power",
        chipsLabel: "Start training:",
        btnLesson: "Learn AI from scratch",
        btnLessonText:
          "I want to learn Artificial Intelligence from scratch and start with Module 1: AI Fundamentals.",
        btnEmotion: "Apply AI to my work",
        btnEmotionText:
          "I want to apply AI to my job or business and design a practical, step-by-step plan with you.",
        btnChallenge: "Master ChatGPT and other AIs",
        btnChallengeText:
          "I want to master ChatGPT and other generative models to create content, ideas and automations.",
        contentLabel: "Program tools:",
        btnSlides: "View program structure",
        btnSlidesText:
          "Show me the full structure of the Esteborg IA ‚Äì Unleash all your power program: modules, duration, objectives and outcomes.",
        btnSummary: "Automate tasks with AI",
        btnSummaryText:
          "Help me automate tasks with AI using no-code tools, agents and smart workflows in my daily work.",
        inputPlaceholder:
          "Tell me what you want to achieve with Artificial Intelligence in your job, business or projects...",
        footerTokenTitle: "Esteborg Members Token",
        footerTokenText:
          "If you don‚Äôt have a token yet, you can get or recover it at: https://membersvip.esteborg.live/#miembrosvip",
        chatName: "Esteborg",
        chatRole: "Professional AI Coach",
        voiceToggleLabel: "Esteborg voice enabled",
        voicePillLabel: "üéß Esteborg voice",
        sendButtonLabel: "SEND",
        statusInitialWithToken:
          "I detected a Token in the URL or stored locally ¬∑ I‚Äôll use it automatically in your premium training.",
        statusInitialNoToken:
          "Access pending ¬∑ you need your Esteborg Members Token to activate the full training.",
        statusTokenManual:
          "Token pasted manually ¬∑ I‚Äôll use that token in your training.",
        statusTokenValid: "Members mode active ¬∑ VIP token valid.",
        statusTokenInvalid:
          "Invalid or expired token ¬∑ generate a new one in Members to continue your training.",
        statusDemoEnded:
          "Your current access has ended ¬∑ renew your Esteborg Members Token to continue with Esteborg IA.",
        statusDemoActive:
          "Waiting for your Esteborg Members Token ¬∑ once you generate it, I‚Äôll use it automatically.",
        statusListening: "Listening... speak now.",
        statusProcessingSpeech: "Processing what you said...",
        statusMicError:
          "There was a problem with the microphone, please try again.",
        statusTextCaptured:
          "Text captured, you can send or edit it.",
        statusTTSOn: "Esteborg voice enabled.",
        statusTTSOff: "Esteborg voice disabled.",
        statusLangCurrent: "Language set to English.",
        tokenPasteReply:
          "Perfect, I‚Äôve got your Esteborg Members Token ‚úÖ\nNow tell me: do you want us to build your AI training in Spanish, English, Portuguese, French, Italian or German?",
        tokenWelcomeMessage:
          "‚úÖ Your Esteborg Members Token is validated.\nYou‚Äôre in Members VIP mode, so we‚Äôll work through your Esteborg IA ‚Äì Unleash all your power program with full access to modules, practice and certification.",
        welcomeMessage:
          "Great to have you here! üòä Before we start your training I need your Esteborg Members Token to validate your access.\n\nIf you don‚Äôt have a token yet, you can get or recover it at: https://membersvip.esteborg.live/#miembrosvip\n\nOnce you have your token, paste it here or log in through your Members VIP panel. Then choose your language at the top (ES, EN, PT, FR, IT, DE) and we‚Äôll get started."
      },

      pt: {
        bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
        bannerSub: "Programa executivo ¬∑ Coach profissional de Intelig√™ncia Artificial",
        bannerDesc:
          "Esteborg IA ‚Äì Liberte todo o seu poder √© o seu programa executivo para dominar Intelig√™ncia Artificial aplicada. Em 3 meses (vers√£o acelerada) voc√™ vai de iniciante a avan√ßado com pr√°tica guiada e certifica√ß√£o AI Executive & Prompt Engineer pelo Esteborg Institute. Acesso exclusivo com Tokken Esteborg Members.",
        panelTitle: "Mini treinamento ¬∑ Esteborg IA ‚Äì Liberte todo o seu poder",
        chipsLabel: "Iniciar treinamento:",
        btnLesson: "Aprender IA do zero",
        btnLessonText:
          "Quero aprender Intelig√™ncia Artificial do zero e come√ßar pelo M√≥dulo 1: Fundamentos de IA.",
        btnEmotion: "Aplicar IA no meu trabalho",
        btnEmotionText:
          "Quero aplicar IA no meu trabalho ou neg√≥cio e desenhar com voc√™ um plano pr√°tico com tarefas concretas.",
        btnChallenge: "Dominar ChatGPT e outras IAs",
        btnChallengeText:
          "Quero dominar o ChatGPT e outros modelos generativos para criar conte√∫do, ideias e automa√ß√µes.",
        contentLabel: "Ferramentas do programa:",
        btnSlides: "Ver estrutura do programa",
        btnSlidesText:
          "Mostre-me a estrutura completa do programa Esteborg IA ‚Äì Liberte todo o seu poder: m√≥dulos, dura√ß√£o, objetivos e resultados.",
        btnSummary: "Automatizar tarefas com IA",
        btnSummaryText:
          "Quero que voc√™ me ajude a automatizar tarefas com IA usando ferramentas no-code, agentes e fluxos inteligentes no meu dia a dia.",
        inputPlaceholder:
          "Conte-me o que voc√™ quer alcan√ßar com Intelig√™ncia Artificial no seu trabalho, neg√≥cio ou projetos...",
        footerTokenTitle: "Tokken Esteborg Members",
        footerTokenText:
          "Se voc√™ ainda n√£o tem tokken, pode obt√™-lo ou recuper√°-lo em: https://membersvip.esteborg.live/#miembrosvip",
        chatName: "Esteborg",
        chatRole: "Coach profissional em IA",
        voiceToggleLabel: "Voz Esteborg ativada",
        voicePillLabel: "üéß Voz Esteborg",
        sendButtonLabel: "ENVIAR",
        statusInitialWithToken:
          "Detectei um Tokken na URL ou salvo localmente ¬∑ vou us√°-lo automaticamente no seu treinamento premium.",
        statusInitialNoToken:
          "Acesso pendente ¬∑ voc√™ precisa do seu Tokken Esteborg Members para ativar o treinamento completo.",
        statusTokenManual:
          "Tokken colado manualmente ¬∑ vou usar esse Tokken no seu treinamento.",
        statusTokenValid: "Modo Members ativo ¬∑ Tokken VIP v√°lido.",
        statusTokenInvalid:
          "Tokken inv√°lido ou expirado ¬∑ gere um novo em Members para continuar seu treinamento.",
        statusDemoEnded:
          "Seu acesso atual terminou ¬∑ renove o seu Tokken Esteborg Members para continuar com Esteborg IA.",
        statusDemoActive:
          "Aguardando o seu Tokken Esteborg Members ¬∑ assim que voc√™ gerar, vou us√°-lo automaticamente.",
        statusListening: "Ouvindo... pode falar agora.",
        statusProcessingSpeech: "Processando o que voc√™ disse...",
        statusMicError:
          "Houve um problema com o microfone, tente novamente.",
        statusTextCaptured:
          "Texto capturado, voc√™ pode enviar ou editar.",
        statusTTSOn: "Voz Esteborg ativada.",
        statusTTSOff: "Voz Esteborg desativada.",
        statusLangCurrent: "Idioma alterado para portugu√™s.",
        tokenPasteReply:
          "Perfeito, j√° tenho o seu Tokken Esteborg Members ‚úÖ\nAgora me diga: voc√™ quer que a gente construa o seu treinamento em IA em espanhol, ingl√™s, portugu√™s, franc√™s, italiano ou alem√£o?",
        tokenWelcomeMessage:
          "‚úÖ Seu Tokken Esteborg Members est√° validado.\nVoc√™ est√° em modo Members VIP, ent√£o vamos trabalhar o seu programa Esteborg IA ‚Äì Liberte todo o seu poder com acesso completo a m√≥dulos, pr√°ticas e certifica√ß√£o.",
        welcomeMessage:
          "Que bom ter voc√™ aqui! üòä Antes de come√ßarmos o seu treinamento eu preciso do seu Tokken Esteborg Members para validar o acesso.\n\nSe voc√™ ainda n√£o tem tokken, pode obt√™-lo ou recuper√°-lo em: https://membersvip.esteborg.live/#miembrosvip\n\nDepois que tiver o tokken, cole aqui ou acesse pelo painel Members VIP. Em seguida escolha o idioma no topo (ES, EN, PT, FR, IT, DE) e come√ßamos."
      },

      // FR, IT, DE siguen el mismo patr√≥n textual adaptado a cada idioma
      // (puedes copiarlos de tu versi√≥n IA previa si quieres 1:1)
    };
    // ========== HELPERS: traducci√≥n r√°pida ==========
    function t(key, langOverride = null) {
      const lang = langOverride || currentLang;
      const pack = I18N[lang] || I18N["es"];
      return pack[key] || key;
    }

    // ========== UI ELEMENTS ==========
    const elChatLog = document.getElementById("chat-log");
    const elUserInput = document.getElementById("user-input");
    const elStatus = document.getElementById("status-line").querySelector("span:last-child");
    const elTTS = document.getElementById("tts-toggle");
    const elSend = document.getElementById("send-btn");
    const elMic = document.getElementById("mic-btn");

    const langButtons = document.querySelectorAll(".lang-option");

    let currentLang = "es";
    let isProcessing = false;
    let listening = false;
    let ttsPlaying = false;
    let ttsAudio = null;

    // ========== APPEND MESSAGE ==========
    function appendMessage(role, text) {
      const row = document.createElement("div");
      row.className = role === "assistant" ? "msg-row assistant" : "msg-row user";

      const tag = document.createElement("div");
      tag.className = "msg-tag " + role;
      tag.textContent = role === "assistant" ? "E" : "T√∫";

      const bubble = document.createElement("div");
      bubble.className = "msg-bubble";
      const span = document.createElement("div");
      span.className = "msg-text";
      span.textContent = text;
      bubble.appendChild(span);

      row.appendChild(tag);
      row.appendChild(bubble);
      elChatLog.appendChild(row);
      elChatLog.scrollTop = elChatLog.scrollHeight;
    }

    // ========== STATUS ==========
    function setStatus(text) {
      elStatus.textContent = text;
    }

    // ========== STOP TTS ==========
    function stopTTS() {
      if (ttsAudio) {
        try { ttsAudio.pause(); } catch (e) {}
        ttsAudio = null;
      }
      ttsPlaying = false;
    }

    // ========== PLAY TTS ==========
    async function playTTS(text, lang = currentLang) {
      if (!elTTS.checked) return;

      stopTTS();

      try {
        const res = await fetch(TTS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, lang })
        });

        if (!res.ok) return;

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        ttsAudio = new Audio(url);
        ttsAudio.play();
        ttsPlaying = true;

        ttsAudio.onended = () => {
          ttsPlaying = false;
        };
      } catch (e) {
        console.warn("TTS error:", e);
      }
    }

    // ========== APPLY UI LANGUAGE ==========
    function applyUILanguage(lang) {
      currentLang = lang;

      const pack = I18N[lang] || I18N["es"];

      document.getElementById("i-banner-main").textContent = pack.bannerMain;
      document.getElementById("i-banner-sub").textContent = pack.bannerSub;
      document.getElementById("i-banner-desc").textContent = pack.bannerDesc;
      document.getElementById("i-panel-title").textContent = pack.panelTitle;

      document.getElementById("i-chips-label").textContent = pack.chipsLabel;
      document.getElementById("i-content-label").textContent = pack.contentLabel;

      document.getElementById("i-btn-lesson").textContent = pack.btnLesson;
      document.getElementById("i-btn-apply").textContent = pack.btnEmotion;
      document.getElementById("i-btn-challenge").textContent = pack.btnChallenge;

      document.getElementById("i-btn-slides").textContent = pack.btnSlides;
      document.getElementById("i-btn-summary").textContent = pack.btnSummary;

      document.getElementById("user-input").placeholder = pack.inputPlaceholder;

      document.getElementById("i-footer-token-title").textContent = pack.footerTokenTitle;
      document.getElementById("i-footer-token-text").textContent = pack.footerTokenText;
      document.getElementById("i-chat-name").textContent = pack.chatName;
      document.getElementById("i-chat-role").textContent = pack.chatRole;

      document.getElementById("i-voice-toggle-label").textContent = pack.voiceToggleLabel;
      document.getElementById("i-voice-pill").textContent = pack.voicePillLabel;
      document.getElementById("send-btn").textContent = pack.sendButtonLabel;

      setStatus(pack.statusLangCurrent);
    }

    // ========== LANG BUTTON EVENTS ==========
    langButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        langButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        applyUILanguage(btn.dataset.lang);
      });
    });

    // ========== INICIAL: MENSAJE DE BIENVENIDA ==========
    function startSessionForCurrentLang() {
      const pack = I18N[currentLang] || I18N["es"];

      // Mostrar mensaje inicial sin tag de usuario
      appendMessage("assistant", pack.welcomeMessage);
      playTTS(pack.welcomeMessage);
    }

    // ========== ENVIAR A GPT BACKEND ==========
    async function sendToGPT(text) {
      if (!text || !text.trim()) return;
      if (isProcessing) return;

      isProcessing = true;

      appendMessage("user", text);
      elUserInput.value = "";

      setStatus("Procesando...");

      try {
        const res = await fetch(API_BASE + MODULE_PATH, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: VIP_TOKEN ? `Bearer ${VIP_TOKEN}` : ""
          },
          body: JSON.stringify({
            message: text,
            lang: currentLang
          })
        });

        const data = await res.json();

        const reply = data.reply || "‚Ä¶";

        appendMessage("assistant", reply);
        playTTS(reply);

        // Estado del Tokken
        if (data.token_status === "valid") {
          setStatus(t("statusTokenValid"));
        } else if (data.token_status === "invalid") {
          setStatus(t("statusTokenInvalid"));
        } else {
          setStatus("");
        }
      } catch (e) {
        appendMessage("assistant", "Hubo un error. Intenta de nuevo.");
      }

      isProcessing = false;
    }

    // ========== SEND BUTTON ==========
    elSend.addEventListener("click", () => {
      sendToGPT(elUserInput.value.trim());
    });

    // ENTER KEY
    elUserInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendToGPT(elUserInput.value.trim());
      }
    });

    // ========== CHIPS: STARTER BUTTONS ==========
    function connectStarterButtons() {
      document.querySelectorAll(".starter").forEach((btn) => {
        btn.addEventListener("click", () => {
          const text = btn.dataset.text || "";
          sendToGPT(text);
        });
      });

      document.querySelectorAll(".content-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const text = btn.dataset.text || "";
          sendToGPT(text);
        });
      });
    }

    connectStarterButtons();

    // ========== MIC (DESACTIVADO POR AHORA, COMPATIBLE CON COM7) ==========
    elMic.addEventListener("click", () => {
      setStatus(t("statusMicError"));
    });

    // ========== ARRANQUE ==========
    document.addEventListener("DOMContentLoaded", () => {
      applyUILanguage(currentLang);

      const hasToken = !!VIP_TOKEN;

      if (hasToken) {
        setStatus(t("statusInitialWithToken"));
      } else {
        setStatus(t("statusInitialNoToken"));
      }

      startSessionForCurrentLang();
    });
  </script>
</body>
</html>
