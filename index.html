<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Esteborg IA - Despliega todo tu poder</title>

  <style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; }

  body {
    margin: 0;
    height: 100%;
    min-height: 100vh;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
      "Inter", sans-serif;
    background: radial-gradient(circle at top, #28224b 0, #050509 55%, #020208 100%);
    color: #f5f5ff;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 16px 8px 32px; /* compacto, igual que Com7 */
    overflow: hidden;
  }

  .app {
    width: 100%;
    max-width: 960px;  /* ancho gemelo a Com7 */
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .shell {
    position: relative;
    border-radius: 32px;
    padding: 26px 26px 22px;
    background:
      radial-gradient(circle at top left, rgba(94, 234, 212, 0.06), transparent 55%),
      radial-gradient(circle at bottom right, rgba(251, 191, 36, 0.09), transparent 55%),
      rgba(3, 7, 18, 0.96);
    box-shadow:
      0 30px 90px rgba(0, 0, 0, 0.95),
      0 0 0 1px rgba(148, 163, 184, 0.28),
      0 0 32px rgba(56, 189, 248, 0.25);
    border: 1px solid rgba(75, 85, 99, 0.75);
  }

  .banner-header {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 10px;
  }
  .banner-avatar {
    width: 40px;
    height: 40px;
    border-radius: 999px;
    background: radial-gradient(circle at top, #38bdf8, #4f46e5);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 20px;
    color: #ecfeff;
    box-shadow:
      0 0 0 2px rgba(15, 23, 42, 1),
      0 0 0 1px rgba(226, 232, 240, 0.9),
      0 0 32px rgba(96, 165, 250, 0.95);
  }

  .banner-title {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .banner-title-main {
    font-size: 13px;
    letter-spacing: 0.19em;
    text-transform: uppercase;
    color: rgba(209, 213, 219, 0.96);
  }
  .banner-title-sub {
    font-size: 22px;
    font-weight: 650;
    letter-spacing: 0.02em;
    color: #e5e7eb;
  }

  .banner-description {
    margin-top: 4px;
    font-size: 13px;
    color: rgba(209, 213, 219, 0.92);
  }

  .panel {
    margin-top: 18px;
    border-radius: 22px;
    padding: 14px 16px 14px;
    background:
      linear-gradient(
        145deg,
        rgba(15, 23, 42, 0.96),
        rgba(15, 23, 42, 0.85)
      );
    border: 1px solid rgba(148, 163, 184, 0.8);
    box-shadow:
      inset 0 0 0 1px rgba(15, 23, 42, 0.96),
      0 18px 40px rgba(15, 23, 42, 0.95);
  }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 10px;
  }
  .panel-title {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: rgba(148, 163, 184, 0.95);
  }
  .panel-badge {
    border-radius: 999px;
    padding: 4px 10px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    border: 1px solid rgba(52, 211, 153, 0.6);
    color: #a7f3d0;
    background: radial-gradient(circle at top left, rgba(16, 185, 129, 0.35), rgba(15, 23, 42, 0.98));
  }
  .panel-badge .dot {
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: radial-gradient(circle at center, #22c55e, #15803d);
    box-shadow: 0 0 12px rgba(34, 197, 94, 0.95);
  }

  .chips-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
    font-size: 11px;
    color: rgba(156, 163, 175, 0.95);
  }
  .chips-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: rgba(148, 163, 184, 0.98);
  }
  .chip-btn {
    border-radius: 999px;
    border: 1px solid rgba(129, 140, 248, 0.9);
    background: radial-gradient(circle at top, rgba(79, 70, 229, 0.95), rgba(30, 64, 175, 0.98));
    color: #e5e7eb;
    padding: 4px 11px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow:
      0 10px 22px rgba(15, 23, 42, 0.95),
      0 0 0 1px rgba(191, 219, 254, 0.35);
  }

  .content-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-bottom: 12px;
  }
  .content-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: rgba(148, 163, 184, 0.98);
  }
  .content-btn {
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.9);
    background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.86));
    color: rgba(209, 213, 219, 0.98);
    padding: 4px 10px;
    font-size: 11px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  /* CHAT */
  .chat-container {
    margin-top: 10px;
    border-radius: 20px;
    padding: 10px 10px 12px;
    background:
      radial-gradient(circle at top left, rgba(96, 165, 250, 0.07), transparent 55%),
      radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.09), transparent 55%),
      rgba(15, 23, 42, 0.98);
    border: 1px solid rgba(55, 65, 81, 0.95);
    box-shadow:
      inset 0 0 0 1px rgba(15, 23, 42, 1),
      0 20px 42px rgba(15, 23, 42, 0.98);

    display: flex;
    flex-direction: column;
    max-height: 540px;
    overflow: hidden;
  }

  .chat-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2px 2px 6px;
  }
  .chat-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .chat-node {
    width: 22px;
    height: 22px;
    border-radius: 999px;
    border: 1px solid rgba(191, 219, 254, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 700;
    color: #e5e7eb;
    background: radial-gradient(circle at top, #4f46e5, #0ea5e9);
    box-shadow:
      0 0 0 1px rgba(15, 23, 42, 1),
      0 0 18px rgba(129, 140, 248, 0.95);
  }
  .chat-title {
    display: flex;
    flex-direction: column;
    gap: 0;
    font-size: 12px;
    color: #e5e7eb;
  }
  .chat-title small {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    color: rgba(148, 163, 184, 0.95);
  }

  .chat-language-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    border-radius: 999px;
    padding: 3px 7px;
    border: 1px solid rgba(248, 250, 252, 0.3);
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.9));
    font-size: 11px;
    color: rgba(229, 231, 235, 0.98);
  }
  .lang-option {
    padding: 1px 6px;
    border-radius: 999px;
    border: 1px solid rgba(55, 65, 81, 0.9);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    cursor: pointer;
  }
  .lang-option.active {
    border-color: rgba(96, 165, 250, 0.95);
    background: radial-gradient(circle at top, rgba(59, 130, 246, 0.9), rgba(15, 23, 42, 0.9));
  }

  /* CHAT BOX */
  #chat-log {
    margin-top: 8px;
    border-radius: 18px;
    background: rgba(5, 7, 18, 0.96);
    border: 1px solid rgba(51, 65, 85, 0.9);
    padding: 12px;

    flex: 1;
    min-height: 200px;
    max-height: none;
    overflow-y: auto;

    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .msg-row {
    display: flex;
    align-items: flex-start;
    gap: 6px;
  }
  .msg-row.user { justify-content: flex-end; }
  .msg-tag {
    font-size: 11px;
    border-radius: 999px;
    padding: 2px 7px;
    border: 1px solid rgba(148, 163, 184, 0.7);
    opacity: 0.9;
    white-space: nowrap;
  }
  .msg-tag.user {
    color: rgba(248, 250, 252, 0.96);
    border-color: rgba(248, 250, 252, 0.6);
  }
  .msg-tag.assistant {
    color: rgba(52, 211, 153, 0.96);
    border-color: rgba(52, 211, 153, 0.7);
  }
  .msg-bubble {
    max-width: 88%;
    padding: 8px 12px;
    border-radius: 14px;
    font-size: 17px;
    line-height: 1.5;
    border: 1px solid transparent;
  }
  .msg-row.user .msg-bubble {
    border-radius: 14px 14px 3px 14px;
    background: linear-gradient(135deg, #1d4ed8, #4c1d95);
    border-color: rgba(191, 219, 254, 0.4);
    color: #e5e7eb;
  }
  .msg-row.assistant .msg-bubble {
    border-radius: 14px 14px 14px 3px;
    background: linear-gradient(135deg, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.92));
    border-color: rgba(55, 65, 81, 0.9);
    color: #e5e7eb;
  }
  .msg-text {
    white-space: pre-wrap;
  }

  .input-row {
    margin-top: 10px;
    display: grid;
    grid-template-columns: minmax(0, 1fr) auto auto;
    gap: 8px;
    align-items: stretch;
  }
  .input-row textarea {
    resize: none;
    border-radius: 999px;
    border: 1px solid rgba(75, 85, 99, 0.95);
    background: radial-gradient(circle at top, rgba(3, 7, 18, 0.98), rgba(3, 7, 18, 0.95));
    color: #e5e7eb;
    padding: 10px 14px;
    font-size: 14px;
    min-height: 44px;
    max-height: 84px;
    line-height: 1.4;
    outline: none;
    box-shadow:
      0 0 0 1px rgba(15, 23, 42, 0.9),
      0 14px 24px rgba(15, 23, 42, 0.98);
  }
  .input-row textarea::placeholder {
    color: rgba(148, 163, 184, 0.95);
  }

  .send-button,
  .mic-button {
    border-radius: 999px;
    border: none;
    padding: 0 18px;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    white-space: nowrap;
  }
  .send-button {
    background: radial-gradient(circle at top left, #facc15, #f97316);
    color: #111827;
    box-shadow:
      0 12px 24px rgba(248, 184, 75, 0.85),
      0 0 0 1px rgba(251, 191, 36, 0.9);
  }
  .mic-button {
    background: radial-gradient(circle at top left, #0ea5e9, #4f46e5);
    color: #e0f2fe;
    box-shadow:
      0 12px 24px rgba(56, 189, 248, 0.7),
      0 0 0 1px rgba(191, 219, 254, 0.7);
    font-size: 18px;
    padding: 0 14px;
  }
  .mic-button.active {
    box-shadow:
      0 0 0 1px rgba(96, 165, 250, 0.95),
      0 0 22px rgba(56, 189, 248, 1);
  }

  .status-line {
    margin-top: 6px;
    font-size: 11px;
    color: rgba(148, 163, 184, 0.96);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .status-dot {
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: radial-gradient(circle at center, #22c55e, #15803d);
    box-shadow: 0 0 10px rgba(34, 197, 94, 0.95);
    transform: translateY(-0.5px);
  }

  .voice-row {
    margin-top: 6px;
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: rgba(226, 232, 240, 0.96);
  }
  .voice-toggle {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .voice-toggle input {
    accent-color: #facc15;
  }
  .voice-pill {
    border-radius: 999px;
    padding: 3px 8px;
    border: 1px solid rgba(251, 191, 36, 0.75);
    background: radial-gradient(circle at top, rgba(250, 204, 21, 0.85), rgba(15, 23, 42, 0.95));
    color: #111827;
    font-weight: 600;
    font-size: 11px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  /* FOOTER */
  .footer-row {
    margin-top: 10px;
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: center;
    font-size: 11px;
    color: rgba(148, 163, 184, 0.95);
  }
  .footer-left {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .footer-left strong {
    font-weight: 600;
    color: rgba(229, 231, 235, 0.96);
  }
  .footer-right {
    font-size: 10px;
    color: rgba(148, 163, 184, 0.9);
    text-align: right;
  }
  .footer-right a {
    color: #a5b4fc;
    text-decoration: none;
  }

  @media (max-width: 720px) {
    .shell {
      padding: 20px 16px;
      border-radius: 24px;
    }
    #app {
      padding: 18px 10px 26px;
    }
    .banner-title-sub {
      font-size: 18px;
    }
    .panel {
      padding: 12px 12px 14px;
    }
    .chat-container {
      margin-top: 8px;
    }
  }
</style>
</head>
<body>
  <div id="app">
    <div class="shell">
      
      <!-- HEADER -->
      <div class="banner-header">
        <div class="banner-avatar">E</div>
        <div class="banner-title">
          <div class="banner-title-main" id="i-banner-main">
            ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP
          </div>
          <div class="banner-title-sub" id="i-banner-sub">
            Entrenamiento ejecutivo en IA aplicada
          </div>
        </div>
      </div>

      <div class="banner-description" id="i-banner-desc">
        Esteborg IA es tu copiloto ejecutivo de inteligencia artificial. Aqu√≠ dise√±amos tu plan estrat√©gico, optimizamos tu negocio y entrenamos tus habilidades ejecutivas con IA.
      </div>

      <!-- PANEL PRINCIPAL -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title" id="i-panel-title">
            Inicio del entrenamiento ¬∑ Copiloto Ejecutivo IA
          </div>
          <div class="panel-badge">
            <span class="dot"></span>
            <span>Members VIP</span>
          </div>
        </div>

        <!-- CHIPS: INTENCIONES -->
        <div class="chips-row">
          <span class="chips-label" id="i-chips-label">Quiero empezar:</span>

          <button
            class="chip-btn starter"
            id="i-btn-automation"
            data-text="Quiero usar IA para automatizar tareas repetitivas del d√≠a a d√≠a."
          >
            Automatizar tareas
          </button>

          <button
            class="chip-btn starter"
            id="i-btn-decisions"
            data-text="Quiero que la IA me ayude a tomar mejores decisiones ejecutivas."
          >
            Decisiones ejecutivas
          </button>

          <button
            class="chip-btn starter"
            id="i-btn-business"
            data-text="Quiero lanzar una nueva l√≠nea de negocio apalancando IA generativa."
          >
            Nueva l√≠nea de negocio
          </button>

          <button
            class="chip-btn starter"
            id="i-btn-master"
            data-text="Quiero dominar ChatGPT y otras IA en mi trabajo diario."
          >
            Dominar IA diaria
          </button>
        </div>

        <!-- CHIPS: CONTENIDO VISUAL -->
        <div class="content-row">
          <span class="content-label" id="i-content-label">Material:</span>
          <button
            class="content content-btn"
            id="i-btn-slides"
            data-text="Mu√©strame las diapositivas ejecutivas para este m√≥dulo de IA."
          >
            Diapositivas
          </button>
          <button
            class="content content-btn"
            id="i-btn-summary"
            data-text="Dame un resumen descargable del entrenamiento IA de hoy."
          >
            Resumen IA
          </button>
        </div>

        <!-- CHAT -->
        <div class="chat-container">
          <div class="chat-header-row">
            <div class="chat-header-left">
              <div class="chat-node">E</div>
              <div class="chat-title">
                <div id="i-chat-name">Esteborg IA</div>
                <small id="i-chat-role">Copiloto Ejecutivo IA</small>
              </div>
            </div>

            <div class="chat-language-pill">
              <span class="lang-option active" data-lang="es">ES</span>
              <span class="lang-option" data-lang="en">EN</span>
              <span class="lang-option" data-lang="pt">PT</span>
              <span class="lang-option" data-lang="fr">FR</span>
              <span class="lang-option" data-lang="it">IT</span>
              <span class="lang-option" data-lang="de">DE</span>
            </div>
          </div>

          <div id="chat-log"></div>

          <!-- INPUT -->
          <div class="input-row">
            <textarea
              id="user-input"
              placeholder="Cu√©ntame qu√© quieres lograr con IA en los pr√≥ximos 90 d√≠as..."
            ></textarea>

            <button id="mic-btn" class="mic-button" title="Hablar con voz">
              üéôÔ∏è
            </button>

            <button id="send-btn" class="send-button">ENVIAR</button>
          </div>

          <!-- STATUS -->
          <div class="status-line" id="status-line">
            <span class="status-dot"></span>
            <span>Preparando tu entrenamiento con Esteborg IA...</span>
          </div>

          <!-- VOZ -->
          <div class="voice-row">
            <label class="voice-toggle">
              <input type="checkbox" id="tts-toggle" />
              <span id="i-voice-toggle-label">Voz Esteborg IA activada</span>
            </label>
            <div class="voice-pill" id="i-voice-pill">üéß Voz Esteborg IA</div>
          </div>
        </div>

        <!-- FOOTER -->
        <div class="footer-row">
          <div class="footer-left">
            <strong id="i-footer-token-title">Tokken Esteborg Members</strong>
            <span id="i-footer-token-text">
              Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en:
              https://membersvip.esteborg.live/#miembrosvip
            </span>
          </div>
          <div class="footer-right">
            Propiedad de Esteban Manuel Gonz√°lez C√°rdenas ¬∑ Esteborg<br />
            <a href="https://esteborg.com" target="_blank" rel="noopener">esteborg.com</a>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
  const doc = document;

  const chatBox = doc.getElementById("chatBox");
  const userMsgInput = doc.getElementById("userMsg");
  const sendBtn = doc.getElementById("sendBtn");
  const sendLabelEl = doc.getElementById("sendLabel");
  const demoStatusEl = doc.getElementById("demoStatus");
  const demoStatusLabelEl = doc.getElementById("demoStatusLabel");
  const heroTitleEl = doc.getElementById("heroTitle");
  const heroSubEl = doc.getElementById("heroSub");
  const chatTitleEl = doc.getElementById("chatTitle");
  const chatSubtitleEl = doc.getElementById("chatSubtitle");
  const chatModeLabelEl = doc.getElementById("chatModeLabel");
  const demoNoteEl = doc.getElementById("demoNote");
  const langPillContainer = doc.getElementById("langPills");
  const starterRowEl = doc.getElementById("starterRow");
  const starterLabelEl = doc.getElementById("starterLabel");
  const tokenStatusEl = doc.getElementById("tokenStatus");
  const micBtn = doc.getElementById("micBtn");
  const voiceToggleBtn = doc.getElementById("voiceToggle");
  const voiceLabelEl = doc.getElementById("voiceLabel");

  const API_BASE = "https://esteborg88full-backend-modular.onrender.com";
  const API_URL = `${API_BASE}/api/modules/iavipcom`;

  let history = [];
  let isSending = false;
  let demoEnded = false;
  let userName = null;
  let introStep = 1; // 1: Tokken, 2: nombre+objetivo, 3+: conversaci√≥n
  let currentLang = "es";

  let storedToken = null;
  let voiceEnabled = false;

  const UI_STRINGS = {
    es: {
      heroTitleHTML:
        "Entrenamiento ejecutivo en <span>Inteligencia Artificial aplicada</span><br/>" +
        "para desplegar todo tu poder.",
      heroSubHTML:
        "Programa Esteborg IA Executive ¬∑ 3 meses, 100% online, con certificaci√≥n " +
        "<strong>AI Executive &amp; Prompt Engineer</strong> by Esteborg Institute.",
      chatTitle: "Esteborg IA ¬∑ Copiloto Ejecutivo",
      chatSubtitle:
        "Primero validamos tu Tokken Esteborg Members y te conozco por tu nombre. " +
        "Despu√©s dise√±amos juntos tu plan de 90 d√≠as con IA.",
      chatModeLabel: "Acceso Members VIP",
      inputPlaceholder: "Pega aqu√≠ tu Tokken Esteborg Members...",
      sendLabel: "Enviar",
      demoStatusInitial: "Esperando tu Tokken Esteborg Members",
      demoNoteHTML:
        "Si a√∫n no tienes Tokken, puedes obtenerlo o recuperarlo en: " +
        '<a href="https://membersvip.esteborg.live/#miembrosvip" target="_blank" rel="noopener noreferrer">' +
        "https://membersvip.esteborg.live/#miembrosvip</a>.",
      initialAssistant:
        "¬°Qu√© gusto saludarte! üòä Antes de entrar a tu entrenamiento necesito tu Tokken Esteborg Members para validar tu acceso.\n\n" +
        "Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en:\n" +
        "https://membersvip.esteborg.live/#miembrosvip\n\n" +
        "1Ô∏è‚É£ Pega aqu√≠ tu Tokken Esteborg Members.\n" +
        "2Ô∏è‚É£ Despu√©s te pedir√© tu nombre y qu√© quieres lograr con IA en los pr√≥ximos 90 d√≠as.",
      initialAssistantMeta: "Acceso con Tokken",
      afterToken:
        "Perfecto, ya tengo tu Tokken registrado ‚úÖ\n\n" +
        "Ahora dime:\n" +
        "‚Ä¢ ¬øC√≥mo te llamas?\n" +
        "‚Ä¢ En una frase, ¬øqu√© quieres lograr con IA en los pr√≥ximos 90 d√≠as?",
      afterTokenMeta: "Tokken validado",
      startersLabel: "Ideas para empezar despu√©s de validar tu Tokken:",
      starters: [
        "Quiero usar IA para automatizar tareas repetitivas de mi equipo.",
        "Quiero que la IA me ayude a tomar mejores decisiones ejecutivas.",
        "Quiero lanzar una nueva l√≠nea de negocio apalancando IA generativa.",
        "Quiero dominar ChatGPT y otras IA en mi trabajo diario."
      ],
      tokenDetectedUrl:
        "Detect√© un Tokken en la URL, lo usar√© autom√°ticamente en tu sesi√≥n.",
      tokenDetectedStored:
        "Tengo un Tokken Esteborg Members guardado, lo usar√© autom√°ticamente en tu sesi√≥n.",
      tokenMissingHint:
        "Pega tu Tokken Esteborg Members en el chat para comenzar.",
      invalidToken:
        "Tu Tokken no es v√°lido o ya no est√° activo. Entra a Members VIP y genera uno nuevo.",
      voiceOnLabel: "Voz Esteborg activada",
      voiceOffLabel: "Voz Esteborg",
      micHint:
        "Toca el micr√≥fono, habla y despu√©s revisa el texto antes de enviarlo."
    },
    en: {
      heroTitleHTML:
        "Executive training in <span>applied Artificial Intelligence</span><br/>" +
        "to unlock all your power.",
      heroSubHTML:
        "Esteborg AI Executive Program ¬∑ 3 months, 100% online, with " +
        "<strong>AI Executive &amp; Prompt Engineer</strong> certification.",
      chatTitle: "Esteborg AI ¬∑ Executive Copilot",
      chatSubtitle:
        "First we validate your Esteborg Members Token and I learn your name. " +
        "Then we design your 90-day AI plan together.",
      chatModeLabel: "Members VIP Access",
      inputPlaceholder: "Paste your Esteborg Members Token here...",
      sendLabel: "Send",
      demoStatusInitial: "Waiting for your Esteborg Members Token",
      demoNoteHTML:
        "If you don‚Äôt have a Token yet, you can get or recover it at: " +
        '<a href="https://membersvip.esteborg.live/#miembrosvip" target="_blank" rel="noopener noreferrer">' +
        "https://membersvip.esteborg.live/#miembrosvip</a>.",
      initialAssistant:
        "Great to have you here! üòä Before we start your training I need your Esteborg Members Token to validate access.\n\n" +
        "If you don‚Äôt have a token yet, you can get or recover it at:\n" +
        "https://membersvip.esteborg.live/#miembrosvip\n\n" +
        "1Ô∏è‚É£ Paste your Esteborg Members Token here.\n" +
        "2Ô∏è‚É£ Then I‚Äôll ask your name and what you want to achieve with AI in the next 90 days.",
      initialAssistantMeta: "Token access",
      afterToken:
        "Awesome, I‚Äôve registered your Token ‚úÖ\n\n" +
        "Now tell me:\n" +
        "‚Ä¢ What‚Äôs your name?\n" +
        "‚Ä¢ In one sentence, what do you want to achieve with AI in the next 90 days?",
      afterTokenMeta: "Token validated",
      startersLabel: "Ideas to start after token validation:",
      starters: [
        "Use AI to automate repetitive tasks in my team.",
        "Use AI to support my executive decision-making.",
        "Launch a new business line powered by generative AI.",
        "Master ChatGPT and other AIs in my daily work."
      ],
      tokenDetectedUrl:
        "I detected a Token in the URL. I‚Äôll use it automatically in your session.",
      tokenDetectedStored:
        "I found a stored Esteborg Members Token. I‚Äôll use it automatically.",
      tokenMissingHint:
        "Paste your Esteborg Members Token in the chat to begin.",
      invalidToken:
        "Your Token is not valid or no longer active. Go to Members VIP and generate a new one.",
      voiceOnLabel: "Esteborg voice on",
      voiceOffLabel: "Esteborg voice",
      micHint:
        "Tap the mic, speak, then review the text before sending."
    },
    // PT / FR / IT / DE los puedes ir llenando despu√©s si quieres fino-fino
    pt: {},
    fr: {},
    it: {},
    de: {}
  };

  function formatLangForBackend(lang) {
    const code = (lang || "").toLowerCase();
    if (["es", "en", "pt", "fr", "de", "it"].includes(code)) return code;
    return "es";
  }

  function stripHtml(html) {
    const tmp = document.createElement("div");
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || "";
  }

  function formatTextWithLinks(text) {
    if (!text) return "";
    const urlRegex =
      /(https?:\/\/[^\s]+)|(www\.[^\s]+)|(membersvip\.esteborg\.live[^\s]*)/gi;
    return text.replace(urlRegex, (match) => {
      let url = match;
      if (!/^https?:\/\//i.test(url)) {
        if (url.startsWith("www.")) {
          url = "https://" + url;
        } else if (url.startsWith("membersvip.esteborg.live")) {
          url = "https://" + url;
        }
      }
      return `<a href="${url}" target="_blank" rel="noopener noreferrer">${match}</a>`;
    });
  }

  function appendMessage(role, text, meta) {
    const row = doc.createElement("div");
    row.className = "msg-row " + (role === "user" ? "user" : "ai");

    const bubble = doc.createElement("div");
    bubble.className = "bubble " + (role === "user" ? "bubble-user" : "bubble-ai");

    const label = doc.createElement("div");
    label.className = "bubble-label";
    const dot = doc.createElement("span");
    dot.className = "bubble-label-dot";
    const who = doc.createElement("span");
    who.textContent = role === "user" ? (userName || "T√∫") : "Esteborg IA";

    label.appendChild(dot);
    label.appendChild(who);
    bubble.appendChild(label);

    const content = doc.createElement("div");
    if (role === "assistant") {
      content.innerHTML = formatTextWithLinks(text);
    } else {
      content.textContent = text;
    }
    bubble.appendChild(content);

    if (meta) {
      const metaDiv = doc.createElement("div");
      metaDiv.className = "bubble-meta";
      metaDiv.textContent = meta;
      bubble.appendChild(metaDiv);
    }

    row.appendChild(bubble);
    chatBox.appendChild(row);
    chatBox.scrollTop = chatBox.scrollHeight;

    if (role === "assistant" && voiceEnabled && "speechSynthesis" in window) {
      const utter = new SpeechSynthesisUtterance(stripHtml(text));
      const lang = formatLangForBackend(currentLang);
      const map = {
        es: "es-MX",
        en: "en-US",
        pt: "pt-BR",
        fr: "fr-FR",
        de: "de-DE",
        it: "it-IT"
      };
      utter.lang = map[lang] || "es-MX";
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }
  }

  function setLoading(isLoading) {
    isSending = isLoading;
    sendBtn.disabled = isLoading || demoEnded;
    userMsgInput.disabled = demoEnded;
    micBtn.disabled = demoEnded;

    const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];
    sendLabelEl.textContent = isLoading ? "Pensando..." : strings.sendLabel;
  }

  function applyLanguageUI(lang) {
    const strings = UI_STRINGS[lang] || UI_STRINGS["es"];
    heroTitleEl.innerHTML = strings.heroTitleHTML;
    heroSubEl.innerHTML = strings.heroSubHTML;
    chatTitleEl.textContent = strings.chatTitle;
    chatSubtitleEl.textContent = strings.chatSubtitle;
    chatModeLabelEl.textContent = strings.chatModeLabel;
    userMsgInput.placeholder = strings.inputPlaceholder;
    demoNoteEl.innerHTML = strings.demoNoteHTML;
    sendLabelEl.textContent = strings.sendLabel;
    voiceLabelEl.textContent = voiceEnabled
      ? strings.voiceOnLabel
      : strings.voiceOffLabel;
    demoStatusLabelEl.textContent = strings.demoStatusInitial;

    starterRowEl.innerHTML = "";
    if (strings.starters && strings.starters.length) {
      const labelSpan = document.createElement("span");
      labelSpan.className = "starter-label";
      labelSpan.textContent = strings.startersLabel || "";
      starterRowEl.appendChild(labelSpan);

      strings.starters.forEach((s) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "starter-pill";
        btn.textContent = s;
        btn.addEventListener("click", () => {
          userMsgInput.value = s;
          userMsgInput.focus();
        });
        starterRowEl.appendChild(btn);
      });
    }
  }

  function initTokenStatus() {
    const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];
    let message = "";

    try {
      const params = new URLSearchParams(window.location.search);
      const urlToken =
        params.get("tokken") || params.get("token") || params.get("t");
      const localToken = localStorage.getItem("esteborg_token_members");

      if (urlToken) {
        storedToken = urlToken.trim();
        localStorage.setItem("esteborg_token_members", storedToken);
        message = strings.tokenDetectedUrl;
      } else if (localToken) {
        storedToken = localToken.trim();
        message = strings.tokenDetectedStored;
      } else {
        message = strings.tokenMissingHint;
      }
    } catch (e) {
      console.warn("Token init error", e);
      message = strings.tokenMissingHint;
    }

    if (tokenStatusEl) {
      tokenStatusEl.innerHTML = "";
      const dot = document.createElement("span");
      dot.className = "token-dot";
      const txt = document.createElement("span");
      txt.textContent = message;
      tokenStatusEl.appendChild(dot);
      tokenStatusEl.appendChild(txt);
    }
  }

  function initChat() {
    history = [];
    demoEnded = false;
    introStep = 1;
    userName = null;

    const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];
    chatBox.innerHTML = "";
    appendMessage("assistant", strings.initialAssistant, strings.initialAssistantMeta);
    applyLanguageUI(currentLang);
    initTokenStatus();
    setLoading(false);
  }

  async function sendToBackend(messageText) {
    const langForBackend = formatLangForBackend(currentLang);
    const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];

    const payload = {
      message: messageText,
      history,
      lang: langForBackend,
      userName,
      token: storedToken || null
    };

    try {
      setLoading(true);

      const res = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...(storedToken ? { "x-esteborg-token": storedToken } : {}),
        },
        body: JSON.stringify(payload),
      });

      if (res.status === 401) {
        appendMessage("assistant", strings.invalidToken);
        storedToken = null;
        localStorage.removeItem("esteborg_token_members");
        initTokenStatus();
        introStep = 1;
        return;
      }

      if (!res.ok) {
        throw new Error("Respuesta no OK del backend");
      }

      const data = await res.json();
      const reply =
        (data && (data.reply || data.message || data.response)) ||
        "No pude generar una respuesta en este momento. Intenta de nuevo.";

      history.push({ role: "user", content: messageText });
      history.push({ role: "assistant", content: reply });

      appendMessage("assistant", reply);
    } catch (err) {
      console.error("Error al llamar al backend:", err);
      appendMessage(
        "assistant",
        "Hubo un problema al conectar con Esteborg IA. Intenta de nuevo en unos momentos."
      );
    } finally {
      setLoading(false);
    }
  }

  function handleUserMessage() {
    if (isSending || demoEnded) return;
    const text = (userMsgInput.value || "").trim();
    if (!text) return;

    const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];

    appendMessage("user", text);
    userMsgInput.value = "";

    if (introStep === 1) {
      storedToken = text.trim();
      try {
        localStorage.setItem("esteborg_token_members", storedToken);
      } catch (_) {}

      initTokenStatus();
      appendMessage("assistant", strings.afterToken, strings.afterTokenMeta);
      introStep = 2;
      return;
    }

    if (introStep === 2) {
      userName = text.split(" ")[0] || text;
      introStep = 3;
      sendToBackend(text);
      return;
    }

    sendToBackend(text);
  }

  let recognition = null;
  let listening = false;

  function setupSpeechRecognition() {
    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      micBtn.disabled = true;
      micBtn.title = "Tu navegador no soporta dictado por voz.";
      return;
    }

    const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];

    recognition = new SpeechRecognition();
    recognition.lang = "es-MX";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.addEventListener("result", (event) => {
      const transcript = Array.from(event.results)
        .map((r) => r[0].transcript)
        .join(" ");
      userMsgInput.value = transcript;
      userMsgInput.focus();
    });

    recognition.addEventListener("end", () => {
      listening = false;
      micBtn.classList.remove("listening");
    });

    micBtn.addEventListener("click", () => {
      if (!recognition) return;
      if (listening) {
        recognition.stop();
        listening = false;
        micBtn.classList.remove("listening");
      } else {
        try {
          const lang = formatLangForBackend(currentLang);
          const map = {
            es: "es-MX",
            en: "en-US",
            pt: "pt-BR",
            fr: "fr-FR",
            de: "de-DE",
            it: "it-IT"
          };
          recognition.lang = map[lang] || "es-MX";
        } catch (_) {}
        recognition.start();
        listening = true;
        micBtn.classList.add("listening");
      }
    });

    micBtn.title = strings.micHint || "";
  }

  function setupVoiceToggle() {
    voiceToggleBtn.addEventListener("click", () => {
      voiceEnabled = !voiceEnabled;
      const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];
      voiceLabelEl.textContent = voiceEnabled
        ? strings.voiceOnLabel
        : strings.voiceOffLabel;
      voiceToggleBtn.classList.toggle("active", voiceEnabled);

      if (!voiceEnabled && "speechSynthesis" in window) {
        window.speechSynthesis.cancel();
      }
    });
  }

  if (langPillContainer) {
    langPillContainer.addEventListener("click", (event) => {
      const btn = event.target.closest(".lang-pill");
      if (!btn) return;
      const lang = btn.dataset.lang;
      if (!lang || lang === currentLang) return;

      currentLang = lang;

      Array.from(langPillContainer.querySelectorAll(".lang-pill")).forEach((el) => {
        el.classList.toggle("active", el.dataset.lang === currentLang);
      });

      initChat();
    });
  }

  if (sendBtn) {
    sendBtn.addEventListener("click", handleUserMessage);
  }

  if (userMsgInput) {
    userMsgInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        handleUserMessage();
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    initChat();
    setupSpeechRecognition();
    setupVoiceToggle();

    if (userMsgInput) userMsgInput.focus();
  });
</script>

  
  <script>
  (function () {
    function sendResize() {
      try {
        const doc = document;
        const height = Math.max(
          doc.documentElement.scrollHeight,
          doc.body.scrollHeight
        );

        window.parent &&
          window.parent.postMessage(
            { type: "esteborg-resize", height: height },
            "*"
          );
      } catch (e) {
        console.warn("[Esteborg] Error al enviar resize:", e);
      }
    }

    // Al cargar y al redimensionar ventana
    window.addEventListener("load", sendResize);
    window.addEventListener("resize", sendResize);

    // Observar cambios en el DOM (nuevos mensajes, etc.)
    const observer = new MutationObserver(function () {
      clearTimeout(window.__esteborgResizeTimer);
      window.__esteborgResizeTimer = setTimeout(sendResize, 80);
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true,
      attributes: true,
    });
  })();
</script>
  <script>
  // üîß CONFIG
  const API_URL = "/api/modules/iavipcom";
  const VOICE_API_URL = "/api/voice/stream";
  const TOKEN_STORAGE_KEY = "esteborg_token_members";

  // Paso de flujo:
  // 0 = esperando Tokken
  // 1 = Tokken OK, pidiendo nombre/objetivo
  // 2 = entrenamiento normal
  let flowStep = 0;

  let storedToken = null;
  let history = [];
  let currentLang = "es";
  let userName = null;
  let isSending = false;
  let isTtsEnabled = false;
  let lastAssistantText = "";
  let audioPlayer = null;

  // üî° Textos UI por idioma
  const UI_STRINGS = {
    es: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub: "Entrenamiento ejecutivo en IA aplicada",
      bannerDesc:
        "Esteborg IA es tu copiloto ejecutivo de inteligencia artificial. Aqu√≠ dise√±amos tu plan estrat√©gico, optimizamos tu negocio y entrenamos tus habilidades ejecutivas con IA.",
      panelTitle: "Inicio del entrenamiento ¬∑ Copiloto Ejecutivo IA",
      chipsLabel: "Quiero empezar:",
      contentLabel: "Material:",
      inputPlaceholder:
        "Cu√©ntame qu√© quieres lograr con IA en los pr√≥ximos 90 d√≠as...",
      statusPreparing: "Preparando tu entrenamiento con Esteborg IA...",
      chatName: "Esteborg IA",
      chatRole: "Copiloto Ejecutivo IA",
      voiceToggle: "Voz Esteborg IA activada",
      voicePill: "üéß Voz Esteborg IA",
      footerTokenTitle: "Tokken Esteborg Members",
      footerTokenText:
        "Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip",
      askToken:
        "¬°Qu√© gusto saludarte! üòä Antes de entrar a tu entrenamiento necesito tu Tokken Esteborg Members para validar tu acceso.\n\nPega aqu√≠ tu Tokken y env√≠alo.",
      askNameGoal:
        "Perfecto, tu Tokken ya qued√≥ registrado ‚úÖ\n\nAhora dime:\n1) ¬øC√≥mo te llamas?\n2) ¬øQu√© quieres lograr con IA en los pr√≥ximos 90 d√≠as?",
      invalidToken:
        "Tu Tokken Esteborg Members parece inv√°lido o expirado.\n\nPor favor entra a https://membersvip.esteborg.live/#miembrosvip, genera uno nuevo y p√©galo aqu√≠.",
      sendingLabel: "Entrenando contigo...",
      sendButton: "ENVIAR",
      voiceLabel: "Voz Esteborg IA activada",
    },
    en: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub: "Executive training in applied AI",
      bannerDesc:
        "Esteborg IA is your executive AI copilot. We design your strategic plan, optimize your business and train your executive skills with AI.",
      panelTitle: "Kickoff ¬∑ Executive AI Copilot",
      chipsLabel: "I want to start with:",
      contentLabel: "Material:",
      inputPlaceholder:
        "Tell me what you want to achieve with AI in the next 90 days...",
      statusPreparing: "Preparing your training with Esteborg IA...",
      chatName: "Esteborg IA",
      chatRole: "Executive AI Copilot",
      voiceToggle: "Esteborg IA voice on",
      voicePill: "üéß Esteborg IA Voice",
      footerTokenTitle: "Esteborg Members Tokken",
      footerTokenText:
        "If you don't have a token yet, get or recover it at: https://membersvip.esteborg.live/#miembrosvip",
      askToken:
        "Great to see you! üòä Before we start, I need your Esteborg Members Tokken to validate your access.\n\nPaste your Tokken here and send it.",
      askNameGoal:
        "Perfect, your Tokken is now registered ‚úÖ\n\nNow tell me:\n1) What's your name?\n2) What do you want to achieve with AI in the next 90 days?",
      invalidToken:
        "Your Esteborg Members Tokken seems invalid or expired.\n\nPlease go to https://membersvip.esteborg.live/#miembrosvip, generate a new one and paste it here.",
      sendingLabel: "Training with you...",
      sendButton: "SEND",
      voiceLabel: "Esteborg IA voice on",
    },
    pt: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub: "Treinamento executivo em IA aplicada",
      bannerDesc:
        "Esteborg IA √© o seu copiloto executivo de intelig√™ncia artificial. Aqui desenhamos seu plano estrat√©gico, otimizamos o neg√≥cio e treinamos suas habilidades executivas com IA.",
      panelTitle: "In√≠cio do treinamento ¬∑ Copiloto Executivo IA",
      chipsLabel: "Quero come√ßar com:",
      contentLabel: "Material:",
      inputPlaceholder:
        "Conte-me o que voc√™ quer alcan√ßar com IA nos pr√≥ximos 90 dias...",
      statusPreparing: "Preparando seu treinamento com Esteborg IA...",
      chatName: "Esteborg IA",
      chatRole: "Copiloto Executivo IA",
      voiceToggle: "Voz Esteborg IA ativada",
      voicePill: "üéß Voz Esteborg IA",
      footerTokenTitle: "Tokken Esteborg Members",
      footerTokenText:
        "Se voc√™ ainda n√£o tem token, obtenha ou recupere em: https://membersvip.esteborg.live/#miembrosvip",
      askToken:
        "Que bom falar com voc√™! üòä Antes de come√ßar, preciso do seu Tokken Esteborg Members para validar o acesso.\n\nCole o Tokken aqui e envie.",
      askNameGoal:
        "Perfeito, seu Tokken j√° foi registrado ‚úÖ\n\nAgora me diga:\n1) Como voc√™ se chama?\n2) O que quer alcan√ßar com IA nos pr√≥ximos 90 dias?",
      invalidToken:
        "Seu Tokken Esteborg Members parece inv√°lido ou expirado.\n\nEntre em https://membersvip.esteborg.live/#miembrosvip, gere um novo e cole aqui.",
      sendingLabel: "Treinando com voc√™...",
      sendButton: "ENVIAR",
      voiceLabel: "Voz Esteborg IA ativada",
    },
    fr: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub: "Formation ex√©cutive en IA appliqu√©e",
      bannerDesc:
        "Esteborg IA est ton copilote ex√©cutif en intelligence artificielle. On con√ßoit ta strat√©gie, on optimise ton business et on entra√Æne tes comp√©tences ex√©cutives avec l‚ÄôIA.",
      panelTitle: "D√©marrage ¬∑ Copilote Ex√©cutif IA",
      chipsLabel: "Je veux commencer par :",
      contentLabel: "Mat√©riel :",
      inputPlaceholder:
        "Dis-moi ce que tu veux atteindre avec l‚ÄôIA dans les 90 prochains jours...",
      statusPreparing: "Pr√©paration de ta session avec Esteborg IA...",
      chatName: "Esteborg IA",
      chatRole: "Copilote Ex√©cutif IA",
      voiceToggle: "Voix Esteborg IA activ√©e",
      voicePill: "üéß Voix Esteborg IA",
      footerTokenTitle: "Tokken Esteborg Members",
      footerTokenText:
        "Si tu n‚Äôas pas encore de token, r√©cup√®re-le sur : https://membersvip.esteborg.live/#miembrosvip",
      askToken:
        "Ravi de te voir ! üòä Avant de commencer, j‚Äôai besoin de ton Tokken Esteborg Members.\n\nColle-le ici et envoie.",
      askNameGoal:
        "Parfait, ton Tokken est enregistr√© ‚úÖ\n\nMaintenant dis-moi :\n1) Comment tu t‚Äôappelles ?\n2) Ce que tu veux accomplir avec l‚ÄôIA dans les 90 prochains jours ?",
      invalidToken:
        "Ton Tokken Esteborg Members semble invalide ou expir√©.\n\nVa sur https://membersvip.esteborg.live/#miembrosvip, g√©n√®re-en un nouveau et colle-le ici.",
      sendingLabel: "Entra√Ænement en cours...",
      sendButton: "ENVOYER",
      voiceLabel: "Voix Esteborg IA activ√©e",
    },
    it: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub: "Formazione esecutiva in IA applicata",
      bannerDesc:
        "Esteborg IA √® il tuo copilota esecutivo di intelligenza artificiale. Progettiamo il tuo piano strategico, ottimizziamo il business e alleniamo le tue capacit√† esecutive con l‚ÄôIA.",
      panelTitle: "Avvio ¬∑ Copilota Esecutivo IA",
      chipsLabel: "Voglio iniziare da:",
      contentLabel: "Materiale:",
      inputPlaceholder:
        "Dimmi cosa vuoi ottenere con l‚ÄôIA nei prossimi 90 giorni...",
      statusPreparing: "Preparando il tuo training con Esteborg IA...",
      chatName: "Esteborg IA",
      chatRole: "Copilota Esecutivo IA",
      voiceToggle: "Voce Esteborg IA attiva",
      voicePill: "üéß Voce Esteborg IA",
      footerTokenTitle: "Tokken Esteborg Members",
      footerTokenText:
        "Se non hai ancora il token, ottienilo o recuperalo su: https://membersvip.esteborg.live/#miembrosvip",
      askToken:
        "Che piacere sentirti! üòä Prima di iniziare ho bisogno del tuo Tokken Esteborg Members.\n\nIncollalo qui e invialo.",
      askNameGoal:
        "Perfetto, il tuo Tokken √® registrato ‚úÖ\n\nOra dimmi:\n1) Come ti chiami?\n2) Cosa vuoi ottenere con l‚ÄôIA nei prossimi 90 giorni?",
      invalidToken:
        "Il tuo Tokken Esteborg Members sembra non valido o scaduto.\n\nVai su https://membersvip.esteborg.live/#miembrosvip, generane uno nuovo e incollalo qui.",
      sendingLabel: "Training in corso...",
      sendButton: "INVIA",
      voiceLabel: "Voce Esteborg IA attiva",
    },
    de: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub: "Executive-Training in angewandter KI",
      bannerDesc:
        "Esteborg IA ist dein Executive-KI-Copilot. Wir gestalten deinen Strategieplan, optimieren dein Business und trainieren deine F√ºhrungskompetenzen mit KI.",
      panelTitle: "Start ¬∑ Executive KI-Copilot",
      chipsLabel: "Ich m√∂chte beginnen mit:",
      contentLabel: "Material:",
      inputPlaceholder:
        "Erz√§hl mir, was du in den n√§chsten 90 Tagen mit KI erreichen m√∂chtest...",
      statusPreparing: "Dein Training mit Esteborg IA wird vorbereitet...",
      chatName: "Esteborg IA",
      chatRole: "Executive KI-Copilot",
      voiceToggle: "Esteborg IA Stimme aktiviert",
      voicePill: "üéß Esteborg IA Stimme",
      footerTokenTitle: "Esteborg Members Tokken",
      footerTokenText:
        "Wenn du noch keinen Token hast, hole ihn dir hier: https://membersvip.esteborg.live/#miembrosvip",
      askToken:
        "Sch√∂n, dass du da bist! üòä Bevor wir starten, brauche ich deinen Esteborg Members Tokken.\n\nF√ºge ihn hier ein und sende ihn.",
      askNameGoal:
        "Perfekt, dein Tokken ist registriert ‚úÖ\n\nJetzt sag mir bitte:\n1) Wie hei√üt du?\n2) Was willst du in den n√§chsten 90 Tagen mit KI erreichen?",
      invalidToken:
        "Dein Esteborg Members Tokken scheint ung√ºltig oder abgelaufen zu sein.\n\nBitte gehe zu https://membersvip.esteborg.live/#miembrosvip, generiere einen neuen und f√ºge ihn hier ein.",
      sendingLabel: "Training l√§uft...",
      sendButton: "SENDEN",
      voiceLabel: "Esteborg IA Stimme aktiviert",
    },
  };

  function getStrings() {
    return UI_STRINGS[currentLang] || UI_STRINGS["es"];
  }

  // üîé ELEMENTOS
  const langOptions = document.querySelectorAll(".lang-option");
  const bannerMainEl = document.getElementById("i-banner-main");
  const bannerSubEl = document.getElementById("i-banner-sub");
  const bannerDescEl = document.getElementById("i-banner-desc");
  const panelTitleEl = document.getElementById("i-panel-title");
  const chipsLabelEl = document.getElementById("i-chips-label");
  const contentLabelEl = document.getElementById("i-content-label");
  const chatNameEl = document.getElementById("i-chat-name");
  const chatRoleEl = document.getElementById("i-chat-role");
  const userInput = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");
  const micBtn = document.getElementById("mic-btn");
  const statusLine = document.getElementById("status-line");
  const chatLog = document.getElementById("chat-log");
  const ttsToggle = document.getElementById("tts-toggle");
  const voiceToggleLabel = document.getElementById("i-voice-toggle-label");
  const voicePill = document.getElementById("i-voice-pill");
  const footerTokenTitleEl = document.getElementById("i-footer-token-title");
  const footerTokenTextEl = document.getElementById("i-footer-token-text");

  const starterChips = document.querySelectorAll(".chip-btn.starter");
  const contentChips = document.querySelectorAll(".content-btn.content");

  // üîÑ TRADUCCI√ìN DE LA INTERFAZ
  function applyLanguageToUI() {
    const s = getStrings();
    if (bannerMainEl) bannerMainEl.textContent = s.bannerMain;
    if (bannerSubEl) bannerSubEl.textContent = s.bannerSub;
    if (bannerDescEl) bannerDescEl.textContent = s.bannerDesc;
    if (panelTitleEl) panelTitleEl.textContent = s.panelTitle;
    if (chipsLabelEl) chipsLabelEl.textContent = s.chipsLabel;
    if (contentLabelEl) contentLabelEl.textContent = s.contentLabel;
    if (chatNameEl) chatNameEl.textContent = s.chatName;
    if (chatRoleEl) chatRoleEl.textContent = s.chatRole;
    if (userInput) userInput.placeholder = s.inputPlaceholder;
    if (statusLine) {
      const spanText = statusLine.querySelector("span:nth-child(2)");
      if (spanText) spanText.textContent = s.statusPreparing;
    }
    if (voiceToggleLabel) voiceToggleLabel.textContent = s.voiceToggle;
    if (voicePill) voicePill.textContent = s.voicePill;
    if (footerTokenTitleEl) footerTokenTitleEl.textContent = s.footerTokenTitle;
    if (footerTokenTextEl) footerTokenTextEl.textContent = s.footerTokenText;
    if (sendBtn) sendBtn.textContent = s.sendButton;
  }

  // üí¨ MANEJO DE MENSAJES EN LA UI
  function appendMessage(role, text) {
    if (!chatLog) return;
    const row = document.createElement("div");
    row.className = "msg-row " + (role === "user" ? "user" : "assistant");

    const tag = document.createElement("div");
    tag.className = "msg-tag " + (role === "user" ? "user" : "assistant");
    tag.textContent = role === "user" ? "T√∫" : "Esteborg IA";

    const bubble = document.createElement("div");
    bubble.className = "msg-bubble";
    const inner = document.createElement("div");
    inner.className = "msg-text";
    inner.textContent = text;
    bubble.appendChild(inner);

    if (role === "user") {
      row.appendChild(bubble);
      row.appendChild(tag);
    } else {
      row.appendChild(tag);
      row.appendChild(bubble);
    }

    chatLog.appendChild(row);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function setStatus(text) {
    if (!statusLine) return;
    const spanText = statusLine.querySelector("span:nth-child(2)");
    if (spanText) spanText.textContent = text;
  }

  function setLoadingState(loading) {
    isSending = loading;
    const s = getStrings();
    if (loading) {
      setStatus(s.sendingLabel);
      sendBtn.disabled = true;
    } else {
      setStatus(s.statusPreparing);
      sendBtn.disabled = false;
    }
  }

  // üîä TTS / VOZ
  function cleanTextForTTS(text) {
    if (!text) return "";
    let t = String(text);
    // eliminar markdown simple y s√≠mbolos ruidosos
    t = t.replace(/\*\*(.*?)\*\*/g, "$1");
    t = t.replace(/\*(.*?)\*/g, "$1");
    t = t.replace(/`+/g, "");
    t = t.replace(/[‚Ä¢‚óè‚ñ™‚ñ∂‚óá‚óÜ‚ñ†‚ñ°\-]+/g, " ");
    t = t.replace(/[#=_~]+/g, " ");
    t = t.replace(/[!?]{2,}/g, "!");
    t = t.replace(/[.,;:()\[\]{}]/g, " ");
    t = t.replace(/\s+/g, " ").trim();
    return t;
  }

  async function speakText(text) {
    try {
      if (!text) return;
      const cleaned = cleanTextForTTS(text);
      if (!cleaned) return;

      if (audioPlayer) {
        try {
          audioPlayer.pause();
        } catch (e) {}
      }

      const resp = await fetch(VOICE_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: cleaned,
          lang: currentLang,
          profile: "esteborg-ia",
        }),
      });

      if (!resp.ok) {
        console.error("Error en TTS:", await resp.text());
        return;
      }

      const blob = await resp.blob();
      const url = URL.createObjectURL(blob);
      audioPlayer = new Audio(url);
      audioPlayer.play();
    } catch (err) {
      console.error("Error reproduciendo audio:", err);
    }
  }

  // üß† BACKEND
  async function callBackend(messageText) {
    const body = {
      message: messageText,
      history,
      rawToken: storedToken || "",
      userName: userName || null,
      lang: currentLang,
    };

    const resp = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });

    if (!resp.ok) {
      throw new Error("Backend error: " + resp.status);
    }

    const data = await resp.json();
    return data;
  }

  async function handleUserMessage() {
    if (isSending) return;
    const text = (userInput.value || "").trim();
    if (!text) return;

    // Mostramos siempre lo que el usuario escribi√≥
    appendMessage("user", text);
    userInput.value = "";

    const s = getStrings();

    // Paso 0: esperando TOKKEN
    if (flowStep === 0 && !storedToken) {
      storedToken = text;
      localStorage.setItem(TOKEN_STORAGE_KEY, storedToken);
      setLoadingState(true);

      try {
        // Peque√±o ping al backend para validar
        const data = await callBackend("Validar Tokken Esteborg Members.");
        const tokenStatus = data.tokenStatus || "unknown";

        if (tokenStatus !== "valid") {
          // Tokken malo
          storedToken = null;
          localStorage.removeItem(TOKEN_STORAGE_KEY);
          flowStep = 0;
          appendMessage("assistant", s.invalidToken);
        } else {
          // Tokken OK ‚Üí paso 1: pedir nombre/objetivo
          flowStep = 1;
          appendMessage("assistant", s.askNameGoal);
        }
      } catch (err) {
        console.error("Error validando token:", err);
        storedToken = null;
        localStorage.removeItem(TOKEN_STORAGE_KEY);
        flowStep = 0;
        appendMessage(
          "assistant",
          "Hubo un problema al validar tu Tokken. Intenta de nuevo."
        );
      } finally {
        setLoadingState(false);
      }
      return;
    }

    // Paso 1: ya hay Tokken, pedimos nombre/objetivo
    if (flowStep === 1 && storedToken) {
      userName = text; // lo guardamos tal cual (puedes parsear despu√©s si quieres)
      flowStep = 2; // ya puede entrenar normal

      setLoadingState(true);
      try {
        const data = await callBackend(
          `Mi nombre es ${userName} y esto es lo que quiero lograr con IA: ${text}`
        );
        const reply = data.reply || "Listo, comencemos con tu entrenamiento IA.";
        history.push({ role: "user", content: text });
        history.push({ role: "assistant", content: reply });
        lastAssistantText = reply;
        appendMessage("assistant", reply);
        if (isTtsEnabled) {
          speakText(reply);
        }
      } catch (err) {
        console.error("Error en entrenamiento inicial:", err);
        appendMessage(
          "assistant",
          "Hubo un problema al iniciar tu entrenamiento. Intenta otra vez."
        );
      } finally {
        setLoadingState(false);
      }
      return;
    }

    // Paso 2+: conversaci√≥n normal
    if (flowStep >= 2) {
      setLoadingState(true);
      try {
        const data = await callBackend(text);
        const reply =
          data.reply || "No pude generar una respuesta en este momento.";
        const tokenStatus = data.tokenStatus || "valid";

        if (tokenStatus !== "valid") {
          // Algo pas√≥ con el Tokken a mitad del camino
          storedToken = null;
          localStorage.removeItem(TOKEN_STORAGE_KEY);
          flowStep = 0;
          appendMessage("assistant", s.invalidToken);
        } else {
          history.push({ role: "user", content: text });
          history.push({ role: "assistant", content: reply });
          lastAssistantText = reply;
          appendMessage("assistant", reply);
          if (isTtsEnabled) {
            speakText(reply);
          }
        }
      } catch (err) {
        console.error("Error llamando al backend:", err);
        appendMessage(
          "assistant",
          "Hubo un problema al conectar con Esteborg IA. Intenta de nuevo en unos momentos."
        );
      } finally {
        setLoadingState(false);
      }
    }
  }

  // üåê CAMBIO DE IDIOMA
  langOptions.forEach((btn) => {
    btn.addEventListener("click", () => {
      const lang = btn.dataset.lang || "es";
      currentLang = lang;
      langOptions.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      applyLanguageToUI();
    });
  });

  // üéõÔ∏è EVENTOS DE UI
  if (sendBtn) {
    sendBtn.addEventListener("click", handleUserMessage);
  }

  if (userInput) {
    userInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        handleUserMessage();
      }
    });
  }

  if (ttsToggle) {
    ttsToggle.addEventListener("change", () => {
      isTtsEnabled = !!ttsToggle.checked;
      const s = getStrings();
      if (voiceToggleLabel) voiceToggleLabel.textContent = s.voiceToggle;
    });
  }

  if (micBtn) {
    micBtn.addEventListener("click", () => {
      // Por ahora solo es visual; la parte de STT se puede conectar despu√©s
      micBtn.classList.toggle("active");
    });
  }

  starterChips.forEach((btn) => {
    btn.addEventListener("click", () => {
      const text = btn.dataset.text || btn.textContent || "";
      if (!text) return;
      userInput.value = text;
      userInput.focus();
    });
  });

  contentChips.forEach((btn) => {
    btn.addEventListener("click", () => {
      const text = btn.dataset.text || btn.textContent || "";
      if (!text) return;
      userInput.value = text;
      userInput.focus();
    });
  });

  // üöÄ INIT
  function init() {
    // Cargar Tokken si existe
    storedToken = localStorage.getItem(TOKEN_STORAGE_KEY) || null;
    currentLang = "es";
    applyLanguageToUI();

    const s = getStrings();

    if (!storedToken) {
      flowStep = 0;
      appendMessage("assistant", s.askToken);
    } else {
      flowStep = 1; // ya tenemos Tokken, pedimos nombre/objetivo
      appendMessage(
        "assistant",
        s.askNameGoal
      );
    }
  }

  init();
</script>

</body>
</html>
