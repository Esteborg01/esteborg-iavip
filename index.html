<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Esteborg IA - Despliega todo tu poder</title>

  <style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; }

  body {
    margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden; /* ‚Üê ESTE ES EL FIX */
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
    -apple-system, system-ui, "Segoe UI", sans-serif;
  background: radial-gradient(circle at top, #020617, #020617);
  color: #e5e7eb;
}

  #app {
    min-height: 100vh;
    padding: 32px 16px 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .shell {
    width: 100%;
    max-width: 960px;
    border-radius: 24px;
    padding: 18px 18px 20px;
    background:
      radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent 55%),
      radial-gradient(circle at bottom right, rgba(37, 99, 235, 0.14), transparent 55%),
      rgba(15, 23, 42, 0.98);
    border: 1px solid rgba(15, 23, 42, 1);
    box-shadow:
      0 32px 120px rgba(15, 23, 42, 0.95),
      0 0 0 1px rgba(148, 163, 184, 0.35);
  }

  .banner-header {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 10px;
  }
  .banner-avatar {
    width: 40px;
    height: 40px;
    border-radius: 999px;
    background: radial-gradient(circle at top, #38bdf8, #4f46e5);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 20px;
    color: #ecfeff;
    box-shadow:
      0 0 0 2px rgba(15, 23, 42, 1),
      0 0 0 1px rgba(226, 232, 240, 0.9),
      0 0 32px rgba(96, 165, 250, 0.95);
  }

  .banner-title {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .banner-title-main {
    font-size: 13px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: #e5e7eb;
  }
  .banner-title-sub {
    font-size: 20px;
    font-weight: 600;
    letter-spacing: 0.02em;
    background: linear-gradient(to right, #e5e7eb, #93c5fd);
    -webkit-background-clip: text;
    color: transparent;
  }

  .banner-desc {
    margin-top: 4px;
    font-size: 12px;
    color: rgba(156, 163, 175, 0.95);
    max-width: 720px;
  }

  .panel {
    margin-top: 16px;
    border-radius: 22px;
    padding: 14px 14px 16px;
    background:
      radial-gradient(circle at top left, rgba(59, 130, 246, 0.16), transparent 55%),
      radial-gradient(circle at bottom right, rgba(22, 163, 74, 0.15), transparent 55%),
      rgba(15, 23, 42, 0.98);
    border: 1px solid rgba(55, 65, 81, 0.95);
    box-shadow:
      0 24px 80px rgba(15, 23, 42, 0.95),
      0 0 0 1px rgba(148, 163, 184, 0.35);
  }

  .panel-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
  }

  .panel-title-wrap {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .panel-title {
    font-size: 13px;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: #e5e7eb;
  }

  .panel-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    border: 1px solid rgba(52, 211, 153, 0.6);
    color: #a7f3d0;
    background: radial-gradient(circle at top left, rgba(16, 185, 129, 0.35), rgba(15, 23, 42, 0.98));
  }
  .panel-badge .dot {
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: radial-gradient(circle at center, #22c55e, #15803d);
    box-shadow: 0 0 12px rgba(34, 197, 94, 0.95);
  }

  .chips-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
    font-size: 11px;
    color: rgba(156, 163, 175, 0.95);
  }
  .chips-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: rgba(148, 163, 184, 0.95);
    margin-right: 4px;
  }

  .chip-btn {
    border-radius: 999px;
    border: 1px solid rgba(55, 65, 81, 0.95);
    background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.14), rgba(15, 23, 42, 0.98));
    padding: 6px 10px;
    font-size: 11px;
    color: #e5e7eb;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition:
      background-color 0.18s ease,
      border-color 0.18s ease,
      transform 0.12s ease,
      box-shadow 0.18s ease;
    box-shadow:
      0 10px 22px rgba(15, 23, 42, 0.95),
      0 0 0 1px rgba(30, 64, 175, 0.35);
  }
  .chip-btn span.icon {
    font-size: 14px;
  }
  .chip-btn:hover {
    border-color: rgba(96, 165, 250, 0.9);
    background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.24), rgba(15, 23, 42, 1));
    transform: translateY(-1px);
    box-shadow:
      0 12px 26px rgba(15, 23, 42, 0.98),
      0 0 0 1px rgba(129, 140, 248, 0.7);
  }
  .chip-btn:active {
    transform: translateY(0);
    box-shadow:
      0 4px 14px rgba(15, 23, 42, 0.95),
      0 0 0 1px rgba(30, 64, 175, 0.7);
  }

  .chips-hint {
    margin-top: 2px;
    font-size: 10px;
    color: rgba(148, 163, 184, 0.9);
  }

  .content-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-top: 10px;
    margin-bottom: 6px;
    font-size: 11px;
  }
  .content-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: rgba(148, 163, 184, 0.95);
    margin-right: 4px;
  }
  .content {
    border-radius: 999px;
    border: 1px solid rgba(55, 65, 81, 0.95);
    background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.16), rgba(15, 23, 42, 0.98));
    padding: 5px 9px;
    font-size: 11px;
    color: #e5e7eb;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition:
      background-color 0.18s ease,
      border-color 0.18s ease,
      transform 0.12s ease,
      box-shadow 0.18s ease;
    box-shadow:
      0 10px 20px rgba(15, 23, 42, 0.95),
      0 0 0 1px rgba(56, 189, 248, 0.35);
  }
  .content span.icon {
    font-size: 14px;
  }
  .content:hover {
    border-color: rgba(56, 189, 248, 0.9);
    background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.26), rgba(15, 23, 42, 1));
    transform: translateY(-1px);
    box-shadow:
      0 12px 26px rgba(15, 23, 42, 0.98),
      0 0 0 1px rgba(56, 189, 248, 0.7);
  }
  .content:active {
    transform: translateY(0);
    box-shadow:
      0 4px 14px rgba(15, 23, 42, 0.95),
      0 0 0 1px rgba(37, 99, 235, 0.7);
  }

  .chat-container {
    margin-top: 10px;
    border-radius: 20px;
    padding: 10px 10px 12px;
    background:
      radial-gradient(circle at top left, rgba(96, 165, 250, 0.07), transparent 55%),
      radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.09), transparent 55%),
      rgba(15, 23, 42, 0.98);
    border: 1px solid rgba(55, 65, 81, 0.95);
    box-shadow:
      0 22px 70px rgba(15, 23, 42, 0.96),
      0 0 0 1px rgba(148, 163, 184, 0.4);
  }

  .chat-header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 8px;
  }

  .chat-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .chat-node {
    width: 28px;
    height: 28px;
    border-radius: 999px;
    background: radial-gradient(circle at top, #38bdf8, #4f46e5);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 15px;
    color: #ecfeff;
    box-shadow:
      0 0 0 1px rgba(226, 232, 240, 0.9),
      0 0 24px rgba(96, 165, 250, 0.95);
  }

  .chat-title {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .chat-title div {
    font-size: 13px;
    font-weight: 600;
  }

  .chat-title small {
    font-size: 11px;
    color: rgba(156, 163, 175, 0.95);
  }

  .chat-header-right {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .lang-pill {
    border-radius: 999px;
    border: 1px solid rgba(55, 65, 81, 0.95);
    background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98));
    padding: 3px 8px;
    font-size: 11px;
    color: rgba(148, 163, 184, 0.95);
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .lang-label {
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-size: 10px;
  }

  .lang-options {
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .lang-option {
    padding: 2px 6px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 10px;
    border: 1px solid transparent;
    transition:
      background-color 0.14s ease,
      color 0.14s ease,
      border-color 0.14s ease;
    color: rgba(148, 163, 184, 0.9);
  }

  .lang-option.active {
    border-color: rgba(96, 165, 250, 0.85);
    background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.5), rgba(15, 23, 42, 1));
    color: #e5e7eb;
  }

  .voice-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .voice-toggle {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: rgba(148, 163, 184, 0.95);
    cursor: pointer;
  }
  .voice-toggle input {
    width: 26px;
    height: 14px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 1);
    border: 1px solid rgba(55, 65, 81, 1);
    position: relative;
    appearance: none;
    outline: none;
    cursor: pointer;
  }
  .voice-toggle input::before {
    content: "";
    position: absolute;
    top: 1px;
    left: 1px;
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: rgba(148, 163, 184, 1);
    transition: transform 0.18s ease, background-color 0.18s ease;
  }
  .voice-toggle input:checked::before {
    transform: translateX(10px);
    background: rgba(56, 189, 248, 1);
  }

  .voice-pill {
    border-radius: 999px;
    border: 1px solid rgba(55, 65, 81, 0.95);
    background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.15), rgba(15, 23, 42, 0.98));
    padding: 4px 9px;
    font-size: 11px;
    color: #e5e7eb;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .status-row {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: rgba(148, 163, 184, 0.9);
    margin-bottom: 6px;
  }
  .status-dot {
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: radial-gradient(circle at center, #22c55e, #22c55e);
    box-shadow: 0 0 12px rgba(34, 197, 94, 0.95);
  }

  #chat-log {
    max-height: 320px;
    min-height: 160px;
    overflow-y: auto;
    padding: 8px 10px;
    border-radius: 14px;
    background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98));
    border: 1px solid rgba(31, 41, 55, 1);
    box-shadow:
      inset 0 0 0 1px rgba(15, 23, 42, 1),
      inset 0 0 18px rgba(15, 23, 42, 1);
  }

  .msg-row {
    display: flex;
    align-items: flex-start;
    gap: 6px;
    margin-bottom: 8px;
  }
  .msg-row.user {
    justify-content: flex-end;
  }

  .msg-tag {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: rgba(148, 163, 184, 0.95);
    margin-top: 2px;
  }

  .msg-tag.user {
    order: 2;
  }

  .msg-bubble {
    max-width: 80%;
    padding: 7px 10px;
    border-radius: 14px;
    font-size: 12px;
    line-height: 1.45;
  }

  .msg-row.user .msg-bubble {
    background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.15), rgba(15, 23, 42, 0.98));
    border: 1px solid rgba(59, 130, 246, 0.9);
    box-shadow:
      0 12px 24px rgba(15, 23, 42, 0.96),
      0 0 0 1px rgba(37, 99, 235, 0.75);
  }

  .msg-row.assistant .msg-bubble {
    background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.16), rgba(15, 23, 42, 0.98));
    border: 1px solid rgba(30, 64, 175, 0.9);
    box-shadow:
      0 12px 24px rgba(15, 23, 42, 0.96),
      0 0 0 1px rgba(30, 64, 175, 0.75);
  }

  .msg-text {
    white-space: pre-wrap;
  }

  .input-row {
    margin-top: 10px;
    display: flex;
    gap: 8px;
    align-items: flex-end;
  }

  .input-row textarea {
    flex: 1;
    resize: none;
    border-radius: 999px;
    border: 1px solid rgba(55, 65, 81, 0.95);
    background: radial-gradient(circle at top, rgba(3, 7, 18, 0.98), rgba(3, 7, 18, 0.95));
    color: #e5e7eb;
    padding: 10px 14px;
    font-size: 14px;
    min-height: 44px;
    max-height: 84px;
    line-height: 1.4;
    outline: none;
    box-shadow:
      0 0 0 1px rgba(15, 23, 42, 0.9),
      0 14px 24px rgba(15, 23, 42, 0.98);
  }
  .input-row textarea::placeholder {
    color: rgba(148, 163, 184, 0.95);
  }

  .input-actions {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .send-btn {
    border-radius: 999px;
    border: 1px solid rgba(96, 165, 250, 1);
    background: radial-gradient(circle at top left, rgba(37, 99, 235, 1), rgba(30, 64, 175, 1));
    padding: 9px 16px;
    font-size: 12px;
    font-weight: 600;
    color: #eff6ff;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    box-shadow:
      0 14px 30px rgba(30, 64, 175, 0.9),
      0 0 0 1px rgba(129, 140, 248, 0.9);
    transition:
      transform 0.12s ease,
      box-shadow 0.18s ease,
      background-color 0.18s ease,
      border-color 0.18s ease;
  }

  .send-btn:hover {
    transform: translateY(-1px);
    box-shadow:
      0 18px 40px rgba(30, 64, 175, 0.95),
      0 0 0 1px rgba(129, 140, 248, 1);
    border-color: rgba(129, 140, 248, 1);
  }

  .send-btn:active {
    transform: translateY(0);
    box-shadow:
      0 6px 18px rgba(30, 64, 175, 0.98),
      0 0 0 1px rgba(79, 70, 229, 1);
  }

  .send-btn:disabled {
    opacity: 0.5;
    cursor: default;
    transform: none;
    box-shadow:
      0 6px 16px rgba(15, 23, 42, 0.9),
      0 0 0 1px rgba(30, 64, 175, 0.7);
  }

  .mic-btn {
    width: 34px;
    height: 34px;
    border-radius: 999px;
    border: 1px solid rgba(55, 65, 81, 0.95);
    background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98));
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: rgba(148, 163, 184, 0.95);
    cursor: pointer;
    box-shadow:
      0 10px 20px rgba(15, 23, 42, 0.96),
      0 0 0 1px rgba(30, 64, 175, 0.6);
    transition:
      background-color 0.16s ease,
      border-color 0.16s ease,
      box-shadow 0.16s ease,
      transform 0.12s ease,
      color 0.16s ease;
  }

  .mic-btn:hover {
    border-color: rgba(96, 165, 250, 0.9);
    background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.4), rgba(15, 23, 42, 1));
    color: #e5e7eb;
    transform: translateY(-1px);
    box-shadow:
      0 14px 30px rgba(15, 23, 42, 0.98),
      0 0 0 1px rgba(129, 140, 248, 0.9);
  }

  .mic-btn.active {
    border-color: rgba(52, 211, 153, 1);
    background: radial-gradient(circle at top left, rgba(22, 163, 74, 0.55), rgba(15, 23, 42, 1));
    color: #bbf7d0;
    box-shadow:
      0 16px 36px rgba(22, 163, 74, 0.85),
      0 0 0 1px rgba(34, 197, 94, 0.9);
  }

  .mic-btn:disabled {
    opacity: 0.5;
    cursor: default;
    transform: none;
  }

  .footer-row {
    margin-top: 14px;
    padding-top: 10px;
    border-top: 1px solid rgba(31, 41, 55, 1);
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    justify-content: space-between;
    font-size: 11px;
    color: rgba(148, 163, 184, 0.9);
  }

  .footer-left {
    max-width: 460px;
  }

  .footer-left span {
    display: inline;
  }

  .footer-right {
    text-align: right;
  }

  .footer-right a {
    color: #60a5fa;
    text-decoration: none;
  }

  .footer-right a:hover {
    text-decoration: underline;
  }

  @media (max-width: 720px) {
    #app {
      padding: 24px 10px 28px;
    }
    .shell {
      padding: 14px 12px 16px;
      border-radius: 20px;
    }
    .banner-header {
      flex-direction: column;
      align-items: flex-start;
    }
    .panel {
      margin-top: 14px;
    }
    .chat-container {
      margin-top: 8px;
    }
    #chat-log {
      max-height: 260px;
      min-height: 160px;
    }
    .footer-row {
      flex-direction: column;
      align-items: flex-start;
    }
    .footer-right {
      text-align: left;
    }
  }

  @media (max-width: 480px) {
    .banner-title-main {
      font-size: 11px;
    }
    .banner-title-sub {
      font-size: 18px;
    }
    .panel-title {
      font-size: 11px;
    }
    .panel-badge {
      font-size: 10px;
    }
    .chips-row,
    .content-row {
      flex-direction: column;
      align-items: flex-start;
    }
    .input-row {
      flex-direction: column;
      align-items: stretch;
    }
    .input-actions {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
    }
    .send-btn {
      flex: 1;
      justify-content: center;
    }
    .mic-btn {
      width: 32px;
      height: 32px;
    }
  }

  @media (max-width: 400px) {
    .shell {
      padding: 12px 10px 14px;
    }
    #app {
      padding: 18px 10px 26px;
    }
    .banner-title-sub {
      font-size: 18px;
    }
    .panel {
      padding: 12px 12px 14px;
    }
    .chat-container {
      margin-top: 8px;
    }
  }
</style>
</head>
<body>
  <div id="app">
    <div class="shell">
      
      <!-- HEADER -->
      <div class="banner-header">
        <div class="banner-avatar">E</div>
        <div class="banner-title">
          <div class="banner-title-main" id="i-banner-main">
            ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP
          </div>
          <div class="banner-title-sub" id="i-banner-sub">
            Entrenamiento ejecutivo en IA aplicada para desplegar todo tu poder.
          </div>
        </div>
      </div>

      <div class="banner-desc" id="i-banner-desc">
        Esteborg IA es tu copiloto ejecutivo de inteligencia artificial. Aqu√≠
        dise√±amos tu plan estrat√©gico, optimizamos tu negocio y entrenamos tus
        habilidades ejecutivas con IA.
      </div>

      <!-- PANEL -->
      <div class="panel">
        <div class="panel-header-row">
          <div class="panel-title-wrap">
            <div class="panel-title" id="i-panel-title">
              INICIO DEL ENTRENAMIENTO ¬∑ COPILOTO EJECUTIVO IA
            </div>
            <div class="panel-badge">
              <span class="dot"></span>
              <span>Sesi√≥n privada con Esteborg IA</span>
            </div>
          </div>
        </div>

        <!-- CHIPS: INTENCI√ìN INICIAL -->
        <div class="chips-row">
          <span class="chips-label" id="i-chips-label">Quiero empezar:</span>

          <button
            class="chip-btn starter"
            id="i-btn-automation"
            data-text="Quiero usar IA para automatizar tareas repetitivas del d√≠a a d√≠a."
          >
            Automatizar tareas
          </button>

          <button
            class="chip-btn starter"
            id="i-btn-decisions"
            data-text="Quiero que la IA me ayude a tomar mejores decisiones ejecutivas."
          >
            Decisiones ejecutivas
          </button>

          <button
            class="chip-btn starter"
            id="i-btn-business"
            data-text="Quiero lanzar una nueva l√≠nea de negocio apalancando IA generativa."
          >
            Nueva l√≠nea de negocio
          </button>

          <button
            class="chip-btn starter"
            id="i-btn-master"
            data-text="Quiero dominar ChatGPT y otras IA en mi trabajo diario."
          >
            Dominar IA diaria
          </button>
        </div>
        <div class="chips-hint">
          Da clic en alguno de estos botones para que Esteborg IA arranque tu entrenamiento con un contexto claro.
        </div>

        <!-- CHIPS: CONTENIDO VISUAL -->
        <div class="content-row">
          <span class="content-label" id="i-content-label">Material:</span>
          <button
            class="content content-btn"
            id="i-btn-slides"
            data-text="Mu√©strame las diapositivas del entrenamiento ejecutivo en IA aplicada."
          >
            Diapositivas
          </button>
          <button
            class="content content-btn"
            id="i-btn-summary"
            data-text="Dame un resumen descargable con los puntos clave del entrenamiento en IA."
          >
            Resumen IA
          </button>
        </div>

        <!-- CHAT -->
        <div class="chat-container">
          <div class="chat-header-row">
            <div class="chat-header-left">
              <div class="chat-node">E</div>
              <div class="chat-title">
                <div id="i-chat-name">Esteborg IA</div>
                <small id="i-chat-role">Copiloto Ejecutivo IA</small>
              </div>
            </div>

            <div class="chat-header-right">
              <div class="voice-row">
                <label class="voice-toggle">
                  <input type="checkbox" id="tts-toggle" />
                  <span id="i-voice-toggle-label">Voz Esteborg IA activada</span>
                </label>
                <div class="voice-pill" id="i-voice-pill">üéß Voz Esteborg IA</div>
              </div>
            </div>
          </div>

          <div class="status-row" id="status-line">
            <span class="status-dot"></span>
            <span>Preparando tu entrenamiento con Esteborg IA...</span>
          </div>

          <div class="lang-pill">
            <span class="lang-label">Idioma:</span>
            <div class="lang-options">
              <span class="lang-option active" data-lang="es">ES</span>
              <span class="lang-option" data-lang="en">EN</span>
              <span class="lang-option" data-lang="pt">PT</span>
              <span class="lang-option" data-lang="fr">FR</span>
              <span class="lang-option" data-lang="it">IT</span>
              <span class="lang-option" data-lang="de">DE</span>
            </div>
          </div>

          <div id="chat-log"></div>

          <!-- INPUT -->
          <div class="input-row">
            <textarea
              id="user-input"
              placeholder="Cu√©ntame qu√© quieres lograr con IA en los pr√≥ximos 90 d√≠as..."
            ></textarea>

            <div class="input-actions">
              <button class="send-btn" id="send-btn">
                <span>ENVIAR</span>
                <span>‚èé</span>
              </button>

              <button class="mic-btn" id="mic-btn" title="Hablar con Esteborg IA">
                üéôÔ∏è
              </button>
            </div>
          </div>
        </div>

        <!-- FOOTER -->
        <div class="footer-row">
          <div class="footer-left">
            <strong id="i-footer-token-title">Tokken Esteborg Members</strong>
            <br />
            <span id="i-footer-token-text">
              Para acceder al entrenamiento completo necesitas tu Tokken Esteborg Members.
              Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en:
              https://membersvip.esteborg.live/#miembrosvip
            </span>
          </div>
          <div class="footer-right">
            Propiedad de Esteban Manuel Gonz√°lez C√°rdenas ¬∑ Esteborg<br />
            <a href="https://esteborg.com" target="_blank" rel="noopener">esteborg.com</a>
          </div>
        </div>

      </div>
    </div>
  </div>
<script>
(() => {
  // ========== CONFIG ==========
  const API_BASE = "https://esteborg88full-backend-modular.onrender.com";
  const MODULE_PATH = "/api/modules/iavipcom";
  const TTS_URL = API_BASE + "/api/voice";
  const VIP_STORAGE_KEY = "esteborg_vip_token";

  // ========== I18N ==========
  const I18N = {
    es: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub: "Entrenamiento ejecutivo en IA aplicada para desplegar todo tu poder.",
      bannerDesc:
        "Esteborg IA es tu copiloto ejecutivo de inteligencia artificial. Aqu√≠ dise√±amos tu plan estrat√©gico, optimizamos tu negocio y entrenamos tus habilidades ejecutivas con IA.",
      panelTitle: "INICIO DEL ENTRENAMIENTO ¬∑ COPILOTO EJECUTIVO IA",

      chipsLabel: "Quiero empezar:",
      btnAutomation: "Automatizar tareas",
      btnAutomationText:
        "Quiero usar IA para automatizar tareas repetitivas del d√≠a a d√≠a.",
      btnDecisions: "Decisiones ejecutivas",
      btnDecisionsText:
        "Quiero que la IA me ayude a tomar mejores decisiones ejecutivas.",
      btnBusiness: "Nueva l√≠nea de negocio",
      btnBusinessText:
        "Quiero lanzar una nueva l√≠nea de negocio apalancando IA generativa.",
      btnMaster: "Dominar IA diaria",
      btnMasterText:
        "Quiero dominar ChatGPT y otras IA en mi trabajo diario.",

      contentLabel: "Material:",
      btnSlides: "Diapositivas",
      btnSlidesText:
        "Mu√©strame las diapositivas del entrenamiento ejecutivo en IA aplicada.",
      btnSummary: "Resumen IA",
      btnSummaryText:
        "Dame un resumen descargable con los puntos clave del entrenamiento en IA.",

      chatName: "Esteborg IA",
      chatRole: "Copiloto Ejecutivo IA",
      inputPlaceholder:
        "Cu√©ntame qu√© quieres lograr con IA en los pr√≥ximos 90 d√≠as...",

      footerTokenTitle: "Tokken Esteborg Members",
      footerTokenText:
        "Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip",

      voiceToggleLabel: "Voz Esteborg IA activada",
      voicePillLabel: "üéß Voz Esteborg IA",
      sendButtonLabel: "ENVIAR",

      statusInitialWithToken:
        "Detect√© un Tokken en la URL o guardado ¬∑ lo usar√© autom√°ticamente en tu entrenamiento con Esteborg IA.",
      statusInitialNoToken:
        "Demo activa ¬∑ si generas tu Tokken VIP en Members, lo usar√© autom√°ticamente en tu entrenamiento IA.",
      statusTokenManual:
        "Tokken pegado manualmente ¬∑ usar√© ese Tokken en tu entrenamiento IA.",
      statusTokenValid:
        "Modo Members activo ¬∑ Tokken VIP v√°lido para Esteborg IA.",
      statusTokenInvalid:
        "Tokken inv√°lido o expirado ¬∑ usando modo demo. Genera uno nuevo en Members.",
      statusDemoEnded:
        "Demo finalizada ¬∑ renueva tu acceso para seguir entrenando con Esteborg IA.",
      statusDemoActive:
        "Demo activa ¬∑ cuando est√©s listo, pega tu Tokken VIP Esteborg Members.",
      statusListening: "Escuchando... habla ahora.",
      statusProcessingSpeech: "Procesando lo que dijiste...",
      statusMicError:
        "Hubo un problema con el micr√≥fono, intenta de nuevo.",
      statusTextCaptured:
        "Texto capturado, puedes enviarlo o editarlo.",
      statusTTSOn: "Voz Esteborg IA activada.",
      statusTTSOff: "Voz Esteborg IA desactivada.",
      statusLangCurrent: "Idioma cambiado a espa√±ol.",

      tokenPasteReply:
        "Perfecto, ya tengo tu Tokken Esteborg Members ‚úÖ\nAhora dime: ¬øqu√© quieres lograr con IA en tu negocio y tu rol ejecutivo?",
      tokenWelcomeMessage:
        "‚úÖ Tu Tokken Esteborg Members est√° validado.\nEst√°s en modo Members VIP con Esteborg IA, podemos trabajar tus escenarios reales de negocio con acceso completo.",

      welcomeMessage:
        "¬°Qu√© gusto saludarte! üòä Antes de entrar a tu entrenamiento necesito tu Tokken Esteborg Members para validar tu acceso.\n\n" +
        "Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip\n\n" +
        "Una vez que tengas tu Tokken, p√©galo aqu√≠ o accede desde tu panel Members VIP. Despu√©s elige el idioma en la parte superior (ES, EN, PT, FR, IT, DE) y empezamos a dise√±ar tu plan de IA."
    },

    en: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub: "Executive training in Applied AI to unlock all your power.",
      bannerDesc:
        "Esteborg IA is your executive AI copilot. Here we design your strategic plan, optimize your business and train your executive skills with AI.",
      panelTitle: "TRAINING START ¬∑ EXECUTIVE AI COPILOT",

      chipsLabel: "I want to start with:",
      btnAutomation: "Automate tasks",
      btnAutomationText:
        "I want to use AI to automate repetitive day-to-day tasks.",
      btnDecisions: "Executive decisions",
      btnDecisionsText:
        "I want AI to help me make better executive decisions.",
      btnBusiness: "New business line",
      btnBusinessText:
        "I want to launch a new business line leveraging generative AI.",
      btnMaster: "Daily AI mastery",
      btnMasterText:
        "I want to master ChatGPT and other AIs in my daily work.",

      contentLabel: "Content:",
      btnSlides: "Slides",
      btnSlidesText:
        "Show me the slides for the executive training in Applied AI.",
      btnSummary: "AI Summary",
      btnSummaryText:
        "Give me a downloadable summary with the key points of this AI training.",

      chatName: "Esteborg IA",
      chatRole: "Executive AI copilot",
      inputPlaceholder:
        "Tell me what you want to achieve with AI in the next 90 days...",

      footerTokenTitle: "Esteborg Members Token",
      footerTokenText:
        "If you don't have a token yet, you can get or recover it at: https://membersvip.esteborg.live/#miembrosvip",

      voiceToggleLabel: "Esteborg IA voice enabled",
      voicePillLabel: "üéß Esteborg IA Voice",
      sendButtonLabel: "SEND",

      statusInitialWithToken:
        "I detected a token in the URL or stored locally ¬∑ I‚Äôll use it automatically in your AI training.",
      statusInitialNoToken:
        "Demo active ¬∑ if you generate your VIP token in Members, I‚Äôll use it automatically in your AI training.",
      statusTokenManual:
        "Token pasted manually ¬∑ I‚Äôll use that token in your AI training.",
      statusTokenValid:
        "Members mode active ¬∑ valid VIP token for Esteborg IA.",
      statusTokenInvalid:
        "Token invalid or expired ¬∑ using demo mode. Generate a new one in Members.",
      statusDemoEnded:
        "Demo finished ¬∑ renew your access to keep training with Esteborg IA.",
      statusDemoActive:
        "Demo active ¬∑ whenever you‚Äôre ready, paste your Esteborg Members VIP token.",
      statusListening: "Listening... you can speak now.",
      statusProcessingSpeech: "Processing what you said...",
      statusMicError:
        "There was a problem with the microphone, please try again.",
      statusTextCaptured:
        "Text captured, you can send it or edit it.",
      statusTTSOn: "Esteborg IA voice enabled.",
      statusTTSOff: "Esteborg IA voice disabled.",
      statusLangCurrent: "Language switched to English.",

      tokenPasteReply:
        "Perfect, I already have your Esteborg Members token ‚úÖ\nTell me now what you want to achieve with AI in your business and executive role.",
      tokenWelcomeMessage:
        "‚úÖ Your Esteborg Members token is validated.\nYou are in Members VIP mode with Esteborg IA, so we can work on your real business scenarios with full access.",

      welcomeMessage:
        "Great to see you here! üòä Before we start your training I need your Esteborg Members token to validate your access.\n\n" +
        "If you don‚Äôt have a token yet, you can get or recover it at: https://membersvip.esteborg.live/#miembrosvip\n\n" +
        "Once you have your token, paste it here or come from your Members VIP panel. Then choose your language at the top (ES, EN, PT, FR, IT, DE) and we‚Äôll start designing your AI plan."
    }.

      pt: {
  bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
  bannerSub: "Treinamento executivo em IA aplicada para liberar todo o seu poder.",
  bannerDesc:
    "Esteborg IA √© seu copiloto executivo de intelig√™ncia artificial. Aqui desenhamos seu plano estrat√©gico, otimizamos seu neg√≥cio e treinamos suas habilidades executivas com IA.",
  panelTitle: "IN√çCIO DO TREINAMENTO ¬∑ COPILOTO EXECUTIVO IA",

  chipsLabel: "Quero come√ßar por:",
  btnAutomation: "Automatizar tarefas",
  btnAutomationText: "Quero usar IA para automatizar tarefas repetitivas.",
  btnDecisions: "Decis√µes executivas",
  btnDecisionsText: "Quero que a IA me ajude a tomar melhores decis√µes.",
  btnBusiness: "Nova linha de neg√≥cio",
  btnBusinessText:
    "Quero lan√ßar uma nova linha de neg√≥cio usando IA generativa.",
  btnMaster: "Dominar IA di√°ria",
  btnMasterText: "Quero dominar ChatGPT e IA no meu dia a dia.",

  contentLabel: "Material:",
  btnSlides: "Apresenta√ß√£o",
  btnSlidesText: "Mostre os slides do treinamento executivo em IA aplicada.",
  btnSummary: "Resumo IA",
  btnSummaryText:
    "D√™-me um resumo para download com os pontos-chave da IA.",

  chatName: "Esteborg IA",
  chatRole: "Copiloto Executivo IA",
  inputPlaceholder: "Conte o que deseja alcan√ßar com IA nos pr√≥ximos 90 dias...",

  footerTokenTitle: "Tokken Esteborg Members",
  footerTokenText:
    "Se voc√™ ainda n√£o tem token, pode obt√™-lo em: https://membersvip.esteborg.live/#miembrosvip",

  voiceToggleLabel: "Voz Esteborg IA ativada",
  voicePillLabel: "üéß Voz Esteborg IA",
  sendButtonLabel: "ENVIAR",

  statusInitialWithToken:
    "Detectei um Tokken na URL ou armazenado ¬∑ usarei automaticamente.",
  statusInitialNoToken:
    "Demo ativa ¬∑ quando gerar seu Tokken VIP, usarei automaticamente.",
  statusTokenManual: "Tokken colado manualmente ¬∑ usarei ele agora.",
  statusTokenValid: "Modo Members ativo ¬∑ Tokken VIP v√°lido.",
  statusTokenInvalid: "Tokken inv√°lido ou expirado ¬∑ usando modo demo.",
  statusDemoEnded: "Demo finalizada ¬∑ renove seu acesso.",
  statusDemoActive: "Demo ativa ¬∑ cole seu Tokken quando quiser.",
  statusListening: "Ouvindo‚Ä¶ pode falar.",
  statusProcessingSpeech: "Processando‚Ä¶",
  statusMicError: "Erro com microfone.",
  statusTextCaptured: "Texto capturado.",
  statusTTSOn: "Voz ativada.",
  statusTTSOff: "Voz desativada.",
  statusLangCurrent: "Idioma alterado para portugu√™s.",

  tokenPasteReply:
    "Perfeito, j√° tenho seu Tokken Esteborg Members. O que deseja alcan√ßar com IA?",
  tokenWelcomeMessage:
    "Seu Tokken Esteborg Members √© v√°lido. Vamos trabalhar com IA em cen√°rios reais.",

  welcomeMessage:
    "Que bom ter voc√™ aqui! üòä Antes de come√ßarmos, preciso do seu Tokken Esteborg Members para validar o acesso.\n\nSe ainda n√£o tem um, obtenha em: https://membersvip.esteborg.live/#miembrosvip\n\nDepois escolha seu idioma acima (ES, EN, PT, FR, IT, DE) e come√ßaremos seu plano de IA."
},

  fr: {
  bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
  bannerSub:
    "Formation ex√©cutive en IA appliqu√©e pour lib√©rer tout votre potentiel.",
  bannerDesc:
    "Esteborg IA est votre copilote ex√©cutif en intelligence artificielle. Nous concevons votre plan strat√©gique et optimisons votre entreprise gr√¢ce √† l‚ÄôIA.",
  panelTitle: "D√âBUT DE LA FORMATION ¬∑ COPILOTE IA",

  chipsLabel: "Je veux commencer par :",
  btnAutomation: "Automatiser des t√¢ches",
  btnAutomationText:
    "Je veux utiliser l‚ÄôIA pour automatiser des t√¢ches r√©p√©titives.",
  btnDecisions: "D√©cisions ex√©cutives",
  btnDecisionsText:
    "Je veux que l‚ÄôIA m‚Äôaide √† prendre de meilleures d√©cisions.",
  btnBusiness: "Nouvelle activit√©",
  btnBusinessText:
    "Je veux lancer une nouvelle activit√© gr√¢ce √† l‚ÄôIA g√©n√©rative.",
  btnMaster: "Ma√Ætriser l‚ÄôIA quotidienne",
  btnMasterText:
    "Je veux ma√Ætriser ChatGPT et l‚ÄôIA au quotidien.",

  contentLabel: "Contenu :",
  btnSlides: "Diapositives",
  btnSlidesText:
    "Montrez-moi les diapositives de la formation ex√©cutive en IA appliqu√©e.",
  btnSummary: "R√©sum√© IA",
  btnSummaryText:
    "Donnez-moi un r√©sum√© t√©l√©chargeable avec les points cl√©s.",

  chatName: "Esteborg IA",
  chatRole: "Copilote Ex√©cutif IA",
  inputPlaceholder:
    "Dites-moi ce que vous souhaitez accomplir avec l‚ÄôIA dans les 90 prochains jours‚Ä¶",

  footerTokenTitle: "Tokken Esteborg Members",
  footerTokenText:
    "Si vous n‚Äôavez pas de token, obtenez-le ici : https://membersvip.esteborg.live/#miembrosvip",

  voiceToggleLabel: "Voix Esteborg IA activ√©e",
  voicePillLabel: "üéß Voix Esteborg IA",
  sendButtonLabel: "ENVOYER",

  statusInitialWithToken:
    "Tokken d√©tect√© ¬∑ utilis√© automatiquement.",
  statusInitialNoToken: "Demo active.",
  statusTokenManual:
    "Tokken coll√© manuellement.",
  statusTokenValid: "Mode Members actif.",
  statusTokenInvalid: "Tokken invalide ¬∑ mode demo.",
  statusDemoEnded: "Demo termin√©e.",
  statusDemoActive: "Demo active.",
  statusListening: "√âcoute‚Ä¶",
  statusProcessingSpeech: "Traitement‚Ä¶",
  statusMicError: "Erreur micro.",
  statusTextCaptured: "Texte captur√©.",
  statusTTSOn: "Voix activ√©e.",
  statusTTSOff: "Voix d√©sactiv√©e.",
  statusLangCurrent: "Langue chang√©e en fran√ßais.",

  tokenPasteReply:
    "Parfait, j‚Äôai votre Tokken. Quel objectif IA souhaitez-vous atteindre ?",
  tokenWelcomeMessage:
    "Votre Tokken Esteborg Members est valid√©. Travaillons sur vos sc√©narios d‚ÄôIA.",

  welcomeMessage:
    "Ravi de vous voir ici ! üòä Avant de commencer, j‚Äôai besoin de votre Tokken Esteborg Members.\n\nObtenez-le ici : https://membersvip.esteborg.live/#miembrosvip\n\nChoisissez ensuite votre langue ci-dessus (ES, EN, PT, FR, IT, DE)."
},

  it: {
  bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
  bannerSub:
    "Formazione executive in IA applicata per liberare tutto il tuo potenziale.",
  bannerDesc:
    "Esteborg IA √® il tuo copilota esecutivo di intelligenza artificiale. Disegniamo il tuo piano strategico e ottimizziamo la tua azienda con l‚ÄôIA.",
  panelTitle: "INIZIO DEL TRAINING ¬∑ COPILOTA IA",

  chipsLabel: "Voglio iniziare da:",
  btnAutomation: "Automatizzare compiti",
  btnAutomationText:
    "Voglio usare l‚ÄôIA per automatizzare attivit√† ripetitive.",
  btnDecisions: "Decisioni executive",
  btnDecisionsText:
    "Voglio che l‚ÄôIA mi aiuti a prendere decisioni migliori.",
  btnBusiness: "Nuova linea di business",
  btnBusinessText:
    "Voglio lanciare una nuova linea di business sfruttando l‚ÄôIA generativa.",
  btnMaster: "Dominare IA quotidiana",
  btnMasterText:
    "Voglio dominare ChatGPT e l‚ÄôIA nel mio lavoro quotidiano.",

  contentLabel: "Materiale:",
  btnSlides: "Slide",
  btnSlidesText:
    "Mostrami le slide del training executive in IA applicata.",
  btnSummary: "Sintesi IA",
  btnSummaryText:
    "Dammi una sintesi scaricabile con i punti chiave.",

  chatName: "Esteborg IA",
  chatRole: "Copilota Esecutivo IA",
  inputPlaceholder:
    "Dimmi cosa vuoi ottenere con l‚ÄôIA nei prossimi 90 giorni‚Ä¶",

  footerTokenTitle: "Tokken Esteborg Members",
  footerTokenText:
    "Se non hai un token, ottienilo qui: https://membersvip.esteborg.live/#miembrosvip",

  voiceToggleLabel: "Voce Esteborg IA attivata",
  voicePillLabel: "üéß Voce Esteborg IA",
  sendButtonLabel: "INVIA",

  statusInitialWithToken:
    "Tokken rilevato ¬∑ utilizzo automatico.",
  statusInitialNoToken: "Demo attiva.",
  statusTokenManual:
    "Tokken incollato manualmente.",
  statusTokenValid: "Modalit√† Members attiva.",
  statusTokenInvalid: "Tokken non valido.",
  statusDemoEnded: "Demo terminata.",
  statusDemoActive: "Demo attiva.",
  statusListening: "Ascolto‚Ä¶",
  statusProcessingSpeech: "Elaborazione‚Ä¶",
  statusMicError: "Errore microfono.",
  statusTextCaptured: "Testo acquisito.",
  statusTTSOn: "Voce attivata.",
  statusTTSOff: "Voce disattivata.",
  statusLangCurrent: "Lingua cambiata in italiano.",

  tokenPasteReply:
    "Perfetto, ho il tuo Tokken. Cosa vuoi ottenere con l‚ÄôIA?",
  tokenWelcomeMessage:
    "Tokken valido. Lavoriamo sui tuoi scenari concreti.",

  welcomeMessage:
    "Felice di vederti! üòä Per iniziare ho bisogno del tuo Tokken.\n\nOttienilo qui: https://membersvip.esteborg.live/#miembrosvip\n\nPoi scegli la lingua sopra (ES, EN, PT, FR, IT, DE)."
},

  de: {
  bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
  bannerSub:
    "Executive-Training in angewandter KI, um dein volles Potenzial freizusetzen.",
  bannerDesc:
    "Esteborg IA ist dein Executive-KI-Copilot. Wir entwickeln deinen Strategieplan und optimieren dein Unternehmen mit KI.",
  panelTitle: "TRAININGSSTART ¬∑ KI-COPILOT",

  chipsLabel: "Ich m√∂chte beginnen mit:",
  btnAutomation: "Aufgaben automatisieren",
  btnAutomationText:
    "Ich m√∂chte KI nutzen, um wiederkehrende Aufgaben zu automatisieren.",
  btnDecisions: "Executive-Entscheidungen",
  btnDecisionsText:
    "Ich m√∂chte bessere Entscheidungen mithilfe von KI treffen.",
  btnBusiness: "Neue Gesch√§ftslinie",
  btnBusinessText:
    "Ich m√∂chte eine neue Gesch√§ftslinie mit generativer KI starten.",
  btnMaster: "KI im Alltag beherrschen",
  btnMasterText:
    "Ich m√∂chte ChatGPT und KI im Arbeitsalltag meistern.",

  contentLabel: "Material:",
  btnSlides: "Folien",
  btnSlidesText:
    "Zeig mir die Folien des Executive-Trainings in angewandter KI.",
  btnSummary: "KI-Zusammenfassung",
  btnSummaryText:
    "Gib mir eine herunterladbare Zusammenfassung der wichtigsten Punkte.",

  chatName: "Esteborg IA",
  chatRole: "Executive KI-Copilot",
  inputPlaceholder:
    "Erz√§hl mir, was du in den n√§chsten 90 Tagen mit KI erreichen m√∂chtest‚Ä¶",

  footerTokenTitle: "Tokken Esteborg Members",
  footerTokenText:
    "Wenn du noch keinen Token hast, bekommst du ihn hier: https://membersvip.esteborg.live/#miembrosvip",

  voiceToggleLabel: "Esteborg IA-Stimme aktiviert",
  voicePillLabel: "üéß Esteborg IA-Stimme",
  sendButtonLabel: "SENDEN",

  statusInitialWithToken: "Tokken erkannt ¬∑ automatische Nutzung.",
  statusInitialNoToken: "Demo aktiv.",
  statusTokenManual: "Tokken manuell eingetragen.",
  statusTokenValid: "Members-Modus aktiv.",
  statusTokenInvalid: "Tokken ung√ºltig.",
  statusDemoEnded: "Demo beendet.",
  statusDemoActive: "Demo aktiv.",
  statusListening: "Ich h√∂re zu‚Ä¶",
  statusProcessingSpeech: "Verarbeite‚Ä¶",
  statusMicError: "Mikrofonfehler.",
  statusTextCaptured: "Text erfasst.",
  statusTTSOn: "Stimme aktiviert.",
  statusTTSOff: "Stimme deaktiviert.",
  statusLangCurrent: "Sprache auf Deutsch ge√§ndert.",

  tokenPasteReply:
    "Perfekt, ich habe deinen Tokken. Was m√∂chtest du mit KI erreichen?",
  tokenWelcomeMessage:
    "Tokken g√ºltig. Lassen Sie uns an echten KI-Szenarien arbeiten.",

  welcomeMessage:
    "Sch√∂n, dich hier zu sehen! üòä Bevor wir starten, brauche ich deinen Tokken.\n\nHier bekommst du ihn: https://membersvip.esteborg.live/#miembrosvip\n\nDann w√§hle oben deine Sprache (ES, EN, PT, FR, IT, DE)."
}
  };

  function t(key, langOverride) {
    const lang = langOverride || currentLang || "es";
    const pack = I18N[lang] || I18N.es;
    return pack[key] || I18N.es[key] || "";
  }

  // ========== TOKEN VIP ==========
  let VIP_TOKEN = null;
  let hasShownTokenWelcome = false;

  function getVIPTokenFromURL() {
    try {
      const params = new URLSearchParams(window.location.search || "");
      const raw =
        params.get("tokken") ||
        params.get("access_token") ||
        params.get("token") ||
        "";
      const trimmed = (raw || "").trim();
      console.log(
        "[IA] Tokken detectado en URL:",
        trimmed ? trimmed.slice(0, 40) + "..." : "(ninguno)"
      );
      return trimmed || null;
    } catch (e) {
      console.warn("[IA] Error leyendo URL:", e);
      return null;
    }
  }

  window.addEventListener("message", (event) => {
    if (!event.data || event.data.type !== "esteborg-token") return;
    const tokken = (event.data.tokken || "").trim();
    if (!tokken) return;
    VIP_TOKEN = tokken;
    console.log("[IA] Tokken recibido por postMessage:", VIP_TOKEN.slice(0, 40) + "...");
    try {
      localStorage.setItem(VIP_STORAGE_KEY, VIP_TOKEN);
    } catch (e) {
      console.warn("[IA] No pude guardar Tokken desde postMessage:", e);
    }
  });

  // ========== DOM & STATE ==========
  let currentLang = "es";
  let history = [];
  let isSending = false;
  let currentAudio = null;
  let recognition = null;
  let isRecording = false;

  const $ = (id) => document.getElementById(id);

  function getEls() {
    return {
      bannerMainEl: $("i-banner-main"),
      bannerSubEl: $("i-banner-sub"),
      bannerDescEl: $("i-banner-desc"),
      panelTitleEl: $("i-panel-title"),
      chipsLabelEl: $("i-chips-label"),
      contentLabelEl: $("i-content-label"),
      chatNameEl: $("i-chat-name"),
      chatRoleEl: $("i-chat-role"),
      inputEl: $("user-input"),
      sendBtn: $("send-btn"),
      micBtn: $("mic-btn"),
      statusLine: $("status-line"),
      chatLog: $("chat-log"),
      ttsToggle: $("tts-toggle"),
      voiceToggleLabel: $("i-voice-toggle-label"),
      voicePill: $("i-voice-pill"),
      footerTokenTitleEl: $("i-footer-token-title"),
      footerTokenTextEl: $("i-footer-token-text"),
      langOptions: document.querySelectorAll(".lang-option"),
      starterBtns: document.querySelectorAll(".chip-btn.starter"),
      contentBtns: document.querySelectorAll(".content-btn.content")
    };
  }

  const els = {};

  // ========== UI ==========
  function applyUILanguage() {
    const s = (key) => t(key);

    if (els.bannerMainEl) els.bannerMainEl.textContent = s("bannerMain");
    if (els.bannerSubEl) els.bannerSubEl.textContent = s("bannerSub");
    if (els.bannerDescEl) els.bannerDescEl.textContent = s("bannerDesc");
    if (els.panelTitleEl) els.panelTitleEl.textContent = s("panelTitle");

    if (els.chipsLabelEl) els.chipsLabelEl.textContent = s("chipsLabel");
    if (els.contentLabelEl) els.contentLabelEl.textContent = s("contentLabel");

    if (els.chatNameEl) els.chatNameEl.textContent = s("chatName");
    if (els.chatRoleEl) els.chatRoleEl.textContent = s("chatRole");

    if (els.inputEl) els.inputEl.placeholder = s("inputPlaceholder");

    if (els.footerTokenTitleEl)
      els.footerTokenTitleEl.textContent = s("footerTokenTitle");
    if (els.footerTokenTextEl)
      els.footerTokenTextEl.textContent = s("footerTokenText");

    if (els.voiceToggleLabel)
      els.voiceToggleLabel.textContent = s("voiceToggleLabel");
    if (els.voicePill) els.voicePill.textContent = s("voicePillLabel");
    if (els.sendBtn) els.sendBtn.textContent = s("sendButtonLabel");

    if (els.statusLine) {
      const spans = els.statusLine.querySelectorAll("span");
      if (spans.length > 1) spans[1].textContent = s("statusInitialNoToken");
    }

    const btnAuto = $("i-btn-automation");
    const btnDec = $("i-btn-decisions");
    const btnBiz = $("i-btn-business");
    const btnMaster = $("i-btn-master");
    const btnSlides = $("i-btn-slides");
    const btnSummary = $("i-btn-summary");

    if (btnAuto) {
      btnAuto.textContent = s("btnAutomation");
      btnAuto.dataset.text = s("btnAutomationText");
    }
    if (btnDec) {
      btnDec.textContent = s("btnDecisions");
      btnDec.dataset.text = s("btnDecisionsText");
    }
    if (btnBiz) {
      btnBiz.textContent = s("btnBusiness");
      btnBiz.dataset.text = s("btnBusinessText");
    }
    if (btnMaster) {
      btnMaster.textContent = s("btnMaster");
      btnMaster.dataset.text = s("btnMasterText");
    }
    if (btnSlides) {
      btnSlides.textContent = s("btnSlides");
      btnSlides.dataset.text = s("btnSlidesText");
    }
    if (btnSummary) {
      btnSummary.textContent = s("btnSummary");
      btnSummary.dataset.text = s("btnSummaryText");
    }
  }

  function setStatus(keyOrText) {
    if (!els.statusLine) return;
    const spans = els.statusLine.querySelectorAll("span");
    const txt =
      typeof keyOrText === "string" ? t(keyOrText) : String(keyOrText || "");
    if (spans.length > 1) spans[1].textContent = txt;
    else els.statusLine.textContent = txt;
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function appendMessage(role, content) {
    if (!els.chatLog) return;

    const raw = content || "";
    const processed = raw.replace(/^###\s*/gm, "");
    const safe = escapeHtml(processed);

    const row = document.createElement("div");
    row.className = "msg-row " + (role === "user" ? "user" : "assistant");

    const tag = document.createElement("div");
    tag.className = "msg-tag " + (role === "user" ? "user" : "assistant");
    tag.textContent = role === "user" ? "T√∫" : t("chatName");

    const bubble = document.createElement("div");
    bubble.className = "msg-bubble";
    bubble.innerHTML = '<div class="msg-text">' + safe + "</div>";
    if (role === "user") {
      row.appendChild(bubble);
      row.appendChild(tag);
    } else {
      row.appendChild(tag);
      row.appendChild(bubble);
    }

    els.chatLog.appendChild(row);
    els.chatLog.scrollTop = els.chatLog.scrollHeight;
  }

  // ========== TTS ==========
  function stopTTS() {
    if (currentAudio) {
      try {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      } catch (_) {}
    }
  }

  async function playTTS(text) {
  if (!els.ttsToggle || !els.ttsToggle.checked) return;
  if (!text) return;

  try {
    // --- LIMPIADOR DE VOZ (NO LEE SIGNOS) ---
    let cleaned = text
      .replace(/\.\.\./g, " ")      // elimina "..."
      .replace(/[.,;:!?¬°¬ø(){}\[\]"‚Äú‚Äù‚Äò‚Äô]/g, " ")  // signos
      .replace(/-/g, " ")           // guiones
      .replace(/\s+/g, " ")         // compacta espacios
      .trim();

    // acorta para ElevenLabs si es muy largo
    if (cleaned.length > 450) cleaned = cleaned.slice(0, 450);

    const res = await fetch(TTS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        text: cleaned,
        voiceId: "IdhxxSTaAg80CTeSgScm"
      })
    });

    if (!res.ok) {
      console.error("[TTS] error:", await res.text());
      return;
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);

    stopTTS();
    currentAudio = new Audio(url);
    currentAudio.play().catch((err) => {
      console.warn("[TTS] no se pudo reproducir:", err);
    });
  } catch (e) {
    console.error("[TTS] error general:", e);
  }
}

  // ========== SPEECH ==========
  function getSpeechLangCode(lang) {
    switch (lang) {
      case "en":
        return "en-US";
      case "pt":
        return "pt-BR";
      case "fr":
        return "fr-FR";
      case "it":
        return "it-IT";
      case "de":
        return "de-DE";
      default:
        return "es-MX";
    }
  }

  function initSpeechRecognition() {
    const SR =
      window.SpeechRecognition || window.webkitSpeechRecognition || null;
    if (!SR || !els.micBtn) return;

    recognition = new SR();
    recognition.lang = getSpeechLangCode(currentLang);
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      isRecording = true;
      els.micBtn.classList.add("active");
      setStatus("statusListening");
    };
    recognition.onend = () => {
      isRecording = false;
      els.micBtn.classList.remove("active");
      setStatus("statusProcessingSpeech");
    };
    recognition.onerror = (e) => {
      isRecording = false;
      els.micBtn.classList.remove("active");
      console.warn("[IA] Speech error:", e);
      setStatus("statusMicError");
    };
    recognition.onresult = (e) => {
      const transcript = e.results[0][0].transcript.trim();
      if (transcript && els.inputEl) {
        els.inputEl.value = transcript;
        setStatus("statusTextCaptured");
      }
    };
  }

  function toggleMic() {
    if (!recognition) return;
    try {
      if (!isRecording) recognition.start();
      else recognition.stop();
    } catch (err) {
      console.warn("[IA] No se pudo iniciar reconocimiento:", err);
    }
  }

  // ========== BACKEND ==========
  async function sendToBackend(userText) {
    const tokenToSend = VIP_TOKEN || getVIPTokenFromURL();
    console.log(
      "[IA] Enviando mensaje:",
      userText,
      "Tokken:",
      tokenToSend ? tokenToSend.slice(0, 40) + "..." : "(null)"
    );

    stopTTS();
    isSending = true;
    if (els.sendBtn) els.sendBtn.disabled = true;
    if (els.inputEl) els.inputEl.disabled = true;
    if (els.micBtn) els.micBtn.disabled = true;

    try {
      const resp = await fetch(API_BASE + MODULE_PATH, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: userText,
          rawToken: tokenToSend,
          userName: null,
          history,
          lang: currentLang
        })
      });

      console.log("[IA] Respuesta HTTP:", resp.status);
      if (!resp.ok) throw new Error("HTTP " + resp.status);

      const data = await resp.json();
      console.log("[IA] Payload backend:", data);

      const reply =
        data.reply ||
        data.message ||
        "No tengo una respuesta en este momento, intenta de nuevo.";

      appendMessage("assistant", reply);
      history.push({ role: "assistant", content: reply });

      if (data.tokenStatus === "valid") {
        setStatus("statusTokenValid");
        if (!hasShownTokenWelcome) {
          const tokenMsg = t("tokenWelcomeMessage");
          appendMessage("assistant", tokenMsg);
          history.push({ role: "assistant", content: tokenMsg });
          hasShownTokenWelcome = true;
        }
      } else if (data.tokenStatus === "invalid") {
        setStatus("statusTokenInvalid");
      } else if (data.demoStatus === "ended") {
        setStatus("statusDemoEnded");
      } else {
        setStatus("statusDemoActive");
      }

      await playTTS(reply);
    } catch (err) {
      console.error("[IA] Error:", err);
      appendMessage(
        "assistant",
        "Hubo un problema al conectar con el servidor. Intenta de nuevo en unos segundos."
      );
      setStatus("statusDemoActive");
    } finally {
      isSending = false;
      if (els.sendBtn) els.sendBtn.disabled = false;
      if (els.inputEl) els.inputEl.disabled = false;
      if (els.micBtn) els.micBtn.disabled = false;
      if (els.inputEl) els.inputEl.focus();
    }
  }

  async function handleSend(fromText) {
    if (isSending) return;

    const baseText =
      fromText != null
        ? fromText
        : (els.inputEl && els.inputEl.value) || "";
    const text = baseText.trim();
    if (!text) return;

    const candidate = text.replace(/\s+/g, "");
    const looksLikeTokken =
      /^[A-Za-z0-9+/=_-]{40,}$/.test(candidate) && !candidate.includes(".");

    if (fromText == null && looksLikeTokken) {
      VIP_TOKEN = candidate;
      console.log(
        "[IA] Tokken pegado (interceptado, no se manda al backend):",
        VIP_TOKEN.slice(0, 40) + "..."
      );
      try {
        localStorage.setItem(VIP_STORAGE_KEY, VIP_TOKEN);
      } catch (e) {
        console.warn("[IA] No pude guardar Tokken en localStorage:", e);
      }
      appendMessage("assistant", t("tokenPasteReply"));
      setStatus("statusTokenManual");
      if (els.inputEl) els.inputEl.value = "";
      return;
    }

    appendMessage("user", text);
    history.push({ role: "user", content: text });
    if (els.inputEl) els.inputEl.value = "";

    await sendToBackend(text);
  }

  // ========== SESI√ìN ==========
  function startSession(updateStatus) {
    if (typeof updateStatus === "undefined") updateStatus = true;

    if (els.chatLog) els.chatLog.innerHTML = "";
    history = [];
    stopTTS();

    const welcome = t("welcomeMessage");
    appendMessage("assistant", welcome);
    playTTS(welcome);

    try {
      const stored = localStorage.getItem(VIP_STORAGE_KEY);
      if (stored) {
        VIP_TOKEN = stored.trim();
        console.log("[IA] Tokken recuperado de localStorage");
      } else {
        VIP_TOKEN = getVIPTokenFromURL();
      }
    } catch (e) {
      console.warn("[IA] No pude leer localStorage:", e);
      VIP_TOKEN = getVIPTokenFromURL();
    }

    if (updateStatus) {
      if (VIP_TOKEN) setStatus("statusInitialWithToken");
      else setStatus("statusInitialNoToken");
    }
  }

  // ========== RESIZE PARA CARRD ==========
  function sendHeight() {
    const height = document.body.scrollHeight;
    window.parent.postMessage(
      { type: "esteborg-resize", height: height },
      "*"
    );
  }

  window.addEventListener("load", sendHeight);
  window.addEventListener("resize", sendHeight);
  setInterval(sendHeight, 600);

  // ========== INIT ==========
  window.addEventListener("DOMContentLoaded", () => {
    Object.assign(els, getEls());
    applyUILanguage();

    if (els.starterBtns) {
      els.starterBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const txt = btn.dataset.text || btn.textContent || "";
          handleSend(txt);
        });
      });
    }

    if (els.contentBtns) {
      els.contentBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const txt = btn.dataset.text || btn.textContent || "";
          handleSend(txt);
        });
      });
    }

    if (els.sendBtn) {
      els.sendBtn.addEventListener("click", () => handleSend());
    }

    if (els.inputEl) {
      els.inputEl.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" && !ev.shiftKey) {
          ev.preventDefault();
          handleSend();
        }
      });
    }

    if (els.langOptions && els.langOptions.length) {
      els.langOptions.forEach((opt) => {
        opt.addEventListener("click", () => {
          const lang = opt.dataset.lang;
          if (!lang || lang === currentLang) return;

          currentLang = lang;
          els.langOptions.forEach((o) =>
            o.classList.toggle("active", o === opt)
          );

          applyUILanguage();
          setStatus("statusLangCurrent");
          startSession(false);
        });
      });
    }

    initSpeechRecognition();
    if (els.micBtn) {
      els.micBtn.addEventListener("click", toggleMic);
    }

    if (els.ttsToggle && els.voicePill) {
      els.ttsToggle.addEventListener("change", () => {
        setStatus(els.ttsToggle.checked ? "statusTTSOn" : "statusTTSOff");
      });
      els.voicePill.addEventListener("click", () => {
        els.ttsToggle.checked = !els.ttsToggle.checked;
        setStatus(els.ttsToggle.checked ? "statusTTSOn" : "statusTTSOff");
      });
    }

    startSession(true);
  });
})();
</script>

</body>
</html>
