<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Esteborg IA ¬∑ Coach profesional de Inteligencia Artificial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      height: 100%;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Inter", sans-serif;
      background: radial-gradient(circle at top, #28224b 0, #050509 55%, #020208 100%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px 8px 32px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    #app {
      width: 100%;
      max-width: 960px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .shell {
      position: relative;
      border-radius: 32px;
      padding: 26px 26px 22px;
      background:
        radial-gradient(circle at top left, rgba(94, 234, 212, 0.06), transparent 55%),
        radial-gradient(circle at bottom right, rgba(251, 191, 36, 0.09), transparent 55%),
        rgba(3, 7, 18, 0.96);
      box-shadow:
        0 30px 90px rgba(0, 0, 0, 0.95),
        0 0 0 1px rgba(148, 163, 184, 0.28),
        0 0 32px rgba(56, 189, 248, 0.25);
      border: 1px solid rgba(75, 85, 99, 0.75);
      max-height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }

    .banner-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 10px;
    }

    .banner-avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #38bdf8, #4f46e5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 20px;
      color: #ecfeff;
      box-shadow:
        0 0 0 2px rgba(15, 23, 42, 1),
        0 0 0 1px rgba(226, 232, 240, 0.9),
        0 0 32px rgba(96, 165, 250, 0.95);
    }

    .banner-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .banner-title-main {
      font-size: 13px;
      letter-spacing: 0.19em;
      text-transform: uppercase;
      color: rgba(209, 213, 219, 0.96);
    }

    .banner-title-sub {
      font-size: 22px;
      font-weight: 650;
      letter-spacing: 0.02em;
      color: #e5e7eb;
    }

    .banner-description {
      margin-top: 4px;
      font-size: 13px;
      color: rgba(209, 213, 219, 0.92);
    }

    .panel {
      margin-top: 18px;
      border-radius: 22px;
      padding: 14px 16px 14px;
      background:
        linear-gradient(
          145deg,
          rgba(15, 23, 42, 0.96),
          rgba(15, 23, 42, 0.85)
        );
      border: 1px solid rgba(148, 163, 184, 0.8);
      box-shadow:
        inset 0 0 0 1px rgba(15, 23, 42, 0.96),
        0 18px 40px rgba(15, 23, 42, 0.95);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .panel-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: rgba(148, 163, 184, 0.95);
    }

    .panel-badge {
      border-radius: 999px;
      padding: 4px 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      border: 1px solid rgba(52, 211, 153, 0.6);
      color: #a7f3d0;
      background: radial-gradient(circle at top left, rgba(16, 185, 129, 0.35), rgba(15, 23, 42, 0.98));
    }

    .panel-badge .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle at center, #22c55e, #15803d);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.95);
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 11px;
      color: rgba(156, 163, 175, 0.95);
    }

    .chips-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(148, 163, 184, 0.98);
    }

    .chip-btn {
      border-radius: 999px;
      border: 1px solid rgba(129, 140, 248, 0.9);
      background: radial-gradient(circle at top, rgba(79, 70, 229, 0.95), rgba(30, 64, 175, 0.98));
      color: #e5e7eb;
      padding: 4px 11px;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow:
        0 10px 22px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(191, 219, 254, 0.35);
    }

    .content-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
    }

    .content-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(148, 163, 184, 0.98);
    }

    .content-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.86));
      color: rgba(209, 213, 219, 0.98);
      padding: 4px 10px;
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* CHAT */
    .chat-container {
      margin-top: 10px;
      border-radius: 20px;
      padding: 10px 10px 12px;
      background:
        radial-gradient(circle at top left, rgba(96, 165, 250, 0.07), transparent 55%),
        radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.09), transparent 55%),
        rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(55, 65, 81, 0.95);
      box-shadow:
        inset 0 0 0 1px rgba(15, 23, 42, 1),
        0 20px 42px rgba(15, 23, 42, 0.98);
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 2px 6px;
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-node {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid rgba(191, 219, 254, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: #e5e7eb;
      background: radial-gradient(circle at top, #4f46e5, #0ea5e9);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 0 18px rgba(129, 140, 248, 0.95);
    }

    .chat-title {
      display: flex;
      flex-direction: column;
      gap: 0;
      font-size: 11px;
      color: #e5e7eb;
    }

    .chat-title small {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: rgba(148, 163, 184, 0.95);
    }

    .chat-language-pill {
      display: inline-flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 4px;
      border-radius: 999px;
      padding: 3px 7px;
      border: 1px solid rgba(248, 250, 252, 0.3);
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.9));
      font-size: 11px;
      color: rgba(229, 231, 235, 0.98);
    }

    .lang-option {
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      cursor: pointer;
    }

    .lang-option.active {
      border-color: rgba(96, 165, 250, 0.95);
      background: radial-gradient(circle at top, rgba(59, 130, 246, 0.9), rgba(15, 23, 42, 0.9));
    }

    #chat-log {
      margin-top: 8px;
      border-radius: 18px;
      background: rgba(5, 7, 18, 0.96);
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 12px;
      flex: 1;
      min-height: 180px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg-row {
      display: flex;
      align-items: flex-start;
      gap: 6px;
    }

    .msg-row.user { justify-content: flex-end; }

    .msg-tag {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 7px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      opacity: 0.9;
      white-space: nowrap;
    }

    .msg-tag.user {
      color: rgba(248, 250, 252, 0.96);
      border-color: rgba(248, 250, 252, 0.6);
    }

    .msg-tag.assistant {
      color: rgba(52, 211, 153, 0.96);
      border-color: rgba(52, 211, 153, 0.7);
    }

    .msg-bubble {
      max-width: 88%;
      padding: 8px 12px;
      border-radius: 14px;
      font-size: 15px;      /* üëà tama√±o tipo chat */
      line-height: 1.5;
      border: 1px solid transparent;
    }

    .msg-row.user .msg-bubble {
      border-radius: 14px 14px 3px 14px;
      background: linear-gradient(135deg, #1d4ed8, #4c1d95);
      border-color: rgba(191, 219, 254, 0.4);
      color: #e5e7eb;
    }

    .msg-row.assistant .msg-bubble {
      border-radius: 14px 14px 14px 3px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.92));
      border-color: rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
    }

    .msg-text { white-space: pre-wrap; }

    .input-row {
      margin-top: 10px;
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto auto;
      gap: 8px;
      align-items: stretch;
    }

    .input-row textarea {
      resize: none;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.95);
      background: radial-gradient(circle at top, rgba(3, 7, 18, 0.98), rgba(3, 7, 18, 0.95));
      color: #e5e7eb;
      padding: 10px 14px;
      font-size: 13px;
      min-height: 44px;
      max-height: 84px;
      line-height: 1.4;
      outline: none;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 14px 24px rgba(15, 23, 42, 0.98);
    }

    .input-row textarea::placeholder {
      color: rgba(148, 163, 184, 0.95);
    }

    .send-button,
    .mic-button {
      border-radius: 999px;
      border: none;
      padding: 0 18px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .send-button {
      background: radial-gradient(circle at top left, #facc15, #f97316);
      color: #111827;
      box-shadow:
        0 12px 24px rgba(248, 184, 75, 0.85),
        0 0 0 1px rgba(251, 191, 36, 0.9);
    }

    .mic-button {
      background: radial-gradient(circle at top left, #0ea5e9, #4f46e5);
      color: #e0f2fe;
      box-shadow:
        0 12px 24px rgba(56, 189, 248, 0.7),
        0 0 0 1px rgba(191, 219, 254, 0.7);
      font-size: 18px;
      padding: 0 14px;
    }

    .mic-button.active {
      box-shadow:
        0 0 0 1px rgba(96, 165, 250, 0.95),
        0 0 22px rgba(56, 189, 248, 1);
    }

    .status-line {
      margin-top: 6px;
      font-size: 11px;
      color: rgba(148, 163, 184, 0.96);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle at center, #22c55e, #15803d);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.95);
      transform: translateY(-0.5px);
    }

    .voice-row {
      margin-top: 6px;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: rgba(226, 232, 240, 0.96);
    }

    .voice-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .voice-toggle input { accent-color: #facc15; }

    .voice-pill {
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(251, 191, 36, 0.75);
      background: radial-gradient(circle at top, rgba(250, 204, 21, 0.85), rgba(15, 23, 42, 0.95));
      color: #111827;
      font-weight: 600;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .footer-row {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      font-size: 11px;
      color: rgba(148, 163, 184, 0.95);
    }

    .footer-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .footer-left strong {
      font-weight: 600;
      color: rgba(229, 231, 235, 0.96);
    }

    .footer-right {
      font-size: 10px;
      color: rgba(148, 163, 184, 0.9);
      text-align: right;
    }

    .footer-right a {
      color: #a5b4fc;
      text-decoration: none;
    }

    /* Tablet / m√≥vil grande */
    @media (max-width: 720px) {
      body {
        padding: 0;
        height: auto;
        min-height: 100vh;
        overflow-y: auto;
        align-items: stretch;
        justify-content: flex-start;
      }

      #app {
        padding: 18px 0 22px;
        width: 100%;
      }

      .shell {
        max-width: 100%;
        margin: 0;
        padding: 14px 12px 16px;
        border-radius: 0;
      }

      .banner-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .panel {
        margin-top: 14px;
        padding: 12px 12px 14px;
      }

      .chat-container {
        margin-top: 8px;
        -webkit-overflow-scrolling: touch;
      }

      #chat-log {
        min-height: 260px;
        max-height: none;
      }

      .footer-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .footer-right {
        text-align: left;
      }
    }

    /* M√≥vil chico */
    @media (max-width: 480px) {
      .banner-title-main { font-size: 11px; }
      .banner-title-sub { font-size: 18px; }

      .panel-title { font-size: 11px; }

      .panel-badge { font-size: 10px; }

      .chips-row,
      .content-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .input-row {
        flex-direction: column;
        align-items: stretch;
        display: flex;
      }

      #app { padding: 14px 0 18px; }
      .shell { padding: 12px 10px 14px; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="shell">
      <div class="banner-header">
        <div class="banner-avatar">E</div>
        <div class="banner-title">
          <div class="banner-title-main" id="i-banner-main">
            ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP
          </div>
          <div class="banner-title-sub" id="i-banner-sub">
            Programa ejecutivo ¬∑ Coach profesional de Inteligencia Artificial
          </div>
        </div>
      </div>
      <div class="banner-description" id="i-banner-desc">
        Esteborg IA ‚Äì Despliega todo tu poder es tu programa ejecutivo para usar
        la Inteligencia Artificial como ventaja real en tu trabajo, negocio y vida.
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title" id="i-panel-title">
            Mini entrenamiento ¬∑ Esteborg IA ‚Äì Despliega todo tu poder
          </div>
          <div class="panel-badge">
            <span class="dot"></span>
            <span>Members VIP</span>
          </div>
        </div>

        <!-- CHIPS: SESI√ìN -->
        <div class="chips-row">
          <span class="chips-label" id="i-chips-label">Comenzar entrenamiento:</span>
          <button
            class="chip-btn starter"
            id="i-btn-lesson"
            data-text="Quiero aprender Inteligencia Artificial desde cero con un programa ejecutivo paso a paso."
          >
            Aprender IA desde cero
          </button>
          <button
            class="chip-btn starter"
            id="i-btn-emotion"
            data-text="Quiero aplicar IA en mi trabajo y proyectos reales."
          >
            Aplicar IA en mi trabajo
          </button>
          <button
            class="chip-btn starter"
            id="i-btn-challenge"
            data-text="Quiero dominar ChatGPT y otras IA como herramientas estrat√©gicas."
          >
            Dominar ChatGPT y otras IA
          </button>
        </div>

        <!-- CHIPS: CONTENIDO VISUAL -->
        <div class="content-row">
          <span class="content-label" id="i-content-label">Herramientas del programa:</span>
          <button
            class="content content-btn"
            id="i-btn-slides"
            data-text="Mu√©strame la estructura completa del programa Esteborg IA ‚Äì Despliega todo tu poder."
          >
            Estructura del programa
          </button>
          <button
            class="content content-btn"
            id="i-btn-summary"
            data-text="Ay√∫dame a automatizar tareas con IA para ahorrar tiempo y energ√≠a."
          >
            Automatizar tareas con IA
          </button>
        </div>

        <!-- CHAT -->
        <div class="chat-container">
          <div class="chat-header-row">
            <div class="chat-header-left">
              <div class="chat-node">E</div>
              <div class="chat-title">
                <div id="i-chat-name">Esteborg</div>
                <small id="i-chat-role">Coach profesional de Inteligencia Artificial</small>
              </div>
            </div>
            <div class="chat-language-pill">
              <span class="lang-option active" data-lang="es">ES</span>
              <span class="lang-option" data-lang="en">EN</span>
              <span class="lang-option" data-lang="pt">PT</span>
              <span class="lang-option" data-lang="fr">FR</span>
              <span class="lang-option" data-lang="it">IT</span>
              <span class="lang-option" data-lang="de">DE</span>
            </div>
          </div>

          <div id="chat-log"></div>

          <div class="input-row">
            <textarea
              id="user-input"
              placeholder="Cu√©ntame qu√© quieres lograr con la Inteligencia Artificial..."
            ></textarea>
            <button id="mic-btn" class="mic-button" title="Hablar con voz">
              üéôÔ∏è
            </button>
            <button id="send-btn" class="send-button">ENVIAR</button>
          </div>

          <div class="status-line" id="status-line">
            <span class="status-dot"></span>
            <span>Preparando tu entrenamiento con Esteborg IA...</span>
          </div>

          <div class="voice-row">
            <label class="voice-toggle">
              <input type="checkbox" id="tts-toggle" />
              <span id="i-voice-toggle-label">Voz Esteborg activada</span>
            </label>
            <div class="voice-pill" id="i-voice-pill">üéß Voz Esteborg</div>
          </div>
        </div>

        <div class="footer-row">
          <div class="footer-left">
            <strong id="i-footer-token-title">Tokken Esteborg Members</strong>
            <span id="i-footer-token-text">
              Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en:
              https://membersvip.esteborg.live/#miembrosvip
            </span>
          </div>
          <div class="footer-right">
            Propiedad de Esteban Manuel Gonz√°lez C√°rdenas ¬∑ Esteborg<br />
            <a href="https://esteborg.com" target="_blank" rel="noopener">esteborg.com</a>
          </div>
        </div>
      </div>
    </div>
  </div>

    <script>
    // ========= CONFIG =========
    const API_BASE = "https://esteborg88full-backend-modular.onrender.com";
    const MODULE_PATH = "/api/modules/iavipcom";
    const TTS_URL = API_BASE + "/api/voice";

    // ========= I18N BASE ES =========
    const I18N_ES = {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub: "Programa ejecutivo ¬∑ Coach profesional de Inteligencia Artificial",
      bannerDesc:
        "Esteborg IA ‚Äì Despliega todo tu poder es tu programa ejecutivo para usar la Inteligencia Artificial como ventaja en tu trabajo, negocio y vida.",
      panelTitle: "Mini entrenamiento ¬∑ Esteborg IA ‚Äì Despliega todo tu poder",
      chipsLabel: "Comenzar entrenamiento:",
      btnLesson: "Aprender IA desde cero",
      btnLessonText:
        "Quiero aprender Inteligencia Artificial desde cero con un programa ejecutivo paso a paso.",
      btnEmotion: "Aplicar IA en mi trabajo",
      btnEmotionText:
        "Quiero aplicar IA en mi trabajo y proyectos reales.",
      btnChallenge: "Dominar ChatGPT y otras IA",
      btnChallengeText:
        "Quiero dominar ChatGPT y otras IA como herramientas estrat√©gicas.",
      contentLabel: "Herramientas del programa:",
      btnSlides: "Estructura del programa",
      btnSlidesText:
        "Mu√©strame la estructura completa del programa Esteborg IA ‚Äì Despliega todo tu poder.",
      btnSummary: "Automatizar tareas con IA",
      btnSummaryText:
        "Ay√∫dame a automatizar tareas con IA para ahorrar tiempo y energ√≠a.",
      inputPlaceholder:
        "Cu√©ntame qu√© quieres lograr con la Inteligencia Artificial...",
      footerTokenTitle: "Tokken Esteborg Members",
      footerTokenText:
        "Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip",
      chatName: "Esteborg",
      chatRole: "Coach profesional de Inteligencia Artificial",
      voiceToggleLabel: "Voz Esteborg activada",
      voicePillLabel: "üéß Voz Esteborg",
      sendButtonLabel: "ENVIAR",
      statusInitialWithToken:
        "Detect√© un Tokken en la URL o guardado ¬∑ lo usar√© autom√°ticamente en tu entrenamiento.",
      statusInitialNoToken:
        "Demo activa ¬∑ si generas tu Tokken VIP en Members, lo usar√© autom√°ticamente.",
      statusTokenManual:
        "Tokken pegado manualmente ¬∑ usar√© ese Tokken en tu entrenamiento.",
      statusTokenValid: "Modo Members activo ¬∑ Tokken VIP v√°lido.",
      statusTokenInvalid:
        "Tokken inv√°lido o expirado ¬∑ usando modo demo. Genera uno nuevo en Members.",
      statusDemoEnded:
        "Demo finalizada ¬∑ renueva tu acceso para seguir con Esteborg IA.",
      statusDemoActive:
        "Demo activa ¬∑ si generas tu Tokken VIP en Members, lo usar√© autom√°ticamente.",
      statusListening: "Escuchando... habla ahora.",
      statusProcessingSpeech: "Procesando lo que dijiste...",
      statusMicError:
        "Hubo un problema con el micr√≥fono, intenta de nuevo.",
      statusTextCaptured:
        "Texto capturado, puedes enviarlo o editarlo.",
      statusTTSOn: "Voz Esteborg activada.",
      statusTTSOff: "Voz Esteborg desactivada.",
      statusLangCurrent: "Idioma cambiado a espa√±ol.",
      tokenPasteReply:
        "Perfecto, ya tengo tu Tokken Esteborg Members ‚úÖ\nAhora dime: ¬øquieres que trabajemos en espa√±ol, ingl√©s, portugu√©s, franc√©s, italiano o alem√°n?",
      tokenWelcomeMessage:
        "‚úÖ Tu Tokken Esteborg Members est√° validado.\nEst√°s en modo Members VIP, as√≠ que podemos trabajar tus entrenamientos de IA con acceso completo.",
      welcomeMessage:
        "¬°Qu√© gusto saludarte! üòä Antes de entrar a tu entrenamiento necesito tu Tokken Esteborg Members para validar tu acceso.\n\n" +
        "Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip\n\n" +
        "Una vez que tengas tu Tokken, p√©galo aqu√≠ o accede desde tu panel Members VIP. Despu√©s elige el idioma en la parte superior (ES, EN, PT, FR, IT, DE) y comenzamos."
    };

    // ========= I18N BASE EN =========
    const I18N_EN = {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub: "Executive Program ¬∑ AI Professional Coach",
      bannerDesc:
        "Esteborg IA ‚Äì Unleash your power is your executive program to use Artificial Intelligence as a real advantage in your work, business and life.",
      panelTitle: "Mini training ¬∑ Esteborg IA ‚Äì Unleash your power",
      chipsLabel: "Start training:",
      btnLesson: "Learn AI from scratch",
      btnLessonText:
        "I want to learn Artificial Intelligence from scratch with an executive, step-by-step program.",
      btnEmotion: "Apply AI in my work",
      btnEmotionText:
        "I want to apply AI to my real work and projects.",
      btnChallenge: "Master ChatGPT & other AIs",
      btnChallengeText:
        "I want to master ChatGPT and other AIs as strategic tools.",
      contentLabel: "Program tools:",
      btnSlides: "Program structure",
      btnSlidesText:
        "Show me the full structure of the Esteborg IA ‚Äì Unleash your power program.",
      btnSummary: "Automate tasks with AI",
      btnSummaryText:
        "Help me automate tasks with AI to save time and energy.",
      inputPlaceholder:
        "Tell me what you want to achieve with Artificial Intelligence...",
      footerTokenTitle: "Esteborg Members Token",
      footerTokenText:
        "If you don‚Äôt have a token yet, you can get or recover it at: https://membersvip.esteborg.live/#miembrosvip",
      chatName: "Esteborg",
      chatRole: "AI professional coach",
      voiceToggleLabel: "Esteborg voice enabled",
      voicePillLabel: "üéß Esteborg Voice",
      sendButtonLabel: "SEND",
      statusInitialWithToken:
        "I detected a token in the URL or stored locally ¬∑ I‚Äôll use it automatically in your training.",
      statusInitialNoToken:
        "Demo mode is active ¬∑ if you generate your VIP token in Members, I‚Äôll use it automatically.",
      statusTokenManual:
        "Token pasted manually ¬∑ I‚Äôll use that token in your training.",
      statusTokenValid: "Members mode active ¬∑ VIP token valid.",
      statusTokenInvalid:
        "Invalid or expired token ¬∑ using demo mode. Generate a new one in Members.",
      statusDemoEnded:
        "Demo finished ¬∑ renew your access to continue with Esteborg IA.",
      statusDemoActive:
        "Demo mode active ¬∑ if you generate your VIP token in Members, I‚Äôll use it automatically.",
      statusListening: "Listening... you can speak now.",
      statusProcessingSpeech: "Processing what you said...",
      statusMicError:
        "There was a problem with the microphone, please try again.",
      statusTextCaptured:
        "Text captured, you can send or edit it.",
      statusTTSOn: "Esteborg voice enabled.",
      statusTTSOff: "Esteborg voice disabled.",
      statusLangCurrent: "Language set to English.",
      tokenPasteReply:
        "Perfect, I‚Äôve got your Esteborg Members Token ‚úÖ\nNow tell me: would you rather work in Spanish, English, Portuguese, French, Italian or German?",
      tokenWelcomeMessage:
        "‚úÖ Your Esteborg Members Token is validated.\nYou‚Äôre in Members VIP mode, so we can work your AI trainings with full access.",
      welcomeMessage:
        "Great to have you here! üòä Before we start your training I need your Esteborg Members Token to validate your access.\n\n" +
        "If you don‚Äôt have a token yet, you can get or recover it at: https://membersvip.esteborg.live/#miembrosvip\n\n" +
        "Once you have your token, paste it here or access through your Members VIP panel. Then choose the language at the top (ES, EN, PT, FR, IT, DE) and we begin."
    };

    // ========= I18N FINAL (sin usar I18N dentro de s√≠) =========
    const I18N = {
      es: I18N_ES,
      en: I18N_EN,
      pt: {
        ...I18N_ES,
        bannerSub: "Programa executivo ¬∑ Coach profissional de Intelig√™ncia Artificial",
        statusLangCurrent: "Idioma alterado para portugu√™s."
      },
      fr: {
        ...I18N_ES,
        bannerSub: "Programme ex√©cutif ¬∑ Coach professionnel en Intelligence Artificielle",
        statusLangCurrent: "Langue chang√©e en fran√ßais."
      },
      it: {
        ...I18N_ES,
        bannerSub: "Programma esecutivo ¬∑ Coach professionale di Intelligenza Artificiale",
        statusLangCurrent: "Lingua cambiata in italiano."
      },
      de: {
        ...I18N_ES,
        bannerSub: "Executive Programm ¬∑ Professioneller KI-Coach",
        statusLangCurrent: "Sprache auf Deutsch ge√§ndert."
      }
    };

    // ========= ESTADO GLOBAL =========
    let currentLang = "es";
    let history = [];
    let isSending = false;
    let recognition = null;
    let isRecording = false;
    let currentAudio = null;
    let hasShownTokenWelcome = false;

    const VIP_STORAGE_KEY = "esteborg_vip_token";
    let VIP_TOKEN = null;

    const chatLog = document.getElementById("chat-log");
    const inputEl = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const micBtn = document.getElementById("mic-btn");
    const ttsToggle = document.getElementById("tts-toggle");
    const statusLine = document.getElementById("status-line");
    const langOptions = document.querySelectorAll(".lang-option");

    // ========= HELPERS =========
    function t(key, langOverride) {
      const lang = langOverride || currentLang || "es";
      const pack = I18N[lang] || I18N.es;
      return (pack && pack[key]) || I18N.es[key] || "";
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function appendMessage(role, content) {
      const raw = content || "";
      const processed = raw.replace(/^###\s*/gm, "");
      const safe = escapeHtml(processed);

      const row = document.createElement("div");
      row.className = "msg-row " + (role === "user" ? "user" : "assistant");

      const tag = document.createElement("div");
      tag.className = "msg-tag " + (role === "user" ? "user" : "assistant");
      tag.textContent = role === "user" ? "T√∫" : "Esteborg";

      const bubble = document.createElement("div");
      bubble.className = "msg-bubble";
      bubble.innerHTML = '<div class="msg-text">' + safe + "</div>";

      if (role === "user") {
        row.appendChild(bubble);
        row.appendChild(tag);
      } else {
        row.appendChild(tag);
        row.appendChild(bubble);
      }

      chatLog.appendChild(row);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function setStatus(msg) {
      if (!statusLine) return;
      const spans = statusLine.querySelectorAll("span");
      if (spans.length > 1) spans[1].textContent = msg;
      else statusLine.textContent = msg;
    }

    function applyUILanguage(lang) {
      const pack = I18N[lang] || I18N.es;
      const $ = (id) => document.getElementById(id);

      if ($("i-banner-main")) $("i-banner-main").textContent = pack.bannerMain;
      if ($("i-banner-sub")) $("i-banner-sub").textContent = pack.bannerSub;
      if ($("i-banner-desc")) $("i-banner-desc").textContent = pack.bannerDesc;

      if ($("i-panel-title")) $("i-panel-title").textContent = pack.panelTitle;

      if ($("i-chips-label")) $("i-chips-label").textContent = pack.chipsLabel;
      if ($("i-btn-lesson")) {
        $("i-btn-lesson").textContent = pack.btnLesson;
        $("i-btn-lesson").dataset.text = pack.btnLessonText;
      }
      if ($("i-btn-emotion")) {
        $("i-btn-emotion").textContent = pack.btnEmotion;
        $("i-btn-emotion").dataset.text = pack.btnEmotionText;
      }
      if ($("i-btn-challenge")) {
        $("i-btn-challenge").textContent = pack.btnChallenge;
        $("i-btn-challenge").dataset.text = pack.btnChallengeText;
      }

      if ($("i-content-label")) $("i-content-label").textContent = pack.contentLabel;
      if ($("i-btn-slides")) {
        $("i-btn-slides").textContent = pack.btnSlides;
        $("i-btn-slides").dataset.text = pack.btnSlidesText;
      }
      if ($("i-btn-summary")) {
        $("i-btn-summary").textContent = pack.btnSummary;
        $("i-btn-summary").dataset.text = pack.btnSummaryText;
      }

      if (inputEl) inputEl.placeholder = pack.inputPlaceholder;

      if ($("i-footer-token-title"))
        $("i-footer-token-title").textContent = pack.footerTokenTitle;
      if ($("i-footer-token-text"))
        $("i-footer-token-text").textContent = pack.footerTokenText;

      if ($("i-chat-name")) $("i-chat-name").textContent = pack.chatName;
      if ($("i-chat-role")) $("i-chat-role").textContent = pack.chatRole;

      if ($("i-voice-toggle-label"))
        $("i-voice-toggle-label").textContent = pack.voiceToggleLabel;
      if ($("i-voice-pill"))
        $("i-voice-pill").textContent = pack.voicePillLabel;

      if (sendBtn) sendBtn.textContent = pack.sendButtonLabel;
    }

    function getSpeechLangCode(lang) {
      switch (lang) {
        case "en": return "en-US";
        case "pt": return "pt-BR";
        case "fr": return "fr-FR";
        case "it": return "it-IT";
        case "de": return "de-DE";
        default: return "es-MX";
      }
    }

    function stopTTS() {
      if (currentAudio) {
        try {
          currentAudio.pause();
          currentAudio.currentTime = 0;
        } catch (_) {}
      }
    }

    async function playTTS(text) {
      if (!ttsToggle || !ttsToggle.checked) return;
      if (!text) return;

      try {
        const trimmed = text.length > 450 ? text.slice(0, 450) : text;
        const res = await fetch(TTS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            text: trimmed,
            voiceId: "IdhxxSTaAg80CTeSgScm"
          })
        });
        if (!res.ok) return;
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        stopTTS();
        currentAudio = new Audio(url);
        currentAudio.play().catch(() => {});
      } catch (e) {
        console.error("[TTS] Error:", e);
      }
    }

    function startSessionForCurrentLang(updateStatus = true) {
      if (!chatLog) return;
      chatLog.innerHTML = "";
      history = [];
      stopTTS();

      const welcome = t("welcomeMessage");
      appendMessage("assistant", welcome);
      playTTS(welcome);

      if (updateStatus) {
        if (VIP_TOKEN) {
          setStatus(t("statusInitialWithToken"));
        } else {
          setStatus(t("statusInitialNoToken"));
        }
      }
    }

    function getVIPTokenFromURL() {
      const params = new URLSearchParams(window.location.search || "");
      const raw =
        params.get("tokken") ||
        params.get("access_token") ||
        params.get("token") ||
        "";
      const trimmed = (raw || "").trim();
      return trimmed || null;
    }

    function bootstrapTokenStatus() {
      if (VIP_TOKEN) {
        setStatus(t("statusInitialWithToken"));
      } else {
        setStatus(t("statusInitialNoToken"));
      }
    }

    // ========= TOKEN POR postMessage (iframe Members) =========
    window.addEventListener("message", (event) => {
      if (!event.data || event.data.type !== "esteborg-token") return;
      const tokken = (event.data.tokken || "").trim();
      if (!tokken) return;
      VIP_TOKEN = tokken;
      try {
        localStorage.setItem(VIP_STORAGE_KEY, VIP_TOKEN);
      } catch (e) {
        console.warn("[IA] No pude guardar Tokken desde postMessage:", e);
      }
      setStatus(t("statusTokenManual"));
    });

    document.addEventListener("DOMContentLoaded", () => {
      try {
        const stored = localStorage.getItem(VIP_STORAGE_KEY);
        if (stored) {
          VIP_TOKEN = stored;
        } else {
          VIP_TOKEN = getVIPTokenFromURL();
        }
      } catch (e) {
        VIP_TOKEN = getVIPTokenFromURL();
      }

      applyUILanguage(currentLang);
      startSessionForCurrentLang(true);
      bootstrapTokenStatus();
      initLanguagePills();
      initButtons();
      initSpeech();
      initTTSToggle();
    });

    function initLanguagePills() {
      langOptions.forEach((btn) => {
        btn.addEventListener("click", () => {
          const lang = btn.dataset.lang || "es";
          currentLang = lang;
          langOptions.forEach((b) =>
            b.classList.toggle("active", b === btn)
          );
          applyUILanguage(lang);
          startSessionForCurrentLang(false);
          setStatus(t("statusLangCurrent", lang));
        });
      });
    }

    function initButtons() {
      if (sendBtn) {
        sendBtn.addEventListener("click", () => sendMessage());
      }
      if (inputEl) {
        inputEl.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
      document.querySelectorAll(".starter").forEach((btn) => {
        btn.addEventListener("click", () => {
          const text = btn.dataset.text || "";
          sendMessage(text);
        });
      });
      document.querySelectorAll(".content").forEach((btn) => {
        btn.addEventListener("click", () => {
          const text = btn.dataset.text || "";
          sendMessage(text);
        });
      });
    }

    function initTTSToggle() {
      if (!ttsToggle) return;
      ttsToggle.addEventListener("change", () => {
        if (ttsToggle.checked) {
          setStatus(t("statusTTSOn"));
        } else {
          stopTTS();
          setStatus(t("statusTTSOff"));
        }
      });
    }

    function initSpeech() {
      const SR =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR || !micBtn) return;

      recognition = new SR();
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => {
        isRecording = true;
        micBtn.classList.add("active");
        setStatus(t("statusListening"));
      };

      recognition.onerror = () => {
        isRecording = false;
        micBtn.classList.remove("active");
        setStatus(t("statusMicError"));
      };

      recognition.onend = () => {
        isRecording = false;
        micBtn.classList.remove("active");
      };

      recognition.onresult = (event) => {
        const transcript =
          event.results[0] && event.results[0][0]
            ? event.results[0][0].transcript
            : "";
        if (inputEl && transcript) {
          inputEl.value = transcript;
          setStatus(t("statusTextCaptured"));
        }
      };

      micBtn.addEventListener("click", () => {
        if (!recognition) return;
        if (isRecording) {
          recognition.stop();
          return;
        }
        try {
          recognition.lang = getSpeechLangCode(currentLang);
          recognition.start();
        } catch (e) {
          console.error("[IA] Error al iniciar reconocimiento:", e);
        }
      });
    }

    async function sendMessage(optionalText) {
      let text = (optionalText || inputEl.value || "").trim();
      if (!text || isSending) return;

      const candidate = text.replace(/\s+/g, "");
      const looksLikeTokken =
        /^[A-Za-z0-9+/=_-]{40,}$/.test(candidate);

      if (looksLikeTokken && !text.includes(" ")) {
        VIP_TOKEN = candidate;
        try {
          localStorage.setItem(VIP_STORAGE_KEY, VIP_TOKEN);
        } catch (e) {}
        appendMessage("user", text);
        appendMessage("assistant", t("tokenPasteReply"));
        setStatus(t("statusTokenManual"));
        if (inputEl) inputEl.value = "";
        return;
      }

      appendMessage("user", text);
      if (inputEl) inputEl.value = "";
      setStatus("Enviando mensaje...");
      isSending = true;

      try {
        const res = await fetch(API_BASE + MODULE_PATH, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: text,
            lang: currentLang,
            history,
            tokken: VIP_TOKEN || null,
            vipToken: VIP_TOKEN || null
          })
        });

        if (!res.ok) {
          appendMessage(
            "assistant",
            "Hubo un problema al conectar con Esteborg IA. Intenta de nuevo en unos momentos."
          );
          setStatus("Error de conexi√≥n con el m√≥dulo IA.");
          return;
        }

        const data = await res.json();
        const reply =
          data.reply ||
          data.assistant ||
          data.assistantReply ||
          data.message ||
          data.output ||
          "Listo, sigamos con tu entrenamiento de IA.";

        appendMessage("assistant", reply);
        playTTS(reply);

        history.push({ role: "user", content: text });
        history.push({ role: "assistant", content: reply });

        const vipStatus =
          data.vip_status ?? data.vipStatus ?? null;
        if (vipStatus === "valid" || vipStatus === true) {
          setStatus(t("statusTokenValid"));
          if (!hasShownTokenWelcome && VIP_TOKEN) {
            appendMessage("assistant", t("tokenWelcomeMessage"));
            playTTS(t("tokenWelcomeMessage"));
            hasShownTokenWelcome = true;
          }
        } else if (vipStatus === "invalid" || vipStatus === false) {
          setStatus(t("statusTokenInvalid"));
        } else if (!VIP_TOKEN) {
          setStatus(t("statusDemoActive"));
        } else {
          setStatus(t("statusInitialWithToken"));
        }
      } catch (e) {
        console.error("[IA] Error general sendMessage:", e);
        appendMessage(
          "assistant",
          "Tuvimos un problema de red. Verifica tu conexi√≥n e intenta de nuevo."
        );
        setStatus("Error de red al conectar con Esteborg IA.");
      } finally {
        isSending = false;
      }
    }
  </script>
</body>
</html>
