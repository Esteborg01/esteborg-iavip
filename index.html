<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Esteborg IA - Despliega todo tu poder</title>

  <style>
    :root {
      --bg-main: #050509;
      --accent: #f1ca63;
      --accent-strong: #f6e29e;
      --accent-alt: #8fd8ff;
      --text-main: #f5f5ff;
      --text-soft: #c3c3d8;
      --text-dim: #7e7e9c;
      --border-subtle: #25253a;
      --card-bg: #0b0b16;
      --card-inner: #10101d;
      --radius-lg: 20px;
      --radius-pill: 999px;
      --danger: #ff6b6b;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
  margin: 0;
  height: 100%;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
    "Inter", sans-serif;
  background: radial-gradient(circle at top, #28224b 0, #050509 55%, #020208 100%);
  color: var(--text-main);
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 16px 8px 32px; /* üëà antes 24px 12px 40px */
  overflow: hidden;
}

    .app {
  width: 100%;
  max-width: 960px;  /* üëà m√°s compacto */
  height: 100%;
  display: flex;
  flex-direction: column;
}

    .hero {
      text-align: center;
      margin-bottom: 12px;
      flex-shrink: 0;
    }

    .hero-logo {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .hero-logo-mark {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #f8e089 0, #f1c967 18%, #8c46ff 52%, #32127b 90%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.8),
        0 10px 30px rgba(0, 0, 0, 0.75);
    }

    .hero-logo-mark svg {
      width: 24px;
      height: 24px;
    }

    .hero-logo-text {
      font-size: 0.95rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-weight: 650;
    }

    .hero-logo-text span {
      color: var(--accent-strong);
    }

    .hero-title {
      font-size: clamp(1.5rem, 2.4vw, 1.9rem);
      line-height: 1.35;
      margin: 0 0 6px;
      font-weight: 640;
    }

    .hero-title span {
      color: var(--accent-strong);
    }

    .hero-sub {
      font-size: 0.9rem;
      color: var(--text-soft);
      max-width: 560px;
      margin: 0 auto;
    }

    .hero-sub strong {
      color: var(--accent-strong);
    }

    .chat-card {
      margin-top: 10px;
      border-radius: 24px;
      background: radial-gradient(circle at top left, #262042 0, #050509 60%);
      border: 1px solid rgba(140, 139, 196, 0.55);
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.8);
      padding: 18px;
      flex: 1;
      min-height: 700px; /* m√°s alto */
      display: flex;
      flex-direction: column;
    }

    .chat-inner {
      border-radius: 18px;
      background: linear-gradient(145deg, #0c0c19, #090915);
      border: 1px solid rgba(111, 111, 180, 0.6);
      padding: 14px 14px 12px;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
      flex-shrink: 0;
    }

    .chat-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chat-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .chat-subtitle {
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    .chat-header-right {
      font-size: 0.72rem;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dot-live {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent-strong);
      box-shadow: 0 0 0 4px rgba(241, 202, 99, 0.28);
    }

    .lang-pill-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(140, 139, 196, 0.7);
      background: rgba(8, 8, 20, 0.9);
    }

    .lang-pill-wrapper .lang-icon {
      font-size: 0.9rem;
    }

    .lang-pill-group {
      display: inline-flex;
      gap: 4px;
    }

    .lang-pill {
      border-radius: 999px;
      border: 1px solid rgba(140, 139, 196, 0.4);
      background: transparent;
      color: var(--text-soft);
      padding: 4px 10px;
      font-size: 0.7rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .lang-pill:hover {
      border-color: rgba(241, 202, 99, 0.9);
      color: var(--accent-strong);
    }

    .lang-pill.active {
      background: radial-gradient(circle at 30% 0, #3c73ff, #182b5c);
      border-color: rgba(135, 170, 255, 0.95);
      color: #fff;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.7),
        0 0 12px rgba(60, 115, 255, 0.7);
    }

    .starter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      margin-top: 4px;
      font-size: 0.75rem;
    }

    .starter-label {
      color: var(--text-dim);
      flex-basis: 100%;
    }

    .starter-pill {
      border-radius: 999px;
      border: 1px solid rgba(140, 139, 196, 0.5);
      background: rgba(9, 10, 22, 0.96);
      color: var(--text-soft);
      padding: 4px 10px;
      font-size: 0.76rem;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .starter-pill:hover {
      border-color: var(--accent-strong);
      color: var(--accent-strong);
      background: rgba(19, 22, 60, 0.96);
    }

    .chat-box {
      border-radius: 12px;
      padding: 10px 9px;
      background: radial-gradient(circle at top, rgba(32, 32, 64, 0.9) 0, rgba(8, 9, 20, 0.98) 42%);
      border: 1px solid rgba(84, 84, 133, 0.8);
      box-shadow:
        inset 0 0 0 1px rgba(5, 5, 12, 0.8),
        0 14px 40px rgba(0, 0, 0, 0.75);
      scroll-behavior: smooth;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
    }

    .chat-box::-webkit-scrollbar {
      width: 6px;
    }

    .chat-box::-webkit-scrollbar-thumb {
      background: rgba(110, 110, 160, 0.7);
      border-radius: 999px;
    }

    .msg-row {
      display: flex;
      margin-bottom: 8px;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .bubble {
      max-width: 80%;
      padding: 9px 11px 8px;
      border-radius: 14px;
      font-size: 0.9rem; /* + */
      line-height: 1.5;
      border: 1px solid transparent;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.65);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .bubble-user {
      background: linear-gradient(135deg, #f1ca63, #f6e29e);
      color: #1c1407;
      border-color: rgba(115, 85, 34, 0.52);
    }

    .bubble-ai {
      background: radial-gradient(circle at top left, rgba(17, 18, 32, 0.98), rgba(11, 12, 24, 0.98));
      color: var(--text-main);
      border-color: rgba(135, 134, 202, 0.62);
    }

    .bubble-ai a {
      color: var(--accent-alt);
      text-decoration: none;
      border-bottom: 1px dotted rgba(143, 216, 210, 0.7);
    }

    .bubble-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      margin-bottom: 3px;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .bubble-label-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .bubble-meta {
      font-size: 0.66rem;
      color: var(--text-dim);
      margin-top: 2px;
      text-align: right;
    }

    .input-row {
      display: flex;
      align-items: stretch;
      gap: 8px;
      margin-top: 9px;
      flex-shrink: 0;
    }

    .input-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      align-items: center;
    }

    #userMsg {
      width: 100%;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(124, 124, 180, 0.65);
      background: radial-gradient(circle at top left, rgba(26, 26, 52, 0.9), rgba(8, 9, 20, 0.98));
      color: var(--text-main);
      padding: 9px 38px 9px 12px;
      font-size: 0.9rem;
      outline: none;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.7),
        0 10px 25px rgba(0, 0, 0, 0.75);
    }

    #userMsg::placeholder {
      color: rgba(159, 159, 210, 0.72);
    }

    .mic-btn {
      position: absolute;
      right: 8px;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(140, 139, 196, 0.7);
      background: rgba(12, 12, 32, 0.96);
      color: var(--text-soft);
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }

    .mic-btn.listening {
      border-color: var(--accent-strong);
      color: var(--accent-strong);
      box-shadow: 0 0 0 4px rgba(241, 202, 99, 0.25);
      background: radial-gradient(circle at 30% 0, #30224f, #12091f);
    }

    #sendBtn {
      border-radius: var(--radius-pill);
      border: none;
      padding: 0 18px;
      font-size: 0.82rem;
      font-weight: 560;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #f1ca63, #f6e29e);
      color: #21140a;
      cursor: pointer;
      min-width: 150px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow:
        0 8px 22px rgba(0, 0, 0, 0.75),
        0 0 0 1px rgba(0, 0, 0, 0.7);
    }

    #sendBtn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 0.75rem;
      color: var(--text-dim);
      gap: 8px;
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    #demoStatus {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-strong);
      box-shadow: 0 0 0 4px rgba(241, 202, 99, 0.28);
    }

    .status-dot.ended {
      background: var(--danger);
      box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.3);
    }

    .token-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    .token-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #39d98a;
      box-shadow: 0 0 0 4px rgba(57, 217, 138, 0.25);
    }

    .demo-note {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--text-dim);
      flex-shrink: 0;
    }

    .demo-note a {
      color: var(--accent-strong);
      text-decoration: none;
    }

    .voice-toggle {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      font-size: 0.75rem;
    }

    .voice-pill {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(140, 139, 196, 0.7);
      background: rgba(9, 9, 24, 0.96);
      color: var(--text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .voice-pill.active {
      border-color: var(--accent-strong);
      color: var(--accent-strong);
      box-shadow: 0 0 0 3px rgba(241, 202, 99, 0.25);
      background: radial-gradient(circle at 30% 0, #352654, #120a1f);
    }

    .voice-pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-strong);
    }

    @media (max-width: 720px) {
      body {
        padding: 16px 8px 28px;
      }

      .chat-card {
        margin-top: 10px;
        min-height: 620px;
      }

      .status-row {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="hero">
      <div class="hero-logo">
        <div class="hero-logo-mark">
          <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="gradHero" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#f9e6a9"/>
                <stop offset="35%" stop-color="#f1c45d"/>
                <stop offset="70%" stop-color="#b37cff"/>
                <stop offset="100%" stop-color="#2c0f63"/>
              </linearGradient>
            </defs>
            <circle cx="20" cy="20" r="18" fill="url(#gradHero)" />
            <path d="M14 10c3.5 0 6 3.2 6 7.5S17.5 25 14 25 8 21.8 8 17.5 10.5 10 14 10Z" fill="rgba(12,8,24,0.96)"/>
            <path d="M26 13c2.4 0 4.2 1.9 4.2 4.5S28.4 22 26 22s-4.2-1.9-4.2-4.5S23.6 13 26 13Z" fill="rgba(12,8,24,0.96)"/>
            <path d="M18 13h3.5M18 16h3.5M18 19h3.5M18 22h3.5" stroke="#f9e6a9" stroke-width="1.2" stroke-linecap="round" />
          </svg>
        </div>
        <div class="hero-logo-text">ESTEBORG <span>EXECUTIVE</span></div>
      </div>

      <h1 class="hero-title" id="heroTitle"></h1>
      <p class="hero-sub" id="heroSub"></p>
    </header>

    <main class="chat-card">
      <div class="chat-inner">
        <div class="chat-header">
          <div class="chat-header-left">
            <div class="chat-title" id="chatTitle"></div>
            <div class="chat-subtitle" id="chatSubtitle"></div>
          </div>
          <div class="chat-header-right">
            <span class="dot-live"></span>
            <span id="chatModeLabel"></span>

            <div class="lang-pill-wrapper">
              <span class="lang-icon">üåê</span>
              <div class="lang-pill-group" id="langPills">
                <button class="lang-pill active" type="button" data-lang="es">ES</button>
                <button class="lang-pill" type="button" data-lang="en">EN</button>
                <button class="lang-pill" type="button" data-lang="pt">PT</button>
                <button class="lang-pill" type="button" data-lang="fr">FR</button>
                <button class="lang-pill" type="button" data-lang="it">IT</button>
                <button class="lang-pill" type="button" data-lang="de">DE</button>
              </div>
            </div>
          </div>
        </div>

        <div class="starter-row" id="starterRow">
          <span class="starter-label" id="starterLabel"></span>
        </div>

        <div id="chatBox" class="chat-box"></div>

        <div class="input-row">
          <div class="input-wrapper">
            <input
              id="userMsg"
              type="text"
              placeholder="Pega tu Tokken Esteborg Members aqu√≠..."
              autocomplete="off"
            />
            <button id="micBtn" type="button" class="mic-btn" aria-label="Hablar con Esteborg IA">
              üéôÔ∏è
            </button>
          </div>

          <button id="sendBtn" type="button">
            <span id="sendLabel"></span>
          </button>
        </div>

        <div class="status-row">
          <div id="demoStatus">
            <span class="status-dot"></span>
            <span id="demoStatusLabel"></span>
          </div>

          <div class="voice-toggle">
            <button id="voiceToggle" type="button" class="voice-pill">
              <span class="voice-pill-dot"></span>
              <span id="voiceLabel"></span>
            </button>
          </div>

          <div class="token-status" id="tokenStatus"></div>
        </div>

        <p class="demo-note" id="demoNote"></p>
      </div>
    </main>
  </div>

  <script>
    const doc = document;

    const chatBox = doc.getElementById("chatBox");
    const userMsgInput = doc.getElementById("userMsg");
    const sendBtn = doc.getElementById("sendBtn");
    const sendLabelEl = doc.getElementById("sendLabel");
    const demoStatusEl = doc.getElementById("demoStatus");
    const demoStatusLabelEl = doc.getElementById("demoStatusLabel");
    const heroTitleEl = doc.getElementById("heroTitle");
    const heroSubEl = doc.getElementById("heroSub");
    const chatTitleEl = doc.getElementById("chatTitle");
    const chatSubtitleEl = doc.getElementById("chatSubtitle");
    const chatModeLabelEl = doc.getElementById("chatModeLabel");
    const demoNoteEl = doc.getElementById("demoNote");
    const langPillContainer = doc.getElementById("langPills");
    const starterRowEl = doc.getElementById("starterRow");
    const starterLabelEl = doc.getElementById("starterLabel");
    const tokenStatusEl = doc.getElementById("tokenStatus");
    const micBtn = doc.getElementById("micBtn");
    const voiceToggleBtn = doc.getElementById("voiceToggle");
    const voiceLabelEl = doc.getElementById("voiceLabel");

    const API_BASE = "https://esteborg88full-backend-modular.onrender.com";
    const API_URL = `${API_BASE}/api/modules/iavipcom`;

    let history = [];
    let isSending = false;
    let demoEnded = false;
    let userName = null;
    let introStep = 1; // 1: Tokken, 2: nombre+objetivo, 3+: conversaci√≥n
    let currentLang = "es";

    let storedToken = null;
    let voiceEnabled = false;

    const UI_STRINGS = {
      es: {
        heroTitleHTML:
          "Entrenamiento ejecutivo en <span>Inteligencia Artificial aplicada</span><br/>" +
          "para desplegar todo tu poder.",
        heroSubHTML:
          "Programa Esteborg IA Executive ¬∑ 3 meses, 100% online, con certificaci√≥n " +
          "<strong>AI Executive &amp; Prompt Engineer</strong> by Esteborg Institute.",
        chatTitle: "Esteborg IA ¬∑ Copiloto Ejecutivo",
        chatSubtitle:
          "Primero validamos tu Tokken Esteborg Members y te conozco por tu nombre. " +
          "Despu√©s dise√±amos juntos tu plan de 90 d√≠as con IA.",
        chatModeLabel: "Acceso Members VIP",
        inputPlaceholder: "Pega aqu√≠ tu Tokken Esteborg Members...",
        sendLabel: "Enviar",
        demoStatusInitial: "Esperando tu Tokken Esteborg Members",
        demoNoteHTML:
          "Si a√∫n no tienes Tokken, puedes obtenerlo o recuperarlo en: " +
          '<a href="https://membersvip.esteborg.live/#miembrosvip" target="_blank" rel="noopener noreferrer">' +
          "https://membersvip.esteborg.live/#miembrosvip</a>.",
        initialAssistant:
          "¬°Qu√© gusto saludarte! üòä Antes de entrar a tu entrenamiento necesito tu Tokken Esteborg Members para validar tu acceso.\n\n" +
          "Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en:\n" +
          "https://membersvip.esteborg.live/#miembrosvip\n\n" +
          "1Ô∏è‚É£ Pega aqu√≠ tu Tokken Esteborg Members.\n" +
          "2Ô∏è‚É£ Despu√©s te pedir√© tu nombre y qu√© quieres lograr con IA en los pr√≥ximos 90 d√≠as.",
        initialAssistantMeta: "Acceso con Tokken",
        afterToken:
          "Perfecto, ya tengo tu Tokken registrado ‚úÖ\n\n" +
          "Ahora dime:\n" +
          "‚Ä¢ ¬øC√≥mo te llamas?\n" +
          "‚Ä¢ En una frase, ¬øqu√© quieres lograr con IA en los pr√≥ximos 90 d√≠as?",
        afterTokenMeta: "Tokken validado",
        startersLabel: "Ideas para empezar despu√©s de validar tu Tokken:",
        starters: [
          "Quiero usar IA para automatizar tareas repetitivas de mi equipo.",
          "Quiero que la IA me ayude a tomar mejores decisiones ejecutivas.",
          "Quiero lanzar una nueva l√≠nea de negocio apalancando IA generativa.",
          "Quiero dominar ChatGPT y otras IA en mi trabajo diario."
        ],
        tokenDetectedUrl:
          "Detect√© un Tokken en la URL, lo usar√© autom√°ticamente en tu sesi√≥n.",
        tokenDetectedStored:
          "Tengo un Tokken Esteborg Members guardado, lo usar√© autom√°ticamente en tu sesi√≥n.",
        tokenMissingHint:
          "Pega tu Tokken Esteborg Members en el chat para comenzar.",
        invalidToken:
          "Tu Tokken no es v√°lido o ya no est√° activo. Entra a Members VIP y genera uno nuevo.",
        voiceOnLabel: "Voz Esteborg activada",
        voiceOffLabel: "Voz Esteborg",
        micHint:
          "Toca el micr√≥fono, habla y despu√©s revisa el texto antes de enviarlo."
      },
      en: {
        heroTitleHTML:
          "Executive training in <span>applied Artificial Intelligence</span><br/>" +
          "to unlock all your power.",
        heroSubHTML:
          "Esteborg AI Executive Program ¬∑ 3 months, 100% online, with " +
          "<strong>AI Executive &amp; Prompt Engineer</strong> certification.",
        chatTitle: "Esteborg AI ¬∑ Executive Copilot",
        chatSubtitle:
          "First we validate your Esteborg Members Token and I learn your name. " +
          "Then we design your 90-day AI plan together.",
        chatModeLabel: "Members VIP Access",
        inputPlaceholder: "Paste your Esteborg Members Token here...",
        sendLabel: "Send",
        demoStatusInitial: "Waiting for your Esteborg Members Token",
        demoNoteHTML:
          "If you don‚Äôt have a Token yet, you can get or recover it at: " +
          '<a href="https://membersvip.esteborg.live/#miembrosvip" target="_blank" rel="noopener noreferrer">' +
          "https://membersvip.esteborg.live/#miembrosvip</a>.",
        initialAssistant:
          "Great to have you here! üòä Before we start your training I need your Esteborg Members Token to validate access.\n\n" +
          "If you don‚Äôt have a token yet, you can get or recover it at:\n" +
          "https://membersvip.esteborg.live/#miembrosvip\n\n" +
          "1Ô∏è‚É£ Paste your Esteborg Members Token here.\n" +
          "2Ô∏è‚É£ Then I‚Äôll ask your name and what you want to achieve with AI in the next 90 days.",
        initialAssistantMeta: "Token access",
        afterToken:
          "Awesome, I‚Äôve registered your Token ‚úÖ\n\n" +
          "Now tell me:\n" +
          "‚Ä¢ What‚Äôs your name?\n" +
          "‚Ä¢ In one sentence, what do you want to achieve with AI in the next 90 days?",
        afterTokenMeta: "Token validated",
        startersLabel: "Ideas to start after token validation:",
        starters: [
          "Use AI to automate repetitive tasks in my team.",
          "Use AI to support my executive decision-making.",
          "Launch a new business line powered by generative AI.",
          "Master ChatGPT and other AIs in my daily work."
        ],
        tokenDetectedUrl:
          "I detected a Token in the URL. I‚Äôll use it automatically in your session.",
        tokenDetectedStored:
          "I found a stored Esteborg Members Token. I‚Äôll use it automatically.",
        tokenMissingHint:
          "Paste your Esteborg Members Token in the chat to begin.",
        invalidToken:
          "Your Token is not valid or no longer active. Go to Members VIP and generate a new one.",
        voiceOnLabel: "Esteborg voice on",
        voiceOffLabel: "Esteborg voice",
        micHint:
          "Tap the mic, speak, then review the text before sending."
      },
      // Para ahorrar espacio, PT / FR / IT / DE pueden ser clones del EN/ES
      pt: { /* puedes copiar y traducir igual que antes */ },
      fr: { /* idem */ },
      it: { /* idem */ },
      de: { /* idem */ }
    };

    function formatLangForBackend(lang) {
      const code = (lang || "").toLowerCase();
      if (["es", "en", "pt", "fr", "de", "it"].includes(code)) return code;
      return "es";
    }

    function stripHtml(html) {
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || "";
    }

    function formatTextWithLinks(text) {
      if (!text) return "";
      const urlRegex =
        /(https?:\/\/[^\s]+)|(www\.[^\s]+)|(membersvip\.esteborg\.live[^\s]*)/gi;
      return text.replace(urlRegex, (match) => {
        let url = match;
        if (!/^https?:\/\//i.test(url)) {
          if (url.startsWith("www.")) {
            url = "https://" + url;
          } else if (url.startsWith("membersvip.esteborg.live")) {
            url = "https://" + url;
          }
        }
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${match}</a>`;
      });
    }

    function appendMessage(role, text, meta) {
      const row = doc.createElement("div");
      row.className = "msg-row " + (role === "user" ? "user" : "ai");

      const bubble = doc.createElement("div");
      bubble.className = "bubble " + (role === "user" ? "bubble-user" : "bubble-ai");

      const label = doc.createElement("div");
      label.className = "bubble-label";
      const dot = doc.createElement("span");
      dot.className = "bubble-label-dot";
      const who = doc.createElement("span");
      who.textContent = role === "user" ? (userName || "T√∫") : "Esteborg IA";

      label.appendChild(dot);
      label.appendChild(who);
      bubble.appendChild(label);

      const content = doc.createElement("div");
      if (role === "assistant") {
        content.innerHTML = formatTextWithLinks(text);
      } else {
        content.textContent = text;
      }
      bubble.appendChild(content);

      if (meta) {
        const metaDiv = doc.createElement("div");
        metaDiv.className = "bubble-meta";
        metaDiv.textContent = meta;
        bubble.appendChild(metaDiv);
      }

      row.appendChild(bubble);
      chatBox.appendChild(row);
      chatBox.scrollTop = chatBox.scrollHeight;

      if (role === "assistant" && voiceEnabled && "speechSynthesis" in window) {
        const utter = new SpeechSynthesisUtterance(stripHtml(text));
        const lang = formatLangForBackend(currentLang);
        const map = {
          es: "es-MX",
          en: "en-US",
          pt: "pt-BR",
          fr: "fr-FR",
          de: "de-DE",
          it: "it-IT"
        };
        utter.lang = map[lang] || "es-MX";
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utter);
      }
    }

    function setLoading(isLoading) {
      isSending = isLoading;
      sendBtn.disabled = isLoading || demoEnded;
      userMsgInput.disabled = demoEnded;
      micBtn.disabled = demoEnded;

      const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];
     sendLabel: "Enviar a Esteborg IA";
    }

    function applyLanguageUI(lang) {
      const strings = UI_STRINGS[lang] || UI_STRINGS["es"];
      heroTitleEl.innerHTML = strings.heroTitleHTML;
      heroSubEl.innerHTML = strings.heroSubHTML;
      chatTitleEl.textContent = strings.chatTitle;
      chatSubtitleEl.textContent = strings.chatSubtitle;
      chatModeLabelEl.textContent = strings.chatModeLabel;
      userMsgInput.placeholder = strings.inputPlaceholder;
      demoNoteEl.innerHTML = strings.demoNoteHTML;
      sendLabelEl.textContent = strings.sendLabel;
      voiceLabelEl.textContent = voiceEnabled
        ? strings.voiceOnLabel
        : strings.voiceOffLabel;
      demoStatusLabelEl.textContent = strings.demoStatusInitial;

      starterRowEl.innerHTML = "";
      if (strings.starters && strings.starters.length) {
        const labelSpan = document.createElement("span");
        labelSpan.className = "starter-label";
        labelSpan.textContent = strings.startersLabel || "";
        starterRowEl.appendChild(labelSpan);

        strings.starters.forEach((s) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "starter-pill";
          btn.textContent = s;
          btn.addEventListener("click", () => {
            userMsgInput.value = s;
            userMsgInput.focus();
          });
          starterRowEl.appendChild(btn);
        });
      }
    }

    function initTokenStatus() {
      const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];
      let message = "";

      try {
        const params = new URLSearchParams(window.location.search);
        const urlToken =
          params.get("tokken") || params.get("token") || params.get("t");
        const localToken = localStorage.getItem("esteborg_token_members");

        if (urlToken) {
          storedToken = urlToken.trim();
          localStorage.setItem("esteborg_token_members", storedToken);
          message = strings.tokenDetectedUrl;
        } else if (localToken) {
          storedToken = localToken.trim();
          message = strings.tokenDetectedStored;
        } else {
          message = strings.tokenMissingHint;
        }
      } catch (e) {
        console.warn("Token init error", e);
        message = strings.tokenMissingHint;
      }

      if (tokenStatusEl) {
        tokenStatusEl.innerHTML = "";
        const dot = document.createElement("span");
        dot.className = "token-dot";
        const txt = document.createElement("span");
        txt.textContent = message;
        tokenStatusEl.appendChild(dot);
        tokenStatusEl.appendChild(txt);
      }
    }

    function initChat() {
      history = [];
      demoEnded = false;
      introStep = 1;
      userName = null;

      const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];
      chatBox.innerHTML = "";
      appendMessage("assistant", strings.initialAssistant, strings.initialAssistantMeta);
      applyLanguageUI(currentLang);
      initTokenStatus();
      setLoading(false);
    }

    async function sendToBackend(messageText) {
      const langForBackend = formatLangForBackend(currentLang);
      const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];

      const payload = {
        message: messageText,
        history,
        lang: langForBackend,
        userName,
        token: storedToken || null
      };

      try {
        setLoading(true);

        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(storedToken ? { "x-esteborg-token": storedToken } : {}),
          },
          body: JSON.stringify(payload),
        });

        if (res.status === 401) {
          appendMessage("assistant", strings.invalidToken);
          storedToken = null;
          localStorage.removeItem("esteborg_token_members");
          initTokenStatus();
          introStep = 1;
          return;
        }

        if (!res.ok) {
          throw new Error("Respuesta no OK del backend");
        }

        const data = await res.json();
        const reply =
          (data && (data.reply || data.message || data.response)) ||
          "No pude generar una respuesta en este momento. Intenta de nuevo.";

        history.push({ role: "user", content: messageText });
        history.push({ role: "assistant", content: reply });

        appendMessage("assistant", reply);
      } catch (err) {
        console.error("Error al llamar al backend:", err);
        appendMessage(
          "assistant",
          "Hubo un problema al conectar con Esteborg IA. Intenta de nuevo en unos momentos."
        );
      } finally {
        setLoading(false);
      }
    }

    function handleUserMessage() {
      if (isSending || demoEnded) return;
      const text = (userMsgInput.value || "").trim();
      if (!text) return;

      const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];

      appendMessage("user", text);
      userMsgInput.value = "";

      if (introStep === 1) {
        storedToken = text.trim();
        try {
          localStorage.setItem("esteborg_token_members", storedToken);
        } catch (_) {}

        initTokenStatus();
        appendMessage("assistant", strings.afterToken, strings.afterTokenMeta);
        introStep = 2;
        return;
      }

      if (introStep === 2) {
        userName = text.split(" ")[0] || text;
        introStep = 3;
        sendToBackend(text);
        return;
      }

      sendToBackend(text);
    }

    let recognition = null;
    let listening = false;

    function setupSpeechRecognition() {
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        micBtn.disabled = true;
        micBtn.title = "Tu navegador no soporta dictado por voz.";
        return;
      }

      recognition = new SpeechRecognition();
      recognition.lang = "es-MX";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.addEventListener("result", (event) => {
        const transcript = Array.from(event.results)
          .map((r) => r[0].transcript)
          .join(" ");
        userMsgInput.value = transcript;
        userMsgInput.focus();
      });

      recognition.addEventListener("end", () => {
        listening = false;
        micBtn.classList.remove("listening");
      });

      micBtn.addEventListener("click", () => {
        if (!recognition) return;
        if (listening) {
          recognition.stop();
          listening = false;
          micBtn.classList.remove("listening");
        } else {
          try {
            const lang = formatLangForBackend(currentLang);
            const map = {
              es: "es-MX",
              en: "en-US",
              pt: "pt-BR",
              fr: "fr-FR",
              de: "de-DE",
              it: "it-IT"
            };
            recognition.lang = map[lang] || "es-MX";
          } catch (_) {}
          recognition.start();
          listening = true;
          micBtn.classList.add("listening");
        }
      });

      micBtn.title = strings.micHint || "";
    }

    function setupVoiceToggle() {
      voiceToggleBtn.addEventListener("click", () => {
        voiceEnabled = !voiceEnabled;
        const strings = UI_STRINGS[currentLang] || UI_STRINGS["es"];
        voiceLabelEl.textContent = voiceEnabled
          ? strings.voiceOnLabel
          : strings.voiceOffLabel;
        voiceToggleBtn.classList.toggle("active", voiceEnabled);

        if (!voiceEnabled && "speechSynthesis" in window) {
          window.speechSynthesis.cancel();
        }
      });
    }

    if (langPillContainer) {
      langPillContainer.addEventListener("click", (event) => {
        const btn = event.target.closest(".lang-pill");
        if (!btn) return;
        const lang = btn.dataset.lang;
        if (!lang || lang === currentLang) return;

        currentLang = lang;

        Array.from(langPillContainer.querySelectorAll(".lang-pill")).forEach((el) => {
          el.classList.toggle("active", el.dataset.lang === currentLang);
        });

        initChat();
      });
    }

    if (sendBtn) {
      sendBtn.addEventListener("click", handleUserMessage);
    }

    if (userMsgInput) {
      userMsgInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          handleUserMessage();
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      initChat();
      setupSpeechRecognition();
      setupVoiceToggle();

      if (userMsgInput) userMsgInput.focus();
    });
  </script>
  
  <script>
  (function () {
    function sendResize() {
      try {
        const doc = document;
        const height = Math.max(
          doc.documentElement.scrollHeight,
          doc.body.scrollHeight
        );

        window.parent &&
          window.parent.postMessage(
            { type: "esteborg-resize", height: height },
            "*"
          );
      } catch (e) {
        console.warn("[Esteborg] Error al enviar resize:", e);
      }
    }

    // Al cargar y al redimensionar ventana
    window.addEventListener("load", sendResize);
    window.addEventListener("resize", sendResize);

    // Observar cambios en el DOM (nuevos mensajes, etc.)
    const observer = new MutationObserver(function () {
      clearTimeout(window.__esteborgResizeTimer);
      window.__esteborgResizeTimer = setTimeout(sendResize, 80);
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true,
      attributes: true,
    });
  })();
</script>
</body>
</html>
