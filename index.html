<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>Esteborg IA ¬∑ Entrenamiento Ejecutivo en IA</title>

  <style>
    :root {
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
  margin: 0;
  height: auto;                 /* ya no forzamos 100% */
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
    "Inter", sans-serif;
  background: radial-gradient(circle at top, #28224b 0, #050509 55%, #020208 100%);
  color: #f5f5ff;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 16px 8px 32px;
  overflow-y: auto;             /* scroll vertical normal */
  -webkit-overflow-scrolling: touch;
}

    .app {
  width: 100%;
  max-width: 960px;
  min-height: calc(100vh - 40px);  /* se adapta al viewport */
  display: flex;
  flex-direction: column;
}

.shell {
  position: relative;
  border-radius: 32px;
  padding: 26px 26px 22px;
  background:
    radial-gradient(circle at top left, rgba(94, 234, 212, 0.06), transparent 55%),
    radial-gradient(circle at top right, rgba(248, 250, 252, 0.06), transparent 55%),
    linear-gradient(145deg, #020617, #020617 55%, #020617);
  border: 1px solid rgba(148, 163, 184, 0.4);
  box-shadow: 0 22px 60px rgba(15, 23, 42, 0.9);
  flex: 1;
  display: flex;
  flex-direction: column;
  max-height: 100vh;       /* no crece infinito */
}

    /* Banner */

    .banner-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 18px;
      flex-shrink: 0;
    }

    .banner-avatar {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      background: radial-gradient(circle at 20% 0%, #38bdf8, #4f46e5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 22px;
      color: #0b1120;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.4),
        0 18px 35px rgba(15, 23, 42, 0.9);
    }

    .banner-title-main {
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .banner-title-sub {
      font-size: 20px;
      font-weight: 600;
      color: #e5e7eb;
    }

    .banner-title-sub span {
      color: #a5b4fc;
    }

    .banner-description {
      font-size: 13px;
      color: #9ca3af;
      margin-top: 6px;
      max-width: 540px;
      line-height: 1.5;
    }

    /* Panel sesi√≥n / botones de arriba */

    .panel {
      border-radius: 22px;
      background: radial-gradient(circle at top, #020617, #020617);
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 14px 18px 16px;
      margin-top: 14px;
      flex-shrink: 0;
    }

    .panel-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .panel-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px 4px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      background: linear-gradient(
        to right,
        rgba(34, 197, 94, 0.1),
        rgba(22, 163, 74, 0.2)
      );
      border: 1px solid rgba(34, 197, 94, 0.6);
      color: #bbf7d0;
      margin-bottom: 8px;
    }

    .panel-badge-indicator {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    .chip-btn {
      padding: 7px 14px;
      border-radius: 999px;
      background: radial-gradient(circle at top left, #0b1120, #020617);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.18s ease, border-color 0.18s ease,
        transform 0.08s ease;
    }

    .chip-btn:hover {
      background: radial-gradient(circle at top left, #111827, #020617);
      border-color: rgba(165, 180, 252, 0.9);
      transform: translateY(-1px);
    }

    .chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #38bdf8;
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.25);
    }

    /* Tarjeta de chat */

    .chat-panel {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0; /* clave para que el chat se ajuste dentro de shell */
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
      flex-shrink: 0;
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bot-avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 20% 0%, #38bdf8, #4f46e5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: #0b1120;
    }

    .bot-meta {
      display: flex;
      flex-direction: column;
    }

    .bot-name {
      font-size: 13px;
      font-weight: 600;
    }

    .bot-role {
      font-size: 11px;
      color: #9ca3af;
    }

    .chat-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      color: #9ca3af;
    }

    .toggle-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .toggle-label span {
      font-size: 11px;
    }

    .toggle-switch {
      position: relative;
      width: 38px;
      height: 20px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #020617;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      transition: 0.2s;
    }

    .toggle-slider::before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      top: 2px;
      background-color: #9ca3af;
      border-radius: 999px;
      transition: 0.2s;
    }

    .toggle-switch input:checked + .toggle-slider {
      background: linear-gradient(145deg, #4f46e5, #38bdf8);
      border-color: transparent;
    }

    .toggle-switch input:checked + .toggle-slider::before {
      transform: translateX(16px);
      background: #020617;
    }

    /* Idiomas */

    .lang-row {
      margin-top: 8px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
      color: #9ca3af;
      flex-shrink: 0;
    }

    .lang-label {
      margin-right: 4px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .lang-pill {
      min-width: 26px;
      padding: 3px 8px 4px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: radial-gradient(circle at top left, #020617, #020617);
      font-size: 11px;
      cursor: pointer;
      text-align: center;
      color: #e5e7eb;
      transition: background 0.15s ease, border-color 0.15s ease,
        color 0.15s ease;
    }

    .lang-pill.active {
      background: linear-gradient(145deg, #4f46e5, #38bdf8);
      border-color: transparent;
      color: #020617;
    }

    /* Chat log */

    .chat-container {
      margin-top: 10px;
      border-radius: 18px;
      padding: 12px 10px 10px;
      background: radial-gradient(circle at top, #020617, #020617);
      border: 1px solid rgba(31, 41, 55, 0.9);
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 180px;
      max-height: none;
    }

    #chat-log {
      flex: 1;
      overflow-y: auto;
      padding-right: 6px;
      font-size: 13px;
      line-height: 1.55;
    }

    .msg-row {
      margin-bottom: 10px;
    }

    .msg-role {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #6b7280;
      margin-bottom: 2px;
    }

    .msg-bubble {
      border-radius: 14px;
      padding: 8px 10px;
      background: #020617;
      border: 1px solid rgba(31, 41, 55, 0.9);
      color: #e5e7eb;
    }

    .msg-bubble.user {
      border-color: rgba(59, 130, 246, 0.8);
      background: radial-gradient(circle at top, #020617, #020617);
    }

    .msg-bubble.assistant {
      border-color: rgba(148, 163, 184, 0.9);
      background: radial-gradient(circle at top, #020617, #020617);
    }

    .msg-bubble.system {
      font-size: 11px;
      color: #9ca3af;
      border-style: dashed;
    }

    /* Input zona */

    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      margin-top: 10px;
      flex-shrink: 0;
    }

    #user-input {
      flex: 1;
      resize: none;
      min-height: 44px;
      max-height: 88px;
      background: #020617;
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 1);
      padding: 10px 12px;
      color: #e5e7eb;
      font-size: 13px;
      line-height: 1.4;
      outline: none;
    }

    #user-input::placeholder {
      color: #6b7280;
    }

    .input-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .send-btn,
    .mic-btn {
      border: none;
      cursor: pointer;
      border-radius: 999px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 9px 16px;
      font-weight: 500;
    }

    .send-btn {
      background: linear-gradient(145deg, #4f46e5, #38bdf8);
      color: #020617;
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.55);
      gap: 6px;
    }

    .send-btn span.icon {
      font-size: 15px;
    }

    .mic-btn {
      background: radial-gradient(circle at top, #020617, #020617);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.6);
      width: 40px;
      height: 40px;
      padding: 0;
    }

    /* Footer */

    .footer-row {
      font-size: 11px;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 12px;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
      padding-top: 8px;
      flex-shrink: 0;
    }

    .footer-left {
      max-width: 60%;
    }

    .footer-link {
      color: #60a5fa;
      text-decoration: none;
    }

    .footer-link:hover {
      text-decoration: underline;
    }

    .footer-right {
      text-align: right;
    }

    /* üîª RESPONSIVE */

    /* Tablet / m√≥vil grande */
    @media (max-width: 720px) {
      body {
        height: auto;
        min-height: 100vh;
        overflow-y: auto;
        align-items: stretch;
        justify-content: flex-start;
        padding: 12px 0 18px;
      }

      #app {
        height: auto;
        min-height: 100vh;
        padding: 0;
        max-width: 100%;
      }

      .shell {
        max-width: 100%;
        margin: 0;
        border-radius: 0;
        padding: 14px 12px 16px;
        max-height: none; /* en m√≥vil dejamos que crezca y el body scrollea */
      }

      .banner-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .panel {
        margin-top: 12px;
        padding: 12px 12px 14px;
      }

      .chat-container {
        margin-top: 8px;
        -webkit-overflow-scrolling: touch;
      }

      #chat-log {
        max-height: none;
      }

      .footer-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .footer-right {
        text-align: left;
      }
    }

    /* M√≥vil chico */
    @media (max-width: 480px) {
      .banner-title-main {
        font-size: 11px;
      }

      .banner-title-sub {
        font-size: 18px;
      }

      .panel-title {
        font-size: 11px;
      }

      .panel-badge {
        font-size: 10px;
      }

      .chips-row {
        flex-direction: column;
        align-items: stretch;
      }

      .input-row {
        flex-direction: column;
        align-items: stretch;
      }

      .input-actions {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }

      .send-btn {
        flex: 1;
        justify-content: center;
      }

      .mic-btn {
        width: 34px;
        height: 34px;
      }
    }
    /* ============================
   DESKTOP OPTIMIZATION BOOST
   Hace m√°s grande la ventana del chat
   ============================ */
@media (min-width: 1024px) {

  /* Reduce padding general superior */
  body {
    padding-top: 12px !important;
  }

  /* Contenedor principal m√°s ajustado */
  .app {
    gap: 8px;
  }

  /* Secci√≥n de ‚Äúinicio del entrenamiento‚Äù, chips, material */
  .shell,
  .training-section,
  .chips-row,
  .materials-row {
    margin-bottom: 8px !important;
  }

  /* Reduce altura de chips/botones */
  .chips-row button,
  .materials-row button {
    padding: 6px 14px !important;
    font-size: 0.78rem !important;
  }

  /* Reduce tama√±o del t√≠tulo/slogan */
  .hero-title {
    font-size: 1.3rem !important;
    margin-bottom: 4px !important;
  }

  .hero-sub {
    font-size: 0.85rem !important;
    max-width: 520px !important;
  }

  /* --- AQUI VIENE LA MAGIA DEL CHAT GRANDE --- */

  .chat-card {
    flex: 1 !important;            /* ocupa mayor espacio vertical */
    min-height: 650px !important;  /* tama√±o base m√°s grande */
    max-height: 78vh !important;   /* nunca se sale de pantalla */
    margin-top: 4px !important;
  }

  .chat-inner {
    min-height: 0 !important;
  }

  /* Chat box ahora es gigante */
  .chat-box {
    flex: 1 !important;
    min-height: 450px !important;  /* antes era como 240 */
    max-height: 63vh !important;
  }

  /* Entrada de texto m√°s compacta */
  .input-row {
    margin-top: 6px !important;
  }

  #userMsg {
    font-size: 0.85rem !important;
    padding: 8px 14px !important;
  }

}
    /* ============================================
   EXECUTIVE ULTRA DESKTOP LAYOUT
   Chat gigante, encabezado compacto
   ============================================ */
@media (min-width: 1200px) {

  /* Layout general m√°s limpio y centrado */
  body {
    padding: 10px 28px 18px !important;
  }

  .app {
    max-width: 1180px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  /* ---------- ENCABEZADO / SHELL ---------- */

  .shell {
    padding: 12px 18px 14px !important;
    border-radius: 24px !important;
    margin-bottom: 6px !important;
  }

  .banner-header {
    margin-bottom: 4px !important;
  }

  .banner-title-main {
    font-size: 0.95rem !important;
    letter-spacing: 0.18em !important;
  }

  .banner-title-sub {
    font-size: 1.5rem !important;
    line-height: 1.25 !important;
    margin-bottom: 4px !important;
  }

  .banner-description {
    font-size: 0.85rem !important;
    max-width: 560px !important;
  }

  /* ---------- PANELES SUPERIORES ---------- */

  .panel {
    padding: 10px 14px 10px !important;
    margin-top: 6px !important;
    margin-bottom: 4px !important;
  }

  .panel-title {
    font-size: 0.78rem !important;
    letter-spacing: 0.18em !important;
    margin-bottom: 4px !important;
  }

  .chips-row,
  .content-row {
    margin-top: 4px !important;
    row-gap: 4px !important;
  }

  .chips-row .chip-btn,
  .content-row .chip-btn {
    padding: 5px 12px !important;
    font-size: 0.78rem !important;
    line-height: 1.2 !important;
  }

  .chips-row .chip-btn .chip-dot {
    width: 5px;
    height: 5px;
  }

  /* Botones de material (Slides / Executive summary) m√°s compactos */
  .material-chips .chip-btn {
    padding: 4px 11px !important;
    font-size: 0.76rem !important;
  }

  /* ---------- BLOQUE DE CHAT GIGANTE ---------- */

  .chat-container {
    margin-top: 6px !important;
  }

  .chat-card {
    margin-top: 2px !important;
    border-radius: 26px !important;
    flex: 1 !important;
    min-height: 720px !important;     /* altura base grande */
    max-height: 84vh !important;      /* no se sale de pantalla */
  }

  .chat-inner {
    min-height: 0 !important;
  }

  /* √Årea de mensajes enorme */
  #chat-log,
  .chat-box {
    flex: 1 !important;
    min-height: 480px !important;
    max-height: 66vh !important;
  }

  /* Fila input + bot√≥n m√°s pegada al chat */
  .input-row {
    margin-top: 6px !important;
  }

  #user-input,
  #userMsg {
    font-size: 0.85rem !important;
    padding: 8px 14px !important;
  }

  #send-btn,
  #sendBtn {
    min-width: 140px !important;
    padding-inline: 16px !important;
  }

  /* L√≠nea de estatus / demo / tokken m√°s compacta */
  .status-row,
  .demo-note {
    margin-top: 4px !important;
    font-size: 0.72rem !important;
  }
}

  </style>
</head>

<body>
  <div id="app">
    <div class="shell">
      <!-- HEADER -->
      <header class="banner-header">
        <div class="banner-avatar">E</div>
        <div>
          <div class="banner-title-main">ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP</div>
          <div class="banner-title-sub">
            Entrenamiento ejecutivo en <span>IA</span> aplicada para desplegar todo tu poder.
          </div>
          <div class="banner-description">
            Esteborg IA es tu copiloto ejecutivo de inteligencia artificial. Aqu√≠ dise√±amos tu plan estrat√©gico,
            optimizamos tu negocio y entrenamos tus habilidades ejecutivas con IA.
          </div>
        </div>
      </header>

      <!-- PANEL SUPERIOR: BOTONES DE INICIO -->
      <section class="panel">
        <div class="panel-title">INICIO DEL ENTRENAMIENTO ¬∑ COPILOTO EJECUTIVO IA</div>
        <div class="panel-badge">
          <span class="panel-badge-indicator"></span>
          SESI√ìN PRIVADA CON ESTEBORG IA
        </div>

        <div class="panel-title" style="margin-top:6px;">QUIERO EMPEZAR:</div>
        <div class="chips-row">
          <button class="chip-btn" data-prompt="Automatizar tareas repetitivas con IA">
            <span class="chip-dot"></span> Automatizar tareas
          </button>
          <button class="chip-btn" data-prompt="Tomar mejores decisiones ejecutivas con IA">
            <span class="chip-dot"></span> Decisiones ejecutivas
          </button>
          <button class="chip-btn" data-prompt="Dise√±ar una nueva l√≠nea de negocio usando IA">
            <span class="chip-dot"></span> Nueva l√≠nea de negocio
          </button>
          <button class="chip-btn" data-prompt="Usar IA todos los d√≠as como h√°bito ejecutivo">
            <span class="chip-dot"></span> Dominar IA diaria
          </button>
        </div>

        <div class="panel-title" style="margin-top:10px;">MATERIAL:</div>
        <div class="chips-row">
          <button class="chip-btn" data-prompt="Quiero que me resumas las diapositivas de la sesi√≥n.">
            Diapositivas
          </button>
          <button class="chip-btn" data-prompt="Dame el resumen ejecutivo de todo lo que trabajamos hoy.">
            Resumen IA
          </button>
        </div>
      </section>

      <!-- PANEL CHAT -->
      <section class="panel chat-panel">
        <div class="chat-header">
          <div class="chat-header-left">
            <div class="bot-avatar">E</div>
            <div class="bot-meta">
              <div class="bot-name">Esteborg IA</div>
              <div class="bot-role">Copiloto Ejecutivo IA</div>
            </div>
          </div>
          <div class="chat-header-right">
            <label class="toggle-label">
              <span>Voz Esteborg IA</span>
              <div class="toggle-switch">
                <input type="checkbox" id="voice-toggle" />
                <span class="toggle-slider"></span>
              </div>
            </label>
          </div>
        </div>

        <!-- Idiomas -->
        <div class="lang-row">
          <span class="lang-label">IDIOMA:</span>
          <button class="lang-pill" data-lang="es">ES</button>
          <button class="lang-pill" data-lang="en">EN</button>
          <button class="lang-pill" data-lang="pt">PT</button>
          <button class="lang-pill" data-lang="fr">FR</button>
          <button class="lang-pill" data-lang="it">IT</button>
          <button class="lang-pill" data-lang="de">DE</button>
        </div>

        <!-- Chat log -->
        <div class="chat-container">
          <div id="chat-log"></div>
        </div>

        <!-- Input -->
        <div class="input-row">
          <textarea id="user-input" placeholder="Cu√©ntame qu√© quieres lograr con IA en los pr√≥ximos 90 d√≠as..."></textarea>
          <div class="input-actions">
            <button class="send-btn" id="send-btn">
              <span class="icon">‚ûú</span>
              <span>Enviar</span>
            </button>
            <button class="mic-btn" id="mic-btn">üé§</button>
          </div>
        </div>

        <!-- Footer -->
        <div class="footer-row">
          <div class="footer-left">
            Tokken Esteborg Members<br />
            Para acceder al entrenamiento completo necesitas tu Tokken Esteborg Members. Si a√∫n no tienes token, puedes
            obtenerlo o recuperarlo en: <a class="footer-link"
              href="https://membersvip.esteborg.live/#miembrosvip" target="_blank">membersvip.esteborg.live</a>
          </div>
          <div class="footer-right">
            Propiedad de Esteban Manuel Gonz√°lez C√°rdenas ¬∑ Esteborg
          </div>
        </div>
      </section>
    </div>
  </div>

 <script>
  // =========================
  // CONFIG
  // =========================

  const API_BASE = "https://esteborg88full-backend-modular.onrender.com";
  const API_URL = API_BASE + "/api/modules/iavipcom";

  const ELEVEN_VOICE_ID = "IdhxxSTaAg80CTeSgScm";
  const ELEVEN_API_KEY = "sk_d7c998f4ef73b568e67098031d28b96c5cf1f1d46db39c8f"; // <-- pon aqu√≠ tu key

  const LANGS = ["es", "en", "pt", "fr", "it", "de"];

  // =========================
  // TOKKEN VIP (MISMO FLUJO QUE COM7)
  // =========================

  const VIP_STORAGE_KEY = "esteborg_vip_token";
  let VIP_TOKEN = null;

  function getVIPTokenFromURL() {
    const params = new URLSearchParams(window.location.search || "");
    const raw =
      params.get("tokken") ||
      params.get("access_token") ||
      params.get("token") ||
      "";
    const trimmed = (raw || "").trim();
    console.log(
      "[IA] Tokken detectado en URL:",
      trimmed ? trimmed.slice(0, 40) + "..." : "(ninguno)"
    );
    return trimmed || null;
  }

  // Permite que otro iframe/p√°gina nos mande el tokken por postMessage
  window.addEventListener("message", (event) => {
    if (!event.data || event.data.type !== "esteborg-token") return;
    const tokken = (event.data.tokken || "").trim();
    if (!tokken) return;
    VIP_TOKEN = tokken;
    console.log(
      "[IA] Tokken recibido por postMessage:",
      VIP_TOKEN.slice(0, 40) + "..."
    );
    try {
      localStorage.setItem(VIP_STORAGE_KEY, VIP_TOKEN);
    } catch (e) {
      console.warn("[IA] No pude guardar Tokken desde postMessage:", e);
    }
  });

  // Carga inicial del Tokken (igual que en Com7)
  document.addEventListener("DOMContentLoaded", () => {
    try {
      const stored = localStorage.getItem(VIP_STORAGE_KEY);
      if (stored) {
        VIP_TOKEN = stored.trim();
        console.log("[IA] Tokken recuperado de localStorage");
      } else {
        VIP_TOKEN = getVIPTokenFromURL();
      }
    } catch (e) {
      console.warn("[IA] No pude leer localStorage:", e);
      VIP_TOKEN = getVIPTokenFromURL();
    }
  });

  // =========================
  // TEXTOS UI POR IDIOMA
  // =========================

  const I18N = {
    es: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub:
        "Entrenamiento ejecutivo en IA aplicada para desplegar todo tu poder.",
      bannerDesc:
        "Esteborg IA es tu copiloto ejecutivo de inteligencia artificial. Aqu√≠ dise√±amos tu plan estrat√©gico, optimizamos tu negocio y entrenamos tus habilidades ejecutivas con IA.",
      panelTitleTop: "INICIO DEL ENTRENAMIENTO ¬∑ COPILOTO EJECUTIVO IA",
      chipsLabel: "QUIERO EMPEZAR:",
      materialLabel: "MATERIAL:",
      chipAutomate: "Automatizar tareas",
      chipAutomatePrompt: "Automatizar tareas repetitivas con IA",
      chipDecisions: "Decisiones ejecutivas",
      chipDecisionsPrompt: "Tomar mejores decisiones ejecutivas con IA",
      chipBusiness: "Nueva l√≠nea de negocio",
      chipBusinessPrompt: "Dise√±ar una nueva l√≠nea de negocio usando IA",
      chipDailyIA: "Dominar IA diaria",
      chipDailyIAPrompt: "Usar IA todos los d√≠as como h√°bito ejecutivo",
      chipSlides: "Diapositivas",
      chipSlidesPrompt: "Quiero que me resumas las diapositivas de la sesi√≥n.",
      chipSummary: "Resumen IA",
      chipSummaryPrompt:
        "Dame el resumen ejecutivo de todo lo que trabajamos hoy.",
      chatUserLabel: "T√ö",
      chatAssistantLabel: "ESTEBORG IA",
      inputPlaceholder:
        "Cu√©ntame qu√© quieres lograr con IA en los pr√≥ximos 90 d√≠as...",
      voiceLabel: "Voz Esteborg IA",
      systemLangChanged: "Idioma cambiado a Espa√±ol."
    },
    en: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub: "Executive AI training to unlock all your power.",
      bannerDesc:
        "Esteborg IA is your executive AI copilot. Here we design your strategic plan, optimize your business and train your executive skills with AI.",
      panelTitleTop: "TRAINING START ¬∑ EXECUTIVE AI COPILOT",
      chipsLabel: "I WANT TO START WITH:",
      materialLabel: "MATERIAL:",
      chipAutomate: "Automate tasks",
      chipAutomatePrompt: "Automate my repetitive tasks with AI.",
      chipDecisions: "Executive decisions",
      chipDecisionsPrompt: "Make better executive decisions using AI.",
      chipBusiness: "New business line",
      chipBusinessPrompt: "Design a new business line using AI.",
      chipDailyIA: "Daily AI habit",
      chipDailyIAPrompt: "Use AI every day as an executive habit.",
      chipSlides: "Slides",
      chipSlidesPrompt: "Summarize the slides of this session.",
      chipSummary: "Executive summary",
      chipSummaryPrompt:
        "Give me the executive summary of everything we worked on today.",
      chatUserLabel: "YOU",
      chatAssistantLabel: "ESTEBORG IA",
      inputPlaceholder:
        "Tell me what you want to achieve with AI in the next 90 days...",
      voiceLabel: "Esteborg IA voice",
      systemLangChanged: "Language switched to English."
    },
    pt: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub:
        "Treinamento executivo em IA para liberar todo o seu poder.",
      bannerDesc:
        "Esteborg IA √© seu copiloto executivo de intelig√™ncia artificial. Aqui desenhamos seu plano estrat√©gico, otimizamos seu neg√≥cio e treinamos suas habilidades executivas com IA.",
      panelTitleTop: "IN√çCIO DO TREINAMENTO ¬∑ COPILOTO EXECUTIVO IA",
      chipsLabel: "QUERO COME√áAR POR:",
      materialLabel: "MATERIAL:",
      chipAutomate: "Automatizar tarefas",
      chipAutomatePrompt: "Automatizar tarefas repetitivas com IA.",
      chipDecisions: "Decis√µes executivas",
      chipDecisionsPrompt:
        "Tomar melhores decis√µes executivas usando IA.",
      chipBusiness: "Nova linha de neg√≥cios",
      chipBusinessPrompt:
        "Desenhar uma nova linha de neg√≥cios com IA.",
      chipDailyIA: "Dominar IA di√°ria",
      chipDailyIAPrompt:
        "Usar IA todos os dias como h√°bito executivo.",
      chipSlides: "Apresenta√ß√£o",
      chipSlidesPrompt: "Resuma os slides desta sess√£o.",
      chipSummary: "Resumo IA",
      chipSummaryPrompt:
        "D√™ o resumo executivo de tudo o que trabalhamos hoje.",
      chatUserLabel: "VOC√ä",
      chatAssistantLabel: "ESTEBORG IA",
      inputPlaceholder:
        "Conte o que voc√™ quer alcan√ßar com IA nos pr√≥ximos 90 dias...",
      voiceLabel: "Voz Esteborg IA",
      systemLangChanged: "Idioma alterado para Portugu√™s."
    },
    fr: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub:
        "Entra√Ænement ex√©cutif en IA pour d√©ployer tout ton pouvoir.",
      bannerDesc:
        "Esteborg IA est ton copilote ex√©cutif en intelligence artificielle. Ici nous concevons ton plan strat√©gique, optimisons ton business et entra√Ænons tes comp√©tences ex√©cutives avec l‚ÄôIA.",
      panelTitleTop: "D√âBUT DE LA FORMATION ¬∑ COPILOTE IA EX√âCUTIF",
      chipsLabel: "JE VEUX COMMENCER PAR :",
      materialLabel: "CONTENU :",
      chipAutomate: "Automatiser des t√¢ches",
      chipAutomatePrompt:
        "Automatiser mes t√¢ches r√©p√©titives avec l‚ÄôIA.",
      chipDecisions: "D√©cisions ex√©cutives",
      chipDecisionsPrompt:
        "Prendre de meilleures d√©cisions ex√©cutives avec l‚ÄôIA.",
      chipBusiness: "Nouvelle ligne de business",
      chipBusinessPrompt:
        "Concevoir une nouvelle activit√© en utilisant l‚ÄôIA.",
      chipDailyIA: "IA au quotidien",
      chipDailyIAPrompt:
        "Utiliser l‚ÄôIA tous les jours comme habitude ex√©cutive.",
      chipSlides: "Diapositives",
      chipSlidesPrompt:
        "R√©sume-moi les diapositives de la session.",
      chipSummary: "R√©sum√© IA",
      chipSummaryPrompt:
        "Donne-moi le r√©sum√© ex√©cutif de tout ce que nous avons travaill√© aujourd‚Äôhui.",
      chatUserLabel: "TOI",
      chatAssistantLabel: "ESTEBORG IA",
      inputPlaceholder:
        "Dis-moi ce que tu veux accomplir avec l‚ÄôIA dans les 90 prochains jours...",
      voiceLabel: "Voix Esteborg IA",
      systemLangChanged: "Langue chang√©e en Fran√ßais."
    },
    it: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub:
        "Training esecutivo in IA per liberare tutto il tuo potere.",
      bannerDesc:
        "Esteborg IA √® il tuo copilota esecutivo di intelligenza artificiale. Qui disegniamo il tuo piano strategico, ottimizziamo il business e alleniamo le tue abilit√† esecutive con l‚ÄôIA.",
      panelTitleTop: "INIZIO DELL‚ÄôALLENAMENTO ¬∑ COPILOTA ESECUTIVO IA",
      chipsLabel: "VOGLIO INIZIARE DA:",
      materialLabel: "MATERIALE:",
      chipAutomate: "Automatizzare compiti",
      chipAutomatePrompt:
        "Automatizzare i miei compiti ripetitivi con l‚ÄôIA.",
      chipDecisions: "Decisioni esecutive",
      chipDecisionsPrompt:
        "Prendere decisioni esecutive migliori usando l‚ÄôIA.",
      chipBusiness: "Nuova linea di business",
      chipBusinessPrompt:
        "Progettare una nuova linea di business usando l‚ÄôIA.",
      chipDailyIA: "IA quotidiana",
      chipDailyIAPrompt:
        "Usare l‚ÄôIA ogni giorno come abitudine esecutiva.",
      chipSlides: "Diapositive",
      chipSlidesPrompt:
        "Riassumi le diapositive della sessione.",
      chipSummary: "Sintesi IA",
      chipSummaryPrompt:
        "Dammi la sintesi esecutiva di tutto ci√≤ che abbiamo lavorato oggi.",
      chatUserLabel: "TU",
      chatAssistantLabel: "ESTEBORG IA",
      inputPlaceholder:
        "Raccontami cosa vuoi ottenere con l‚ÄôIA nei prossimi 90 giorni...",
      voiceLabel: "Voce Esteborg IA",
      systemLangChanged: "Lingua cambiata in Italiano."
    },
    de: {
      bannerMain: "ESTEBORG EXECUTIVE ¬∑ MEMBERS VIP",
      bannerSub:
        "Executive-AI-Training, um deine ganze Kraft freizusetzen.",
      bannerDesc:
        "Esteborg IA ist dein Executive-AI-Copilot. Hier entwerfen wir deinen strategischen Plan, optimieren dein Gesch√§ft und trainieren deine F√ºhrungsf√§higkeiten mit KI.",
      panelTitleTop: "START DES TRAININGS ¬∑ EXECUTIVE-AI-COPILOT",
      chipsLabel: "ICH M√ñCHTE STARTEN MIT:",
      materialLabel: "MATERIAL:",
      chipAutomate: "Aufgaben automatisieren",
      chipAutomatePrompt:
        "Meine wiederkehrenden Aufgaben mit KI automatisieren.",
      chipDecisions: "Management-Entscheidungen",
      chipDecisionsPrompt:
        "Bessere Management-Entscheidungen mit KI treffen.",
      chipBusiness: "Neue Gesch√§ftslinie",
      chipBusinessPrompt:
        "Eine neue Gesch√§ftslinie mit KI entwerfen.",
      chipDailyIA: "T√§gliche KI-Routine",
      chipDailyIAPrompt:
        "KI jeden Tag als F√ºhrungsgewohnheit nutzen.",
      chipSlides: "Folien",
      chipSlidesPrompt:
        "Fasse mir die Folien dieser Sitzung zusammen.",
      chipSummary: "KI-Zusammenfassung",
      chipSummaryPrompt:
        "Gib mir die Executive-Zusammenfassung von allem, was wir heute erarbeitet haben.",
      chatUserLabel: "DU",
      chatAssistantLabel: "ESTEBORG IA",
      inputPlaceholder:
        "Erz√§hl mir, was du in den n√§chsten 90 Tagen mit KI erreichen m√∂chtest...",
      voiceLabel: "Esteborg-IA-Stimme",
      systemLangChanged: "Sprache auf Deutsch umgestellt."
    }
  };

 const WELCOME = {
  es: `¬°Qu√© gusto saludarte! üòä Antes de entrar a tu entrenamiento necesito tu Tokken Esteborg Members para validar tu acceso.

Si a√∫n no tienes token, puedes obtenerlo o recuperarlo en: https://membersvip.esteborg.live/#miembrosvip

Una vez que tengas tu Tokken, p√©galo aqu√≠ o accede desde tu panel Members VIP. Despu√©s elige el idioma en la parte superior (ES, EN, PT, FR, IT, DE) y comenzamos.`,
  en: `Great to see you here! üòä Before we start your training I need your Esteborg Members Tokken to validate your access.

If you don‚Äôt have a token yet, you can get or recover it at: https://membersvip.esteborg.live/#miembrosvip

Once you have your Tokken, paste it here or access from your Members VIP panel. Then choose the language at the top (ES, EN, PT, FR, IT, DE) and we‚Äôll start.`,
  pt: `Que bom te ver por aqui! üòä Antes de come√ßar o seu treinamento eu preciso do seu Tokken Esteborg Members para validar o acesso.

Se voc√™ ainda n√£o tem token, pode obt√™-lo ou recuper√°-lo em: https://membersvip.esteborg.live/#miembrosvip

Quando tiver o seu Tokken, cole aqui ou acesse a partir do seu painel Members VIP. Depois escolha o idioma na parte superior (ES, EN, PT, FR, IT, DE) e come√ßamos.`,
  fr: `Ravi de te voir ici ! üòä Avant de commencer ta formation, j‚Äôai besoin de ton Tokken Esteborg Members pour valider ton acc√®s.

Si tu n‚Äôas pas encore de token, tu peux l‚Äôobtenir ou le r√©cup√©rer ici : https://membersvip.esteborg.live/#miembrosvip

Une fois que tu as ton Tokken, colle-le ici ou acc√®de depuis ton panneau Members VIP. Ensuite choisis la langue en haut (ES, EN, PT, FR, IT, DE) et on d√©marre.`,
  it: `Che bello vederti qui! üòä Prima di iniziare il tuo allenamento ho bisogno del tuo Tokken Esteborg Members per validare l‚Äôaccesso.

Se non hai ancora il token, puoi ottenerlo o recuperarlo su: https://membersvip.esteborg.live/#miembrosvip

Quando avrai il tuo Tokken, incollalo qui oppure accedi dal tuo pannello Members VIP. Poi scegli la lingua in alto (ES, EN, PT, FR, IT, DE) e iniziamo.`,
  de: `Sch√∂n, dich hier zu sehen! üòä Bevor wir mit deinem Training starten, brauche ich dein Esteborg Members Tokken, um deinen Zugang zu validieren.

Wenn du noch kein Token hast, kannst du es hier erhalten oder wiederherstellen: https://membersvip.esteborg.live/#miembrosvip

Sobald du dein Tokken hast, f√ºge es hier ein oder greife √ºber dein Members-VIP-Panel darauf zu. Danach w√§hlst du oben die Sprache (ES, EN, PT, FR, IT, DE) und wir legen los.`
};

   function welcomeKeyFor(lang) {
  return `esteborg_ia_welcome_${lang}`;
}

function hasShownWelcome(lang) {
  try {
    return sessionStorage.getItem(welcomeKeyFor(lang)) === "1";
  } catch {
    return false;
  }
}

function markWelcomeShown(lang) {
  try {
    sessionStorage.setItem(welcomeKeyFor(lang), "1");
  } catch {}
}

  const TYPING_TEXT = {
    es: "Escribiendo‚Ä¶",
    en: "Typing‚Ä¶",
    pt: "Digitando‚Ä¶",
    fr: "√âcriture‚Ä¶",
    it: "Schreibend‚Ä¶",
    de: "Schreibt‚Ä¶"
  };

  const STT_LOCALE = {
    es: "es-MX",
    en: "en-US",
    pt: "pt-BR",
    fr: "fr-FR",
    it: "it-IT",
    de: "de-DE"
  };

  // =========================
  // STATE
  // =========================

  let currentLang =
    localStorage.getItem("esteborg_ia_lang") &&
    LANGS.includes(localStorage.getItem("esteborg_ia_lang"))
      ? localStorage.getItem("esteborg_ia_lang")
      : "es";

  let history = [];
  let ttsAudio = null;
  let isSending = false;

   function looksLikeToken(str) {
    if (!str) return false;
    const s = str.trim();
    if (s.length < 40) return false;
    // T√≠pico formato JWT: 3 segmentos separados por puntos
    if (s.split(".").length >= 3) return true;
    // Fallback: cadena larga alfanum√©rica tipo token
    return /^[A-Za-z0-9\-_]+$/.test(s) && s.length > 80;
  }

  // =========================
  // DOM
  // =========================

  const chatLog = document.getElementById("chat-log");
  const userInput = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");
  const micBtn = document.getElementById("mic-btn");
  const voiceToggle = document.getElementById("voice-toggle");
  const langPills = Array.from(document.querySelectorAll(".lang-pill"));
  const chipButtons = Array.from(document.querySelectorAll(".chip-btn"));

  const bannerMainEl = document.querySelector(".banner-title-main");
  const bannerSubEl = document.querySelector(".banner-title-sub");
  const bannerDescEl = document.querySelector(".banner-description");
  const panelTitles = document.querySelectorAll(".panel .panel-title");
  const voiceLabelSpan = document.querySelector(".toggle-label span");
  const langLabelSpan = document.querySelector(".lang-label");

  // =========================
  // UTILS
  // =========================

  function scrollChatToBottom() {
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function cleanForTTS(text) {
    return text
      .replace(/[\n\r]+/g, " ")
      .replace(/[.,;:!?¬°¬ø\"'‚Äú‚Äù(){}\[\]<>¬´¬ª]/g, "")
      .replace(/\s{2,}/g, " ")
      .trim();
  }

  function addMessage(role, content, { speak = false } = {}) {
    const row = document.createElement("div");
    row.className = "msg-row";

    const roleLabel = document.createElement("div");
    roleLabel.className = "msg-role";

    const pack = I18N[currentLang] || I18N.es;
    if (role === "user") {
      roleLabel.textContent = pack.chatUserLabel;
    } else if (role === "assistant") {
      roleLabel.textContent = pack.chatAssistantLabel;
    } else {
      roleLabel.textContent = "SISTEMA";
    }

    const bubble = document.createElement("div");
    bubble.className = `msg-bubble ${role}`;
    bubble.textContent = content;

    row.appendChild(roleLabel);
    row.appendChild(bubble);
    chatLog.appendChild(row);
    scrollChatToBottom();

    if (role === "user" || role === "assistant") {
      history.push({ role: role === "user" ? "user" : "assistant", content });
      if (history.length > 20) history = history.slice(-20);
    }

    if (role === "assistant" && speak && voiceToggle && voiceToggle.checked) {
      playTTS(content).catch(() => {});
    }

    return bubble;
  }

  function applyUILanguage() {
    const pack = I18N[currentLang] || I18N.es;

    if (bannerMainEl) bannerMainEl.textContent = pack.bannerMain;
    if (bannerSubEl) bannerSubEl.textContent = pack.bannerSub;
    if (bannerDescEl) bannerDescEl.textContent = pack.bannerDesc;

    if (panelTitles[0]) panelTitles[0].textContent = pack.panelTitleTop;
    if (panelTitles[1]) panelTitles[1].textContent = pack.chipsLabel;
    if (panelTitles[2]) panelTitles[2].textContent = pack.materialLabel;

    const rows = document.querySelectorAll(".panel .chips-row");
    if (rows[0]) {
      const chips = rows[0].querySelectorAll(".chip-btn");
      if (chips[0]) {
        chips[0].dataset.prompt = pack.chipAutomatePrompt;
        chips[0].innerHTML =
          '<span class="chip-dot"></span> ' + pack.chipAutomate;
      }
      if (chips[1]) {
        chips[1].dataset.prompt = pack.chipDecisionsPrompt;
        chips[1].innerHTML =
          '<span class="chip-dot"></span> ' + pack.chipDecisions;
      }
      if (chips[2]) {
        chips[2].dataset.prompt = pack.chipBusinessPrompt;
        chips[2].innerHTML =
          '<span class="chip-dot"></span> ' + pack.chipBusiness;
      }
      if (chips[3]) {
        chips[3].dataset.prompt = pack.chipDailyIAPrompt;
        chips[3].innerHTML =
          '<span class="chip-dot"></span> ' + pack.chipDailyIA;
      }
    }

    if (rows[1]) {
      const chips2 = rows[1].querySelectorAll(".chip-btn");
      if (chips2[0]) {
        chips2[0].dataset.prompt = pack.chipSlidesPrompt;
        chips2[0].textContent = pack.chipSlides;
      }
      if (chips2[1]) {
        chips2[1].dataset.prompt = pack.chipSummaryPrompt;
        chips2[1].textContent = pack.chipSummary;
      }
    }

    if (userInput) userInput.placeholder = pack.inputPlaceholder;
    if (voiceLabelSpan) voiceLabelSpan.textContent = pack.voiceLabel;
    if (langLabelSpan)
      langLabelSpan.textContent =
        currentLang === "en" ? "LANGUAGE:" : "IDIOMA:";
  }

  function setLanguage(lang) {
  if (!LANGS.includes(lang)) return;
  currentLang = lang;
  localStorage.setItem("esteborg_ia_lang", lang);

  langPills.forEach((pill) =>
    pill.classList.toggle("active", pill.dataset.lang === lang)
  );

  applyUILanguage();

  const pack = I18N[currentLang] || I18N.es;
  addMessage("system", pack.systemLangChanged, { speak: false });

  // Mensaje de Tokken en el idioma seleccionado (solo una vez por idioma)
  if (!hasShownWelcome(currentLang)) {
    addMessage("assistant", WELCOME[currentLang], { speak: false });
    markWelcomeShown(currentLang);
  }
}

  // =========================
  // TTS
  // =========================

  async function playTTS(text) {
    try {
      stopTTS();
      const cleaned = cleanForTTS(text);
      if (!cleaned) return;

      const response = await fetch(
        "https://api.elevenlabs.io/v1/text-to-speech/" + ELEVEN_VOICE_ID,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "xi-api-key": ELEVEN_API_KEY
          },
          body: JSON.stringify({
            text: cleaned,
            model_id: "eleven_multilingual_v2",
            voice_settings: {
              stability: 0.5,
              similarity_boost: 0.75
            }
          })
        }
      );

      if (!response.ok) return;
      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      ttsAudio = new Audio(url);
      ttsAudio.play();
    } catch (err) {
      console.error("[TTS ERROR]", err);
    }
  }

  function stopTTS() {
    if (ttsAudio) {
      try {
        ttsAudio.pause();
        ttsAudio.currentTime = 0;
      } catch (e) {}
      ttsAudio = null;
    }
  }

  if (voiceToggle) {
    voiceToggle.addEventListener("change", () => {
      if (!voiceToggle.checked) stopTTS();
    });
  }

  // =========================
  // STT
  // =========================

  async function startSTT() {
    try {
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return;

      const recognition = new SpeechRecognition();
      recognition.lang = STT_LOCALE[currentLang] || "es-MX";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      return await new Promise((resolve, reject) => {
        recognition.onresult = (event) => {
          resolve(event.results[0][0].transcript);
        };
        recognition.onerror = (event) => {
          reject(event.error);
        };
        recognition.start();
      });
    } catch (err) {
      console.error("[STT ERROR]", err);
    }
  }

  // =========================
  // BACKEND
  // =========================

  async function sendToBackend(text) {
    // Igual que Com7: usamos VIP_TOKEN o lo buscamos de la URL
    const tokenToSend = VIP_TOKEN || getVIPTokenFromURL();

    console.log(
      "[IA] Tokken que mando al backend:",
      tokenToSend ? tokenToSend.slice(0, 40) + "..." : "(null)"
    );

    const payload = {
      message: text,
      rawToken: tokenToSend || null,
      userName: null,
      history,
      lang: currentLang
    };

    const headers = {
      "Content-Type": "application/json"
    };

    if (tokenToSend) {
      headers["x-esteborg-token"] = tokenToSend;
    }

    const res = await fetch(API_URL, {
      method: "POST",
      headers,
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      throw new Error("Error HTTP " + res.status);
    }

    return await res.json();
  }

  // =========================
  // HANDLE SEND
  // =========================

    async function handleSend(forcedText) {
    if (isSending) return;

    const rawText = (forcedText || userInput.value || "").trim();
    if (!rawText) return;

    // Mostramos lo que escribi√≥ el usuario tal cual
    stopTTS();
    addMessage("user", rawText);
    userInput.value = "";
    userInput.style.height = "44px";

    // Si a√∫n no tenemos Tokken y el texto parece JWT, lo guardamos
    let textToSend = rawText;
    if (!VIP_TOKEN && looksLikeToken(rawText)) {
      VIP_TOKEN = rawText;
      try {
        localStorage.setItem(VIP_STORAGE_KEY, VIP_TOKEN);
      } catch (e) {
        console.warn("[IA] No pude guardar Tokken en localStorage:", e);
      }

      addMessage(
        "system",
        "Tokken Esteborg Members recibido. Lo usar√© autom√°ticamente en tu entrenamiento.",
        { speak: false }
      );

      // Al backend ya no le mandamos el JWT, solo una frase de validaci√≥n
      textToSend =
        "Valida mi Tokken Esteborg Members y confirma que tengo acceso VIP para iniciar mi entrenamiento ejecutivo en IA.";
    }

    isSending = true;
    if (sendBtn) sendBtn.disabled = true;

    const typingBubble = addMessage(
      "assistant",
      TYPING_TEXT[currentLang] || "‚Ä¶",
      { speak: false }
    );

    try {
      const data = await sendToBackend(textToSend);
      const reply =
        (data &&
          (data.reply || data.message || data.response || data.content)) ||
        "No recib√≠ respuesta del servidor. Intenta de nuevo.";

      typingBubble.textContent = reply;

      if (voiceToggle && voiceToggle.checked) {
        playTTS(reply).catch(() => {});
      }
    } catch (err) {
      console.error(err);
      typingBubble.textContent =
        "Hubo un error al conectar con Esteborg IA. Intenta de nuevo en unos segundos.";
    } finally {
      isSending = false;
      if (sendBtn) sendBtn.disabled = false;
      scrollChatToBottom();
    }
  }

  // =========================
  // EVENTOS
  // =========================

  function wireEvents() {
    if (sendBtn) {
      sendBtn.addEventListener("click", () => handleSend());
    }

    if (userInput) {
      userInput.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" && !ev.shiftKey) {
          ev.preventDefault();
          handleSend();
        }
      });

      userInput.addEventListener("input", () => {
        userInput.style.height = "44px";
        userInput.style.height =
          Math.min(userInput.scrollHeight, 120) + "px";
      });
    }

    if (chipButtons && chipButtons.length) {
      chipButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const prompt =
            btn.dataset.prompt ||
            btn.dataset.text ||
            btn.textContent ||
            "";
          handleSend(prompt);
        });
      });
    }

    if (langPills && langPills.length) {
      langPills.forEach((pill) => {
        pill.addEventListener("click", () => {
          const lang = pill.dataset.lang;
          setLanguage(lang);
        });
      });
    }

    if (micBtn) {
      micBtn.addEventListener("click", async () => {
        try {
          const transcript = await startSTT();
          if (transcript) {
            userInput.value = transcript;
            handleSend();
          }
        } catch (e) {
          console.error(e);
        }
      });
    }
  }

  // =========================
  // INIT
  // =========================

  function initLanguageUI() {
    langPills.forEach((pill) =>
      pill.classList.toggle("active", pill.dataset.lang === currentLang)
    );
    applyUILanguage();
  }

  function initWelcome() {
  if (!hasShownWelcome(currentLang)) {
    addMessage("assistant", WELCOME[currentLang], { speak: false });
    markWelcomeShown(currentLang);
  }
}

  (function init() {
    initLanguageUI();
    initWelcome();

    const tokenToSend = VIP_TOKEN || getVIPTokenFromURL();
    if (tokenToSend) {
      addMessage(
        "system",
        "Tokken Esteborg Members detectado. Lo usar√© autom√°ticamente en tu entrenamiento.",
        { speak: false }
      );
    }

    wireEvents();
  })();
</script>


</body>
</html>
